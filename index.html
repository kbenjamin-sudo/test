<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>StudyOS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#07080a;--panel:#0e1116;--panel2:#10151d;--card:#0c0f14;
  --stroke:rgba(255,255,255,.10);--stroke2:rgba(255,255,255,.14);
  --text:#eef2ff;--muted:rgba(238,242,255,.55);--muted2:rgba(238,242,255,.35);
  --brand:#ff6a00;--brand2:#ffb100;--ok:#22c55e;--bad:#ff3b3b;--warn:#ffb100;
  --mono:'JetBrains Mono',ui-monospace,Menlo,monospace;
  --font:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --shadow:0 16px 55px rgba(0,0,0,.55);--shadow2:0 22px 80px rgba(0,0,0,.75);
  --r12:12px;--r14:14px;--r16:16px;--r18:18px;--r22:22px;
  --side:320px;--top:66px;
  --focus-ring:0 0 0 3px rgba(255,106,0,.38);
  --tx:130ms ease;
}
body.skyTheme{
  --bg:#eaf3ff;--panel:rgba(255,255,255,.84);--panel2:rgba(255,255,255,.78);
  --card:rgba(255,255,255,.86);--stroke:rgba(15,23,42,.10);--stroke2:rgba(15,23,42,.16);
  --text:#0b1220;--muted:rgba(11,18,32,.58);--muted2:rgba(11,18,32,.38);
  --brand:#3b82f6;--brand2:#60a5fa;
  --shadow:0 16px 55px rgba(2,6,23,.18);--shadow2:0 22px 80px rgba(2,6,23,.22);
  --focus-ring:0 0 0 3px rgba(59,130,246,.32);
}
body.skyTheme{
  background:radial-gradient(1200px 700px at 20% -10%,rgba(59,130,246,.22),transparent 55%),
    radial-gradient(900px 600px at 110% 15%,rgba(96,165,250,.18),transparent 60%),
    linear-gradient(#eef6ff,#e8f1ff);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:radial-gradient(1200px 700px at 20% -10%,rgba(255,106,0,.14),transparent 55%),
    radial-gradient(900px 600px at 110% 15%,rgba(255,177,0,.12),transparent 60%),
    linear-gradient(#07080a,#07080a);
  color:var(--text);font-family:var(--font);overflow:hidden;
  -webkit-font-smoothing:antialiased;
}
body.sidebar-open{overflow:hidden}
a{color:inherit}
button,input,select,textarea{font-family:var(--font)}
::selection{background:rgba(255,106,0,.35)}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.10);border-radius:999px;border:2px solid transparent;background-clip:content-box}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18);background-clip:content-box}
::-webkit-scrollbar-track{background:transparent}
:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.app{height:100%;display:grid;grid-template-columns:var(--side) 1fr}
.sidebar{position:relative;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.02));border-right:1px solid var(--stroke);overflow:hidden;z-index:10}
.side-inner{height:100%;display:flex;flex-direction:column}
.brand{padding:16px 16px 12px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,rgba(255,106,0,.08),transparent);flex-shrink:0}
.brand-top{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:16px;box-shadow:0 0 0 1px rgba(255,255,255,.14) inset,0 12px 32px rgba(255,106,0,.20);user-select:none;flex-shrink:0}
.brand-name{display:flex;flex-direction:column;gap:2px;min-width:0}
.brand-name .t{font-weight:900;letter-spacing:-.5px;font-size:17px;white-space:nowrap}
.brand-name .s{font-weight:700;color:var(--muted);font-size:10.5px;letter-spacing:.2px}
.side-actions{margin-top:12px;display:flex;gap:8px}
.school-select-wrap{margin-top:10px}
.school-select-wrap select{width:100%;border-radius:12px;border:1px solid var(--stroke2);background:rgba(255,255,255,.04);color:var(--text);padding:9px 10px;font-weight:800;font-size:11.5px;cursor:pointer;transition:border-color var(--tx)}
.school-select-wrap select:hover{border-color:rgba(255,106,0,.35)}
.school-select-wrap select:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.search-wrap{padding:10px 16px 8px;flex-shrink:0}
.search{width:100%;border-radius:12px;border:1px solid var(--stroke2);background:rgba(0,0,0,.18);color:var(--text);padding:10px 12px;font-weight:700;font-size:12px;transition:border-color var(--tx),box-shadow var(--tx)}
.search:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.search::placeholder{color:var(--muted2);font-weight:600}
.side-filters{padding:0 16px 8px;display:flex;gap:8px;align-items:center;flex-shrink:0}
.side-filters select{flex:1;border-radius:12px;border:1px solid var(--stroke2);background:rgba(255,255,255,.04);color:var(--text);padding:9px 10px;font-weight:800;font-size:11px;cursor:pointer}
.side-filters select:focus{outline:none;box-shadow:var(--focus-ring);border-color:rgba(255,106,0,.55)}
.side-filters .kbtn{width:44px;display:flex;justify-content:center;align-items:center;flex-shrink:0}
.note-list{flex:1;overflow-y:auto;overflow-x:hidden;padding:8px 10px 12px}
.group{margin:8px 0 12px}
.group-head{display:flex;align-items:center;justify-content:space-between;padding:8px 8px;color:var(--muted);font-weight:800;font-size:10px;letter-spacing:1.1px;text-transform:uppercase;user-select:none}
.group-head .count{font-size:9.5px;padding:2px 7px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid var(--stroke);color:var(--muted);font-weight:900}
.note-card{margin:6px 4px;padding:11px 12px;border-radius:14px;background:rgba(255,255,255,.03);border:1px solid var(--stroke);cursor:pointer;transition:transform var(--tx),border-color var(--tx),background var(--tx),box-shadow var(--tx)}
.note-card:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.28);background:rgba(255,255,255,.05);box-shadow:0 10px 28px rgba(0,0,0,.25)}
.note-card:active{transform:translateY(0)}
.note-card.active{border-color:rgba(255,106,0,.68);background:linear-gradient(180deg,rgba(255,106,0,.11),rgba(255,255,255,.03));box-shadow:0 18px 44px rgba(0,0,0,.35)}
.note-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:5px}
.note-title .t{font-weight:800;font-size:12.5px;letter-spacing:-.15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-title .tag{font-size:9.5px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,177,0,.28);color:rgba(255,212,150,.95);background:rgba(255,177,0,.07);font-weight:900;flex-shrink:0}
.note-snippet{color:var(--muted);font-weight:600;font-size:11px;line-height:1.45;height:30px;overflow:hidden}
.note-meta{margin-top:8px;display:flex;justify-content:space-between;align-items:center;color:var(--muted2);font-weight:800;font-size:9.5px}
.badges{display:flex;gap:5px;align-items:center}
.badge{font-size:9px;font-weight:900;padding:2px 6px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--muted)}
.badge.link{border-color:rgba(34,197,94,.22);background:rgba(34,197,94,.07);color:rgba(152,255,200,.95)}
.badge.draft{border-color:var(--stroke);background:rgba(255,255,255,.02);color:var(--muted2)}
.side-footer{padding:10px 14px 12px;border-top:1px solid var(--stroke);background:linear-gradient(180deg,transparent,rgba(255,255,255,.025));display:flex;flex-direction:column;gap:8px;flex-shrink:0}
.timerbar{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(0,0,0,.20);border:1px solid var(--stroke);padding:9px 12px;border-radius:14px}
.timerbar .time{font-family:var(--mono);font-size:18px;font-weight:900;letter-spacing:1px;background:linear-gradient(135deg,var(--brand),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.timerbar .tbtns{display:flex;gap:6px}
.timerbar .tbtn{width:36px;height:32px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--text);font-weight:900;transition:transform var(--tx),border-color var(--tx),background var(--tx);user-select:none}
.timerbar .tbtn:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.40);background:rgba(255,255,255,.07)}
.timerbar .tbtn:active{transform:translateY(0)}
.timerbar .tbtn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.timer-modes{display:flex;gap:6px;flex-wrap:wrap}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--muted);font-weight:800;font-size:10px;cursor:pointer;user-select:none;transition:transform var(--tx),border-color var(--tx),background var(--tx),color var(--tx)}
.pill:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.35);background:rgba(255,255,255,.07);color:var(--text)}
.pill:active{transform:translateY(0)}
.pill:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.userline{display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);font-weight:700;font-size:11px}
.userline .left{display:flex;align-items:center;gap:9px;min-width:0}
.avatar{width:32px;height:32px;border-radius:11px;background:linear-gradient(135deg,rgba(255,255,255,.10),rgba(255,255,255,.03));border:1px solid var(--stroke2);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:var(--text);user-select:none;flex-shrink:0}
.userline .email{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:155px;color:var(--text);font-size:11px}
.btn{border:1px solid var(--stroke2);background:rgba(255,255,255,.04);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:800;font-size:11.5px;transition:transform var(--tx),border-color var(--tx),background var(--tx),box-shadow var(--tx);user-select:none}
.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.07);border-color:rgba(255,106,0,.38);box-shadow:0 10px 28px rgba(0,0,0,.25)}
.btn:active{transform:translateY(0);box-shadow:none}
.btn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#111}
.btn.primary:hover{border-color:transparent;box-shadow:0 14px 40px rgba(255,106,0,.18)}
.btn.ghost{background:transparent;border-color:var(--stroke)}
.btn.ghost:hover{background:rgba(255,255,255,.05)}
.btn.danger{border-color:rgba(255,59,59,.28);color:rgba(255,180,180,.92)}
.btn.danger:hover{border-color:rgba(255,59,59,.60);background:rgba(255,59,59,.08)}
.iconbtn{width:42px;height:38px;border-radius:12px;border:1px solid var(--stroke2);background:rgba(255,255,255,.04);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;transition:transform var(--tx),border-color var(--tx),background var(--tx);user-select:none}
.iconbtn:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.35);background:rgba(255,255,255,.07)}
.iconbtn:active{transform:translateY(0)}
.iconbtn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.iconbtn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#111}
.iconbtn.primary:hover{border-color:transparent;box-shadow:0 14px 40px rgba(255,106,0,.18)}
.iconbtn.danger{border-color:rgba(255,59,59,.25);color:rgba(255,180,180,.90)}
.iconbtn.danger:hover{border-color:rgba(255,59,59,.60);background:rgba(255,59,59,.08)}
.iconbtn.wide{width:auto;padding:0 12px;gap:8px}
.iconbtn.wide span{font-weight:900;font-size:11.5px}
.main{position:relative;overflow:hidden;display:flex;flex-direction:column}
.topbar{height:var(--top);display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);flex-shrink:0;gap:10px}
.top-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
.mode-tabs{display:flex;gap:6px;align-items:center;flex-shrink:0}
.tab{padding:8px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--muted);font-weight:800;font-size:11.5px;cursor:pointer;user-select:none;transition:transform var(--tx),border-color var(--tx),background var(--tx),color var(--tx)}
.tab:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.28);background:rgba(255,255,255,.07);color:var(--text)}
.tab:active{transform:translateY(0)}
.tab:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.tab.active{background:linear-gradient(135deg,rgba(255,106,0,.20),rgba(255,177,0,.09));border-color:rgba(255,106,0,.55);color:rgba(255,245,240,.98);box-shadow:0 14px 36px rgba(0,0,0,.25)}
.notecrumb{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1}
.notecrumb .title{font-weight:900;letter-spacing:-.4px;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.notecrumb .sub{font-weight:700;color:var(--muted);font-size:10.5px;display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:3px 8px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--muted);font-weight:800;font-size:10px}
.top-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;flex-shrink:0}
.status{display:flex;align-items:center;gap:7px;padding:7px 10px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);font-weight:800;font-size:11px;color:var(--muted);user-select:none;transition:border-color .3s;white-space:nowrap}
.status.is-saving{border-color:rgba(255,177,0,.32)}
.status.is-saved{border-color:rgba(34,197,94,.28)}
.status.is-error{border-color:rgba(255,59,59,.32)}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;transition:all .3s}
.dot.ok{background:var(--ok);box-shadow:0 0 10px rgba(34,197,94,.35)}
.dot.warn{background:var(--warn);box-shadow:0 0 10px rgba(255,177,0,.35);animation:dotPulse 1.1s ease infinite}
.dot.bad{background:var(--bad);box-shadow:0 0 10px rgba(255,59,59,.35)}
@keyframes dotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.45;transform:scale(.65)}}
.content{flex:1;position:relative;overflow:hidden;min-height:0}
.view{position:absolute;inset:0;display:none}
.view.active{display:block}
#viewPreview{overflow:auto;-webkit-overflow-scrolling:touch}
#viewGames{overflow:auto}
.editor-shell{height:100%;display:grid;grid-template-rows:auto 1fr}
.toolbar{padding:10px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);flex-wrap:wrap}
.lefttools{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.tool{padding:7px 10px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);cursor:pointer;font-weight:900;font-size:11px;color:var(--muted);transition:transform var(--tx),border-color var(--tx),background var(--tx),color var(--tx);user-select:none}
.tool:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.28);background:rgba(255,255,255,.07);color:var(--text)}
.tool:active{transform:translateY(0)}
.tool:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.metapick{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.metapick select,.metapick input{border-radius:10px;border:1px solid var(--stroke2);background:rgba(255,255,255,.04);color:var(--text);padding:8px 10px;font-weight:800;font-size:11px;transition:border-color var(--tx),box-shadow var(--tx)}
.metapick input{width:230px}
.metapick input::placeholder{color:var(--muted2);font-weight:600}
.metapick input:focus,.metapick select:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.split{height:100%;display:grid;grid-template-columns:1fr 12px 1fr;overflow:hidden}
.split.singleEditor{grid-template-columns:1fr}
.split.singlePreview{grid-template-columns:1fr}
.pane{height:100%;overflow:auto;padding:16px 16px 20px}
.divider{display:flex;align-items:center;justify-content:center;cursor:col-resize;user-select:none}
.divider::before{content:'';width:5px;height:48%;border-radius:999px;background:rgba(255,255,255,.09);border:1px solid var(--stroke);transition:background var(--tx),border-color var(--tx)}
.divider:hover::before{background:rgba(255,106,0,.13);border-color:rgba(255,106,0,.28)}
.titleInput{width:100%;border:none;outline:none;background:transparent;color:var(--text);font-weight:900;letter-spacing:-.8px;font-size:34px;padding:8px 0 10px}
.titleInput::placeholder{color:var(--muted2)}
.bodyInput{width:100%;min-height:calc(100% - 65px);border:1px solid var(--stroke);outline:none;background:rgba(0,0,0,.16);color:rgba(238,242,255,.90);border-radius:16px;padding:14px;font-family:var(--mono);font-size:13.5px;line-height:1.75;resize:none;transition:border-color var(--tx),box-shadow var(--tx)}
.bodyInput:focus{border-color:rgba(255,106,0,.50);box-shadow:var(--focus-ring)}
.bodyInput::placeholder{color:var(--muted2)}
.rightpane{display:flex;flex-direction:column;gap:12px}
.card{border-radius:16px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);padding:13px}
.cardhead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
.cardhead .h{font-weight:900;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
.cardhead .act{display:flex;gap:8px}
.linkbtn{font-weight:900;font-size:11px;color:rgba(255,200,160,.88);cursor:pointer;user-select:none}
.linkbtn:hover{color:rgba(255,220,200,.98)}
.pills{display:flex;gap:7px;flex-wrap:wrap}
.pillnote{padding:7px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.14);color:var(--muted);font-weight:800;font-size:11px;cursor:pointer;user-select:none;display:flex;gap:7px;align-items:center;transition:transform var(--tx),border-color var(--tx),background var(--tx),color var(--tx)}
.pillnote:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.28);background:rgba(255,255,255,.06);color:var(--text)}
.pillnote:active{transform:translateY(0)}
.pillnote .x{width:17px;height:17px;border-radius:999px;display:flex;align-items:center;justify-content:center;border:1px solid var(--stroke);background:rgba(255,255,255,.04);font-weight:900;font-size:11px}
.pillnote:hover .x{border-color:rgba(255,59,59,.28);background:rgba(255,59,59,.08);color:rgba(255,200,200,.95)}
.smallHint{color:var(--muted);font-weight:700;font-size:11px;line-height:1.7}
kbd{font-family:var(--mono);padding:2px 6px;border-radius:8px;border:1px solid var(--stroke);background:rgba(0,0,0,.22);font-size:10.5px}
hr.sep{border:0;border-top:1px solid var(--stroke);margin:10px 0}
.preview{max-width:940px;margin:0 auto;padding:20px 22px 36px}
.preview h1{font-size:46px;font-weight:900;letter-spacing:-1.1px;margin-bottom:10px;background:linear-gradient(135deg,rgba(255,240,230,.98),rgba(255,210,170,.85));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.preview .metaRow{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px}
.preview .metaRow .chip{font-size:11px;padding:5px 10px}
.preview .body{font-size:15.5px;line-height:1.9;color:rgba(238,242,255,.90)}
.preview .body h2{margin-top:2em;margin-bottom:.6em;font-size:26px;color:rgba(255,210,170,.92);font-weight:900;letter-spacing:-.4px}
.preview .body h3{margin-top:1.7em;margin-bottom:.55em;font-size:21px;color:rgba(255,177,0,.90);font-weight:900}
.preview .body p{margin:.9em 0}
.preview .body a{color:rgba(255,190,150,.95);font-weight:800;text-decoration:none;border-bottom:1px solid transparent}
.preview .body a:hover{border-bottom-color:rgba(255,190,150,.55)}
.preview .body code{font-family:var(--mono);font-size:.88em;padding:2px 6px;border-radius:9px;border:1px solid var(--stroke);background:rgba(0,0,0,.20);color:rgba(255,220,170,.94)}
.preview .body pre{margin:1.1em 0;border-radius:16px;border:1px solid var(--stroke);background:rgba(0,0,0,.20);overflow:auto;padding:13px}
.preview .body pre code{background:transparent;border:none;padding:0;color:rgba(238,242,255,.90)}
.preview .body blockquote{margin:1.1em 0;padding:12px 14px;border-left:3px solid rgba(255,106,0,.78);background:rgba(255,255,255,.03);border-radius:0 14px 14px 0;color:var(--muted);font-style:italic}
.preview .body ul,.preview .body ol{margin:.9em 0 .9em 1.3em}
.preview .body li{margin:.3em 0}
body.previewFull .sidebar{display:none}
body.previewFull .topbar{display:none}
body.previewFull .app{grid-template-columns:1fr}
body.previewFull .content{height:100%}
body.previewFull .preview{max-width:none;padding:40px 64px}
body.previewFull .preview h1{font-size:56px}
.graphWrap{height:100%;position:relative;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
#graph{width:100%;height:100%;display:block}
.graphUI{position:absolute;top:12px;right:12px;display:flex;gap:8px}
.graphHint{position:absolute;left:12px;bottom:12px;padding:9px 12px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.22);color:var(--muted);font-weight:800;font-size:11px}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.68);display:none;align-items:center;justify-content:center;z-index:3000;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.modal{width:92%;max-width:700px;border-radius:20px;border:1px solid var(--stroke2);background:rgba(14,17,22,.94);box-shadow:var(--shadow2);overflow:hidden}
.modalTop{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:12px}
.modalTop .h{font-weight:900;font-size:14px;letter-spacing:-.2px}
.modalBody{padding:14px 16px 16px}
.modalBody p{color:var(--muted);font-weight:700;font-size:11.5px;line-height:1.7;margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row input,.row select{flex:1;min-width:180px;padding:11px 11px;border-radius:14px;border:1px solid var(--stroke2);background:rgba(0,0,0,.20);color:var(--text);font-weight:800;font-size:11.5px;transition:border-color var(--tx),box-shadow var(--tx)}
.row input:focus,.row select:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.modalActions{padding:12px 16px 16px;display:flex;gap:8px;justify-content:flex-end}
.modalActions .btn{border-radius:14px}
.toastWrap{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:4000;pointer-events:none}
.toast{pointer-events:none;width:310px;border-radius:16px;border:1px solid var(--stroke2);background:rgba(14,17,22,.90);backdrop-filter:blur(10px);box-shadow:var(--shadow);padding:11px 12px;animation:toastIn .18s ease;transition:opacity .22s,transform .22s}
.toast.out{opacity:0;transform:translateY(6px)}
@keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.toast .t1{font-weight:900;font-size:12px;margin-bottom:2px}
.toast .t2{font-weight:700;font-size:11px;color:var(--muted);line-height:1.5}
.toast.ok{border-color:rgba(34,197,94,.22)}
.toast.warn{border-color:rgba(255,177,0,.22)}
.toast.bad{border-color:rgba(255,59,59,.25)}
.paletteBack{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:flex-start;justify-content:center;padding-top:90px;z-index:3500;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.palette{width:92%;max-width:740px;border-radius:20px;border:1px solid var(--stroke2);background:rgba(14,17,22,.93);box-shadow:var(--shadow2);overflow:hidden}
.paletteTop{padding:12px 12px;border-bottom:1px solid var(--stroke);display:flex;gap:10px;align-items:center}
.paletteTop input{flex:1;padding:11px 12px;border-radius:14px;border:1px solid var(--stroke2);background:rgba(0,0,0,.20);color:var(--text);font-weight:800;font-size:13px;transition:border-color var(--tx),box-shadow var(--tx)}
.paletteTop input:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.paletteTop .hint{color:var(--muted);font-weight:900;font-size:11px;white-space:nowrap}
.paletteList{max-height:410px;overflow:auto}
.pItem{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;border-top:1px solid rgba(255,255,255,.05);transition:background var(--tx)}
.pItem:hover,.pItem.pal-selected{background:rgba(255,255,255,.05)}
.pItem.pal-selected{background:linear-gradient(135deg,rgba(255,106,0,.10),rgba(255,177,0,.04))}
.pItem .l{display:flex;gap:10px;align-items:center;min-width:0}
.pIco{width:32px;height:32px;border-radius:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,106,0,.20);background:rgba(255,106,0,.08)}
.pTxt{min-width:0}
.pA{font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pB{margin-top:1px;font-weight:700;font-size:10.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pK{color:var(--muted);font-weight:900;font-size:11px;white-space:nowrap}
.authBack{position:fixed;inset:0;background:radial-gradient(900px 650px at 20% 10%,rgba(255,106,0,.14),transparent 60%),radial-gradient(700px 520px at 90% 25%,rgba(255,177,0,.12),transparent 65%),rgba(0,0,0,.80);display:flex;align-items:center;justify-content:center;z-index:5000}
.authCard{width:92%;max-width:450px;border-radius:24px;border:1px solid var(--stroke2);background:rgba(14,17,22,.92);box-shadow:var(--shadow2);padding:20px}
.authHead{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.authHead .t{font-weight:900;font-size:17px;letter-spacing:-.3px}
.authHead .s{font-weight:700;font-size:10.5px;color:var(--muted);margin-top:2px}
.authTabs{display:flex;gap:8px;margin:8px 0 12px}
.atab{flex:1;text-align:center;padding:9px 10px;border-radius:14px;border:1px solid var(--stroke2);background:rgba(255,255,255,.04);font-weight:900;font-size:12px;cursor:pointer;user-select:none;transition:border-color var(--tx),background var(--tx)}
.atab.active{border-color:rgba(255,106,0,.48);background:linear-gradient(135deg,rgba(255,106,0,.15),rgba(255,177,0,.07))}
.authCard input{width:100%;padding:11px 12px;border-radius:14px;border:1px solid var(--stroke2);background:rgba(0,0,0,.20);color:var(--text);font-weight:800;margin-bottom:8px;outline:none;font-size:13px;transition:border-color var(--tx),box-shadow var(--tx)}
.authCard input:focus{border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.authRow{display:flex;gap:8px;margin-top:4px}
.authRow .btn{flex:1}
.authErr{margin-top:8px;font-weight:800;font-size:11.5px;color:rgba(255,160,160,.95);min-height:16px}
.authSmall{margin-top:10px;display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-weight:800;font-size:11px}
.authSmall span{cursor:pointer;user-select:none}
.authSmall span:hover{color:rgba(255,220,200,.95)}
.backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.52);z-index:2400}
.backdrop.show{display:block}
.gamesWrap{height:100%;display:flex;align-items:flex-start;justify-content:center;padding:16px;overflow:auto}
.gameCard{width:min(960px,96vw);border-radius:22px;border:1px solid rgba(255,106,0,.28);background:rgba(14,17,22,.88);box-shadow:var(--shadow2);padding:14px}
.gameTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:4px 6px 10px}
.gTabs{display:flex;gap:8px;flex-wrap:wrap}
.gTab{padding:9px 12px;border-radius:14px;border:1px solid var(--stroke2);background:rgba(255,255,255,.04);cursor:pointer;font-weight:900;font-size:12px;user-select:none;transition:border-color var(--tx),background var(--tx)}
.gTab.active{border-color:rgba(255,106,0,.48);background:linear-gradient(135deg,rgba(255,106,0,.15),rgba(255,177,0,.07))}
.gameTitle{font-weight:900;font-size:14px;color:rgba(255,220,200,.95)}
.gameBody{display:grid;grid-template-columns:1.15fr .85fr;gap:12px}
@media(max-width:900px){.gameBody{grid-template-columns:1fr}}
.canvasWrap{border-radius:18px;border:1px solid var(--stroke);background:rgba(0,0,0,.20);padding:10px;display:flex;align-items:center;justify-content:center}
canvas{display:block;border-radius:14px;border:1px solid rgba(255,106,0,.20);background:#050505;box-shadow:0 0 28px rgba(255,106,0,.08)}
.gameSide{display:flex;flex-direction:column;gap:10px}
.scoreBox{border-radius:18px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);padding:13px}
.scoreBox .r{display:flex;justify-content:space-between;gap:8px;margin:6px 0;font-weight:900;font-size:12px}
.scoreBox .r span{color:rgba(255,210,170,.95);font-weight:900}
.cheatBox{border-radius:18px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);padding:13px}
.cheatBox .h{font-weight:900;font-size:11.5px;color:rgba(255,220,200,.95);margin-bottom:9px}
.cheatBox label{display:flex;justify-content:space-between;align-items:center;gap:8px;font-weight:800;font-size:11.5px;color:var(--muted);margin:9px 0}
.cheatBox input[type="checkbox"]{accent-color:var(--brand);cursor:pointer}
.cheatBox input[type="range"]{accent-color:var(--brand);width:150px;cursor:pointer}
.cheatBox input[type="number"]{width:80px;padding:8px 9px;border-radius:12px;border:1px solid var(--stroke2);background:rgba(0,0,0,.20);color:var(--text);font-weight:900;outline:none;font-size:12px;transition:border-color var(--tx)}
.cheatBox input[type="number"]:focus{border-color:rgba(255,106,0,.55);box-shadow:var(--focus-ring)}
.gameBtns{display:flex;gap:8px;flex-wrap:wrap}
@media(max-width:1080px){.notecrumb .title{max-width:340px}}
@media(max-width:900px){
  .app{grid-template-columns:1fr}
  .sidebar{position:fixed;left:-330px;top:0;bottom:0;width:310px;z-index:2500;transition:left .18s ease,box-shadow .18s ease}
  .sidebar.open{left:0;box-shadow:24px 0 60px rgba(0,0,0,.45)}
  .topbar{padding:0 10px}
  .notecrumb .title{max-width:200px}
  .metapick input{width:160px}
}
body.skyTheme .sidebar{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-right:1px solid rgba(255,255,255,.15)}
body.skyTheme .brand-name .t,body.skyTheme .brand-name .s{color:rgba(255,255,255,.92)}
body.skyTheme .brand{background:linear-gradient(180deg,rgba(255,255,255,.08),transparent)}
body.skyTheme .side-footer{background:linear-gradient(180deg,transparent,rgba(0,0,0,.12))}
body.skyTheme .topbar{background:rgba(255,255,255,.65);border-color:rgba(15,23,42,.10);box-shadow:0 8px 20px rgba(15,23,42,.08)}
body.skyTheme .tab.active{background:linear-gradient(135deg,rgba(59,130,246,.20),rgba(96,165,250,.09));border-color:rgba(59,130,246,.52)}
body.skyTheme .btn.primary,.body.skyTheme .iconbtn.primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
body.skyTheme .logo{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
body.skyTheme .search,.body.skyTheme .bodyInput{background:rgba(255,255,255,.88);color:#0b1220}
body.skyTheme .search::placeholder,.body.skyTheme .bodyInput::placeholder{color:rgba(11,18,32,.32)}
body.skyTheme .titleInput{color:#0b1220}
body.skyTheme .timerbar{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18)}
body.skyTheme .timerbar .time{background:linear-gradient(135deg,#fff,rgba(255,255,255,.78));-webkit-background-clip:text;background-clip:text}
body.skyTheme .note-card{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.20)}
body.skyTheme .note-card:hover{background:rgba(255,255,255,.20)}
body.skyTheme .note-card.active{background:rgba(255,255,255,.24);border-color:rgba(255,255,255,.38)}
body.skyTheme .pill{border-color:rgba(255,255,255,.20);background:rgba(255,255,255,.10);color:rgba(255,255,255,.82)}
body.skyTheme .pill:hover{background:rgba(255,255,255,.18);color:#fff}
body.skyTheme .userline{color:rgba(255,255,255,.72)}
body.skyTheme .userline .email{color:rgba(255,255,255,.90)}
body.skyTheme .avatar{background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.22)}
body.skyTheme .group-head{color:rgba(255,255,255,.58)}
body.skyTheme .note-snippet{color:rgba(255,255,255,.58)}
body.skyTheme .note-meta{color:rgba(255,255,255,.42)}
body.skyTheme .side-filters select,.body.skyTheme .school-select-wrap select{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18);color:rgba(255,255,255,.90)}
body.skyTheme .bodyInput{background:rgba(255,255,255,.88);color:#0b1220}
body.skyTheme .bodyInput::placeholder{color:rgba(11,18,32,.32)}
body.skyTheme .search{background:rgba(255,255,255,.88);color:#0b1220}
body.skyTheme .search::placeholder{color:rgba(11,18,32,.32)}
</style>
</head>
<body class="skyTheme">
<div class="toastWrap" id="toastWrap"></div>
<div class="paletteBack" id="paletteBack">
  <div class="palette">
    <div class="paletteTop">
      <input id="paletteQ" placeholder="Search notes or type a command‚Ä¶" autocomplete="off">
      <div class="hint">‚Üë‚Üì ¬∑ Enter ¬∑ Esc</div>
    </div>
    <div class="paletteList" id="paletteList"></div>
  </div>
</div>
<div class="modalBack" id="modalPdf">
  <div class="modal">
    <div class="modalTop"><div class="h">Export PDF</div><button class="iconbtn" id="pdfClose">‚úï</button></div>
    <div class="modalBody">
      <p>Exports a styled PDF of the current note. Optionally include linked notes as an appendix.</p>
      <div class="row">
        <select id="pdfIncludeLinks"><option value="1">Include linked notes</option><option value="0">Only this note</option></select>
        <select id="pdfIncludeDates"><option value="1">Include dates</option><option value="0">No dates</option></select>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="pdfCancel">Cancel</button>
      <button class="btn primary" id="pdfGo">Export</button>
    </div>
  </div>
</div>
<div class="modalBack" id="modalSettings">
  <div class="modal">
    <div class="modalTop"><div class="h">Settings</div><button class="iconbtn" id="setClose">‚úï</button></div>
    <div class="modalBody">
      <p>These sync across devices.</p>
      <div class="row">
        <select id="setSidebar"><option value="0">Sidebar: Normal</option><option value="1">Sidebar: Hidden</option></select>
        <select id="setPreviewFull"><option value="0">Preview Full-screen: Off</option><option value="1">Preview Full-screen: On</option></select>
        <select id="setTheme"><option value="dark">Theme: Dark</option><option value="sky">Theme: Sky</option></select>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <input id="setFocus" type="number" min="1" max="180" placeholder="Focus minutes (25)">
        <input id="setBreak" type="number" min="1" max="60" placeholder="Break minutes (5)">
        <input id="setLong" type="number" min="1" max="120" placeholder="Long break (15)">
      </div>
      <hr class="sep">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div style="font-weight:900;font-size:12px">Settings for nerds</div>
        <div style="font-size:10.5px;color:var(--muted);font-weight:800">PIN 9999</div>
      </div>
      <div style="height:8px"></div>
      <div class="row" id="nerdLockRow">
        <input id="nerdPass" type="password" inputmode="numeric" placeholder="Enter PIN to unlock">
        <button class="btn" id="nerdUnlock">Unlock</button>
      </div>
      <div id="nerdBox" style="display:none;margin-top:10px">
        <p style="margin-bottom:8px">Background audio. Quick mute: <kbd>Alt+M</kbd> or <kbd>`</kbd>. Toggle bar: <kbd>P</kbd>. Mute: <kbd>M</kbd>.</p>
        <div class="row">
          <select id="musicMode">
            <option value="off">Audio: Off</option><option value="amb1">Audio: Ambience 1</option>
            <option value="amb2">Audio: Ambience 2</option><option value="amb3">Audio: Ambience 3</option>
            <option value="amb4">Audio: Ambience 4</option><option value="amb5">Audio: Ambience 5</option>
            <option value="amb6">Audio: Ambience 6</option><option value="amb7">Audio: Ambience 7</option>
          </select>
          <select id="sfxMode"><option value="on">Game SFX: On</option><option value="off">Game SFX: Off</option></select>
        </div>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="setCancel">Cancel</button>
      <button class="btn primary" id="setSave">Save</button>
    </div>
  </div>
</div>
<div class="authBack" id="authBack">
  <div class="authCard">
    <div class="authHead"><div class="logo">S</div><div><div class="t">StudyOS</div><div class="s">Everything saves. Everywhere.</div></div></div>
    <div class="authTabs"><div class="atab active" id="tabSignIn">Sign In</div><div class="atab" id="tabSignUp">Sign Up</div></div>
    <input id="authEmail" type="email" placeholder="Email" autocomplete="email">
    <input id="authPass" type="password" placeholder="Password" autocomplete="current-password">
    <div class="authRow">
      <button class="btn primary" id="authGo">Enter</button>
      <button class="btn ghost" id="authMagic">Magic Link</button>
    </div>
    <div class="authSmall"><span id="authReset">Forgot password?</span><span id="authTip">Ctrl+K inside app</span></div>
    <div class="authErr" id="authErr"></div>
  </div>
</div>
<div class="backdrop" id="backdrop"></div>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="side-inner">
      <div class="brand">
        <div class="brand-top">
          <div class="logo">S</div>
          <div class="brand-name"><div class="t">StudyOS</div><div class="s">notes ¬∑ links ¬∑ graph ¬∑ games</div></div>
        </div>
        <div class="side-actions">
          <button class="btn primary" id="btnNew">New Note</button>
          <button class="btn" id="btnGames">Games</button>
        </div>
        <div class="school-select-wrap">
          <select id="schoolSelect">
            <option value="Salesianum">School: Salesianum</option>
            <option value="St Peter Cathedral">School: St Peter Cathedral</option>
            <option value="Charter">School: Charter</option>
            <option value="Public">School: Public</option>
            <option value="Other">School: Other</option>
          </select>
        </div>
      </div>
      <div class="search-wrap"><input class="search" id="search" placeholder="Search titles + content (Ctrl+K)" autocomplete="off"></div>
      <div class="side-filters">
        <select id="sort">
          <option value="updated_desc">Sort: Updated</option>
          <option value="title_asc">Sort: Title</option>
          <option value="grade_asc">Sort: Grade</option>
        </select>
        <button class="btn kbtn" id="openPalette" title="Command Palette">‚åò</button>
      </div>
      <div class="note-list" id="noteList"></div>
      <div class="side-footer">
        <div class="timerbar">
          <div class="time" id="timerText">25:00</div>
          <div class="tbtns">
            <button class="tbtn" id="tStart" title="Start">‚ñ∂</button>
            <button class="tbtn" id="tPause" title="Pause">‚è∏</button>
            <button class="tbtn" id="tReset" title="Reset">‚Ü∫</button>
          </div>
        </div>
        <div class="timer-modes">
          <button class="pill" id="mFocus">Focus</button>
          <button class="pill" id="mBreak">Break</button>
          <button class="pill" id="mLong">Long</button>
          <button class="pill" id="mBreakGame">Break+Game</button>
        </div>
        <div class="userline">
          <div class="left"><div class="avatar" id="avatar">U</div><div class="email" id="userEmail">Signed out</div></div>
          <button class="btn ghost out" id="signOut" style="padding:7px 10px;border-radius:12px">Sign out</button>
        </div>
      </div>
    </div>
  </aside>
  <main class="main">
    <div class="topbar">
      <div class="top-left">
        <div class="mode-tabs">
          <button class="tab active" id="modeEdit">Edit</button>
          <button class="tab" id="modePreview">Preview</button>
          <button class="tab" id="modeGraph">Graph</button>
        </div>
        <div class="notecrumb">
          <div class="title" id="crumbTitle">No note selected</div>
          <div class="sub" id="crumbSub"></div>
        </div>
      </div>
      <div class="top-right">
        <div class="status" id="saveStatus"><span class="dot warn"></span><span>Not saved</span></div>
        <button class="iconbtn wide" id="toggleSplit"><span>Split</span></button>
        <button class="iconbtn wide" id="toggleFull"><span>Full</span></button>
        <button class="iconbtn wide" id="doPdf"><span>PDF</span></button>
        <button class="iconbtn" id="openSettings" title="Settings">‚öô</button>
        <button class="iconbtn primary" id="saveNow" title="Save (Ctrl+S)">Save</button>
        <button class="iconbtn danger" id="delNote" title="Delete note">üóë</button>
        <button class="iconbtn" id="mobileMenu" style="display:none">‚ò∞</button>
      </div>
    </div>
    <div class="content">
      <section class="view active" id="viewEditor">
        <div class="editor-shell">
          <div class="toolbar">
            <div class="lefttools">
              <button class="tool" data-md="bold">B</button>
              <button class="tool" data-md="italic">I</button>
              <button class="tool" data-md="h1">H1</button>
              <button class="tool" data-md="h2">H2</button>
              <button class="tool" data-md="ul">‚Ä¢ List</button>
              <button class="tool" data-md="ol">1. List</button>
              <button class="tool" data-md="quote">Quote</button>
              <button class="tool" data-md="code">Code</button>
              <button class="tool" data-md="link">Link</button>
            </div>
            <div class="metapick">
              <select id="grade">
                <option value="">Grade: (none)</option>
                <option value="8th">8th</option><option value="9th">9th</option>
                <option value="10th">10th</option><option value="11th">11th</option><option value="12th">12th</option>
              </select>
              <input id="linkSearch" placeholder="Link notes by title‚Ä¶" autocomplete="off">
            </div>
          </div>
          <div class="split" id="split">
            <div class="pane" id="paneLeft">
              <input class="titleInput" id="title" placeholder="Untitled" spellcheck="true">
              <textarea class="bodyInput" id="body" placeholder="Write in Markdown‚Ä¶" spellcheck="true"></textarea>
            </div>
            <div class="divider" id="divider" title="Double-click to reset 50/50"></div>
            <div class="pane" id="paneRight">
              <div class="rightpane">
                <div class="card" id="cardLinks" style="display:none">
                  <div class="cardhead"><div class="h">Linked notes</div><div class="act"><span class="linkbtn" id="unlinkAll">Unlink all</span><span class="linkbtn" id="jumpPreview">Preview</span></div></div>
                  <div class="pills" id="linksPills"></div>
                </div>
                <div class="card" id="cardBack" style="display:none">
                  <div class="cardhead"><div class="h">Backlinks</div><div class="act"><span class="linkbtn" id="jumpGraph">Graph</span></div></div>
                  <div class="pills" id="backPills"></div>
                </div>
                <div class="card" id="cardMentions" style="display:none">
                  <div class="cardhead"><div class="h">Unlinked mentions</div><div class="act"><span class="linkbtn" id="linkAllMentions">Link all</span></div></div>
                  <div class="pills" id="menPills"></div>
                </div>
                <div class="card">
                  <div class="cardhead"><div class="h">Shortcuts</div></div>
                  <div class="smallHint">
                    <div><kbd>Ctrl+S</kbd> save &nbsp; <kbd>Ctrl+K</kbd> command palette</div>
                    <div><kbd>Esc</kbd> exit full-screen / close dialogs</div>
                    <div style="margin-top:4px;opacity:.7"><kbd>‚Üë‚Üì Enter</kbd> navigate palette</div>
                  </div>
                </div>
                <div class="card" id="cardDrop" style="display:none">
                  <div class="cardhead"><div class="h">Link results</div><div class="act"><span class="linkbtn" id="closeDrop">Close</span></div></div>
                  <div id="dropList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="view" id="viewPreview">
        <div class="preview">
          <h1 id="pTitle">Untitled</h1>
          <div class="metaRow" id="pMeta"></div>
          <div class="body" id="pBody"></div>
          <div class="card" id="pLinksCard" style="margin-top:18px;display:none">
            <div class="cardhead"><div class="h">Linked notes</div><div class="act"><span class="linkbtn" id="backToEdit">Back</span></div></div>
            <div class="pills" id="pLinks"></div>
          </div>
        </div>
      </section>
      <section class="view" id="viewGraph">
        <div class="graphWrap">
          <canvas id="graph"></canvas>
          <div class="graphUI">
            <button class="iconbtn wide" id="gReset"><span>Reset</span></button>
            <button class="iconbtn wide" id="gPhys"><span>Physics</span></button>
            <button class="iconbtn wide" id="gCenter"><span>Center</span></button>
          </div>
          <div class="graphHint">Drag to pan ¬∑ Scroll to zoom ¬∑ Click node to open</div>
        </div>
      </section>
      <section class="view" id="viewGames">
        <div class="gamesWrap">
          <div class="gameCard">
            <div class="gameTop">
              <div class="gameTitle" id="gTitle">Break Games</div>
              <div class="gTabs">
                <button class="gTab active" id="tabSnake">Snake+</button>
                <button class="gTab" id="tabTetris">Tetris</button>
                <button class="gTab" id="tabRunner">Pulse Runner</button>
              </div>
              <div class="gameBtns">
                <button class="btn primary" id="gStart">Start</button>
                <button class="btn" id="gClose">Back</button>
              </div>
            </div>
            <div class="gameBody">
              <div class="canvasWrap">
                <canvas id="snakeCanvas" width="420" height="420"></canvas>
                <canvas id="tetrisCanvas" width="240" height="480" style="display:none"></canvas>
                <canvas id="runnerCanvas" width="560" height="260" style="display:none"></canvas>
              </div>
              <div class="gameSide">
                <div class="scoreBox" id="snakeScoreBox">
                  <div class="r">Score <span id="snakeScore">0</span></div>
                  <div class="r">Best <span id="snakeBest">0</span></div>
                  <div class="smallHint">Move: <kbd>WASD</kbd>/<kbd>Arrows</kbd> ¬∑ Boost: <kbd>Shift</kbd></div>
                </div>
                <div class="scoreBox" id="tetrisScoreBox" style="display:none">
                  <div class="r">Score <span id="tScore">0</span></div>
                  <div class="r">Best <span id="tBest">0</span></div>
                  <div class="r">Level <span id="tLevel">1</span></div>
                  <div class="r">Lines <span id="tLines">0</span></div>
                  <div class="smallHint">Rotate <kbd>‚Üë</kbd> ¬∑ Drop <kbd>Space</kbd></div>
                </div>
                <div class="scoreBox" id="runnerScoreBox" style="display:none">
                  <div class="r">Distance <span id="rDist">0</span></div>
                  <div class="r">Best <span id="rBest">0</span></div>
                  <div class="smallHint">Jump: <kbd>Space</kbd>/<kbd>‚Üë</kbd> ¬∑ Dash: <kbd>Shift</kbd></div>
                </div>
                <div class="cheatBox">
                  <div class="h">Game tweaks (saved)</div>
                  <div id="snakeCheats">
                    <label>Snake No-Die <input type="checkbox" id="cSnakeNoDie"></label>
                    <label>Snake Speed <input type="range" id="cSnakeSpeed" min="5" max="260" step="1"></label>
                    <label>Snake Boost <input type="checkbox" id="cSnakeBoost"></label>
                    <label>Walls Kill <input type="checkbox" id="cSnakeWalls"></label>
                    <label>Obstacles <input type="range" id="cSnakeObs" min="0" max="90" step="1"></label>
                    <label>Evasive Food <input type="checkbox" id="cSnakeEvasive"></label>
                    <label>Poison Food <input type="checkbox" id="cSnakePoison"></label>
                    <label>Food Distance <input type="range" id="cSnakeFoodDist" min="0" max="14" step="1"></label>
                    <div class="smallHint">Speed: <span id="cSnakeSpeedV" style="color:rgba(255,210,170,.95);font-weight:900"></span> ¬∑ Obs: <span id="cSnakeObsV" style="color:rgba(255,210,170,.95);font-weight:900"></span> ¬∑ FoodDist: <span id="cSnakeFoodDistV" style="color:rgba(255,210,170,.95);font-weight:900"></span></div>
                  </div>
                  <div id="tetrisCheats" style="display:none">
                    <label>No Game Over <input type="checkbox" id="cTNoOver"></label>
                    <label>Start Level <input type="number" id="cTLevel" min="1" max="20"></label>
                  </div>
                  <div id="runnerCheats" style="display:none">
                    <label>No Crash <input type="checkbox" id="cRNoCrash"></label>
                    <label>Slow Obstacles <input type="checkbox" id="cRSlow"></label>
                  </div>
                </div>
                <div class="card">
                  <div class="cardhead"><div class="h">Tip</div></div>
                  <div class="smallHint">Use <kbd>Break+Game</kbd> to instantly swap into games while your break timer runs.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
const SUPABASE_URL='https://cgmazcvmpcgistoimqlw.supabase.co'
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc'
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY,{global:{fetch:(url,o)=>fetch(url,{...(o||{}),keepalive:true})}})

marked.setOptions({breaks:true,highlight:(code,lang)=>{try{if(lang&&hljs.getLanguage(lang))return hljs.highlight(code,{language:lang}).value;return hljs.highlightAuto(code).value}catch(e){return code}}})

const $=id=>document.getElementById(id)
const gradeLabels={'':'','8th':'8th','9th':'9th','10th':'10th','11th':'11th','12th':'12th'}
const gradeOrder={'':99,'8th':0,'9th':1,'10th':2,'11th':3,'12th':4}
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function orderedPair(a,b){return a<b?[a,b]:[b,a]}
function fmtTime(d){try{return new Date(d).toLocaleString(undefined,{hour:'numeric',minute:'2-digit'})}catch(e){return ''}}
function fmtShort(d){try{return new Date(d).toLocaleString(undefined,{month:'short',day:'numeric'})}catch(e){return ''}}
function relTime(iso){if(!iso)return '';const t=new Date(iso).getTime();const diff=Math.max(0,Date.now()-t);const m=Math.floor(diff/60000);if(m<1)return 'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';const d=Math.floor(h/24);if(d<7)return d+'d ago';return fmtShort(iso)}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}

let user=null,notes=[],links=[],activeId=null
let uiPrefs={sort:'updated_desc',previewFull:false,sidebarHidden:false,theme:'sky',lastOpenNoteId:null,splitSizes:[50,50]}
let timerPresets={focus:25,break:5,long:15}
let gameCheats={snake:{highScore:0,noDie:false,speed:70,boost:false,wallsKill:true,obstacles:28,evasive:true,poison:true,foodDist:9},tetris:{highScore:0,noGameOver:false,startLevel:1},runner:{best:0,noCrash:false,slow:false}}
let currentSchool='Salesianum',nerdUnlocked=false
let nerdPrefs={musicMode:'off',sfxMode:'on'}
let autosaveTimer=null,autosaveDirty=false,previewDT=null
let timerInterval=null,timeLeft=25*60
let splitMode='split',splitSizes=[50,50],draggingDivider=false

function setStatus(mode){
  const el=$('saveStatus'),dot=el.querySelector('.dot'),txt=el.querySelectorAll('span')[1]
  el.classList.remove('is-saving','is-saved','is-error')
  if(mode==='saving'){dot.className='dot warn';txt.textContent='Saving‚Ä¶';el.classList.add('is-saving')}
  else if(mode==='saved'){dot.className='dot ok';txt.textContent='Saved '+fmtTime(Date.now());el.classList.add('is-saved')}
  else if(mode==='editing'){dot.className='dot warn';txt.textContent='Editing‚Ä¶'}
  else if(mode==='error'){dot.className='dot bad';txt.textContent='Save failed';el.classList.add('is-error')}
  else if(mode==='offline'){dot.className='dot bad';txt.textContent='Offline (local draft kept)';el.classList.add('is-error')}
  else{dot.className='dot warn';txt.textContent='Not saved'}
}

function toast(title,body,type='ok'){
  const wrap=$('toastWrap'),el=document.createElement('div')
  el.className='toast '+(type==='ok'?'ok':type==='warn'?'warn':'bad')
  el.innerHTML='<div class="t1"></div><div class="t2"></div>'
  el.querySelector('.t1').textContent=title
  el.querySelector('.t2').textContent=body
  wrap.appendChild(el)
  setTimeout(()=>el.classList.add('out'),2400)
  setTimeout(()=>{try{el.remove()}catch(e){}},2700)
}

function draftKey(){return user&&activeId?'studyOS_v2_'+user.id+'_'+activeId:null}
function saveDraft(){const k=draftKey();if(!k)return;try{localStorage.setItem(k,JSON.stringify({title:$('title').value,content:$('body').value,grade:$('grade').value,ts:Date.now()}))}catch(e){}}
function loadDraft(){const k=draftKey();if(!k)return null;try{const r=localStorage.getItem(k);return r?JSON.parse(r):null}catch(e){return null}}
function clearDraft(){const k=draftKey();if(!k)return;try{localStorage.removeItem(k)}catch(e){}}

function autosave(){
  if(!activeId)return
  autosaveDirty=true;saveDraft();setStatus('editing')
  clearTimeout(autosaveTimer)
  autosaveTimer=setTimeout(async()=>{
    const ok=await saveNote(true)
    if(ok){autosaveDirty=false;clearDraft()}
    else{autosaveDirty=true;setStatus(navigator.onLine?'error':'offline')}
  },700)
}

async function saveNote(silent=false){
  if(!user||!activeId)return false
  saveDraft()
  const payload={id:activeId,user_id:user.id,title:($('title').value||'').trim()||'Untitled',content:$('body').value,grade:$('grade').value||null,school:currentSchool,updated_at:new Date().toISOString()}
  setStatus('saving')
  try{
    const{error}=await supabase.from('notes').upsert(payload,{onConflict:'id'})
    if(error)throw error
    const idx=notes.findIndex(n=>n.id===activeId)
    if(idx>=0)notes[idx]={...notes[idx],...payload}
    setStatus('saved')
    if(!silent)toast('Saved',payload.title,'ok')
    return true
  }catch(e){
    console.error('saveNote:',e)
    setStatus('error')
    if(!silent)toast('Save failed',(e.message||'Check connection'),'bad')
    return false
  }
}

function mergeDeep(t,s){const o={...t};for(const k in s){if(s[k]&&typeof s[k]==='object'&&!Array.isArray(s[k]))o[k]=mergeDeep(t[k]||{},s[k]);else o[k]=s[k]}return o}

function applySettingsRow(s){
  if(s.current_school)currentSchool=s.current_school
  if(s.ui)uiPrefs={...uiPrefs,...s.ui}
  if(s.timer)timerPresets={...timerPresets,...s.timer}
  if(s.game)gameCheats=mergeDeep(gameCheats,s.game)
  if(s.nerd)nerdPrefs={...nerdPrefs,...s.nerd}
  $('sort').value=uiPrefs.sort||'updated_desc'
  $('setSidebar').value=uiPrefs.sidebarHidden?'1':'0'
  $('setPreviewFull').value=uiPrefs.previewFull?'1':'0'
  $('setTheme').value=uiPrefs.theme||'dark'
  document.body.classList.toggle('skyTheme',(uiPrefs.theme||'dark')==='sky')
  $('setFocus').value=timerPresets.focus||25
  $('setBreak').value=timerPresets.break||5
  $('setLong').value=timerPresets.long||15
  $('schoolSelect').value=currentSchool
  if(s.ui?.splitSizes)splitSizes=s.ui.splitSizes
  if(uiPrefs.previewFull)document.body.classList.add('previewFull')
  else document.body.classList.remove('previewFull')
  $('musicMode').value=nerdPrefs.musicMode||'off'
  $('sfxMode').value=nerdPrefs.sfxMode||'on'
  if(nerdUnlocked){$('nerdBox').style.display='block';$('nerdLockRow').style.display='none'}
  else{$('nerdBox').style.display='none';$('nerdLockRow').style.display='flex'}
  syncCheatUI();updateTimerDisplay();applyMusicMode()
}

let settingsT=null
function saveSettingsDebounced(){
  if(!user)return
  clearTimeout(settingsT)
  settingsT=setTimeout(async()=>{
    const p={user_id:user.id,current_school:currentSchool,ui:{...uiPrefs,splitSizes},timer:timerPresets,game:gameCheats,nerd:nerdPrefs}
    const{error}=await supabase.from('user_settings').upsert(p,{onConflict:'user_id'})
    if(error)console.warn('saveSettings:',error.message)
  },280)
}

async function ensureSettings(){
  const{data,error}=await supabase.from('user_settings').select('*').eq('user_id',user.id).maybeSingle()
  if(error)throw new Error('user_settings: '+error.message)
  if(!data){
    const ins=await supabase.from('user_settings').insert({user_id:user.id,current_school:currentSchool,ui:uiPrefs,timer:timerPresets,game:gameCheats,nerd:nerdPrefs}).select().single()
    if(ins.error)throw new Error('user_settings insert: '+ins.error.message)
    applySettingsRow(ins.data)
  }else{applySettingsRow(data)}
}

async function fetchLinks(){
  const{data,error}=await supabase.from('note_links').select('note_a,note_b').eq('user_id',user.id)
  if(error){console.warn('fetchLinks:',error.message);links=[];return}
  links=data||[]
}

function rebuildLinkedOnClient(){
  const map={}
  notes.forEach(n=>map[n.id]=[])
  links.forEach(l=>{if(map[l.note_a])map[l.note_a].push(l.note_b);if(map[l.note_b])map[l.note_b].push(l.note_a)})
  notes=notes.map(n=>({...n,linked_notes:map[n.id]||[]}))
}

async function fetchNotes(){
  const{data,error}=await supabase.from('notes').select('*').eq('user_id',user.id).order('updated_at',{ascending:false})
  if(error){toast('Could not load notes',error.message,'bad');return}
  notes=(data||[]).map(n=>({...n,linked_notes:[]}))
  await fetchLinks();rebuildLinkedOnClient();renderList()
  const last=uiPrefs.lastOpenNoteId
  if(last&&notes.some(n=>n.id===last))loadNote(last)
  else if(notes.length)loadNote(notes[0].id)
  else setEmptyState()
}

function sortNotes(arr){
  const mode=uiPrefs.sort||'updated_desc',copy=[...arr]
  if(mode==='title_asc')copy.sort((a,b)=>(a.title||'').toLowerCase().localeCompare((b.title||'').toLowerCase()))
  else if(mode==='grade_asc')copy.sort((a,b)=>(gradeOrder[a.grade||'']-gradeOrder[b.grade||''])||((b.updated_at||'')>(a.updated_at||'')?1:-1))
  else copy.sort((a,b)=>((b.updated_at||'')>(a.updated_at||''))?1:-1)
  return copy
}

function noteSnippet(n){const s=(n.content||'').replace(/\s+/g,' ').trim();if(!s)return 'No content yet.';return s.length>88?s.slice(0,88)+'‚Ä¶':s}

function renderList(){
  const q=($('search').value||'').trim().toLowerCase()
  const sorted=sortNotes(notes)
  const groups={}
  sorted.forEach(n=>{
    const title=(n.title||'').toLowerCase(),body=(n.content||'').toLowerCase()
    if(q&&!(title.includes(q)||body.includes(q)))return
    const g=n.grade||''
    if(!groups[g])groups[g]=[]
    groups[g].push(n)
  })
  const order=['8th','9th','10th','11th','12th','']
  const wrap=$('noteList')
  let html='',total=0
  order.forEach(g=>{
    const arr=groups[g]||[]
    if(!arr.length)return
    total+=arr.length
    html+='<div class="group"><div class="group-head"><div>'+(g?'Grade '+gradeLabels[g]:'Ungraded')+'</div><div class="count">'+arr.length+'</div></div>'
    arr.forEach(n=>{
      const t=n.title&&n.title.trim()?n.title:'Untitled'
      const tag=n.grade?'<div class="tag">'+gradeLabels[n.grade]+'</div>':''
      const linked=(n.linked_notes||[]).length>0
      const draft=!n.title&&!n.content
      const badges=(linked?'<div class="badge link">LINK</div>':'')+(draft?'<div class="badge draft">DRAFT</div>':'')
      html+='<div class="note-card'+(n.id===activeId?' active':'')+'" data-id="'+n.id+'">'
      html+='<div class="note-title"><div class="t">'+esc(t)+'</div>'+tag+'</div>'
      html+='<div class="note-snippet">'+esc(noteSnippet(n))+'</div>'
      html+='<div class="note-meta"><div>'+esc(relTime(n.updated_at||n.created_at))+'</div><div class="badges">'+badges+'</div></div></div>'
    })
    html+='</div>'
  })
  if(total===0){
    wrap.innerHTML='<div style="padding:20px 10px;color:var(--muted);font-weight:800;font-size:12px;line-height:1.7">No notes found.<br><span style="color:rgba(255,220,200,.90)">Try another search</span>.</div>'
  }else{
    wrap.innerHTML=html
    wrap.querySelectorAll('.note-card').forEach(c=>c.onclick=()=>loadNote(c.getAttribute('data-id')))
  }
}

function setEmptyState(){
  activeId=null;$('crumbTitle').textContent='No notes yet';$('crumbSub').innerHTML=''
  $('title').value='';$('body').value='';$('grade').value=''
  $('pTitle').textContent='Untitled';$('pMeta').innerHTML=''
  $('pBody').innerHTML='<div style="color:var(--muted);font-weight:800;font-size:13px;line-height:1.7;padding:8px 0">Create your first note using <span style="color:rgba(255,220,200,.92)">New Note</span>.</div>'
  hideLinkCards()
}

function setView(v){
  ['Editor','Preview','Graph','Games'].forEach(n=>$('view'+n).classList.toggle('active',v===n.toLowerCase()))
  $('modeEdit').classList.toggle('active',v==='editor')
  $('modePreview').classList.toggle('active',v==='preview')
  $('modeGraph').classList.toggle('active',v==='graph')
  if(v==='preview')updatePreview()
  if(v==='graph'){if(!gAnimRunning)drawGraph()}
  if(v!=='graph'){if(gAnim){cancelAnimationFrame(gAnim);gAnim=null;gAnimRunning=false}}
}

function setSplit(mode){
  splitMode=mode
  const split=$('split')
  split.classList.remove('singleEditor','singlePreview')
  $('divider').style.display='flex'
  $('paneRight').style.display='block'
  $('paneLeft').style.display='block'
  if(mode==='editor'){split.classList.add('singleEditor');$('paneRight').style.display='none';$('divider').style.display='none'}
  else if(mode==='preview'){split.classList.add('singlePreview');$('paneLeft').style.display='none';$('divider').style.display='none';setView('preview')}
  else applySplitSizes()
  $('toggleSplit').classList.toggle('active',mode==='split')
}

function applySplitSizes(){
  const a=clamp(splitSizes[0],20,80),b=100-a
  $('split').style.gridTemplateColumns=a+'% 12px '+b+'%'
}

async function createNote(){
  if(!user){toast('Not signed in','Please sign in','bad');return}
  const r=await supabase.from('notes').insert({user_id:user.id,title:'',content:'',grade:'',school:currentSchool}).select().single()
  if(r.error){toast('Create failed',r.error.message,'bad');return}
  notes.unshift({...r.data,linked_notes:[]})
  uiPrefs.lastOpenNoteId=r.data.id;saveSettingsDebounced();renderList();loadNote(r.data.id);toast('New note','Ready','ok')
}

function loadNote(id){
  const n=notes.find(x=>x.id===id)
  if(!n)return
  activeId=id;uiPrefs.lastOpenNoteId=id;saveSettingsDebounced()
  $('title').value=n.title||'';$('body').value=n.content||'';$('grade').value=n.grade||''
  const d=loadDraft()
  const serverMs=Date.parse(n.updated_at||n.created_at||0)||0
  if(d&&(d.ts||0)>serverMs+500){
    $('title').value=d.title??$('title').value
    $('body').value=d.content??$('body').value
    $('grade').value=d.grade??$('grade').value
    autosaveDirty=true;setStatus('editing');toast('Draft recovered','Unsaved changes restored','warn')
  }else{setStatus('saved')}
  updateCrumb();renderList();updatePreviewDebounced();refreshLinksUI()
}

function updateCrumb(){
  const n=notes.find(x=>x.id===activeId)
  $('crumbTitle').textContent=n?.title&&n.title.trim()?n.title:'Untitled'
  const chips=[]
  if(n?.grade)chips.push('<span class="chip">Grade '+esc(gradeLabels[n.grade]||n.grade)+'</span>')
  chips.push('<span class="chip">'+esc(currentSchool)+'</span>')
  if(n?.updated_at)chips.push('<span class="chip">'+esc(relTime(n.updated_at))+'</span>')
  $('crumbSub').innerHTML=chips.join('')
}

async function deleteNote(){
  if(!activeId)return
  const n=notes.find(x=>x.id===activeId)
  const t=n?.title&&n.title.trim()?n.title:'Untitled'
  if(!confirm('Delete "'+t+'"?'))return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  const r=await supabase.from('notes').delete().eq('id',activeId).eq('user_id',user.id)
  if(r.error){toast('Delete failed',r.error.message,'bad');return}
  clearDraft();notes=notes.filter(x=>x.id!==activeId);links=links.filter(l=>l.note_a!==activeId&&l.note_b!==activeId)
  rebuildLinkedOnClient();renderList();toast('Deleted',t,'warn')
  if(notes.length)loadNote(notes[0].id);else setEmptyState()
}

function updatePreviewDebounced(){clearTimeout(previewDT);previewDT=setTimeout(updatePreview,80)}

function updatePreview(){
  const n=notes.find(x=>x.id===activeId)
  const title=($('title').value||n?.title||'Untitled').trim()||'Untitled'
  $('pTitle').textContent=title
  const meta=[],g=$('grade').value||n?.grade||''
  if(g)meta.push('<span class="chip">Grade '+esc(gradeLabels[g]||g)+'</span>')
  meta.push('<span class="chip">'+esc(currentSchool)+'</span>')
  if(n?.updated_at)meta.push('<span class="chip">Updated '+esc(new Date(n.updated_at).toLocaleString())+'</span>')
  $('pMeta').innerHTML=meta.join('')
  const md=$('body').value||n?.content||''
  requestAnimationFrame(()=>{
    $('pBody').innerHTML=marked.parse(md)
    $('pBody').querySelectorAll('pre code').forEach(b=>{try{hljs.highlightElement(b)}catch(e){}})
    updatePreviewLinks()
  })
}

function updatePreviewLinks(){
  const n=notes.find(x=>x.id===activeId)
  const ids=n?.linked_notes||[]
  if(ids.length){
    $('pLinksCard').style.display='block'
    $('pLinks').innerHTML=ids.map(id=>{const ln=notes.find(x=>x.id===id);if(!ln)return '';const t=ln.title&&ln.title.trim()?ln.title:'Untitled';return '<div class="pillnote" data-open="'+id+'">'+esc(t)+'</div>'}).join('')
    $('pLinks').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>loadNote(p.getAttribute('data-open')))
  }else $('pLinksCard').style.display='none'
}

function getBacklinks(id){const res=[];notes.forEach(n=>{if(n.id!==id&&(n.linked_notes||[]).includes(id))res.push(n.id)});return res}

function getUnlinkedMentions(){
  const cur=notes.find(x=>x.id===activeId);if(!cur)return[]
  const content=($('body').value||'').toLowerCase(),linked=new Set(cur.linked_notes||[]),out=[]
  notes.forEach(o=>{if(o.id===activeId)return;const t=(o.title||'').trim();if(!t||t.length<4)return;if(linked.has(o.id))return;if(content.includes(t.toLowerCase()))out.push(o.id)})
  return out.slice(0,16)
}

function hideLinkCards(){$('cardLinks').style.display='none';$('cardBack').style.display='none';$('cardMentions').style.display='none';$('cardDrop').style.display='none'}

function refreshLinksUI(){
  const cur=notes.find(x=>x.id===activeId);if(!cur){hideLinkCards();return}
  const linked=cur.linked_notes||[]
  if(linked.length){
    $('cardLinks').style.display='block'
    $('linksPills').innerHTML=linked.map(id=>{const ln=notes.find(x=>x.id===id);if(!ln)return '';const t=ln.title&&ln.title.trim()?ln.title:'Untitled';return '<div class="pillnote" data-open="'+id+'" data-id="'+id+'">'+esc(t)+'<div class="x" data-x="'+id+'">√ó</div></div>'}).join('')
    $('linksPills').querySelectorAll('.pillnote').forEach(p=>{p.onclick=e=>{const xid=e.target?.getAttribute?.('data-x');if(xid){unlinkNote(xid);return}loadNote(p.getAttribute('data-open'))}})
  }else $('cardLinks').style.display='none'
  const bl=getBacklinks(activeId)
  if(bl.length){
    $('cardBack').style.display='block'
    $('backPills').innerHTML=bl.map(id=>{const ln=notes.find(x=>x.id===id);if(!ln)return '';const t=ln.title&&ln.title.trim()?ln.title:'Untitled';return '<div class="pillnote" data-open="'+id+'">'+esc(t)+'</div>'}).join('')
    $('backPills').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>loadNote(p.getAttribute('data-open')))
  }else $('cardBack').style.display='none'
  const men=getUnlinkedMentions()
  if(men.length){
    $('cardMentions').style.display='block'
    $('menPills').innerHTML=men.map(id=>{const ln=notes.find(x=>x.id===id);if(!ln)return '';const t=ln.title&&ln.title.trim()?ln.title:'Untitled';return '<div class="pillnote" data-link="'+id+'">'+esc(t)+'</div>'}).join('')
    $('menPills').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>linkNote(p.getAttribute('data-link')))
  }else $('cardMentions').style.display='none'
}

function showLinkDrop(list){
  $('cardDrop').style.display='block'
  const wrap=$('dropList')
  if(!list.length){wrap.innerHTML='<div style="padding:10px;color:var(--muted);font-weight:800;font-size:11px">No matches</div>';return}
  wrap.innerHTML=list.map(n=>{const t=n.title&&n.title.trim()?n.title:'Untitled';const g=n.grade?' ¬∑ '+gradeLabels[n.grade]:'';return '<div class="pillnote" style="width:100%;justify-content:space-between" data-pick="'+n.id+'"><span>'+esc(t)+'</span><span style="color:var(--muted2);font-size:10.5px">'+esc(g)+'</span></div>'}).join('')
  wrap.querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>linkNote(p.getAttribute('data-pick')))
}

function searchLinkCandidates(){
  if(!activeId)return
  const cur=notes.find(x=>x.id===activeId);if(!cur)return
  const q=($('linkSearch').value||'').trim().toLowerCase()
  if(!q){$('cardDrop').style.display='none';return}
  const already=new Set(cur.linked_notes||[])
  showLinkDrop(notes.filter(n=>n.id!==activeId&&!already.has(n.id)&&(n.title||'').toLowerCase().includes(q)).slice(0,8))
}

async function linkNote(lid){
  if(!activeId||!lid||activeId===lid)return
  const[a,b]=orderedPair(activeId,lid)
  const{error}=await supabase.from('note_links').upsert({user_id:user.id,note_a:a,note_b:b},{onConflict:'user_id,note_a,note_b'})
  if(error){toast('Link failed',error.message,'bad');return}
  $('linkSearch').value='';$('cardDrop').style.display='none'
  await fetchLinks();rebuildLinkedOnClient();refreshLinksUI();renderList();toast('Linked','Notes connected','ok')
}

async function unlinkNote(lid){
  if(!activeId||!lid)return
  const[a,b]=orderedPair(activeId,lid)
  const{error}=await supabase.from('note_links').delete().eq('user_id',user.id).eq('note_a',a).eq('note_b',b)
  if(error){toast('Unlink failed',error.message,'bad');return}
  await fetchLinks();rebuildLinkedOnClient();refreshLinksUI();renderList();toast('Unlinked','Connection removed','warn')
}

async function unlinkAll(){
  if(!activeId)return
  if(!confirm('Unlink all connections?'))return
  const{error}=await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  if(error){toast('Unlink failed',error.message,'bad');return}
  await fetchLinks();rebuildLinkedOnClient();refreshLinksUI();renderList();toast('Unlinked','All connections removed','warn')
}

async function linkAllMentions(){const ids=getUnlinkedMentions();for(const id of ids)await linkNote(id)}

function applyMd(action){
  const ta=$('body'),start=ta.selectionStart,end=ta.selectionEnd,sel=ta.value.slice(start,end)
  const before=ta.value.slice(0,start),after=ta.value.slice(end)
  let rep=''
  if(action==='bold')rep='**'+(sel||'bold')+'**'
  else if(action==='italic')rep='*'+(sel||'italic')+'*'
  else if(action==='h1')rep='# '+(sel||'Heading')
  else if(action==='h2')rep='## '+(sel||'Heading')
  else if(action==='ul')rep='- '+(sel||'Item')
  else if(action==='ol')rep='1. '+(sel||'Item')
  else if(action==='quote')rep='> '+(sel||'Quote')
  else if(action==='code')rep='```\n'+(sel||'code')+'\n```'
  else if(action==='link')rep='['+(sel||'text')+'](https://)'
  ta.value=before+rep+after
  const pos=before.length+rep.length
  ta.setSelectionRange(pos,pos);ta.focus();autosave();updatePreviewDebounced();refreshLinksUI()
}

function openPdfModal(){$('modalPdf').style.display='flex'}
function closePdfModal(){$('modalPdf').style.display='none'}

async function exportPdf(){
  if(!activeId)return
  const n=notes.find(x=>x.id===activeId);if(!n)return
  const inclLinks=$('pdfIncludeLinks').value==='1',inclDates=$('pdfIncludeDates').value==='1'
  const wrap=document.createElement('div')
  wrap.style.cssText='width:820px;padding:34px;background:#fff;color:#111;font-family:Inter,Arial,sans-serif;line-height:1.7'
  const h=document.createElement('div')
  h.style.cssText='font-size:32px;font-weight:900;margin-bottom:10px'
  h.textContent=n.title&&n.title.trim()?n.title:'Untitled'
  wrap.appendChild(h)
  const meta=document.createElement('div')
  meta.style.cssText='display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px'
  const chip=txt=>{const s=document.createElement('span');s.textContent=txt;s.style.cssText='font-size:11px;font-weight:800;padding:5px 10px;border-radius:999px;border:1px solid #e0e0e0;background:#f6f6f6';return s}
  if(n.grade)meta.appendChild(chip('Grade: '+(gradeLabels[n.grade]||n.grade)))
  meta.appendChild(chip('School: '+(n.school||currentSchool)))
  if(inclDates&&n.created_at)meta.appendChild(chip('Created: '+new Date(n.created_at).toLocaleDateString()))
  if(inclDates&&n.updated_at)meta.appendChild(chip('Updated: '+new Date(n.updated_at).toLocaleString()))
  wrap.appendChild(meta)
  const body=document.createElement('div')
  body.innerHTML=marked.parse(n.content||'')
  body.querySelectorAll('pre').forEach(p=>p.style.cssText='background:#0f1117;color:#f5f5f5;padding:14px;border-radius:10px;overflow:auto;margin:12px 0')
  body.querySelectorAll('code').forEach(c=>c.style.cssText='font-family:JetBrains Mono,Consolas,monospace;font-size:12px')
  wrap.appendChild(body)
  if(inclLinks&&(n.linked_notes||[]).length){
    const tt=document.createElement('div')
    tt.style.cssText='margin-top:20px;font-weight:900;font-size:15px'
    tt.textContent='Linked Notes';wrap.appendChild(tt)
    const ul=document.createElement('ul');ul.style.cssText='margin-top:8px;padding-left:18px'
    ;(n.linked_notes||[]).forEach(id=>{const ln=notes.find(x=>x.id===id);if(!ln)return;const li=document.createElement('li');li.textContent=ln.title&&ln.title.trim()?ln.title:'Untitled';li.style.cssText='font-weight:700;margin:5px 0';ul.appendChild(li)})
    wrap.appendChild(ul)
  }
  const{jsPDF}=window.jspdf
  const doc=new jsPDF('p','pt','a4')
  toast('Exporting','Rendering PDF‚Ä¶','warn')
  try{
    await doc.html(wrap,{x:24,y:24,width:547,windowWidth:820,html2canvas:{scale:1.35,backgroundColor:'#fff',useCORS:true}})
    doc.save(((n.title&&n.title.trim()?n.title:'note')+'.pdf').replace(/[\/\\:*?"<>|]+/g,'_'))
    closePdfModal();toast('Exported','PDF saved','ok')
  }catch(e){console.error(e);toast('PDF failed','Try reloading the page','bad')}
}

function openSettings(){$('modalSettings').style.display='flex'}
function closeSettings(){$('modalSettings').style.display='none'}

function saveSettingsFromModal(){
  uiPrefs.sidebarHidden=$('setSidebar').value==='1'
  uiPrefs.previewFull=$('setPreviewFull').value==='1'
  uiPrefs.theme=$('setTheme').value||'dark'
  document.body.classList.toggle('skyTheme',uiPrefs.theme==='sky')
  timerPresets.focus=clamp(parseInt($('setFocus').value||25,10),1,180)
  timerPresets.break=clamp(parseInt($('setBreak').value||5,10),1,60)
  timerPresets.long=clamp(parseInt($('setLong').value||15,10),1,120)
  nerdPrefs.musicMode=$('musicMode').value
  nerdPrefs.sfxMode=$('sfxMode').value
  if(uiPrefs.previewFull)document.body.classList.add('previewFull')
  else document.body.classList.remove('previewFull')
  applyMusicMode();syncCheatUI();updateTimerDisplay();saveSettingsDebounced();closeSettings();toast('Saved','Settings synced','ok')
}

function toggleFullPreview(){
  uiPrefs.previewFull=!uiPrefs.previewFull
  if(uiPrefs.previewFull)document.body.classList.add('previewFull')
  else document.body.classList.remove('previewFull')
  saveSettingsDebounced()
}

let palItems=[], palSel=0
function openPalette(){$('paletteBack').style.display='flex';$('paletteQ').value='';renderPalette('');setTimeout(()=>$('paletteQ').focus(),0)}
function closePalette(){$('paletteBack').style.display='none'}

function renderPalette(q){
  const query=(q||'').toLowerCase().trim()
  const items=[]
  const add=(ico,a,b,k,fn)=>items.push({ico,a,b,k,fn})
  add('‚úè','New note','Create a new note','Enter',()=>createNote())
  add('üìù','Edit','Go to editor','Enter',()=>setView('editor'))
  add('üëÅ','Preview','Go to preview','Enter',()=>setView('preview'))
  add('üï∏','Graph','Open graph view','Enter',()=>setView('graph'))
  add('üéÆ','Games','Open break games','Enter',()=>setView('games'))
  add('‚õ∂','Toggle full preview','Full-screen preview','Enter',()=>toggleFullPreview())
  add('üìÑ','Export PDF','Export current note','Enter',()=>openPdfModal())
  add('‚öô','Settings','Open settings','Enter',()=>openSettings())
  if(activeId)add('üíæ','Save now','Force save','Ctrl+S',()=>saveNote(false))
  const noteHits=notes.filter(n=>{if(!query)return false;const tl=(n.title||'').toLowerCase(),bl=(n.content||'').toLowerCase();return tl.includes(query)||bl.includes(query)}).slice(0,10)
  noteHits.forEach(n=>add('üìå',n.title&&n.title.trim()?n.title:'Untitled','Open note','Enter',()=>loadNote(n.id)))
  palItems=items.filter(it=>{if(!query)return true;return it.a.toLowerCase().includes(query)||it.b.toLowerCase().includes(query)})
  palSel=0
  renderPaletteItems()
}

function renderPaletteItems(){
  const list=$('paletteList')
  list.innerHTML=palItems.map((it,i)=>'<div class="pItem'+(i===palSel?' pal-selected':'')+'" data-i="'+i+'"><div class="l"><div class="pIco">'+it.ico+'</div><div class="pTxt"><div class="pA">'+esc(it.a)+'</div><div class="pB">'+esc(it.b)+'</div></div></div><div class="pK">'+esc(it.k)+'</div></div>').join('')
  list.querySelectorAll('.pItem').forEach(row=>{row.onclick=()=>{const idx=parseInt(row.getAttribute('data-i'),10);closePalette();palItems[idx]?.fn()}})
}

function movePalSel(dir){
  if(!palItems.length)return
  palSel=((palSel+dir)+palItems.length)%palItems.length
  renderPaletteItems()
  const sel=$('paletteList').querySelector('.pal-selected')
  if(sel)sel.scrollIntoView({block:'nearest'})
}

function setTimer(min){pauseTimer();timeLeft=min*60;updateTimerDisplay()}
function updateTimerDisplay(){const m=Math.floor(timeLeft/60).toString().padStart(2,'0');$('timerText').textContent=m+':'+(timeLeft%60).toString().padStart(2,'0')}
function startTimer(){if(timerInterval)return;timerInterval=setInterval(()=>{if(timeLeft>0){timeLeft--;updateTimerDisplay()}else{pauseTimer();toast('Timer',"Time's up",'ok');try{sfx.unlock();sfx.tone(880,0.08,0.12)}catch(e){}}},1000)}
function pauseTimer(){clearInterval(timerInterval);timerInterval=null}
function resetTimer(){pauseTimer();setTimer(timerPresets.focus||25)}

function openMobileSidebar(){$('sidebar').classList.add('open');$('backdrop').classList.add('show');document.body.classList.add('sidebar-open')}
function closeMobileSidebar(){$('sidebar').classList.remove('open');$('backdrop').classList.remove('show');document.body.classList.remove('sidebar-open')}
function maybeMobileUI(){const isMobile=window.innerWidth<=900;$('mobileMenu').style.display=isMobile?'flex':'none'}

function initSplitResize(){
  const div=$('divider')
  div.addEventListener('dblclick',()=>{splitSizes=[50,50];applySplitSizes();uiPrefs.splitSizes=[50,50];saveSettingsDebounced()})
  div.addEventListener('mousedown',e=>{draggingDivider=true;document.body.style.cursor='col-resize';e.preventDefault()})
  window.addEventListener('mouseup',()=>{if(!draggingDivider)return;draggingDivider=false;document.body.style.cursor='';uiPrefs.splitSizes=[...splitSizes];saveSettingsDebounced()})
  window.addEventListener('mousemove',e=>{
    if(!draggingDivider)return
    const split=$('split'),rect=split.getBoundingClientRect()
    const pct=clamp(((e.clientX-rect.left)/rect.width)*100,20,80)
    splitSizes=[pct,100-pct];applySplitSizes()
  })
}

let graphCanvas=null,graphCtx=null,graphNodes=[],graphEdges=[],graphPhysics=true
let gView={x:0,y:0,scale:1},gPan=false,gPanStart=null,gDragNode=null,gAnim=null,gAnimRunning=false

function initGraph(){
  graphCanvas=$('graph');graphCtx=graphCanvas.getContext('2d')
  resizeGraph();window.addEventListener('resize',()=>{resizeGraph();renderGraph()})
  graphCanvas.addEventListener('mousedown',gDown)
  graphCanvas.addEventListener('mousemove',gMove)
  graphCanvas.addEventListener('mouseup',gUp)
  graphCanvas.addEventListener('wheel',gWheel,{passive:false})
}

function resizeGraph(){
  const r=graphCanvas.getBoundingClientRect()
  graphCanvas.width=Math.floor(r.width*devicePixelRatio)
  graphCanvas.height=Math.floor(r.height*devicePixelRatio)
  graphCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0)
}

function buildGraph(){
  const W=graphCanvas.getBoundingClientRect().width,H=graphCanvas.getBoundingClientRect().height,N=notes.length||1
  graphNodes=notes.map((n,i)=>{const a=(i/N)*Math.PI*2,rad=Math.min(W,H)*0.25;return{id:n.id,label:n.title&&n.title.trim()?n.title:'Untitled',x:Math.cos(a)*rad,y:Math.sin(a)*rad,vx:0,vy:0,hue:(i*37)%360}})
  graphEdges=links.map(l=>({a:l.note_a,b:l.note_b}))
  gView={x:0,y:0,scale:1}
}

function screenToWorld(sx,sy){const r=graphCanvas.getBoundingClientRect(),cx=r.width/2,cy=r.height/2;return{x:(sx-cx-gView.x)/gView.scale,y:(sy-cy-gView.y)/gView.scale}}
function hitNode(wx,wy){for(const n of graphNodes){const dx=n.x-wx,dy=n.y-wy;if(Math.sqrt(dx*dx+dy*dy)<22)return n}return null}

function renderGraph(){
  const r=graphCanvas.getBoundingClientRect(),W=r.width,H=r.height
  graphCtx.clearRect(0,0,W,H)
  graphCtx.save()
  graphCtx.translate(W/2+gView.x,H/2+gView.y)
  graphCtx.scale(gView.scale,gView.scale)
  graphCtx.lineWidth=2/gView.scale
  graphEdges.forEach(e=>{
    const a=graphNodes.find(n=>n.id===e.a),b=graphNodes.find(n=>n.id===e.b)
    if(!a||!b)return
    graphCtx.strokeStyle='rgba(255,106,0,.16)';graphCtx.beginPath();graphCtx.moveTo(a.x,a.y);graphCtx.lineTo(b.x,b.y);graphCtx.stroke()
  })
  graphNodes.forEach(n=>{
    const isActive=n.id===activeId,isLinked=graphEdges.some(e=>(e.a===activeId&&e.b===n.id)||(e.b===activeId&&e.a===n.id))
    graphCtx.fillStyle=isActive?'#ff6a00':(isLinked?'#22c55e':'hsla('+n.hue+',92%,60%,0.20)')
    graphCtx.beginPath();graphCtx.arc(n.x,n.y,22,0,Math.PI*2);graphCtx.fill()
    graphCtx.lineWidth=2/gView.scale;graphCtx.strokeStyle='rgba(0,0,0,.35)';graphCtx.stroke()
    if(isActive||isLinked){
      graphCtx.shadowBlur=22/gView.scale;graphCtx.shadowColor=isActive?'rgba(255,106,0,.52)':'rgba(34,197,94,.42)'
      graphCtx.beginPath();graphCtx.arc(n.x,n.y,22,0,Math.PI*2);graphCtx.strokeStyle='rgba(255,255,255,.20)';graphCtx.stroke()
      graphCtx.shadowBlur=0
    }
    graphCtx.fillStyle='rgba(238,242,255,.90)';graphCtx.font='bold '+(12/gView.scale)+'px Inter';graphCtx.textAlign='center'
    const label=n.label.length>18?n.label.slice(0,18)+'‚Ä¶':n.label
    graphCtx.fillText(label,n.x,n.y+44/gView.scale)
  })
  graphCtx.restore()
}

function stepGraph(){
  if(!graphPhysics){renderGraph();gAnim=requestAnimationFrame(stepGraph);return}
  const nodes=graphNodes,edges=graphEdges
  for(const n of nodes){
    let fx=0,fy=0
    for(const o of nodes){if(o===n)continue;const dx=n.x-o.x,dy=n.y-o.y,d=Math.sqrt(dx*dx+dy*dy)||1,f=1150/(d*d);fx+=(dx/d)*f;fy+=(dy/d)*f}
    for(const e of edges){if(e.a!==n.id&&e.b!==n.id)continue;const oid=e.a===n.id?e.b:e.a;const o=nodes.find(x=>x.id===oid);if(!o)continue;fx+=(o.x-n.x)*0.012;fy+=(o.y-n.y)*0.012}
    n.vx=(n.vx+fx)*0.88;n.vy=(n.vy+fy)*0.88
  }
  for(const n of nodes){n.x+=n.vx;n.y+=n.vy}
  renderGraph();gAnim=requestAnimationFrame(stepGraph)
}

function drawGraph(){if(!graphCanvas)return;buildGraph();renderGraph();if(gAnim)cancelAnimationFrame(gAnim);gAnimRunning=true;gAnim=requestAnimationFrame(stepGraph)}

function gDown(e){
  const rect=graphCanvas.getBoundingClientRect(),sx=e.clientX-rect.left,sy=e.clientY-rect.top,w=screenToWorld(sx,sy),node=hitNode(w.x,w.y)
  if(node){gDragNode=node;graphPhysics=false;return}
  gPan=true;gPanStart={sx,sy,ox:gView.x,oy:gView.y}
}
function gMove(e){
  const rect=graphCanvas.getBoundingClientRect(),sx=e.clientX-rect.left,sy=e.clientY-rect.top
  if(gDragNode){const w=screenToWorld(sx,sy);gDragNode.x=w.x;gDragNode.y=w.y;renderGraph();return}
  if(gPan&&gPanStart){gView.x=gPanStart.ox+(sx-gPanStart.sx);gView.y=gPanStart.oy+(sy-gPanStart.sy);renderGraph()}
}
function gUp(e){
  const rect=graphCanvas.getBoundingClientRect(),sx=e.clientX-rect.left,sy=e.clientY-rect.top
  if(gDragNode){const w=screenToWorld(sx,sy);const id=gDragNode.id;gDragNode=null;graphPhysics=true;renderGraph();const cn=hitNode(w.x,w.y);if(cn&&cn.id===id){loadNote(id);setView('editor')};return}
  gPan=false;gPanStart=null
}
function gWheel(e){
  e.preventDefault()
  const rect=graphCanvas.getBoundingClientRect(),sx=e.clientX-rect.left,sy=e.clientY-rect.top
  const before=screenToWorld(sx,sy),f=Math.sign(e.deltaY)>0?0.92:1.08
  gView.scale=clamp(gView.scale*f,0.45,2.8)
  const after=screenToWorld(sx,sy)
  gView.x+=(after.x-before.x)*gView.scale;gView.y+=(after.y-before.y)*gView.scale;renderGraph()
}

// SNAKE
let snakeCanvas=null,snakeCtx=null,snake=[],sFood=null,sPoison=null,sObstacles=[],dir={x:0,y:0},snakeScore=0,snakeRunning=false,sAnim=0,sLast=0,sAccum=0,sBoostUntil=0,sFoodBorn=0
const S_TILE=21
function sKey(x,y){return x+','+y}
function sDistTorus(ax,ay,bx,by){const dx=Math.abs(ax-bx),dy=Math.abs(ay-by);return Math.min(dx,S_TILE-dx)+Math.min(dy,S_TILE-dy)}
function sDistPlain(ax,ay,bx,by){return Math.abs(ax-bx)+Math.abs(ay-by)}
function sWrapOn(){return !gameCheats.snake?.wallsKill}
function sIsOccupied(x,y){return snake.some(s=>s.x===x&&s.y===y)||sObstacles.some(o=>o.x===x&&o.y===y)||(sFood&&sFood.x===x&&sFood.y===y)||(sPoison&&sPoison.x===x&&sPoison.y===y)}
function sSpawnFood(){
  const head=snake[0],wrap=sWrapOn(),minD=clamp(parseInt(gameCheats.snake?.foodDist??9,10)||9,0,14)
  for(let i=0;i<1200;i++){const x=Math.floor(Math.random()*S_TILE),y=Math.floor(Math.random()*S_TILE);if(sIsOccupied(x,y))continue;const d=wrap?sDistTorus(x,y,head.x,head.y):sDistPlain(x,y,head.x,head.y);if(d<minD)continue;return{x,y}}
  for(let x=0;x<S_TILE;x++)for(let y=0;y<S_TILE;y++)if(!sIsOccupied(x,y))return{x,y}
  return{x:0,y:0}
}
function buildSnakeObstacles(){const count=clamp(parseInt(gameCheats.snake?.obstacles??28,10)||28,0,90);const set=new Set(snake.map(s=>sKey(s.x,s.y)));const obs=[];let tries=0;while(obs.length<count&&tries<6000){tries++;const x=Math.floor(Math.random()*S_TILE),y=Math.floor(Math.random()*S_TILE);if(set.has(sKey(x,y))||obs.some(o=>o.x===x&&o.y===y))continue;obs.push({x,y})};sObstacles=obs}
function sSpawnObstacle(){for(let i=0;i<900;i++){const x=Math.floor(Math.random()*S_TILE),y=Math.floor(Math.random()*S_TILE);if(!sIsOccupied(x,y))return{x,y}}return null}
function addSnakeObstacles(n){const base=clamp(parseInt(gameCheats.snake?.obstacles??28,10)||28,0,90);if(base<=0)return;const cap=clamp(base+Math.floor(snakeScore*0.8),0,220);for(let i=0;i<n&&sObstacles.length<cap;i++){const o=sSpawnObstacle();if(o)sObstacles.push(o)}}
function spawnSnakeFoods(){sFood=sSpawnFood();sFoodBorn=performance.now();sPoison=null;if(gameCheats.snake?.poison)sPoison=sSpawnFood()}
function snakeStepMs(){const base=clamp(parseInt(gameCheats.snake?.speed??70,10)||70,5,260);const scale=Math.max(0.08,Math.pow(0.965,snakeScore));let ms=base*scale;if(gameCheats.snake?.boost&&performance.now()<sBoostUntil)ms*=0.52;return clamp(ms,2,260)}
function maybeExpireFood(){if(!sFood)return;const ttl=clamp(3100-snakeScore*22,950,3100);if(performance.now()-sFoodBorn>ttl){if(snake.length>1)snake.pop();spawnSnakeFoods();addSnakeObstacles(1);sfx.unlock();sfx.tone(210,0.04,0.08)}}
function moveFoodEvasive(){if(!sFood||!gameCheats.snake?.evasive)return;const head=snake[0],wrap=sWrapOn(),d=wrap?sDistTorus(sFood.x,sFood.y,head.x,head.y):sDistPlain(sFood.x,sFood.y,head.x,head.y);if(d>4||Math.random()>0.72)return;const opts=[{x:sFood.x+1,y:sFood.y},{x:sFood.x-1,y:sFood.y},{x:sFood.x,y:sFood.y+1},{x:sFood.x,y:sFood.y-1}];const cand=[];for(const o of opts){let x=o.x,y=o.y;if(wrap){x=(x+S_TILE)%S_TILE;y=(y+S_TILE)%S_TILE}else if(x<0||x>=S_TILE||y<0||y>=S_TILE)continue;if(sIsOccupied(x,y))continue;const nd=wrap?sDistTorus(x,y,head.x,head.y):sDistPlain(x,y,head.x,head.y);cand.push({x,y,nd})};cand.sort((a,b)=>b.nd-a.nd);if(cand.length){sFood.x=cand[0].x;sFood.y=cand[0].y;sFoodBorn=performance.now()}}
function movePoisonHunt(){if(!sPoison)return;const head=snake[0],wrap=sWrapOn(),d=wrap?sDistTorus(sPoison.x,sPoison.y,head.x,head.y):sDistPlain(sPoison.x,sPoison.y,head.x,head.y);if(d>8||Math.random()>0.45)return;const opts=[{x:sPoison.x+1,y:sPoison.y},{x:sPoison.x-1,y:sPoison.y},{x:sPoison.x,y:sPoison.y+1},{x:sPoison.x,y:sPoison.y-1}];const cand=[];for(const o of opts){let x=o.x,y=o.y;if(wrap){x=(x+S_TILE)%S_TILE;y=(y+S_TILE)%S_TILE}else if(x<0||x>=S_TILE||y<0||y>=S_TILE)continue;if(snake.some(s=>s.x===x&&s.y===y)||sObstacles.some(ob=>ob.x===x&&ob.y===y)||(sFood&&sFood.x===x&&sFood.y===y))continue;const nd=wrap?sDistTorus(x,y,head.x,head.y):sDistPlain(x,y,head.x,head.y);cand.push({x,y,nd})};cand.sort((a,b)=>a.nd-b.nd);if(cand.length){sPoison.x=cand[0].x;sPoison.y=cand[0].y}}
function resetSnake(){stopSnake();snake=[{x:10,y:10}];dir={x:0,y:0};snakeScore=0;buildSnakeObstacles();spawnSnakeFoods();$('snakeScore').textContent='0';drawSnake()}
function startSnake(){stopSnake();resetSnake();snakeRunning=true;dir={x:1,y:0};sLast=0;sAccum=0;sBoostUntil=0;sAnim=requestAnimationFrame(sLoop)}
function stopSnake(){snakeRunning=false;if(sAnim)cancelAnimationFrame(sAnim);sAnim=0}
function stepSnake(){
  if(!snakeRunning)return
  const wrap=sWrapOn(),noDie=!!gameCheats.snake?.noDie,head0=snake[0]
  let hx=head0.x+dir.x,hy=head0.y+dir.y
  let hitWall=!wrap&&(hx<0||hx>=S_TILE||hy<0||hy>=S_TILE)
  if(hitWall){if(noDie){hx=(hx+S_TILE)%S_TILE;hy=(hy+S_TILE)%S_TILE;sfx.unlock();sfx.tone(240,0.04,0.08)}else{gameOverSnake();return}}
  else if(wrap){hx=(hx+S_TILE)%S_TILE;hy=(hy+S_TILE)%S_TILE}
  const hitSelf=snake.some(s=>s.x===hx&&s.y===hy),hitObs=sObstacles.some(o=>o.x===hx&&o.y===hy),hitPoison=sPoison&&sPoison.x===hx&&sPoison.y===hy
  if(!noDie&&(hitSelf||hitObs||hitPoison)){gameOverSnake();return}
  if(noDie&&(hitSelf||hitObs||hitPoison))sfx.unlock(),sfx.tone(hitPoison?160:220,0.04,0.08)
  snake.unshift({x:hx,y:hy})
  if(sFood&&hx===sFood.x&&hy===sFood.y){
    snakeScore++;$('snakeScore').textContent=String(snakeScore);sfx.unlock();sfx.tone(740,0.05,0.12)
    if(snakeScore>(gameCheats.snake?.highScore||0)){gameCheats.snake.highScore=snakeScore;$('snakeBest').textContent=String(snakeScore);saveSettingsDebounced()}
    addSnakeObstacles(1+Math.floor(snakeScore/6));spawnSnakeFoods()
  }else snake.pop()
  moveFoodEvasive();movePoisonHunt()
}
function sLoop(t){
  if(!snakeRunning)return
  if(!sLast)sLast=t
  const dt=t-sLast;sLast=t;sAccum+=dt;maybeExpireFood()
  const step=snakeStepMs();let steps=0
  while(sAccum>=step&&steps<24){stepSnake();sAccum-=step;steps++;if(!snakeRunning)break}
  drawSnake();if(snakeRunning)sAnim=requestAnimationFrame(sLoop)
}
function drawSnake(){
  const W=snakeCanvas.width,H=snakeCanvas.height,gs=W/S_TILE
  snakeCtx.fillStyle='#050505';snakeCtx.fillRect(0,0,W,H)
  snakeCtx.strokeStyle='rgba(255,106,0,0.06)';snakeCtx.lineWidth=0.5
  for(let i=0;i<=S_TILE;i++){snakeCtx.beginPath();snakeCtx.moveTo(i*gs,0);snakeCtx.lineTo(i*gs,H);snakeCtx.stroke();snakeCtx.beginPath();snakeCtx.moveTo(0,i*gs);snakeCtx.lineTo(W,i*gs);snakeCtx.stroke()}
  sObstacles.forEach(o=>{snakeCtx.fillStyle='rgba(255,59,59,0.60)';snakeCtx.fillRect(o.x*gs+1,o.y*gs+1,gs-2,gs-2)})
  if(sPoison){snakeCtx.fillStyle='rgba(255,59,59,0.90)';snakeCtx.beginPath();snakeCtx.arc(sPoison.x*gs+gs/2,sPoison.y*gs+gs/2,gs/2-4,0,Math.PI*2);snakeCtx.fill()}
  if(sFood){snakeCtx.fillStyle='#ffb100';snakeCtx.beginPath();snakeCtx.arc(sFood.x*gs+gs/2,sFood.y*gs+gs/2,gs/2-3,0,Math.PI*2);snakeCtx.fill()}
  snake.forEach((seg,idx)=>{snakeCtx.fillStyle=idx===0?'#ff6a00':'rgba(255,177,0,'+(0.65-(idx/snake.length)*0.40)+')';snakeCtx.fillRect(seg.x*gs+1,seg.y*gs+1,gs-2,gs-2)})
}
function gameOverSnake(){stopSnake();drawSnake();sfx.unlock();sfx.tone(180,0.10,0.12);const W=snakeCanvas.width,H=snakeCanvas.height;snakeCtx.fillStyle='rgba(0,0,0,.75)';snakeCtx.fillRect(0,0,W,H);snakeCtx.fillStyle='#ff6a00';snakeCtx.font='900 28px Inter';snakeCtx.textAlign='center';snakeCtx.fillText('GAME OVER',W/2,H/2-10);snakeCtx.fillStyle='#ffb100';snakeCtx.font='900 16px Inter';snakeCtx.fillText('Score: '+snakeScore,W/2,H/2+18)}

// TETRIS
let tetrisCanvas=null,tetrisCtx=null,tBoard=null,tPiece=null,tScore=0,tLines=0,tLevel=1,tRunning=false,tDrop=0,tLast=0
const TC=12,TR=24,TS=20
const T_COLORS=[null,'#ff6a00','#ffb100','#ff7e2b','#ff3b3b','#ff9a00','#ffcc00','#ff5500']
const T_SHAPES=[null,[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]]
function resetTetris(){tBoard=Array.from({length:TR},()=>Array(TC).fill(0));tScore=0;tLines=0;tLevel=Math.max(1,gameCheats.tetris?.startLevel??1);$('tScore').textContent='0';$('tLines').textContent='0';$('tLevel').textContent=String(tLevel);$('tBest').textContent=String(gameCheats.tetris?.highScore||0);tPiece=makePiece();drawTetris()}
function makePiece(){const t=Math.floor(Math.random()*7)+1,s=T_SHAPES[t];return{type:t,shape:s.map(r=>[...r]),x:Math.floor(TC/2)-Math.floor(s[0].length/2),y:0}}
function tCollide(){for(let r=0;r<tPiece.shape.length;r++)for(let c=0;c<tPiece.shape[r].length;c++){if(!tPiece.shape[r][c])continue;const nx=tPiece.x+c,ny=tPiece.y+r;if(nx<0||nx>=TC||ny>=TR)return true;if(ny>=0&&tBoard[ny][nx])return true}return false}
function tMove(dx,dy){tPiece.x+=dx;tPiece.y+=dy;if(tCollide()){tPiece.x-=dx;tPiece.y-=dy;if(dy>0)tLock()}else if(dx!==0){sfx.unlock();sfx.tone(420,0.02,0.06)}}
function tRotate(){const orig=tPiece.shape;tPiece.shape=tPiece.shape[0].map((_,ci)=>tPiece.shape.map(row=>row[ci]).reverse());if(tCollide())tPiece.shape=orig;else{sfx.unlock();sfx.tone(520,0.03,0.07)}}
function tHardDrop(){while(!tCollide())tPiece.y++;tPiece.y--;tLock()}
function tLock(){for(let r=0;r<tPiece.shape.length;r++)for(let c=0;c<tPiece.shape[r].length;c++){if(!tPiece.shape[r][c])continue;const ny=tPiece.y+r;if(ny<0){if(gameCheats.tetris?.noGameOver){resetTetris();tRunning=true;requestAnimationFrame(tLoop);return}tGameOver();return}tBoard[ny][tPiece.x+c]=tPiece.type}clearLines();tPiece=makePiece();if(tCollide()){if(gameCheats.tetris?.noGameOver){resetTetris();tRunning=true;requestAnimationFrame(tLoop);return}tGameOver()}}
function clearLines(){let cleared=0;for(let r=TR-1;r>=0;r--){if(tBoard[r].every(v=>v!==0)){tBoard.splice(r,1);tBoard.unshift(Array(TC).fill(0));cleared++;r++}}if(cleared){tScore+=[0,100,300,500,800][cleared]*tLevel;tLines+=cleared;tLevel=Math.max(tLevel,Math.floor(tLines/10)+1);$('tScore').textContent=String(tScore);$('tLines').textContent=String(tLines);$('tLevel').textContent=String(tLevel);sfx.unlock();sfx.tone(720,0.06,0.10);if(tScore>(gameCheats.tetris?.highScore||0)){gameCheats.tetris.highScore=tScore;$('tBest').textContent=String(tScore);saveSettingsDebounced()}}}
function drawCell(c,r,col){const x=c*TS,y=r*TS;tetrisCtx.fillStyle=col;tetrisCtx.fillRect(x+1,y+1,TS-2,TS-2);tetrisCtx.fillStyle='rgba(255,255,255,.12)';tetrisCtx.fillRect(x+2,y+2,TS-6,3)}
function drawTetris(){const W=tetrisCanvas.width,H=tetrisCanvas.height;tetrisCtx.fillStyle='#050505';tetrisCtx.fillRect(0,0,W,H);tetrisCtx.strokeStyle='rgba(255,106,0,0.06)';tetrisCtx.lineWidth=0.5;for(let r=0;r<=TR;r++){tetrisCtx.beginPath();tetrisCtx.moveTo(0,r*TS);tetrisCtx.lineTo(W,r*TS);tetrisCtx.stroke()}for(let c=0;c<=TC;c++){tetrisCtx.beginPath();tetrisCtx.moveTo(c*TS,0);tetrisCtx.lineTo(c*TS,H);tetrisCtx.stroke()}for(let r=0;r<TR;r++)for(let c=0;c<TC;c++)if(tBoard[r][c])drawCell(c,r,T_COLORS[tBoard[r][c]]);if(!tPiece)return;for(let r=0;r<tPiece.shape.length;r++)for(let c=0;c<tPiece.shape[r].length;c++)if(tPiece.shape[r][c])drawCell(tPiece.x+c,tPiece.y+r,T_COLORS[tPiece.type])}
function startTetris(){stopTetris();resetTetris();tRunning=true;tDrop=0;tLast=0;requestAnimationFrame(tLoop)}
function stopTetris(){tRunning=false}
function tLoop(time=0){if(!tRunning)return;const dt=time-tLast;tLast=time;tDrop+=dt;const speed=Math.max(85,700-(tLevel-1)*60);if(tDrop>=speed){tMove(0,1);tDrop=0}drawTetris();requestAnimationFrame(tLoop)}
function tGameOver(){tRunning=false;drawTetris();sfx.unlock();sfx.tone(140,0.12,0.12);const W=tetrisCanvas.width,H=tetrisCanvas.height;tetrisCtx.fillStyle='rgba(0,0,0,.75)';tetrisCtx.fillRect(0,0,W,H);tetrisCtx.fillStyle='#ff6a00';tetrisCtx.font='900 22px Inter';tetrisCtx.textAlign='center';tetrisCtx.fillText('GAME OVER',W/2,H/2-12);tetrisCtx.fillStyle='#ffb100';tetrisCtx.font='900 14px Inter';tetrisCtx.fillText('Score: '+tScore,W/2,H/2+14)}

// RUNNER
let runnerCanvas=null,runnerCtx=null,rRunning=false,rAnim=0,rLast=0,rDist=0,rSpeed=220
let rPlayer={x:70,y:0,v:0,ground:210,rad:16,canDash:true,dashing:false},rObstacles=[],rSpawn=0
function resetRunner(){rRunning=false;cancelAnimationFrame(rAnim);rLast=0;rDist=0;rSpeed=220;rPlayer={x:70,y:210,v:0,ground:210,rad:16,canDash:true,dashing:false};rObstacles=[];rSpawn=0;$('rDist').textContent='0';drawRunner(0)}
function startRunner(){resetRunner();rRunning=true;rLast=0;rAnim=requestAnimationFrame(rLoop)}
function stopRunner(){rRunning=false;cancelAnimationFrame(rAnim)}
function rLoop(t){
  if(!rRunning)return
  if(!rLast)rLast=t
  const dt=(t-rLast)/1000;rLast=t
  const speed=gameCheats.runner?.slow?rSpeed*0.72:rSpeed
  rDist+=speed*dt;$('rDist').textContent=String(Math.floor(rDist/10))
  if(Math.floor(rDist/10)>(gameCheats.runner?.best||0)){gameCheats.runner.best=Math.floor(rDist/10);$('rBest').textContent=String(gameCheats.runner.best);saveSettingsDebounced()}
  rPlayer.v+=1200*dt;rPlayer.y+=rPlayer.v*dt
  if(rPlayer.y>rPlayer.ground){rPlayer.y=rPlayer.ground;rPlayer.v=0;rPlayer.canDash=true;rPlayer.dashing=false}
  rSpawn-=dt
  if(rSpawn<=0){const gap=clamp(1.05-(rDist/8000),0.48,1.05);rSpawn=gap;const h=18+Math.random()*26,w=14+Math.random()*22;rObstacles.push({x:runnerCanvas.width+40,y:rPlayer.ground-h,w,h})}
  rObstacles.forEach(o=>o.x-=speed*dt);rObstacles=rObstacles.filter(o=>o.x>-80)
  if(!gameCheats.runner?.noCrash){for(const o of rObstacles){const px=rPlayer.x,py=rPlayer.y,pr=rPlayer.rad,cx=clamp(px,o.x,o.x+o.w),cy=clamp(py,o.y,o.y+o.h),dx=px-cx,dy=py-cy;if(dx*dx+dy*dy<pr*pr){rGameOver();return}}}
  drawRunner(t);rAnim=requestAnimationFrame(rLoop)
}
function drawRunner(t){
  const W=runnerCanvas.width,H=runnerCanvas.height
  runnerCtx.fillStyle='#050505';runnerCtx.fillRect(0,0,W,H)
  const g=runnerCtx.createLinearGradient(0,0,0,H);g.addColorStop(0,'rgba(255,106,0,0.05)');g.addColorStop(1,'rgba(255,177,0,0.02)');runnerCtx.fillStyle=g;runnerCtx.fillRect(0,0,W,H)
  runnerCtx.strokeStyle='rgba(255,106,0,0.11)';runnerCtx.lineWidth=2;runnerCtx.beginPath();runnerCtx.moveTo(0,rPlayer.ground+18);runnerCtx.lineTo(W,rPlayer.ground+18);runnerCtx.stroke()
  for(let i=0;i<30;i++){const x=(i*97+Math.floor((t||0)/8))%W,y=(i*41)%140;runnerCtx.fillStyle='rgba(255,255,255,0.05)';runnerCtx.fillRect(x,y,2,2)}
  rObstacles.forEach(o=>{runnerCtx.fillStyle='rgba(255,177,0,0.83)';runnerCtx.fillRect(o.x,o.y,o.w,o.h)})
  runnerCtx.fillStyle=rPlayer.dashing?'rgba(34,197,94,0.93)':'rgba(255,106,0,0.93)';runnerCtx.beginPath();runnerCtx.arc(rPlayer.x,rPlayer.y,rPlayer.rad,0,Math.PI*2);runnerCtx.fill()
  runnerCtx.fillStyle='rgba(255,255,255,0.10)';runnerCtx.beginPath();runnerCtx.arc(rPlayer.x-5,rPlayer.y-6,5,0,Math.PI*2);runnerCtx.fill()
}
function rJump(){if(!rRunning)return;if(rPlayer.y>=rPlayer.ground-0.5){rPlayer.v=-520;sfx.unlock();sfx.tone(560,0.05,0.10)}}
function rDash(){if(!rRunning)return;if(rPlayer.canDash){rPlayer.canDash=false;rPlayer.dashing=true;rPlayer.v=-240;sfx.unlock();sfx.tone(900,0.03,0.10);setTimeout(()=>{rPlayer.dashing=false},180)}}
function rGameOver(){rRunning=false;sfx.unlock();sfx.tone(150,0.12,0.14);drawRunner(0);runnerCtx.fillStyle='rgba(0,0,0,.75)';runnerCtx.fillRect(0,0,runnerCanvas.width,runnerCanvas.height);runnerCtx.fillStyle='#ff6a00';runnerCtx.font='900 28px Inter';runnerCtx.textAlign='center';runnerCtx.fillText('CRASHED',runnerCanvas.width/2,runnerCanvas.height/2-8);runnerCtx.fillStyle='#ffb100';runnerCtx.font='900 14px Inter';runnerCtx.fillText('Distance: '+Math.floor(rDist/10),runnerCanvas.width/2,runnerCanvas.height/2+18)}

function switchGame(mode){
  const s=mode==='snake',t=mode==='tetris',r=mode==='runner'
  $('tabSnake').classList.toggle('active',s);$('tabTetris').classList.toggle('active',t);$('tabRunner').classList.toggle('active',r)
  $('snakeCanvas').style.display=s?'block':'none';$('tetrisCanvas').style.display=t?'block':'none';$('runnerCanvas').style.display=r?'block':'none'
  $('snakeScoreBox').style.display=s?'block':'none';$('tetrisScoreBox').style.display=t?'block':'none';$('runnerScoreBox').style.display=r?'block':'none'
  $('snakeCheats').style.display=s?'block':'none';$('tetrisCheats').style.display=t?'block':'none';$('runnerCheats').style.display=r?'block':'none'
  $('gTitle').textContent=s?'Snake Break':t?'Tetris Break':'Pulse Runner'
}

function syncCheatUI(){
  $('snakeBest').textContent=String(gameCheats.snake?.highScore||0)
  $('tBest').textContent=String(gameCheats.tetris?.highScore||0)
  $('rBest').textContent=String(gameCheats.runner?.best||0)
  $('cSnakeNoDie').checked=!!gameCheats.snake?.noDie
  const sp=clamp(parseInt(gameCheats.snake?.speed??70,10)||70,5,260)
  $('cSnakeSpeed').value=String(sp);$('cSnakeSpeedV').textContent=sp+'ms'
  $('cSnakeBoost').checked=!!gameCheats.snake?.boost;$('cSnakeWalls').checked=!!gameCheats.snake?.wallsKill
  const obs=clamp(parseInt(gameCheats.snake?.obstacles??28,10)||28,0,90)
  $('cSnakeObs').value=String(obs);$('cSnakeObsV').textContent=String(obs)
  $('cSnakeEvasive').checked=!!gameCheats.snake?.evasive;$('cSnakePoison').checked=!!gameCheats.snake?.poison
  const fd=clamp(parseInt(gameCheats.snake?.foodDist??9,10)||9,0,14)
  $('cSnakeFoodDist').value=String(fd);$('cSnakeFoodDistV').textContent=String(fd)
  $('cTNoOver').checked=!!gameCheats.tetris?.noGameOver;$('cTLevel').value=gameCheats.tetris?.startLevel??1
  $('cRNoCrash').checked=!!gameCheats.runner?.noCrash;$('cRSlow').checked=!!gameCheats.runner?.slow
}

function initGames(){
  snakeCanvas=$('snakeCanvas');snakeCtx=snakeCanvas.getContext('2d')
  tetrisCanvas=$('tetrisCanvas');tetrisCtx=tetrisCanvas.getContext('2d')
  runnerCanvas=$('runnerCanvas');runnerCtx=runnerCanvas.getContext('2d')
  resetSnake();resetTetris();resetRunner();syncCheatUI()
}

// AUDIO
const audio=new Audio();audio.loop=true;audio.preload='auto';audio.volume=0.35
const MUSIC_URLS={amb1:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/free%20jaydes%20%20pluggnb%20type%20beat%20self%20(1).mp3',amb2:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/jaydes%20%20convenience%20(fixed%20instrumental)%20(1).mp3',amb3:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/Kyle%20Richh%20x%20Sdot%20Go%20-%20Drive%20me%20crazyOblivious%20(official%20instrumental)%20(1).mp3',amb4:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/Me%20vs%20Me%20(Instrumental)%20-%20Jaeychino%20and%20SlimeGetEm%20(1).mp3',amb5:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/jaydes-who%20can%20i%20trust%20ft.rich%20amiri%20(instrumental).mp3',amb6:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/autumn!%20-%20one%20way%20(instrumental).mp3',amb7:'https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/ex.mp3'}
function applyMusicMode(){const mode=nerdPrefs.musicMode||'off';if(mode==='off'){audio.pause();audio.src='';return}const url=MUSIC_URLS[mode];if(!url)return;if(audio.src!==url)audio.src=url;if(document.visibilityState==='visible')audio.play().catch(()=>{})}
function tryQuickMute(){if(!audio.src||audio.paused)return;audio.pause();toast('Audio','Muted','warn')}

const sfx=(()=>{
  const ctx=new (window.AudioContext||window.webkitAudioContext)()
  const tone=(f=440,d=0.05,g=0.15)=>{if(nerdPrefs.sfxMode!=='on')return;const o=ctx.createOscillator(),a=ctx.createGain();o.type='sine';o.frequency.value=f;a.gain.value=g;o.connect(a);a.connect(ctx.destination);o.start();o.stop(ctx.currentTime+d)}
  return{ctx,tone,unlock:()=>{try{if(ctx.state!=='running')ctx.resume()}catch(e){}}}
})()

function initAuth(){
  let mode='signin'
  const setTabs=()=>{$('tabSignIn').classList.toggle('active',mode==='signin');$('tabSignUp').classList.toggle('active',mode==='signup');$('authGo').textContent=mode==='signin'?'Enter':'Create';$('authErr').textContent=''}
  $('tabSignIn').onclick=()=>{mode='signin';setTabs()}
  $('tabSignUp').onclick=()=>{mode='signup';setTabs()}
  $('authGo').onclick=async()=>{
    const email=$('authEmail').value.trim(),pass=$('authPass').value
    if(!email||!pass){$('authErr').textContent='Enter email + password';return}
    $('authErr').textContent=''
    try{
      if(mode==='signup'){const{error}=await supabase.auth.signUp({email,password:pass});if(error){$('authErr').textContent=error.message;return}toast('Check email','Confirm your account then sign in','ok')}
      else{const{error}=await supabase.auth.signInWithPassword({email,password:pass});if(error){$('authErr').textContent=error.message;return}}
    }catch(e){$('authErr').textContent='Auth failed'}
  }
  $('authMagic').onclick=async()=>{const email=$('authEmail').value.trim();if(!email){$('authErr').textContent='Enter email';return};const{error}=await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:location.href}});if(error){$('authErr').textContent=error.message;return};toast('Magic link sent','Check your email','ok')}
  $('authReset').onclick=async()=>{const email=$('authEmail').value.trim();if(!email){$('authErr').textContent='Enter email';return};const{error}=await supabase.auth.resetPasswordForEmail(email,{redirectTo:location.href});if(error){$('authErr').textContent=error.message;return};toast('Reset sent','Check your email','ok')}
  setTabs()
}

async function signOut(){tryQuickMute();await supabase.auth.signOut();location.reload()}

function wireUI(){
  $('btnNew').onclick=createNote
  $('saveNow').onclick=()=>saveNote(false)
  $('delNote').onclick=deleteNote
  $('modeEdit').onclick=()=>setView('editor')
  $('modePreview').onclick=()=>setView('preview')
  $('modeGraph').onclick=()=>setView('graph')
  $('toggleFull').onclick=toggleFullPreview
  $('toggleSplit').onclick=()=>{if(splitMode==='split')setSplit('editor');else setSplit('split')}
  $('doPdf').onclick=openPdfModal
  $('pdfClose').onclick=closePdfModal;$('pdfCancel').onclick=closePdfModal;$('pdfGo').onclick=exportPdf
  $('openSettings').onclick=openSettings;$('setClose').onclick=closeSettings;$('setCancel').onclick=closeSettings;$('setSave').onclick=saveSettingsFromModal
  $('search').oninput=renderList
  $('sort').onchange=()=>{uiPrefs.sort=$('sort').value;saveSettingsDebounced();renderList()}
  $('openPalette').onclick=openPalette
  $('paletteBack').onclick=e=>{if(e.target.id==='paletteBack')closePalette()}
  $('paletteQ').oninput=()=>renderPalette($('paletteQ').value)
  $('paletteQ').onkeydown=e=>{if(e.key==='Escape'){closePalette();return};if(e.key==='ArrowDown'){e.preventDefault();movePalSel(1)};if(e.key==='ArrowUp'){e.preventDefault();movePalSel(-1)};if(e.key==='Enter'){e.preventDefault();if(palItems[palSel]){closePalette();palItems[palSel].fn()}}}
  $('schoolSelect').onchange=()=>{currentSchool=$('schoolSelect').value;saveSettingsDebounced();autosave();updateCrumb();toast('School',currentSchool,'ok')}
  $('title').oninput=()=>{autosave();updatePreviewDebounced();updateCrumb();renderList()}
  $('body').oninput=()=>{autosave();updatePreviewDebounced();refreshLinksUI()}
  $('body').onblur=()=>{if(autosaveDirty)saveNote(true)}
  $('grade').onchange=()=>{autosave();updateCrumb();renderList();refreshLinksUI()}
  document.querySelectorAll('.tool').forEach(t=>t.onclick=()=>applyMd(t.getAttribute('data-md')))
  $('linkSearch').oninput=searchLinkCandidates
  $('closeDrop').onclick=()=>{$('cardDrop').style.display='none';$('linkSearch').value=''}
  $('unlinkAll').onclick=unlinkAll;$('jumpPreview').onclick=()=>setView('preview');$('jumpGraph').onclick=()=>setView('graph')
  $('linkAllMentions').onclick=linkAllMentions;$('backToEdit').onclick=()=>setView('editor')
  $('tStart').onclick=startTimer;$('tPause').onclick=pauseTimer;$('tReset').onclick=resetTimer
  $('mFocus').onclick=()=>setTimer(timerPresets.focus||25)
  $('mBreak').onclick=()=>setTimer(timerPresets.break||5)
  $('mLong').onclick=()=>setTimer(timerPresets.long||15)
  $('mBreakGame').onclick=()=>{setTimer(timerPresets.break||5);setView('games')}
  $('btnGames').onclick=()=>setView('games')
  $('tabSnake').onclick=()=>{switchGame('snake');resetSnake()}
  $('tabTetris').onclick=()=>{switchGame('tetris');resetTetris()}
  $('tabRunner').onclick=()=>{switchGame('runner');resetRunner()}
  $('gStart').onclick=()=>{const s=$('snakeCanvas').style.display!=='none',t=$('tetrisCanvas').style.display!=='none',r=$('runnerCanvas').style.display!=='none';if(s)startSnake();else if(t)startTetris();else if(r)startRunner()}
  $('gClose').onclick=()=>{stopSnake();stopTetris();stopRunner();setView('editor')}
  $('cSnakeNoDie').onchange=()=>{gameCheats.snake.noDie=$('cSnakeNoDie').checked;saveSettingsDebounced();toast('Snake','No-Die '+(gameCheats.snake.noDie?'ON':'OFF'),'warn')}
  $('cSnakeSpeed').oninput=()=>{const v=clamp(parseInt($('cSnakeSpeed').value,10),5,260);gameCheats.snake.speed=v;$('cSnakeSpeedV').textContent=v+'ms';saveSettingsDebounced()}
  $('cSnakeBoost').onchange=()=>{gameCheats.snake.boost=$('cSnakeBoost').checked;saveSettingsDebounced();toast('Snake','Boost '+(gameCheats.snake.boost?'ON':'OFF'),'warn')}
  $('cSnakeWalls').onchange=()=>{gameCheats.snake.wallsKill=$('cSnakeWalls').checked;saveSettingsDebounced();toast('Snake','Walls '+(gameCheats.snake.wallsKill?'KILL':'WRAP'),'warn');buildSnakeObstacles();spawnSnakeFoods()}
  $('cSnakeObs').oninput=()=>{const v=clamp(parseInt($('cSnakeObs').value,10),0,90);gameCheats.snake.obstacles=v;$('cSnakeObsV').textContent=String(v);saveSettingsDebounced();buildSnakeObstacles();spawnSnakeFoods()}
  $('cSnakeEvasive').onchange=()=>{gameCheats.snake.evasive=$('cSnakeEvasive').checked;saveSettingsDebounced();toast('Snake','Evasive Food '+(gameCheats.snake.evasive?'ON':'OFF'),'warn')}
  $('cSnakePoison').onchange=()=>{gameCheats.snake.poison=$('cSnakePoison').checked;saveSettingsDebounced();toast('Snake','Poison '+(gameCheats.snake.poison?'ON':'OFF'),'warn');spawnSnakeFoods()}
  $('cSnakeFoodDist').oninput=()=>{const v=clamp(parseInt($('cSnakeFoodDist').value,10),0,14);gameCheats.snake.foodDist=v;$('cSnakeFoodDistV').textContent=String(v);saveSettingsDebounced();spawnSnakeFoods()}
  $('cTNoOver').onchange=()=>{gameCheats.tetris.noGameOver=$('cTNoOver').checked;saveSettingsDebounced();toast('Tetris','No Game Over '+(gameCheats.tetris.noGameOver?'ON':'OFF'),'warn')}
  $('cTLevel').onchange=()=>{const v=clamp(parseInt($('cTLevel').value||1,10),1,20);gameCheats.tetris.startLevel=v;$('cTLevel').value=v;saveSettingsDebounced();toast('Tetris','Start Level '+v,'warn')}
  $('cRNoCrash').onchange=()=>{gameCheats.runner.noCrash=$('cRNoCrash').checked;saveSettingsDebounced();toast('Runner','No Crash '+(gameCheats.runner.noCrash?'ON':'OFF'),'warn')}
  $('cRSlow').onchange=()=>{gameCheats.runner.slow=$('cRSlow').checked;saveSettingsDebounced();toast('Runner','Slow Obstacles '+(gameCheats.runner.slow?'ON':'OFF'),'warn')}
  $('gReset').onclick=()=>{buildGraph();renderGraph()}
  $('gPhys').onclick=()=>{graphPhysics=!graphPhysics;toast('Graph','Physics '+(graphPhysics?'ON':'OFF'),'warn')}
  $('gCenter').onclick=()=>{gView={x:0,y:0,scale:1};renderGraph()}
  $('signOut').onclick=signOut
  $('nerdUnlock').onclick=()=>{const p=($('nerdPass').value||'').trim();if(p==='9999'){nerdUnlocked=true;$('nerdBox').style.display='block';$('nerdLockRow').style.display='none';$('nerdPass').value='';toast('Unlocked','Advanced settings enabled','ok')}else toast('Nope','Wrong PIN','bad')}
  $('musicMode').onchange=()=>{nerdPrefs.musicMode=$('musicMode').value;saveSettingsDebounced();applyMusicMode()}
  $('sfxMode').onchange=()=>{nerdPrefs.sfxMode=$('sfxMode').value;saveSettingsDebounced()}

  document.addEventListener('keydown',e=>{
    if((e.altKey&&e.key.toLowerCase()==='m')||e.key==='`'){tryQuickMute();return}
    if(e.key==='Escape'){
      if($('paletteBack').style.display==='flex'){closePalette();return}
      if($('modalPdf').style.display==='flex'){closePdfModal();return}
      if($('modalSettings').style.display==='flex'){closeSettings();return}
      if(document.body.classList.contains('previewFull')){toggleFullPreview();return}
      closeMobileSidebar();return
    }
    const k=e.key.toLowerCase()
    if((e.ctrlKey||e.metaKey)&&k==='k'){e.preventDefault();openPalette();return}
    if((e.ctrlKey||e.metaKey)&&k==='s'){e.preventDefault();saveNote(false);return}
    // Nerd-only shortcuts when no modal open
    const noModal=$('paletteBack').style.display!=='flex'&&$('modalSettings').style.display!=='flex'&&$('modalPdf').style.display!=='flex'
    if(noModal&&nerdUnlocked){
      if(k==='p'&&!e.ctrlKey&&!e.metaKey){e.preventDefault();applyMusicMode();return}
      if(k==='m'&&!e.ctrlKey&&!e.metaKey&&!e.altKey){e.preventDefault();tryQuickMute();return}
    }
    // Game input
    if($('viewGames').classList.contains('active')){
      const sSnake=$('snakeCanvas').style.display!=='none',sTetris=$('tetrisCanvas').style.display!=='none',sRunner=$('runnerCanvas').style.display!=='none'
      if(sSnake&&snakeRunning){
        if((k==='arrowup'||k==='w')&&dir.y===0)dir={x:0,y:-1}
        else if((k==='arrowdown'||k==='s')&&dir.y===0)dir={x:0,y:1}
        else if((k==='arrowleft'||k==='a')&&dir.x===0)dir={x:-1,y:0}
        else if((k==='arrowright'||k==='d')&&dir.x===0)dir={x:1,y:0}
        else if(k==='shift'&&gameCheats.snake?.boost){sBoostUntil=performance.now()+260;sfx.unlock();sfx.tone(980,0.03,0.10)}
      }else if(sTetris&&tRunning){
        if(e.key==='ArrowLeft')tMove(-1,0)
        else if(e.key==='ArrowRight')tMove(1,0)
        else if(e.key==='ArrowDown')tMove(0,1)
        else if(e.key==='ArrowUp')tRotate()
        else if(e.key===' '){tHardDrop();e.preventDefault()}
      }else if(sRunner&&rRunning){
        if(e.key===' '||e.key==='ArrowUp'){rJump();e.preventDefault()}
        else if(e.key==='Shift'){rDash();e.preventDefault()}
      }
    }
  })
  document.addEventListener('click',()=>{try{sfx.unlock()}catch(e){}})
  $('backdrop').onclick=closeMobileSidebar
  $('mobileMenu').onclick=openMobileSidebar
  window.addEventListener('resize',maybeMobileUI)
  maybeMobileUI()
  window.addEventListener('online',()=>{if(activeId&&autosaveDirty)saveNote(true);else if(activeId)setStatus('saved')})
  window.addEventListener('offline',()=>setStatus('offline'))
  document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState!=='visible'){if(activeId&&autosaveDirty)saveNote(true);audio.pause();return}
    if(nerdPrefs.musicMode&&nerdPrefs.musicMode!=='off')applyMusicMode()
  })
  window.addEventListener('beforeunload',()=>{if(activeId&&autosaveDirty){saveDraft()}})
}

async function boot(){
  initAuth();initSplitResize();initGraph();initGames();wireUI()
  const sess=await supabase.auth.getSession()
  if(sess.data?.session){
    user=sess.data.session.user
    $('authBack').style.display='none'
    $('userEmail').textContent=user.email||'Signed in'
    $('avatar').textContent=((user.email||'U')[0]||'U').toUpperCase()
    try{await ensureSettings();await fetchNotes();setSplit('split');setStatus(navigator.onLine?'saved':'offline')}
    catch(e){console.error(e);toast('Supabase error',String(e.message||e),'bad')}
  }else{$('authBack').style.display='flex'}
  supabase.auth.onAuthStateChange(async(ev,session)=>{
    if(session){
      user=session.user;$('authBack').style.display='none'
      $('userEmail').textContent=user.email||'Signed in'
      $('avatar').textContent=((user.email||'U')[0]||'U').toUpperCase()
      try{await ensureSettings();await fetchNotes();setSplit('split');setStatus(navigator.onLine?'saved':'offline')}
      catch(e){console.error(e);toast('Supabase error',String(e.message||e),'bad')}
    }else{$('authBack').style.display='flex'}
  })
}
boot()
</script>
</body>
</html>
