<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>StudyOS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDYOS â€” BLACK FLAME THEME
   Montserrat Â· Orange/Amber Â· Deep Black
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:     #080a0d;
  --bg2:    #0b0e14;
  --panel:  #0f1319;
  --panel2: #13181f;
  --card:   #161c24;
  --border: rgba(255,255,255,.08);
  --border2:rgba(255,255,255,.13);
  --text:   #f0ece4;
  --muted:  #8a8070;
  --muted2: #5a5248;
  --brand:  #ff6a00;
  --brand2: #ffb100;
  --brand3: #ff8c00;
  --glow:   rgba(255,106,0,.28);
  --glow2:  rgba(255,177,0,.18);
  --bad:    #ff4040;
  --good:   #3ecf80;
  --shadow: 0 8px 32px rgba(0,0,0,.55);
  --shadow2:0 20px 60px rgba(0,0,0,.75);
  --font:   'Montserrat', system-ui, sans-serif;
  --mono:   'JetBrains Mono', ui-monospace, Menlo, monospace;
  --side:   296px;
  --top:    62px;
  --r:      16px;
  --r2:     20px;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-size:13px}
body{
  font-family:var(--font);
  background:var(--bg);
  background-image:
    radial-gradient(ellipse 1400px 700px at 0% 0%, rgba(255,106,0,.07) 0%, transparent 55%),
    radial-gradient(ellipse 800px 500px at 100% 100%, rgba(255,177,0,.06) 0%, transparent 55%);
  color:var(--text);
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
button,input,select,textarea{ font-family:var(--font); font-size:13px }
button{ cursor:pointer }
a{ color:inherit; text-decoration:none }
::selection{ background:rgba(255,106,0,.30) }
::-webkit-scrollbar{ width:6px; height:6px }
::-webkit-scrollbar-track{ background:transparent }
::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.10); border-radius:99px }
::-webkit-scrollbar-thumb:hover{ background:rgba(255,106,0,.35) }

/* â”€â”€ LAYOUT â”€â”€ */
.app{
  height:100dvh; height:100vh;
  display:grid;
  grid-template-columns: var(--side) 1fr;
  grid-template-rows: 1fr;
  gap:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
aside.sidebar{
  background: linear-gradient(180deg, var(--panel) 0%, var(--bg2) 100%);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
  height:100vh; overflow:hidden;
  position:relative;
}
.side-inner{ display:flex; flex-direction:column; height:100%; min-height:0 }

/* Brand */
.brand{
  padding:18px 16px 14px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  background:linear-gradient(160deg, rgba(255,106,0,.06), transparent 60%);
}
.brand-top{ display:flex; align-items:center; gap:12px; margin-bottom:12px }
.logo{
  width:38px; height:38px; border-radius:12px; flex-shrink:0;
  background:linear-gradient(135deg, var(--brand), var(--brand2));
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:18px; color:#0d0800;
  box-shadow:0 6px 22px var(--glow), inset 0 1px 0 rgba(255,255,255,.25);
  animation:logoFlicker 4s ease infinite;
}
@keyframes logoFlicker{
  0%,100%{ box-shadow:0 6px 22px var(--glow), inset 0 1px 0 rgba(255,255,255,.25) }
  50%{ box-shadow:0 8px 30px rgba(255,177,0,.35), 0 0 50px rgba(255,106,0,.12), inset 0 1px 0 rgba(255,255,255,.25) }
}
.brand-name .t{
  font-size:16px; font-weight:800; letter-spacing:-.3px;
  background:linear-gradient(90deg, var(--brand), var(--brand2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.brand-name .s{ font-size:11px; color:var(--muted); margin-top:2px; font-weight:500 }

.school-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:5px 11px; border-radius:99px; margin-bottom:10px;
  background:rgba(255,106,0,.09); border:1px solid rgba(255,106,0,.22);
  cursor:pointer; transition:all .22s;
}
.school-pill:hover{ background:rgba(255,106,0,.16); border-color:rgba(255,106,0,.40) }
.school-pill span{ font-size:11px; font-weight:700; color:var(--brand); letter-spacing:.02em }

.side-actions{ display:flex; gap:8px }

/* Search */
.search-wrap{ padding:10px 12px 0; flex-shrink:0 }
.search{
  width:100%; padding:9px 12px; border-radius:12px;
  background:rgba(0,0,0,.30); border:1px solid var(--border2);
  color:var(--text); outline:none; transition:all .2s;
}
.search:focus{ border-color:rgba(255,106,0,.45); box-shadow:0 0 0 3px rgba(255,106,0,.12) }
.search::placeholder{ color:var(--muted2) }

/* Filters row */
.side-filters{
  padding:8px 12px 0; display:flex; gap:7px; align-items:center; flex-shrink:0
}
.side-filters select{
  flex:1; padding:7px 10px; border-radius:11px;
  background:rgba(0,0,0,.28); border:1px solid var(--border);
  color:var(--text); outline:none; cursor:pointer; appearance:none;
  transition:border-color .2s;
}
.side-filters select:focus{ border-color:rgba(255,106,0,.45) }

/* Note list */
.note-list{
  flex:1; overflow-y:auto; padding:8px 8px; display:flex; flex-direction:column; gap:2px; min-height:0
}

/* Note groups */
.group{ margin-bottom:4px }
.group-head{
  display:flex; align-items:center; justify-content:space-between;
  padding:6px 10px 4px; font-size:10px; font-weight:700;
  color:var(--muted2); text-transform:uppercase; letter-spacing:.12em
}
.group-head .count{
  font-size:11px; padding:1px 7px; border-radius:99px; font-weight:700;
  background:rgba(255,106,0,.10); color:var(--brand); border:1px solid rgba(255,106,0,.20)
}

.note-card{
  width:100%; text-align:left; padding:10px 12px; border-radius:12px;
  background:transparent; border:1px solid transparent;
  cursor:pointer; transition:all .18s;
}
.note-card:hover{ background:rgba(255,255,255,.04); border-color:var(--border) }
.note-card.active{
  background:linear-gradient(135deg, rgba(255,106,0,.12), rgba(255,177,0,.06));
  border-color:rgba(255,106,0,.30);
}
.note-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:3px }
.note-title .t{ font-size:12px; font-weight:700; color:var(--text); line-height:1.3 }
.tag{
  font-size:10px; padding:2px 8px; border-radius:99px; font-weight:700; flex-shrink:0;
  background:rgba(255,106,0,.12); color:var(--brand); border:1px solid rgba(255,106,0,.22)
}
.note-snippet{ font-size:11px; color:var(--muted); line-height:1.4; margin-bottom:3px }
.note-meta{ font-size:10px; color:var(--muted2); display:flex; align-items:center; justify-content:space-between }
.badges{ display:flex; gap:4px }
.badge{ font-size:9px; padding:2px 6px; border-radius:99px; font-weight:700; border:1px solid }
.badge.link{ color:var(--brand2); border-color:rgba(255,177,0,.25); background:rgba(255,177,0,.08) }
.badge.draft{ color:var(--muted); border-color:var(--border); background:rgba(255,255,255,.04) }

/* Footer */
.side-footer{
  border-top:1px solid var(--border); flex-shrink:0;
  padding:10px 12px; display:flex; flex-direction:column; gap:8px;
  background:linear-gradient(0deg, rgba(255,106,0,.04), transparent)
}

/* Timer bar */
.timerbar{
  display:flex; align-items:center; justify-content:space-between;
  background:rgba(0,0,0,.28); border:1px solid var(--border); border-radius:12px; padding:8px 12px
}
.time{
  font-size:22px; font-weight:800; letter-spacing:-.5px; font-family:var(--mono);
  background:linear-gradient(90deg, var(--brand), var(--brand2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.tbtns{ display:flex; gap:4px }
.tbtn{
  width:30px; height:30px; border-radius:9px; display:flex; align-items:center; justify-content:center;
  background:rgba(255,255,255,.05); border:1px solid var(--border); cursor:pointer;
  font-size:13px; color:var(--muted); transition:all .18s;
}
.tbtn:hover{ background:rgba(255,106,0,.15); border-color:rgba(255,106,0,.35); color:var(--brand) }

.timer-modes{ display:flex; gap:5px; flex-wrap:wrap }
.pill{
  padding:5px 10px; border-radius:99px; font-size:10px; font-weight:700; cursor:pointer;
  background:rgba(255,255,255,.05); border:1px solid var(--border); color:var(--muted);
  transition:all .18s;
}
.pill:hover{ background:rgba(255,106,0,.14); border-color:rgba(255,106,0,.35); color:var(--brand) }

/* User line */
.userline{ display:flex; align-items:center; justify-content:space-between; gap:8px }
.userline .left{ display:flex; align-items:center; gap:8px; min-width:0 }
.avatar{
  width:28px; height:28px; border-radius:9px; flex-shrink:0;
  background:linear-gradient(135deg, var(--brand), var(--brand2));
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:12px; color:#0d0800
}
.email{ font-size:11px; color:var(--muted); font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{ display:flex; flex-direction:column; height:100vh; overflow:hidden; min-width:0 }

.topbar{
  height:var(--top); flex-shrink:0;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:0 14px; border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, var(--panel) 0%, rgba(15,19,25,.8) 100%);
}
.top-left{ display:flex; align-items:center; gap:14px; min-width:0 }
.top-right{ display:flex; align-items:center; gap:6px; flex-shrink:0 }

/* Mode tabs */
.mode-tabs{ display:flex; gap:2px; background:rgba(0,0,0,.28); border:1px solid var(--border); border-radius:12px; padding:3px }
.tab{
  padding:6px 14px; border-radius:9px; font-size:12px; font-weight:700;
  cursor:pointer; color:var(--muted); transition:all .18s; user-select:none;
}
.tab:hover{ color:var(--text) }
.tab.active{
  background:linear-gradient(135deg, var(--brand), var(--brand3));
  color:#0d0800; box-shadow:0 3px 12px var(--glow)
}

/* Breadcrumb */
.notecrumb{ min-width:0 }
.notecrumb .title{ font-size:13px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
.notecrumb .sub{ font-size:11px; color:var(--muted); margin-top:1px; display:flex; gap:6px; flex-wrap:wrap }
.chip{
  display:inline-block; padding:1px 7px; border-radius:99px; font-size:10px; font-weight:700;
  background:rgba(255,106,0,.10); color:var(--brand); border:1px solid rgba(255,106,0,.22)
}

/* Save status */
.status{
  display:flex; align-items:center; gap:6px;
  padding:5px 10px; border-radius:99px; font-size:11px; font-weight:700;
  background:rgba(0,0,0,.28); border:1px solid var(--border); color:var(--muted);
  user-select:none; white-space:nowrap;
}
.dot{ width:7px; height:7px; border-radius:50%; transition:all .3s }
.dot.ok{ background:var(--good); box-shadow:0 0 10px rgba(62,207,128,.4) }
.dot.warn{ background:var(--brand2); box-shadow:0 0 10px rgba(255,177,0,.4); animation:dotBlink 1.2s ease infinite }
.dot.bad{ background:var(--bad); box-shadow:0 0 10px rgba(255,64,64,.4) }
@keyframes dotBlink{ 0%,100%{ opacity:1 } 50%{ opacity:.35 } }

/* Icon buttons */
.iconbtn{
  height:34px; min-width:34px; padding:0 10px; border-radius:10px;
  background:rgba(255,255,255,.05); border:1px solid var(--border); color:var(--text);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  font-size:12px; font-weight:700; gap:5px; transition:all .18s; user-select:none;
}
.iconbtn:hover{ background:rgba(255,255,255,.08); border-color:var(--border2) }
.iconbtn.primary{
  background:linear-gradient(135deg, var(--brand), var(--brand3));
  border:0; color:#0d0800; box-shadow:0 3px 12px var(--glow)
}
.iconbtn.primary:hover{ box-shadow:0 4px 18px rgba(255,106,0,.45); transform:translateY(-1px) }
.iconbtn.danger{ background:rgba(255,64,64,.10); border-color:rgba(255,64,64,.22); color:#ff9999 }
.iconbtn.danger:hover{ background:rgba(255,64,64,.20); border-color:rgba(255,64,64,.40) }

/* Buttons (sidebar + modal) */
.btn{
  padding:9px 14px; border-radius:11px; font-weight:700; font-size:12px;
  background:rgba(255,255,255,.06); border:1px solid var(--border2); color:var(--text);
  transition:all .18s; display:inline-flex; align-items:center; gap:6px;
}
.btn:hover{ background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.20) }
.btn:active{ transform:translateY(1px) }
.btn.primary{
  background:linear-gradient(135deg, var(--brand), var(--brand3));
  border:0; color:#0d0800; font-weight:800; box-shadow:0 4px 14px var(--glow)
}
.btn.primary:hover{ box-shadow:0 5px 20px rgba(255,106,0,.50); transform:translateY(-1px) }
.btn.ghost{ background:transparent; border-color:var(--border) }
.btn.ghost:hover{ background:rgba(255,255,255,.05) }
.btn.kbtn{
  width:34px; height:34px; padding:0; display:flex; align-items:center; justify-content:center;
  font-size:16px; flex-shrink:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENT AREA â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.content{ flex:1; overflow:hidden; position:relative; display:flex; flex-direction:column }
.view{ display:none; flex:1; overflow:auto; padding:16px }
.view.active{ display:flex; flex-direction:column }

/* Editor shell */
.editor-shell{ display:flex; flex-direction:column; height:100%; gap:0 }
.toolbar{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 10px; border-bottom:1px solid var(--border); flex-shrink:0;
  background:rgba(0,0,0,.18); flex-wrap:wrap; gap:6px;
}
.lefttools{ display:flex; gap:4px; flex-wrap:wrap }
.tool{
  padding:5px 10px; border-radius:8px; font-size:12px; font-weight:700;
  background:rgba(255,255,255,.05); border:1px solid var(--border); color:var(--muted);
  cursor:pointer; transition:all .15s; user-select:none;
}
.tool:hover{ background:rgba(255,106,0,.14); border-color:rgba(255,106,0,.30); color:var(--brand) }
.metapick{ display:flex; gap:7px; align-items:center }
.metapick select, .metapick input{
  padding:5px 10px; border-radius:9px;
  background:rgba(0,0,0,.28); border:1px solid var(--border); color:var(--text);
  font-size:12px; outline:none; transition:border-color .2s; appearance:none;
}
.metapick select:focus, .metapick input:focus{ border-color:rgba(255,106,0,.45) }
.metapick input::placeholder{ color:var(--muted2) }

/* Split pane */
.split{
  flex:1; display:grid; grid-template-columns:50% 8px 1fr;
  overflow:hidden; min-height:0;
}
.split.singleEditor{ grid-template-columns:1fr }
.split.singlePreview{ grid-template-columns:1fr }
.pane{ overflow:auto; display:flex; flex-direction:column; height:100% }
#paneLeft{ border-right:1px solid var(--border) }

.titleInput{
  width:100%; padding:16px 18px; font-size:22px; font-weight:800; letter-spacing:-.5px;
  background:transparent; border:none; color:var(--text); outline:none;
  border-bottom:1px solid var(--border);
}
.titleInput::placeholder{ color:var(--muted2) }
.bodyInput{
  flex:1; width:100%; padding:16px 18px; line-height:1.72;
  background:transparent; border:none; color:var(--text); outline:none;
  resize:none; font-family:var(--mono); font-size:13px; font-weight:400;
}
.bodyInput::placeholder{ color:var(--muted2) }

/* Divider */
.divider{
  width:8px; cursor:col-resize; background:transparent;
  display:flex; align-items:center; justify-content:center; transition:background .15s;
}
.divider:hover{ background:rgba(255,106,0,.18) }
.divider::after{
  content:''; width:2px; height:40px; border-radius:99px; background:var(--border2)
}

/* Right pane */
.rightpane{ padding:12px; display:flex; flex-direction:column; gap:10px }
.card{
  border-radius:14px; background:rgba(0,0,0,.22); border:1px solid var(--border); overflow:hidden
}
.cardhead{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:9px 12px; border-bottom:1px solid var(--border); background:rgba(255,255,255,.02)
}
.cardhead .h{ font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:.1em; color:var(--muted) }
.act{ display:flex; gap:6px }
.linkbtn{
  font-size:11px; font-weight:700; color:var(--brand); cursor:pointer; padding:3px 8px;
  border-radius:7px; border:1px solid rgba(255,106,0,.22); background:rgba(255,106,0,.08);
  transition:all .18s;
}
.linkbtn:hover{ background:rgba(255,106,0,.20); border-color:rgba(255,106,0,.45) }
.pills{ padding:10px 12px; display:flex; flex-wrap:wrap; gap:6px }
.pillnote{
  display:inline-flex; align-items:center; gap:5px; padding:5px 10px; border-radius:99px;
  font-size:11px; font-weight:700; cursor:pointer;
  background:rgba(255,106,0,.10); border:1px solid rgba(255,106,0,.22); color:var(--brand);
  transition:all .18s;
}
.pillnote:hover{ background:rgba(255,106,0,.20); transform:translateY(-1px) }
.pillnote .x{ opacity:.55; font-size:13px; line-height:1; margin-left:2px }
.pillnote .x:hover{ opacity:1 }

.smallHint{ padding:10px 12px; font-size:12px; color:var(--muted); line-height:1.7 }
kbd{
  font-family:var(--mono); font-size:10px; padding:2px 6px; border-radius:6px;
  background:rgba(0,0,0,.35); border:1px solid var(--border2); color:var(--muted)
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• PREVIEW VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.preview{ max-width:780px; padding:0 4px }
.preview h1{
  font-size:30px; font-weight:800; letter-spacing:-.8px; margin-bottom:10px;
  background:linear-gradient(90deg, var(--text), rgba(240,236,228,.7));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.metaRow{ display:flex; gap:6px; flex-wrap:wrap; margin-bottom:20px }
.preview .body{ line-height:1.8; color:rgba(240,236,228,.88); font-size:14px }
.preview .body h1,.preview .body h2,.preview .body h3{
  color:var(--text); margin:20px 0 10px; font-weight:800; -webkit-text-fill-color:unset
}
.preview .body code{
  font-family:var(--mono); font-size:12px; padding:2px 6px; border-radius:6px;
  background:rgba(255,106,0,.12); color:var(--brand2); border:1px solid rgba(255,106,0,.20)
}
.preview .body pre{
  background:rgba(0,0,0,.35); border:1px solid var(--border); border-radius:12px;
  padding:14px 16px; overflow-x:auto; margin:14px 0
}
.preview .body pre code{ background:transparent; border:none; padding:0; color:var(--text) }
.preview .body blockquote{
  border-left:3px solid var(--brand); margin:14px 0; padding:8px 16px;
  background:rgba(255,106,0,.06); border-radius:0 10px 10px 0; color:var(--muted)
}
.preview .body a{ color:var(--brand2); border-bottom:1px solid rgba(255,177,0,.3) }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• GRAPH VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.graphWrap{
  position:relative; flex:1; display:flex; flex-direction:column;
  border-radius:16px; background:rgba(0,0,0,.25); border:1px solid var(--border); overflow:hidden;
}
#graph{ flex:1; width:100%; display:block }
.graphUI{
  position:absolute; top:12px; right:12px; display:flex; gap:6px
}
.graphHint{
  position:absolute; bottom:12px; left:50%; transform:translateX(-50%);
  font-size:11px; color:var(--muted); pointer-events:none;
  background:rgba(0,0,0,.55); padding:5px 12px; border-radius:99px; border:1px solid var(--border)
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAMES VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.gamesWrap{ display:flex; align-items:stretch; justify-content:center; padding:0; flex:1 }
.gameCard{
  width:100%; border-radius:18px; border:1px solid rgba(255,106,0,.18);
  background:rgba(0,0,0,.25); padding:14px; display:flex; flex-direction:column; gap:10px;
}
.gameTop{
  display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; flex-shrink:0
}
.gameTitle{ font-size:16px; font-weight:800; color:var(--brand) }
.gTabs{ display:flex; gap:6px }
.gTab{
  padding:7px 14px; border-radius:10px; font-size:12px; font-weight:700; cursor:pointer;
  background:rgba(255,255,255,.05); border:1px solid var(--border); color:var(--muted);
  transition:all .18s; user-select:none;
}
.gTab:hover{ border-color:rgba(255,106,0,.30) }
.gTab.active{
  background:linear-gradient(135deg, rgba(255,106,0,.20), rgba(255,177,0,.10));
  border-color:rgba(255,106,0,.45); color:var(--brand)
}
.gameBtns{ display:flex; gap:7px }
.gameBody{
  flex:1; display:grid; grid-template-columns:1.2fr .8fr; gap:12px; min-height:0
}
@media(max-width:900px){ .gameBody{ grid-template-columns:1fr } }
.canvasWrap{
  border-radius:16px; background:rgba(0,0,0,.30); border:1px solid var(--border);
  padding:10px; display:flex; align-items:center; justify-content:center; overflow:hidden;
}
canvas{ display:block; border-radius:12px; background:#050505 }
.gameSide{ display:flex; flex-direction:column; gap:10px; overflow-y:auto }
.scoreBox{
  border-radius:14px; background:rgba(0,0,0,.22); border:1px solid var(--border); padding:12px
}
.scoreBox .r{
  display:flex; justify-content:space-between; gap:10px; padding:5px 0;
  font-size:12px; font-weight:700; border-bottom:1px solid var(--border); color:var(--muted)
}
.scoreBox .r:last-child{ border-bottom:none }
.scoreBox .r span{ color:var(--brand2) }
.cheatBox{
  border-radius:14px; background:rgba(0,0,0,.22); border:1px solid var(--border); padding:12px
}
.cheatBox .h{
  font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:.12em;
  color:var(--muted2); margin-bottom:10px
}
.cheatBox label{
  display:flex; justify-content:space-between; align-items:center; gap:8px;
  font-size:12px; font-weight:700; color:rgba(240,236,228,.8); padding:8px 0;
  border-bottom:1px solid var(--border)
}
.cheatBox label:last-child{ border-bottom:none }
.cheatBox input[type="checkbox"]{ accent-color:var(--brand); width:16px; height:16px }
.cheatBox input[type="range"]{ accent-color:var(--brand); width:140px }
.cheatBox input[type="number"]{
  width:70px; padding:6px 8px; border-radius:9px;
  background:rgba(0,0,0,.35); border:1px solid var(--border); color:var(--text); outline:none
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  padding:10px 18px; border-radius:12px; font-size:12px; font-weight:700;
  background:rgba(15,19,25,.92); border:1px solid rgba(255,106,0,.30); color:var(--text);
  box-shadow:0 10px 30px rgba(0,0,0,.60), 0 0 20px var(--glow);
  opacity:0; transition:opacity .25s; pointer-events:none; z-index:9999; white-space:nowrap;
}
.toast.show{ opacity:1; pointer-events:auto }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• PALETTE â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.paletteBack{
  position:fixed; inset:0; background:rgba(0,0,0,.78); backdrop-filter:blur(10px);
  display:none; align-items:flex-start; justify-content:center; padding-top:120px; z-index:200
}
.palette{
  width:min(640px, calc(100vw - 28px));
  background:var(--panel2); border:1px solid rgba(255,106,0,.25);
  border-radius:18px; overflow:hidden; box-shadow:var(--shadow2), 0 0 40px var(--glow)
}
.paletteTop{
  display:flex; align-items:center; gap:10px;
  padding:14px 16px; border-bottom:1px solid var(--border)
}
.paletteTop input{
  flex:1; background:transparent; border:none; color:var(--text);
  font-size:15px; font-weight:600; outline:none
}
.paletteTop input::placeholder{ color:var(--muted2) }
.paletteTop .hint{ font-size:11px; color:var(--muted2); font-weight:600; white-space:nowrap }
.paletteList{ max-height:380px; overflow-y:auto }
.pItem{
  width:100%; text-align:left; padding:11px 16px; border-bottom:1px solid var(--border);
  background:transparent; border-left:none; border-right:none; color:var(--text);
  font-size:13px; font-weight:600; cursor:pointer; transition:background .12s; border-radius:0;
}
.pItem:hover{ background:rgba(255,106,0,.10) }
.pItem strong{ color:var(--brand) }
.pItem small{ color:var(--muted); margin-left:8px; font-weight:500 }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modalBack{
  position:fixed; inset:0; background:rgba(0,0,0,.75); backdrop-filter:blur(8px);
  display:none; align-items:center; justify-content:center; padding:14px; z-index:100
}
.modal{
  width:min(480px, 100%); background:var(--panel2);
  border:1px solid var(--border2); border-radius:18px;
  box-shadow:var(--shadow2); padding:20px; display:flex; flex-direction:column; gap:14px
}
.modalTop{
  display:flex; align-items:center; justify-content:space-between
}
.modalTop .h{ font-size:15px; font-weight:800 }
.modalBody{ display:flex; flex-direction:column; gap:10px }
.modalBody p{ font-size:12px; color:var(--muted); line-height:1.6 }
.modalBody .row{ display:flex; gap:8px; flex-wrap:wrap }
.modalBody select, .modalBody input[type="number"]{
  flex:1; padding:9px 12px; border-radius:10px;
  background:rgba(0,0,0,.35); border:1px solid var(--border2); color:var(--text);
  outline:none; appearance:none; font-size:12px;
}
.modalBody select:focus, .modalBody input:focus{ border-color:rgba(255,106,0,.45) }
.modalActions{ display:flex; gap:8px; justify-content:flex-end }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.authBack{
  position:fixed; inset:0; background:var(--bg);
  background-image:
    radial-gradient(ellipse 1200px 700px at 10% -5%, rgba(255,106,0,.09), transparent 55%),
    radial-gradient(ellipse 900px 600px at 90% 100%, rgba(255,177,0,.07), transparent 55%);
  display:flex; align-items:center; justify-content:center; z-index:300;
}
.authCard{
  width:min(400px, calc(100vw - 28px));
  background:var(--panel2); border:1px solid rgba(255,106,0,.22);
  border-radius:20px; padding:28px; box-shadow:var(--shadow2), 0 0 60px var(--glow);
  display:flex; flex-direction:column; gap:14px;
}
.authHead{ display:flex; align-items:center; gap:14px; margin-bottom:2px }
.authHead .logo{
  width:46px; height:46px; border-radius:14px;
  background:linear-gradient(135deg, var(--brand), var(--brand2));
  display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:22px; color:#0d0800; flex-shrink:0;
  box-shadow:0 8px 25px var(--glow)
}
.authHead .t{ font-size:22px; font-weight:800; letter-spacing:-.4px }
.authHead .s{ font-size:12px; color:var(--muted); margin-top:2px }
.authTabs{
  display:flex; gap:4px; background:rgba(0,0,0,.30);
  border:1px solid var(--border); border-radius:11px; padding:3px
}
.atab{
  flex:1; text-align:center; padding:7px; border-radius:8px; font-size:12px; font-weight:700;
  cursor:pointer; color:var(--muted); transition:all .18s; user-select:none
}
.atab:hover{ color:var(--text) }
.atab.active{
  background:linear-gradient(135deg, var(--brand), var(--brand3));
  color:#0d0800; box-shadow:0 3px 10px var(--glow)
}
.authCard input[type="email"], .authCard input[type="password"]{
  width:100%; padding:11px 14px; border-radius:12px;
  background:rgba(0,0,0,.35); border:1px solid var(--border2); color:var(--text);
  outline:none; font-size:13px; transition:border-color .2s
}
.authCard input:focus{ border-color:rgba(255,106,0,.50); box-shadow:0 0 0 3px rgba(255,106,0,.12) }
.authCard input::placeholder{ color:var(--muted2) }
.authRow{ display:flex; gap:8px }
.authSmall{
  display:flex; justify-content:space-between; font-size:11px; color:var(--muted);
  font-weight:600;
}
.authSmall span{ cursor:pointer; transition:color .18s }
.authSmall span:hover{ color:var(--brand) }
.authErr{ font-size:12px; color:var(--bad); font-weight:700; min-height:16px }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• BACKDROP â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.backdrop{
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
  z-index:50; backdrop-filter:blur(4px)
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:1024px){
  .app{ grid-template-columns:1fr }
  aside.sidebar{
    position:fixed; left:-320px; top:0; bottom:0; z-index:60;
    width:var(--side); transition:left .28s cubic-bezier(.4,0,.2,1);
  }
  .sidebar.mobile-open{ left:0 }
  #mobileMenu{ display:flex!important }
  .notecrumb{ display:none }
}
@media(max-width:640px){
  .mode-tabs .tab span{ display:none }
  .top-right .iconbtn.wide span{ display:none }
  .gameBody{ grid-template-columns:1fr }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• PREVIEWFULL â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.previewFull #viewPreview.active{
  position:fixed; inset:0; z-index:80; padding:48px;
  background:var(--bg); overflow:auto;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• DB BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#dbBanner{
  position:fixed; top:0; left:0; right:0; z-index:9999;
  background:linear-gradient(90deg, rgba(180,20,20,.97), rgba(220,60,0,.97));
  color:#fff; padding:10px 20px; font-size:12px; font-weight:700;
  display:none; align-items:center; gap:10px; box-shadow:0 4px 24px rgba(0,0,0,.5)
}
#dbBanner .dbx{ margin-left:auto; cursor:pointer; font-size:18px; opacity:.7; line-height:1 }
#dbBanner .dbx:hover{ opacity:1 }
</style>
<body>

<div class="toastWrap" id="toastWrap"></div>

<div class="paletteBack" id="paletteBack">
  <div class="palette">
    <div class="paletteTop">
      <input id="paletteQ" placeholder="Search notes or type a command...">
      <div class="hint">Enter Â· Esc Â· Ctrl+K</div>
    </div>
    <div class="paletteList" id="paletteList"></div>
  </div>
</div>

<div class="modalBack" id="modalPdf">
  <div class="modal">
    <div class="modalTop">
      <div class="h">Export PDF</div>
      <div class="iconbtn" id="pdfClose">âœ•</div>
    </div>
    <div class="modalBody">
      <p>Exports a styled PDF of the current note. Optionally include linked notes as an appendix.</p>
      <div class="row">
        <select id="pdfIncludeLinks">
          <option value="1">Include linked notes</option>
          <option value="0">Only this note</option>
        </select>
        <select id="pdfIncludeDates">
          <option value="1">Include dates</option>
          <option value="0">No dates</option>
        </select>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="pdfCancel">Cancel</button>
      <button class="btn primary" id="pdfGo">Export</button>
    </div>
  </div>
</div>

<div class="modalBack" id="modalSettings">
  <div class="modal">
    <div class="modalTop">
      <div class="h">Settings</div>
      <div class="iconbtn" id="setClose">âœ•</div>
    </div>
    <div class="modalBody">
      <p>These sync across devices.</p>
      <div class="row">
        <select id="setSidebar">
          <option value="0">Sidebar: Normal</option>
          <option value="1">Sidebar: Hidden (mobile style)</option>
        </select>
        <select id="setPreviewFull">
          <option value="0">Preview Full-screen: Off</option>
          <option value="1">Preview Full-screen: On</option>
        </select>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <input id="setFocus" type="number" min="1" max="180" placeholder="Focus minutes">
        <input id="setBreak" type="number" min="1" max="60" placeholder="Break minutes">
        <input id="setLong" type="number" min="1" max="120" placeholder="Long break minutes">
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="setCancel">Cancel</button>
      <button class="btn primary" id="setSave">Save</button>
    </div>
  </div>
</div>

<div class="authBack" id="authBack">
  <div class="authCard">
    <div class="authHead">
      <div class="logo">S</div>
      <div>
        <div class="t">StudyOS</div>
        <div class="s">Everything saves. Everywhere.</div>
      </div>
    </div>
    <div class="authTabs">
      <div class="atab active" id="tabSignIn">Sign In</div>
      <div class="atab" id="tabSignUp">Sign Up</div>
    </div>
    <input id="authEmail" type="email" placeholder="Email">
    <input id="authPass" type="password" placeholder="Password">
    <div class="authRow">
      <button class="btn primary" id="authGo">Enter</button>
      <button class="btn ghost" id="authMagic">Magic Link</button>
    </div>
    <div class="authSmall">
      <span id="authReset">Forgot password?</span>
      <span id="authTip">Ctrl+K inside app</span>
    </div>
    <div class="authErr" id="authErr"></div>
  </div>
</div>

<div class="backdrop" id="backdrop"></div>

<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="side-inner">
      <div class="brand">
        <div class="brand-top">
          <div class="logo">S</div>
          <div class="brand-name">
            <div class="t">StudyOS</div>
            <div class="s">notes Â· links Â· graph Â· games</div>
          </div>
        </div>
        <div class="school-pill" id="schoolPill"><span id="schoolText">Salesianum</span></div>
        <div class="side-actions">
          <button class="btn primary" id="btnNew">New Note</button>
          <button class="btn" id="btnGames">Games</button>
        </div>
      </div>

      <div class="search-wrap">
        <input class="search" id="search" placeholder="Search titles + content (Ctrl+K)">
      </div>

      <div class="side-filters">
        <select id="sort">
          <option value="updated_desc">Sort: Updated</option>
          <option value="title_asc">Sort: Title</option>
          <option value="grade_asc">Sort: Grade</option>
        </select>
        <button class="btn kbtn" id="openPalette">âŒ˜</button>
      </div>

      <div class="note-list" id="noteList"></div>

      <div class="side-footer">
        <div class="timerbar">
          <div class="time" id="timerText">25:00</div>
          <div class="tbtns">
            <div class="tbtn" id="tStart">â–¶</div>
            <div class="tbtn" id="tPause">â¸</div>
            <div class="tbtn" id="tReset">â†º</div>
          </div>
        </div>
        <div class="timer-modes">
          <div class="pill" id="mFocus">Focus</div>
          <div class="pill" id="mBreak">Break</div>
          <div class="pill" id="mLong">Long</div>
          <div class="pill" id="mBreakGame">Break+Game</div>
        </div>
        <div class="userline">
          <div class="left">
            <div class="avatar" id="avatar">U</div>
            <div class="email" id="userEmail">Signed out</div>
          </div>
          <button class="btn ghost out" id="signOut">Sign out</button>
        </div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="top-left">
        <div class="mode-tabs">
          <div class="tab active" id="modeEdit">Edit</div>
          <div class="tab" id="modePreview">Preview</div>
          <div class="tab" id="modeGraph">Graph</div>
        </div>
        <div class="notecrumb">
          <div class="title" id="crumbTitle">No note selected</div>
          <div class="sub" id="crumbSub"></div>
        </div>
      </div>

      <div class="top-right">
        <div class="status" id="saveStatus"><span class="dot warn"></span><span>Not saved</span></div>
        <div class="iconbtn wide" id="toggleSplit"><span>Split</span></div>
        <div class="iconbtn wide" id="toggleFull"><span>Full</span></div>
        <div class="iconbtn wide" id="doPdf"><span>PDF</span></div>
        <div class="iconbtn" id="openSettings">âš™</div>
        <div class="iconbtn primary" id="saveNow">Save</div>
        <div class="iconbtn danger" id="delNote">ğŸ—‘</div>
        <div class="iconbtn" id="mobileMenu" style="display:none">â˜°</div>
      </div>
    </div>

    <div class="content">
      <section class="view active" id="viewEditor">
        <div class="editor-shell">
          <div class="toolbar">
            <div class="lefttools">
              <div class="tool" data-md="bold">B</div>
              <div class="tool" data-md="italic">I</div>
              <div class="tool" data-md="h1">H1</div>
              <div class="tool" data-md="h2">H2</div>
              <div class="tool" data-md="ul">â€¢ List</div>
              <div class="tool" data-md="ol">1. List</div>
              <div class="tool" data-md="quote">Quote</div>
              <div class="tool" data-md="code">Code</div>
              <div class="tool" data-md="link">Link</div>
            </div>
            <div class="metapick">
              <select id="grade">
                <option value="">Grade: (none)</option>
                <option value="8th">8th</option>
                <option value="9th">9th</option>
                <option value="10th">10th</option>
                <option value="11th">11th</option>
                <option value="12th">12th</option>
              </select>
              <input id="linkSearch" placeholder="Link notes by title...">
            </div>
          </div>

          <div class="split" id="split">
            <div class="pane" id="paneLeft">
              <input class="titleInput" id="title" placeholder="Untitled">
              <textarea class="bodyInput" id="body" placeholder="Write in Markdown..."></textarea>
            </div>

            <div class="divider" id="divider"></div>

            <div class="pane" id="paneRight">
              <div class="rightpane">
                <div class="card" id="cardLinks" style="display:none">
                  <div class="cardhead">
                    <div class="h">Linked notes</div>
                    <div class="act">
                      <div class="linkbtn" id="unlinkAll">Unlink all</div>
                      <div class="linkbtn" id="jumpPreview">Preview</div>
                    </div>
                  </div>
                  <div class="pills" id="linksPills"></div>
                </div>

                <div class="card" id="cardBack" style="display:none">
                  <div class="cardhead">
                    <div class="h">Backlinks</div>
                    <div class="act">
                      <div class="linkbtn" id="jumpGraph">Graph</div>
                    </div>
                  </div>
                  <div class="pills" id="backPills"></div>
                </div>

                <div class="card" id="cardMentions" style="display:none">
                  <div class="cardhead">
                    <div class="h">Unlinked mentions</div>
                    <div class="act">
                      <div class="linkbtn" id="linkAllMentions">Link all</div>
                    </div>
                  </div>
                  <div class="pills" id="menPills"></div>
                </div>

                <div class="card">
                  <div class="cardhead">
                    <div class="h">Shortcuts</div>
                    <div class="act"></div>
                  </div>
                  <div class="smallHint">
                    <div><kbd>Ctrl</kbd> + <kbd>S</kbd> save</div>
                    <div><kbd>Ctrl</kbd> + <kbd>K</kbd> command palette</div>
                    <div><kbd>Esc</kbd> exit full-screen preview / close dialogs</div>
                  </div>
                </div>

                <div class="card" id="cardDrop" style="display:none">
                  <div class="cardhead">
                    <div class="h">Link results</div>
                    <div class="act"><div class="linkbtn" id="closeDrop">Close</div></div>
                  </div>
                  <div id="dropList"></div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </section>

      <section class="view" id="viewPreview">
        <div class="preview">
          <h1 id="pTitle">Untitled</h1>
          <div class="metaRow" id="pMeta"></div>
          <div class="body" id="pBody"></div>
          <div class="card" id="pLinksCard" style="margin-top:20px;display:none">
            <div class="cardhead">
              <div class="h">Linked notes</div>
              <div class="act"><div class="linkbtn" id="backToEdit">Back</div></div>
            </div>
            <div class="pills" id="pLinks"></div>
          </div>
        </div>
      </section>

      <section class="view" id="viewGraph">
        <div class="graphWrap">
          <canvas id="graph"></canvas>
          <div class="graphUI">
            <div class="iconbtn wide" id="gReset"><span>Reset</span></div>
            <div class="iconbtn wide" id="gPhys"><span>Physics</span></div>
            <div class="iconbtn wide" id="gCenter"><span>Center</span></div>
          </div>
          <div class="graphHint">Drag to pan Â· Scroll to zoom Â· Click a node to open</div>
        </div>
      </section>

      <section class="view" id="viewGames">
        <div class="gamesWrap">
          <div class="gameCard">
            <div class="gameTop">
              <div class="gameTitle" id="gTitle">Break Games</div>
              <div class="gTabs">
                <div class="gTab active" id="tabSnake">Snake</div>
                <div class="gTab" id="tabTetris">Tetris</div>
              </div>
              <div class="gameBtns">
                <button class="btn primary" id="gStart">Start</button>
                <button class="btn" id="gClose">Back</button>
              </div>
            </div>

            <div class="gameBody">
              <div class="canvasWrap">
                <canvas id="snakeCanvas" width="420" height="420"></canvas>
                <canvas id="tetrisCanvas" width="240" height="480" style="display:none"></canvas>
              </div>

              <div class="gameSide">
                <div class="scoreBox" id="snakeScoreBox">
                  <div class="r">Score <span id="snakeScore">0</span></div>
                  <div class="r">Best <span id="snakeBest">0</span></div>
                  <div class="smallHint">Move: <kbd>WASD</kbd> / <kbd>Arrows</kbd></div>
                </div>

                <div class="scoreBox" id="tetrisScoreBox" style="display:none">
                  <div class="r">Score <span id="tScore">0</span></div>
                  <div class="r">Best <span id="tBest">0</span></div>
                  <div class="r">Level <span id="tLevel">1</span></div>
                  <div class="r">Lines <span id="tLines">0</span></div>
                  <div class="smallHint">Rotate <kbd>â†‘</kbd> Â· Drop <kbd>Space</kbd></div>
                </div>

                <div class="cheatBox">
                  <div class="h">Cheats (saved)</div>
                  <div id="snakeCheats">
                    <label>Snake No-Die <input type="checkbox" id="cSnakeNoDie"></label>
                    <label>Snake Speed <input type="range" id="cSnakeSpeed" min="40" max="200" step="5"></label>
                    <div class="smallHint">Speed: <span id="cSnakeSpeedV" style="color:rgba(255,210,170,.95);font-weight:950"></span></div>
                  </div>
                  <div id="tetrisCheats" style="display:none">
                    <label>No Game Over <input type="checkbox" id="cTNoOver"></label>
                    <label>Start Level <input type="number" id="cTLevel" min="1" max="20"></label>
                  </div>
                </div>

                <div class="card">
                  <div class="cardhead">
                    <div class="h">Tip</div>
                  </div>
                  <div class="smallHint">Timer + games works best as a break reset. Use <kbd>Break+Game</kbd>.</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL='https://cgmazcvmpcgistoimqlw.supabase.co'
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc'
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY)

marked.setOptions({
  breaks:true,
  highlight:(code,lang)=>{
    try{
      if(lang && hljs.getLanguage(lang)) return hljs.highlight(code,{language:lang}).value
      return hljs.highlightAuto(code).value
    }catch(e){
      return code
    }
  }
})

const $=id=>document.getElementById(id)

const gradeLabels={ '':'', '8th':'8th', '9th':'9th', '10th':'10th', '11th':'11th', '12th':'12th' }
const gradeOrder={ '':99, '8th':0, '9th':1, '10th':2, '11th':3, '12th':4 }

let user=null
let notes=[]
let links=[]
let activeId=null

let uiPrefs={sort:'updated_desc',previewFull:false,sidebarHidden:false,lastOpenNoteId:null}
let timerPresets={focus:25,break:5,long:15}
let gameCheats={snake:{highScore:0,noDie:false,speed:110},tetris:{highScore:0,noGameOver:false,startLevel:1}}
let currentSchool='Salesianum'

let autosaveT=null
let statusMode='idle'
let statusAt=0

let timerInterval=null
let timeLeft=25*60

let splitMode='split'
let splitSizes=[50,50]
let draggingDivider=false

let graphCanvas=null
let graphCtx=null
let graphNodes=[]
let graphEdges=[]
let graphPhysics=true
let gView={x:0,y:0,scale:1}
let gPan=false
let gPanStart=null
let gDragNode=null
let gAnim=null

let snakeCanvas=null
let snakeCtx=null
let snake=[]
let food=null
let dir={x:0,y:0}
let snakeScore=0
let snakeRunning=false
let snakeInterval=null
const S_GRID=20
const S_TILE=21

let tetrisCanvas=null
let tetrisCtx=null
let tBoard=null
let tPiece=null
let tScore=0
let tLines=0
let tLevel=1
let tRunning=false
let tDrop=0
let tLast=0
const TC=12,TR=24,TS=20
const T_COLORS=[null,'#ff6a00','#ffb100','#ff7e2b','#ff3b3b','#ff9a00','#ffcc00','#ff5500']
const T_SHAPES=[null,[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]]

function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function esc(s){return (s||'').replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}
function orderedPair(a,b){return a<b?[a,b]:[b,a]}
function now(){return Date.now()}
function fmtTime(d){
  try{return new Date(d).toLocaleString(undefined,{hour:'numeric',minute:'2-digit'})}catch(e){return ''}
}
function fmtShort(d){
  try{return new Date(d).toLocaleString(undefined,{month:'short',day:'numeric'})}catch(e){return ''}
}
function relTime(iso){
  if(!iso) return ''
  const t=new Date(iso).getTime()
  const diff=Math.max(0,Date.now()-t)
  const m=Math.floor(diff/60000)
  if(m<1) return 'just now'
  if(m<60) return m+'m ago'
  const h=Math.floor(m/60)
  if(h<24) return h+'h ago'
  const d=Math.floor(h/24)
  if(d<7) return d+'d ago'
  return fmtShort(iso)
}

function toast(title,body,type='ok'){
  const wrap=$('toastWrap')
  const el=document.createElement('div')
  el.className='toast '+(type==='ok'?'ok':type==='warn'?'warn':'bad')
  el.innerHTML='<div class="t1"></div><div class="t2"></div>'
  el.querySelector('.t1').textContent=title
  el.querySelector('.t2').textContent=body
  wrap.appendChild(el)
  setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(6px)'},2400)
  setTimeout(()=>{el.remove()},2900)
}

function setStatus(mode){
  statusMode=mode
  statusAt=Date.now()
  const el=$('saveStatus')
  const dot=el.querySelector('.dot')
  const txt=el.querySelectorAll('span')[1]
  if(mode==='saving'){
    dot.className='dot warn'
    txt.textContent='Saving...'
  }else if(mode==='saved'){
    dot.className='dot ok'
    txt.textContent='Saved '+fmtTime(Date.now())
  }else if(mode==='error'){
    dot.className='dot bad'
    txt.textContent='Save failed'
  }else if(mode==='offline'){
    dot.className='dot bad'
    txt.textContent='Offline'
  }else{
    dot.className='dot warn'
    txt.textContent='Not saved'
  }
}

async function ensureSettings(){
  const {data}=await supabase.from('user_settings').select('*').eq('user_id',user.id).maybeSingle()
  if(!data){
    const ins=await supabase.from('user_settings').insert({user_id:user.id}).select().single()
    if(ins.data) applySettings(ins.data)
  }else{
    applySettings(data)
  }
}

function applySettings(s){
  currentSchool=s.current_school||currentSchool
  uiPrefs=s.ui||uiPrefs
  timerPresets=s.timer||timerPresets
  gameCheats=s.game||gameCheats

  $('schoolText').textContent=currentSchool
  $('sort').value=uiPrefs.sort||'updated_desc'
  $('setSidebar').value=uiPrefs.sidebarHidden? '1':'0'
  $('setPreviewFull').value=uiPrefs.previewFull? '1':'0'
  $('setFocus').value=timerPresets.focus||25
  $('setBreak').value=timerPresets.break||5
  $('setLong').value=timerPresets.long||15

  if(uiPrefs.previewFull) document.body.classList.add('previewFull')
  else document.body.classList.remove('previewFull')

  syncCheatUI()
  updateTimerDisplay()
}

let settingsT=null
function saveSettings(){
  clearTimeout(settingsT)
  settingsT=setTimeout(async ()=>{
    await supabase.from('user_settings').upsert({
      user_id:user.id,
      current_school:currentSchool,
      ui:uiPrefs,
      timer:timerPresets,
      game:gameCheats
    })
  },250)
}

async function fetchLinks(){
  const {data}=await supabase.from('note_links').select('note_a,note_b').eq('user_id',user.id)
  links=data||[]
}

function rebuildLinkedOnClient(){
  const map={}
  notes.forEach(n=>map[n.id]=[])
  links.forEach(l=>{
    if(map[l.note_a]) map[l.note_a].push(l.note_b)
    if(map[l.note_b]) map[l.note_b].push(l.note_a)
  })
  notes=notes.map(n=>({...n,linked_notes:map[n.id]||[]}))
}

async function fetchNotes(){
  const {data}=await supabase.from('notes').select('*').eq('user_id',user.id).order('updated_at',{ascending:false})
  notes=(data||[]).map(n=>({...n,linked_notes:[]}))
  await fetchLinks()
  rebuildLinkedOnClient()
  renderList()
  const last=uiPrefs.lastOpenNoteId
  if(last && notes.some(n=>n.id===last)) loadNote(last)
  else if(notes.length) loadNote(notes[0].id)
  else setEmptyState()
}

function sortNotes(arr){
  const mode=uiPrefs.sort||'updated_desc'
  const copy=[...arr]
  if(mode==='title_asc'){
    copy.sort((a,b)=>((a.title||'').toLowerCase()).localeCompare((b.title||'').toLowerCase()))
  }else if(mode==='grade_asc'){
    copy.sort((a,b)=>(gradeOrder[a.grade||'']-gradeOrder[b.grade||''])||(((b.updated_at||'')>(a.updated_at||''))?1:-1))
  }else{
    copy.sort((a,b)=>((b.updated_at||'')>(a.updated_at||''))?1:-1)
  }
  return copy
}

function noteSnippet(n){
  const s=(n.content||'').replace(/\s+/g,' ').trim()
  if(!s) return 'No content yet.'
  return s.length>90? s.slice(0,90)+'â€¦' : s
}

function renderList(){
  const q=($('search').value||'').trim().toLowerCase()
  const sorted=sortNotes(notes)
  const groups={}
  sorted.forEach(n=>{
    const title=(n.title||'').toLowerCase()
    const body=(n.content||'').toLowerCase()
    if(q && !(title.includes(q)||body.includes(q))) return
    const g=n.grade||''
    if(!groups[g]) groups[g]=[]
    groups[g].push(n)
  })

  const order=['8th','9th','10th','11th','12th','']
  const wrap=$('noteList')
  let html=''
  let total=0
  order.forEach(g=>{
    const arr=groups[g]||[]
    if(!arr.length) return
    total+=arr.length
    const head=g?('Grade '+gradeLabels[g]):'Ungraded'
    html+='<div class="group"><div class="group-head"><div>'+head+'</div><div class="count">'+arr.length+'</div></div>'
    arr.forEach(n=>{
      const t=(n.title&&n.title.trim()?n.title:'Untitled')
      const tag=n.grade?('<div class="tag">'+gradeLabels[n.grade]+'</div>'):''
      const linked=(n.linked_notes||[]).length>0
      const draft=(!n.title && !n.content)
      const badges=[]
      if(linked) badges.push('<div class="badge link">LINK</div>')
      if(draft) badges.push('<div class="badge draft">DRAFT</div>')
      const isActive=n.id===activeId
      html+='<div class="note-card '+(isActive?'active':'')+'" data-id="'+n.id+'">'
      html+='<div class="note-title"><div class="t">'+escapeHtml(t)+'</div>'+tag+'</div>'
      html+='<div class="note-snippet">'+escapeHtml(noteSnippet(n))+'</div>'
      html+='<div class="note-meta"><div>'+escapeHtml(relTime(n.updated_at||n.created_at))+'</div><div class="badges">'+badges.join('')+'</div></div>'
      html+='</div>'
    })
    html+='</div>'
  })

  if(total===0){
    wrap.innerHTML='<div style="padding:22px 12px;color:rgba(238,242,255,.55);font-weight:850;line-height:1.7">No notes found.<br><span style="color:rgba(255,220,200,.95)">Try another search</span> or press <span style="font-family:var(--mono)">Ctrl+K</span>.</div>'
  }else{
    wrap.innerHTML=html
    wrap.querySelectorAll('.note-card').forEach(c=>{
      c.onclick=()=>loadNote(c.getAttribute('data-id'))
    })
  }
}

function setEmptyState(){
  activeId=null
  $('crumbTitle').textContent='No notes yet'
  $('crumbSub').innerHTML=''
  $('title').value=''
  $('body').value=''
  $('grade').value=''
  $('pTitle').textContent='Untitled'
  $('pMeta').innerHTML=''
  $('pBody').innerHTML='<div style="color:rgba(238,242,255,.55);font-weight:850;line-height:1.7">Create your first note using <span style="font-family:var(--mono)">New Note</span>.</div>'
  hideLinkCards()
}

function setView(v){
  $('viewEditor').classList.toggle('active',v==='editor')
  $('viewPreview').classList.toggle('active',v==='preview')
  $('viewGraph').classList.toggle('active',v==='graph')
  $('viewGames').classList.toggle('active',v==='games')

  $('modeEdit').classList.toggle('active',v==='editor')
  $('modePreview').classList.toggle('active',v==='preview')
  $('modeGraph').classList.toggle('active',v==='graph')

  if(v==='preview') updatePreview()
  if(v==='graph') drawGraph()
}

function setSplit(mode){
  splitMode=mode
  const split=$('split')
  split.classList.remove('singleEditor','singlePreview')
  $('divider').style.display='flex'
  $('paneRight').style.display='block'
  $('paneLeft').style.display='block'

  if(mode==='editor'){
    split.classList.add('singleEditor')
    $('paneRight').style.display='none'
    $('divider').style.display='none'
  }else if(mode==='preview'){
    split.classList.add('singlePreview')
    $('paneLeft').style.display='none'
    $('divider').style.display='none'
    updatePreviewInSide()
  }else{
    applySplitSizes()
    updatePreviewInSide()
  }
  $('toggleSplit').classList.toggle('active',mode==='split')
}

function applySplitSizes(){
  const split=$('split')
  const a=clamp(splitSizes[0],20,80)
  const b=100-a
  split.style.gridTemplateColumns=a+'% 12px '+b+'%'
}

function escapeHtml(s){
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')
}

async function createNote(){
  const {data,error}=await supabase.from('notes').insert({user_id:user.id,title:'',content:'',grade:'',school:currentSchool}).select().single()
  if(error){toast('Create failed',error.message,'bad');return}
  notes.unshift({...data,linked_notes:[]})
  uiPrefs.lastOpenNoteId=data.id
  saveSettings()
  renderList()
  loadNote(data.id)
  toast('New note','Created','ok')
}

function loadNote(id){
  const n=notes.find(x=>x.id===id)
  if(!n) return
  activeId=id
  uiPrefs.lastOpenNoteId=id
  saveSettings()

  $('title').value=n.title||''
  $('body').value=n.content||''
  $('grade').value=n.grade||''

  updateCrumb()
  renderList()
  updatePreview()
  refreshLinksUI()
  setStatus('saved')
}

function updateCrumb(){
  const n=notes.find(x=>x.id===activeId)
  const title=(n?.title&&n.title.trim()?n.title:'Untitled')
  $('crumbTitle').textContent=title
  const chips=[]
  if(n?.grade) chips.push('<span class="chip">Grade '+escapeHtml(gradeLabels[n.grade]||n.grade)+'</span>')
  chips.push('<span class="chip">'+escapeHtml(currentSchool)+'</span>')
  if(n?.updated_at) chips.push('<span class="chip">'+escapeHtml(relTime(n.updated_at))+'</span>')
  $('crumbSub').innerHTML=chips.join('')
}

function autosave(){
  if(!activeId) return
  if(!navigator.onLine){setStatus('offline');return}
  setStatus('saving')
  clearTimeout(autosaveT)
  autosaveT=setTimeout(()=>saveNote(),650)
}

async function saveNote(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  if(!n) return
  if(!navigator.onLine){setStatus('offline');return}
  setStatus('saving')
  const title=$('title').value
  const content=$('body').value
  const grade=$('grade').value||''
  const {error}=await supabase.from('notes').update({
    title:title,
    content:content,
    grade:grade,
    school:currentSchool,
    updated_at:new Date().toISOString()
  }).eq('id',activeId)

  if(error){
    setStatus('error')
    toast('Save failed',error.message,'bad')
    return
  }

  n.title=title
  n.content=content
  n.grade=grade
  n.school=currentSchool
  n.updated_at=new Date().toISOString()
  setStatus('saved')
  updateCrumb()
  renderList()
  updatePreview()
  refreshLinksUI()
}

async function deleteNote(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  const t=(n?.title&&n.title.trim()?n.title:'Untitled')
  if(!confirm('Delete "'+t+'"?')) return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  const {error}=await supabase.from('notes').delete().eq('id',activeId)
  if(error){toast('Delete failed',error.message,'bad');return}
  notes=notes.filter(x=>x.id!==activeId)
  links=links.filter(l=>l.note_a!==activeId && l.note_b!==activeId)
  rebuildLinkedOnClient()
  renderList()
  toast('Deleted',t,'warn')
  if(notes.length) loadNote(notes[0].id)
  else setEmptyState()
}

function updatePreview(){
  const n=notes.find(x=>x.id===activeId)
  const title=( $('title').value || (n?.title||'') || 'Untitled' ).trim() || 'Untitled'
  $('pTitle').textContent=title
  const meta=[]
  const g=$('grade').value||n?.grade||''
  if(g) meta.push('<span class="chip">Grade '+escapeHtml(gradeLabels[g]||g)+'</span>')
  meta.push('<span class="chip">'+escapeHtml(currentSchool)+'</span>')
  if(n?.updated_at) meta.push('<span class="chip">Updated '+escapeHtml(new Date(n.updated_at).toLocaleString())+'</span>')
  $('pMeta').innerHTML=meta.join('')
  const md=$('body').value||n?.content||''
  $('pBody').innerHTML=marked.parse(md)
  $('pBody').querySelectorAll('pre code').forEach(b=>{try{hljs.highlightElement(b)}catch(e){}})
  updatePreviewLinks()
  updatePreviewInSide()
}

function updatePreviewInSide(){
  if(splitMode==='preview'){
    setView('preview')
  }
}

function updatePreviewLinks(){
  const n=notes.find(x=>x.id===activeId)
  const ids=(n?.linked_notes||[])
  if(ids.length){
    $('pLinksCard').style.display='block'
    $('pLinks').innerHTML=ids.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-open="'+id+'">'+escapeHtml(t)+'</div>'
    }).join('')
    $('pLinks').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>loadNote(p.getAttribute('data-open')))
  }else{
    $('pLinksCard').style.display='none'
  }
}

function getBacklinks(id){
  const res=[]
  notes.forEach(n=>{
    if(n.id===id) return
    if((n.linked_notes||[]).includes(id)) res.push(n.id)
  })
  return res
}

function getUnlinkedMentions(){
  const cur=notes.find(x=>x.id===activeId)
  if(!cur) return []
  const content=($('body').value||'').toLowerCase()
  const linked=new Set(cur.linked_notes||[])
  const out=[]
  notes.forEach(o=>{
    if(o.id===activeId) return
    const t=(o.title||'').trim()
    if(!t) return
    if(t.length<4) return
    if(linked.has(o.id)) return
    if(content.includes(t.toLowerCase())) out.push(o.id)
  })
  return out.slice(0,18)
}

function hideLinkCards(){
  $('cardLinks').style.display='none'
  $('cardBack').style.display='none'
  $('cardMentions').style.display='none'
  $('cardDrop').style.display='none'
}

function refreshLinksUI(){
  const cur=notes.find(x=>x.id===activeId)
  if(!cur){hideLinkCards();return}
  const linked=cur.linked_notes||[]
  if(linked.length){
    $('cardLinks').style.display='block'
    $('linksPills').innerHTML=linked.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-open="'+id+'" data-id="'+id+'">'+escapeHtml(t)+'<div class="x" data-x="'+id+'">Ã—</div></div>'
    }).join('')
    $('linksPills').querySelectorAll('.pillnote').forEach(p=>{
      p.onclick=e=>{
        const xid=e.target?.getAttribute?.('data-x')
        if(xid){unlinkNote(xid);return}
        loadNote(p.getAttribute('data-open'))
      }
    })
  }else{
    $('cardLinks').style.display='none'
  }

  const bl=getBacklinks(activeId)
  if(bl.length){
    $('cardBack').style.display='block'
    $('backPills').innerHTML=bl.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-open="'+id+'">'+escapeHtml(t)+'</div>'
    }).join('')
    $('backPills').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>loadNote(p.getAttribute('data-open')))
  }else{
    $('cardBack').style.display='none'
  }

  const men=getUnlinkedMentions()
  if(men.length){
    $('cardMentions').style.display='block'
    $('menPills').innerHTML=men.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-link="'+id+'">'+escapeHtml(t)+'</div>'
    }).join('')
    $('menPills').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>linkNote(p.getAttribute('data-link')))
  }else{
    $('cardMentions').style.display='none'
  }
}

function showLinkDrop(list){
  $('cardDrop').style.display='block'
  const wrap=$('dropList')
  if(!list.length){
    wrap.innerHTML='<div style="padding:10px;color:rgba(238,242,255,.55);font-weight:850">No matches</div>'
    return
  }
  wrap.innerHTML=list.map(n=>{
    const t=(n.title&&n.title.trim()?n.title:'Untitled')
    const g=n.grade?(' Â· '+gradeLabels[n.grade]):''
    return '<div class="pillnote" style="width:100%;justify-content:space-between" data-pick="'+n.id+'"><span>'+escapeHtml(t)+'</span><span style="color:rgba(238,242,255,.45);font-weight:950;font-size:11px">'+escapeHtml(g)+'</span></div>'
  }).join('')
  wrap.querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>linkNote(p.getAttribute('data-pick')))
}

function searchLinkCandidates(){
  if(!activeId) return
  const cur=notes.find(x=>x.id===activeId)
  if(!cur) return
  const q=($('linkSearch').value||'').trim().toLowerCase()
  if(!q){$('cardDrop').style.display='none';return}
  const already=new Set(cur.linked_notes||[])
  const list=notes.filter(n=>n.id!==activeId)
    .filter(n=>!already.has(n.id))
    .filter(n=>((n.title||'').toLowerCase().includes(q)))
    .slice(0,8)
  showLinkDrop(list)
}

async function linkNote(lid){
  if(!activeId || !lid || activeId===lid) return
  const [a,b]=orderedPair(activeId,lid)
  const {error}=await supabase.from('note_links').upsert({user_id:user.id,note_a:a,note_b:b},{onConflict:'user_id,note_a,note_b'})
  if(error){toast('Link failed',error.message,'bad');return}
  $('linkSearch').value=''
  $('cardDrop').style.display='none'
  await fetchLinks()
  rebuildLinkedOnClient()
  refreshLinksUI()
  renderList()
  toast('Linked','Notes connected','ok')
}

async function unlinkNote(lid){
  if(!activeId || !lid) return
  const [a,b]=orderedPair(activeId,lid)
  const {error}=await supabase.from('note_links').delete().eq('user_id',user.id).eq('note_a',a).eq('note_b',b)
  if(error){toast('Unlink failed',error.message,'bad');return}
  await fetchLinks()
  rebuildLinkedOnClient()
  refreshLinksUI()
  renderList()
  toast('Unlinked','Connection removed','warn')
}

async function unlinkAll(){
  if(!activeId) return
  if(!confirm('Unlink all?')) return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  await fetchLinks()
  rebuildLinkedOnClient()
  refreshLinksUI()
  renderList()
  toast('Unlinked','All connections removed','warn')
}

async function linkAllMentions(){
  const ids=getUnlinkedMentions()
  for(const id of ids) await linkNote(id)
}

function applyMd(action){
  const ta=$('body')
  const start=ta.selectionStart
  const end=ta.selectionEnd
  const sel=ta.value.slice(start,end)
  const before=ta.value.slice(0,start)
  const after=ta.value.slice(end)
  let rep=''
  if(action==='bold') rep='**'+(sel||'bold')+'**'
  if(action==='italic') rep='*'+(sel||'italic')+'*'
  if(action==='h1') rep='# '+(sel||'Heading')
  if(action==='h2') rep='## '+(sel||'Heading')
  if(action==='ul') rep='- '+(sel||'Item')
  if(action==='ol') rep='1. '+(sel||'Item')
  if(action==='quote') rep='> '+(sel||'Quote')
  if(action==='code') rep='```\\n'+(sel||'code')+'\\n```'
  if(action==='link') rep='['+(sel||'text')+'](https://)'
  ta.value=before+rep+after
  const pos=before.length+rep.length
  ta.setSelectionRange(pos,pos)
  ta.focus()
  autosave()
  updatePreview()
  refreshLinksUI()
}

function openPdfModal(){ $('modalPdf').style.display='flex' }
function closePdfModal(){ $('modalPdf').style.display='none' }

async function exportPdf(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  if(!n) return
  const includeLinks=$('pdfIncludeLinks').value==='1'
  const includeDates=$('pdfIncludeDates').value==='1'

  const wrap=document.createElement('div')
  wrap.style.width='820px'
  wrap.style.padding='34px'
  wrap.style.background='#ffffff'
  wrap.style.color='#111111'
  wrap.style.fontFamily='Inter,Arial,sans-serif'
  wrap.style.lineHeight='1.7'

  const h=document.createElement('div')
  h.style.fontSize='34px'
  h.style.fontWeight='900'
  h.style.marginBottom='10px'
  h.textContent=(n.title&&n.title.trim()?n.title:'Untitled')
  wrap.appendChild(h)

  const meta=document.createElement('div')
  meta.style.display='flex'
  meta.style.flexWrap='wrap'
  meta.style.gap='8px'
  meta.style.marginBottom='18px'
  const chip=(txt)=>{
    const s=document.createElement('span')
    s.textContent=txt
    s.style.fontSize='12px'
    s.style.fontWeight='800'
    s.style.padding='6px 10px'
    s.style.borderRadius='999px'
    s.style.border='1px solid #e7e7e7'
    s.style.background='#fafafa'
    return s
  }
  if(n.grade) meta.appendChild(chip('Grade: '+(gradeLabels[n.grade]||n.grade)))
  meta.appendChild(chip('School: '+(n.school||currentSchool)))
  if(includeDates && n.created_at) meta.appendChild(chip('Created: '+new Date(n.created_at).toLocaleDateString()))
  if(includeDates && n.updated_at) meta.appendChild(chip('Updated: '+new Date(n.updated_at).toLocaleString()))
  wrap.appendChild(meta)

  const body=document.createElement('div')
  body.innerHTML=marked.parse(n.content||'')
  body.querySelectorAll('pre').forEach(p=>{
    p.style.background='#0f1117'
    p.style.color='#f5f5f5'
    p.style.padding='14px'
    p.style.borderRadius='12px'
    p.style.overflowX='auto'
  })
  body.querySelectorAll('code').forEach(c=>{
    c.style.fontFamily='JetBrains Mono,Consolas,monospace'
    c.style.fontSize='12px'
  })
  wrap.appendChild(body)

  if(includeLinks && (n.linked_notes||[]).length){
    const tt=document.createElement('div')
    tt.style.marginTop='22px'
    tt.style.fontWeight='900'
    tt.style.fontSize='16px'
    tt.textContent='Linked Notes'
    wrap.appendChild(tt)
    const ul=document.createElement('ul')
    ul.style.marginTop='8px'
    ul.style.paddingLeft='18px'
    ;(n.linked_notes||[]).forEach(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return
      const li=document.createElement('li')
      li.textContent=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      li.style.fontWeight='750'
      li.style.margin='6px 0'
      ul.appendChild(li)
    })
    wrap.appendChild(ul)
  }

  const {jsPDF}=window.jspdf
  const doc=new jsPDF('p','pt','a4')
  toast('Exporting','Rendering PDFâ€¦','warn')
  await doc.html(wrap,{
    x:24,
    y:24,
    width:547,
    windowWidth:820,
    html2canvas:{scale:1.25,backgroundColor:'#ffffff'}
  })
  doc.save(((n.title&&n.title.trim()?n.title:'note')+'.pdf').replace(/[\\/:*?"<>|]+/g,'_'))
  closePdfModal()
  toast('Exported','PDF saved','ok')
}

function openSettings(){ $('modalSettings').style.display='flex' }
function closeSettings(){ $('modalSettings').style.display='none' }
function saveSettingsFromModal(){
  uiPrefs.sidebarHidden=$('setSidebar').value==='1'
  uiPrefs.previewFull=$('setPreviewFull').value==='1'
  timerPresets.focus=clamp(parseInt($('setFocus').value||25,10),1,180)
  timerPresets.break=clamp(parseInt($('setBreak').value||5,10),1,60)
  timerPresets.long=clamp(parseInt($('setLong').value||15,10),1,120)
  applySettings({current_school:currentSchool,ui:uiPrefs,timer:timerPresets,game:gameCheats})
  saveSettings()
  closeSettings()
  toast('Saved','Settings synced','ok')
}

function toggleFullPreview(){
  uiPrefs.previewFull=!uiPrefs.previewFull
  if(uiPrefs.previewFull) document.body.classList.add('previewFull')
  else document.body.classList.remove('previewFull')
  saveSettings()
}

function openPalette(){
  $('paletteBack').style.display='flex'
  $('paletteQ').value=''
  renderPalette('')
  setTimeout(()=>$('paletteQ').focus(),0)
}
function closePalette(){ $('paletteBack').style.display='none' }

function renderPalette(q){
  const query=(q||'').toLowerCase().trim()
  const items=[]
  const add=(ico,a,b,k,fn)=>items.push({ico,a,b,k,fn})

  add('âœ','New note','Create a new note','Enter',()=>createNote())
  add('ğŸ“','Edit','Go to editor','Enter',()=>setView('editor'))
  add('ğŸ‘','Preview','Go to preview','Enter',()=>setView('preview'))
  add('ğŸ•¸','Graph','Open graph view','Enter',()=>setView('graph'))
  add('ğŸ®','Games','Open break games','Enter',()=>setView('games'))
  add('â›¶','Toggle full preview','Full-screen preview','Enter',()=>toggleFullPreview())
  add('ğŸ“„','Export PDF','Export current note','Enter',()=>openPdfModal())
  add('âš™','Settings','Open settings','Enter',()=>openSettings())
  if(activeId) add('ğŸ’¾','Save now','Force save','Enter',()=>saveNote())

  const noteHits=notes
    .map(n=>({id:n.id,title:(n.title&&n.title.trim()?n.title:'Untitled'),body:(n.content||'')}))
    .filter(n=>{
      if(!query) return false
      return n.title.toLowerCase().includes(query) || n.body.toLowerCase().includes(query)
    })
    .slice(0,10)
  noteHits.forEach(n=>add('ğŸ“Œ',n.title,'Open note','Enter',()=>loadNote(n.id)))

  const filtered=items.filter(it=>{
    if(!query) return true
    return it.a.toLowerCase().includes(query) || it.b.toLowerCase().includes(query)
  })

  const list=$('paletteList')
  list.innerHTML=filtered.map((it,i)=>{
    return '<div class="pItem" data-i="'+i+'"><div class="l"><div class="pIco">'+it.ico+'</div><div class="pTxt"><div class="pA">'+escapeHtml(it.a)+'</div><div class="pB">'+escapeHtml(it.b)+'</div></div></div><div class="pK">'+escapeHtml(it.k)+'</div></div>'
  }).join('')

  list.querySelectorAll('.pItem').forEach(row=>{
    row.onclick=()=>{
      const idx=parseInt(row.getAttribute('data-i'),10)
      closePalette()
      filtered[idx].fn()
    }
  })
}

function setTimer(min){
  pauseTimer()
  timeLeft=min*60
  updateTimerDisplay()
}
function updateTimerDisplay(){
  const m=Math.floor(timeLeft/60).toString().padStart(2,'0')
  const s=(timeLeft%60).toString().padStart(2,'0')
  $('timerText').textContent=m+':'+s
}
function startTimer(){
  if(timerInterval) return
  timerInterval=setInterval(()=>{
    if(timeLeft>0){timeLeft--;updateTimerDisplay()}
    else{
      pauseTimer()
      toast('Timer',"Time's up",'ok')
      try{new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play()}catch(e){}
    }
  },1000)
}
function pauseTimer(){clearInterval(timerInterval);timerInterval=null}
function resetTimer(){pauseTimer();setTimer(timerPresets.focus||25)}

function openMobileSidebar(){
  $('sidebar').classList.add('open')
  $('backdrop').classList.add('show')
}
function closeMobileSidebar(){
  $('sidebar').classList.remove('open')
  $('backdrop').classList.remove('show')
}

function maybeMobileUI(){
  const isMobile=window.innerWidth<=900
  $('mobileMenu').style.display=isMobile?'flex':'none'
}

function initSplitResize(){
  const div=$('divider')
  div.addEventListener('mousedown',e=>{
    draggingDivider=true
    document.body.style.cursor='col-resize'
  })
  window.addEventListener('mouseup',e=>{
    if(!draggingDivider) return
    draggingDivider=false
    document.body.style.cursor=''
  })
  window.addEventListener('mousemove',e=>{
    if(!draggingDivider) return
    const split=$('split')
    const rect=split.getBoundingClientRect()
    const x=e.clientX-rect.left
    const pct=clamp((x/rect.width)*100,20,80)
    splitSizes=[pct,100-pct]
    applySplitSizes()
  })
}

function initGraph(){
  graphCanvas=$('graph')
  graphCtx=graphCanvas.getContext('2d')
  resizeGraph()
  window.addEventListener('resize',()=>{resizeGraph();renderGraph()})
  graphCanvas.addEventListener('mousedown',gDown)
  graphCanvas.addEventListener('mousemove',gMove)
  graphCanvas.addEventListener('mouseup',gUp)
  graphCanvas.addEventListener('wheel',gWheel,{passive:false})
}

function resizeGraph(){
  const r=graphCanvas.getBoundingClientRect()
  graphCanvas.width=Math.floor(r.width*devicePixelRatio)
  graphCanvas.height=Math.floor(r.height*devicePixelRatio)
  graphCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0)
}

function buildGraph(){
  const W=graphCanvas.getBoundingClientRect().width
  const H=graphCanvas.getBoundingClientRect().height
  const N=notes.length||1
  graphNodes=notes.map((n,i)=>{
    const a=(i/N)*Math.PI*2
    const rad=Math.min(W,H)*0.25
    return{
      id:n.id,
      label:(n.title&&n.title.trim()?n.title:'Untitled'),
      x:Math.cos(a)*rad,
      y:Math.sin(a)*rad,
      vx:0,vy:0
    }
  })
  graphEdges=links.map(l=>({a:l.note_a,b:l.note_b}))
  gView={x:0,y:0,scale:1}
}

function worldToScreen(wx,wy){
  const r=graphCanvas.getBoundingClientRect()
  const cx=r.width/2, cy=r.height/2
  return { x:cx + gView.x + wx*gView.scale, y:cy + gView.y + wy*gView.scale }
}
function screenToWorld(sx,sy){
  const r=graphCanvas.getBoundingClientRect()
  const cx=r.width/2, cy=r.height/2
  return { x:(sx - cx - gView.x)/gView.scale, y:(sy - cy - gView.y)/gView.scale }
}
function hitNode(wx,wy){
  for(const n of graphNodes){
    const dx=n.x-wx
    const dy=n.y-wy
    if(Math.sqrt(dx*dx+dy*dy) < 22) return n
  }
  return null
}

function renderGraph(){
  const r=graphCanvas.getBoundingClientRect()
  const W=r.width,H=r.height
  graphCtx.clearRect(0,0,W,H)

  graphCtx.save()
  graphCtx.translate(W/2+gView.x, H/2+gView.y)
  graphCtx.scale(gView.scale,gView.scale)

  graphCtx.lineWidth=2/gView.scale
  graphEdges.forEach(e=>{
    const a=graphNodes.find(n=>n.id===e.a)
    const b=graphNodes.find(n=>n.id===e.b)
    if(!a||!b) return
    graphCtx.strokeStyle='rgba(255,106,0,.22)'
    graphCtx.beginPath()
    graphCtx.moveTo(a.x,a.y)
    graphCtx.lineTo(b.x,b.y)
    graphCtx.stroke()
  })

  graphNodes.forEach(n=>{
    const isActive=n.id===activeId
    const isLinked=graphEdges.some(e=>(e.a===activeId && e.b===n.id)||(e.b===activeId && e.a===n.id))
    const r=22
    graphCtx.fillStyle=isActive?'#ff6a00':(isLinked?'#22c55e':'rgba(255,255,255,.18)')
    graphCtx.beginPath()
    graphCtx.arc(n.x,n.y,r,0,Math.PI*2)
    graphCtx.fill()

    graphCtx.lineWidth=2/gView.scale
    graphCtx.strokeStyle='rgba(0,0,0,.35)'
    graphCtx.stroke()

    if(isActive||isLinked){
      graphCtx.shadowBlur=20/gView.scale
      graphCtx.shadowColor=isActive?'rgba(255,106,0,.65)':'rgba(34,197,94,.55)'
      graphCtx.beginPath()
      graphCtx.arc(n.x,n.y,r,0,Math.PI*2)
      graphCtx.strokeStyle='rgba(255,255,255,.25)'
      graphCtx.stroke()
      graphCtx.shadowBlur=0
    }

    graphCtx.fillStyle='rgba(238,242,255,.92)'
    graphCtx.font=(900/gView.scale)+'px Inter'
    graphCtx.textAlign='center'
    const label=n.label.length>18?n.label.slice(0,18)+'â€¦':n.label
    graphCtx.fillText(label,n.x,n.y+46)
  })

  graphCtx.restore()
}

function stepGraph(){
  if(!graphPhysics){renderGraph();gAnim=requestAnimationFrame(stepGraph);return}
  const nodes=graphNodes
  const edges=graphEdges
  for(const n of nodes){
    let fx=0,fy=0
    for(const o of nodes){
      if(o===n) continue
      const dx=n.x-o.x
      const dy=n.y-o.y
      const d=Math.sqrt(dx*dx+dy*dy)||1
      const f=1100/(d*d)
      fx+=(dx/d)*f
      fy+=(dy/d)*f
    }
    for(const e of edges){
      if(e.a!==n.id && e.b!==n.id) continue
      const oid=(e.a===n.id?e.b:e.a)
      const o=nodes.find(x=>x.id===oid)
      if(!o) continue
      fx+=(o.x-n.x)*0.012
      fy+=(o.y-n.y)*0.012
    }
    n.vx=(n.vx+fx)*0.88
    n.vy=(n.vy+fy)*0.88
  }
  for(const n of nodes){
    n.x+=n.vx
    n.y+=n.vy
  }
  renderGraph()
  gAnim=requestAnimationFrame(stepGraph)
}

function drawGraph(){
  if(!graphCanvas) return
  buildGraph()
  renderGraph()
  if(gAnim) cancelAnimationFrame(gAnim)
  gAnim=requestAnimationFrame(stepGraph)
}

function gDown(e){
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const w=screenToWorld(sx,sy)
  const node=hitNode(w.x,w.y)
  if(node){
    gDragNode=node
    graphPhysics=false
    return
  }
  gPan=true
  gPanStart={sx,sy,ox:gView.x,oy:gView.y}
}
function gMove(e){
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  if(gDragNode){
    const w=screenToWorld(sx,sy)
    gDragNode.x=w.x
    gDragNode.y=w.y
    renderGraph()
    return
  }
  if(gPan && gPanStart){
    gView.x=gPanStart.ox+(sx-gPanStart.sx)
    gView.y=gPanStart.oy+(sy-gPanStart.sy)
    renderGraph()
  }
}
function gUp(e){
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  if(gDragNode){
    const w=screenToWorld(sx,sy)
    const node=hitNode(w.x,w.y)
    const id=gDragNode.id
    gDragNode=null
    graphPhysics=true
    renderGraph()
    const clickNode=hitNode(w.x,w.y)
    if(clickNode && clickNode.id===id){
      loadNote(id)
      setView('editor')
    }
    return
  }
  gPan=false
  gPanStart=null
}
function gWheel(e){
  e.preventDefault()
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const before=screenToWorld(sx,sy)
  const delta=Math.sign(e.deltaY)
  const f=delta>0?0.92:1.08
  gView.scale=clamp(gView.scale*f,0.45,2.8)
  const after=screenToWorld(sx,sy)
  gView.x+=(after.x-before.x)*gView.scale
  gView.y+=(after.y-before.y)*gView.scale
  renderGraph()
}

function initGames(){
  snakeCanvas=$('snakeCanvas')
  snakeCtx=snakeCanvas.getContext('2d')
  tetrisCanvas=$('tetrisCanvas')
  tetrisCtx=tetrisCanvas.getContext('2d')
  resetSnake()
  resetTetris()
  syncCheatUI()
}

function syncCheatUI(){
  $('snakeBest').textContent=String(gameCheats.snake?.highScore||0)
  $('tBest').textContent=String(gameCheats.tetris?.highScore||0)
  $('cSnakeNoDie').checked=!!gameCheats.snake?.noDie
  $('cSnakeSpeed').value=gameCheats.snake?.speed??110
  $('cSnakeSpeedV').textContent=(gameCheats.snake?.speed??110)+'ms'
  $('cTNoOver').checked=!!gameCheats.tetris?.noGameOver
  $('cTLevel').value=gameCheats.tetris?.startLevel??1
}

function resetSnake(){
  snake=[{x:10,y:10}]
  dir={x:0,y:0}
  snakeScore=0
  spawnFood()
  $('snakeScore').textContent='0'
  drawSnake()
}
function spawnFood(){
  food={x:Math.floor(Math.random()*S_TILE),y:Math.floor(Math.random()*S_TILE)}
  if(snake.some(s=>s.x===food.x&&s.y===food.y)) spawnFood()
}
function startSnake(){
  stopSnake()
  resetSnake()
  snakeRunning=true
  dir={x:1,y:0}
  const sp=gameCheats.snake?.speed??110
  snakeInterval=setInterval(tickSnake,sp)
}
function stopSnake(){
  snakeRunning=false
  if(snakeInterval){clearInterval(snakeInterval);snakeInterval=null}
}
function tickSnake(){
  const head={x:(snake[0].x+dir.x+S_TILE)%S_TILE, y:(snake[0].y+dir.y+S_TILE)%S_TILE}
  if(!gameCheats.snake?.noDie){
    if(snake.some(s=>s.x===head.x&&s.y===head.y)){gameOverSnake();return}
  }
  snake.unshift(head)
  if(head.x===food.x&&head.y===food.y){
    snakeScore++
    $('snakeScore').textContent=String(snakeScore)
    spawnFood()
    if(snakeScore>(gameCheats.snake?.highScore||0)){
      gameCheats.snake.highScore=snakeScore
      $('snakeBest').textContent=String(snakeScore)
      saveSettings()
    }
  }else{
    snake.pop()
  }
  drawSnake()
}
function drawSnake(){
  const W=snakeCanvas.width,H=snakeCanvas.height
  snakeCtx.fillStyle='#050505'
  snakeCtx.fillRect(0,0,W,H)
  snakeCtx.strokeStyle='rgba(255,106,0,0.06)'
  snakeCtx.lineWidth=0.5
  const gs=W/S_TILE
  for(let i=0;i<=S_TILE;i++){
    snakeCtx.beginPath();snakeCtx.moveTo(i*gs,0);snakeCtx.lineTo(i*gs,H);snakeCtx.stroke()
    snakeCtx.beginPath();snakeCtx.moveTo(0,i*gs);snakeCtx.lineTo(W,i*gs);snakeCtx.stroke()
  }
  snake.forEach((seg,idx)=>{
    const x=seg.x*gs,y=seg.y*gs
    snakeCtx.fillStyle=idx===0?'#ff6a00':'rgba(255,177,0,'+(0.55-(idx/snake.length)*0.35)+')'
    snakeCtx.fillRect(x+1,y+1,gs-2,gs-2)
  })
  snakeCtx.fillStyle='#ffb100'
  snakeCtx.beginPath()
  snakeCtx.arc(food.x*gs+gs/2,food.y*gs+gs/2,gs/2-3,0,Math.PI*2)
  snakeCtx.fill()
}
function gameOverSnake(){
  stopSnake()
  drawSnake()
  const W=snakeCanvas.width,H=snakeCanvas.height
  snakeCtx.fillStyle='rgba(0,0,0,.75)'
  snakeCtx.fillRect(0,0,W,H)
  snakeCtx.fillStyle='#ff6a00'
  snakeCtx.font='900 28px Inter'
  snakeCtx.textAlign='center'
  snakeCtx.fillText('GAME OVER',W/2,H/2-10)
  snakeCtx.fillStyle='#ffb100'
  snakeCtx.font='900 16px Inter'
  snakeCtx.fillText('Score: '+snakeScore,W/2,H/2+18)
}

function resetTetris(){
  tBoard=Array.from({length:TR},()=>Array(TC).fill(0))
  tScore=0
  tLines=0
  tLevel=Math.max(1,gameCheats.tetris?.startLevel??1)
  $('tScore').textContent='0'
  $('tLines').textContent='0'
  $('tLevel').textContent=String(tLevel)
  $('tBest').textContent=String(gameCheats.tetris?.highScore||0)
  tPiece=makePiece()
  drawTetris()
}
function makePiece(){
  const t=Math.floor(Math.random()*7)+1
  const s=T_SHAPES[t]
  return{type:t,shape:s.map(r=>[...r]),x:Math.floor(TC/2)-Math.floor(s[0].length/2),y:0}
}
function tCollide(){
  for(let r=0;r<tPiece.shape.length;r++){
    for(let c=0;c<tPiece.shape[r].length;c++){
      if(!tPiece.shape[r][c]) continue
      const nx=tPiece.x+c
      const ny=tPiece.y+r
      if(nx<0||nx>=TC||ny>=TR) return true
      if(ny>=0 && tBoard[ny][nx]) return true
    }
  }
  return false
}
function tMove(dx,dy){
  tPiece.x+=dx
  tPiece.y+=dy
  if(tCollide()){
    tPiece.x-=dx
    tPiece.y-=dy
    if(dy>0) tLock()
  }
}
function tRotate(){
  const orig=tPiece.shape
  tPiece.shape=tPiece.shape[0].map((_,ci)=>tPiece.shape.map(row=>row[ci]).reverse())
  if(tCollide()) tPiece.shape=orig
}
function tHardDrop(){
  while(!tCollide()) tPiece.y++
  tPiece.y--
  tLock()
}
function tLock(){
  for(let r=0;r<tPiece.shape.length;r++){
    for(let c=0;c<tPiece.shape[r].length;c++){
      if(!tPiece.shape[r][c]) continue
      const ny=tPiece.y+r
      if(ny<0){
        if(gameCheats.tetris?.noGameOver){
          resetTetris()
          tRunning=true
          requestAnimationFrame(tLoop)
          return
        }
        tGameOver()
        return
      }
      tBoard[ny][tPiece.x+c]=tPiece.type
    }
  }
  clearLines()
  tPiece=makePiece()
  if(tCollide()){
    if(gameCheats.tetris?.noGameOver){
      resetTetris()
      tRunning=true
      requestAnimationFrame(tLoop)
      return
    }
    tGameOver()
  }
}
function clearLines(){
  let cleared=0
  for(let r=TR-1;r>=0;r--){
    if(tBoard[r].every(v=>v!==0)){
      tBoard.splice(r,1)
      tBoard.unshift(Array(TC).fill(0))
      cleared++
      r++
    }
  }
  if(cleared){
    tScore+=[0,100,300,500,800][cleared]*tLevel
    tLines+=cleared
    tLevel=Math.max(tLevel,Math.floor(tLines/10)+1)
    $('tScore').textContent=String(tScore)
    $('tLines').textContent=String(tLines)
    $('tLevel').textContent=String(tLevel)
    if(tScore>(gameCheats.tetris?.highScore||0)){
      gameCheats.tetris.highScore=tScore
      $('tBest').textContent=String(tScore)
      saveSettings()
    }
  }
}
function drawCell(c,r,col){
  const x=c*TS,y=r*TS
  tetrisCtx.fillStyle=col
  tetrisCtx.fillRect(x+1,y+1,TS-2,TS-2)
  tetrisCtx.fillStyle='rgba(255,255,255,.12)'
  tetrisCtx.fillRect(x+2,y+2,TS-6,3)
}
function drawTetris(){
  const W=tetrisCanvas.width,H=tetrisCanvas.height
  tetrisCtx.fillStyle='#050505'
  tetrisCtx.fillRect(0,0,W,H)
  tetrisCtx.strokeStyle='rgba(255,106,0,0.06)'
  tetrisCtx.lineWidth=0.5
  for(let r=0;r<=TR;r++){tetrisCtx.beginPath();tetrisCtx.moveTo(0,r*TS);tetrisCtx.lineTo(W,r*TS);tetrisCtx.stroke()}
  for(let c=0;c<=TC;c++){tetrisCtx.beginPath();tetrisCtx.moveTo(c*TS,0);tetrisCtx.lineTo(c*TS,H);tetrisCtx.stroke()}

  for(let r=0;r<TR;r++) for(let c=0;c<TC;c++) if(tBoard[r][c]) drawCell(c,r,T_COLORS[tBoard[r][c]])

  if(!tPiece) return
  for(let r=0;r<tPiece.shape.length;r++){
    for(let c=0;c<tPiece.shape[r].length;c++){
      if(!tPiece.shape[r][c]) continue
      drawCell(tPiece.x+c,tPiece.y+r,T_COLORS[tPiece.type])
    }
  }
}
function startTetris(){
  stopTetris()
  resetTetris()
  tRunning=true
  tDrop=0
  tLast=0
  requestAnimationFrame(tLoop)
}
function stopTetris(){tRunning=false}
function tLoop(time=0){
  if(!tRunning) return
  const dt=time-tLast
  tLast=time
  tDrop+=dt
  const speed=Math.max(85,700-(tLevel-1)*60)
  if(tDrop>=speed){
    tMove(0,1)
    tDrop=0
  }
  drawTetris()
  requestAnimationFrame(tLoop)
}
function tGameOver(){
  tRunning=false
  drawTetris()
  const W=tetrisCanvas.width,H=tetrisCanvas.height
  tetrisCtx.fillStyle='rgba(0,0,0,.75)'
  tetrisCtx.fillRect(0,0,W,H)
  tetrisCtx.fillStyle='#ff6a00'
  tetrisCtx.font='900 22px Inter'
  tetrisCtx.textAlign='center'
  tetrisCtx.fillText('GAME OVER',W/2,H/2-12)
  tetrisCtx.fillStyle='#ffb100'
  tetrisCtx.font='900 14px Inter'
  tetrisCtx.fillText('Score: '+tScore,W/2,H/2+14)
}

function switchGame(mode){
  const snake=mode==='snake'
  $('tabSnake').classList.toggle('active',snake)
  $('tabTetris').classList.toggle('active',!snake)
  $('snakeCanvas').style.display=snake?'block':'none'
  $('tetrisCanvas').style.display=snake?'none':'block'
  $('snakeScoreBox').style.display=snake?'block':'none'
  $('tetrisScoreBox').style.display=snake?'none':'block'
  $('snakeCheats').style.display=snake?'block':'none'
  $('tetrisCheats').style.display=snake?'none':'block'
  $('gTitle').textContent=snake?'Snake Break':'Tetris Break'
}

function initAuth(){
  let mode='signin'
  const setTabs=()=>{
    $('tabSignIn').classList.toggle('active',mode==='signin')
    $('tabSignUp').classList.toggle('active',mode==='signup')
    $('authGo').textContent=mode==='signin'?'Enter':'Create'
    $('authErr').textContent=''
  }
  $('tabSignIn').onclick=()=>{mode='signin';setTabs()}
  $('tabSignUp').onclick=()=>{mode='signup';setTabs()}
  $('authGo').onclick=async ()=>{
    const email=$('authEmail').value.trim()
    const pass=$('authPass').value
    if(!email||!pass){$('authErr').textContent='Enter email + password';return}
    if(mode==='signup'){
      const {error}=await supabase.auth.signUp({email:email,password:pass})
      if(error){$('authErr').textContent=error.message;return}
      toast('Check email','Confirm your account then sign in','ok')
    }else{
      const {error}=await supabase.auth.signInWithPassword({email:email,password:pass})
      if(error){$('authErr').textContent=error.message;return}
    }
  }
  $('authMagic').onclick=async ()=>{
    const email=$('authEmail').value.trim()
    if(!email){$('authErr').textContent='Enter email';return}
    const {error}=await supabase.auth.signInWithOtp({email:email})
    if(error){$('authErr').textContent=error.message;return}
    toast('Magic link sent','Check your email','ok')
  }
  $('authReset').onclick=async ()=>{
    const email=$('authEmail').value.trim()
    if(!email){$('authErr').textContent='Enter email';return}
    const {error}=await supabase.auth.resetPasswordForEmail(email)
    if(error){$('authErr').textContent=error.message;return}
    toast('Reset sent','Check your email','ok')
  }
  setTabs()
}

async function signOut(){
  await supabase.auth.signOut()
  location.reload()
}

function wireUI(){
  $('btnNew').onclick=createNote
  $('saveNow').onclick=saveNote
  $('delNote').onclick=deleteNote

  $('modeEdit').onclick=()=>setView('editor')
  $('modePreview').onclick=()=>setView('preview')
  $('modeGraph').onclick=()=>setView('graph')

  $('toggleFull').onclick=toggleFullPreview
  $('toggleSplit').onclick=()=>{
    if(splitMode==='split') setSplit('editor')
    else if(splitMode==='editor') setSplit('split')
    else setSplit('split')
  }

  $('doPdf').onclick=openPdfModal
  $('pdfClose').onclick=closePdfModal
  $('pdfCancel').onclick=closePdfModal
  $('pdfGo').onclick=exportPdf

  $('openSettings').onclick=openSettings
  $('setClose').onclick=closeSettings
  $('setCancel').onclick=closeSettings
  $('setSave').onclick=saveSettingsFromModal

  $('search').oninput=renderList
  $('sort').onchange=()=>{
    uiPrefs.sort=$('sort').value
    saveSettings()
    renderList()
  }

  $('openPalette').onclick=openPalette
  $('paletteBack').onclick=e=>{if(e.target.id==='paletteBack') closePalette()}
  $('paletteQ').oninput=()=>renderPalette($('paletteQ').value)
  $('paletteQ').onkeydown=e=>{
    if(e.key==='Escape'){closePalette();return}
    if(e.key==='Enter'){
      const first=$('paletteList').querySelector('.pItem')
      if(first) first.click()
    }
  }

  $('schoolPill').onclick=()=>{
    currentSchool=(currentSchool==='Salesianum')?'St Peter Cathedral':'Salesianum'
    $('schoolText').textContent=currentSchool
    saveSettings()
    autosave()
    updateCrumb()
    toast('School',currentSchool,'ok')
  }

  $('title').oninput=()=>{autosave();updatePreview();updateCrumb();renderList()}
  $('body').oninput=()=>{autosave();updatePreview();refreshLinksUI()}
  $('grade').onchange=()=>{autosave();updateCrumb();renderList();refreshLinksUI()}

  document.querySelectorAll('.tool').forEach(t=>{
    t.onclick=()=>applyMd(t.getAttribute('data-md'))
  })

  $('linkSearch').oninput=searchLinkCandidates
  $('closeDrop').onclick=()=>{$('cardDrop').style.display='none';$('linkSearch').value=''}
  $('unlinkAll').onclick=unlinkAll
  $('jumpPreview').onclick=()=>setView('preview')
  $('jumpGraph').onclick=()=>setView('graph')
  $('linkAllMentions').onclick=linkAllMentions
  $('backToEdit').onclick=()=>setView('editor')

  $('tStart').onclick=startTimer
  $('tPause').onclick=pauseTimer
  $('tReset').onclick=resetTimer
  $('mFocus').onclick=()=>setTimer(timerPresets.focus||25)
  $('mBreak').onclick=()=>setTimer(timerPresets.break||5)
  $('mLong').onclick=()=>setTimer(timerPresets.long||15)
  $('mBreakGame').onclick=()=>{setTimer(timerPresets.break||5);setView('games')}

  $('btnGames').onclick=()=>setView('games')

  $('tabSnake').onclick=()=>switchGame('snake')
  $('tabTetris').onclick=()=>switchGame('tetris')
  $('gStart').onclick=()=>{
    const snake=$('snakeCanvas').style.display!=='none'
    if(snake) startSnake()
    else startTetris()
  }
  $('gClose').onclick=()=>{
    stopSnake()
    stopTetris()
    setView('editor')
  }

  $('cSnakeNoDie').onchange=()=>{
    gameCheats.snake.noDie=$('cSnakeNoDie').checked
    saveSettings()
    toast('Cheat','Snake No-Die '+(gameCheats.snake.noDie?'ON':'OFF'),'warn')
  }
  $('cSnakeSpeed').oninput=()=>{
    const v=parseInt($('cSnakeSpeed').value,10)
    gameCheats.snake.speed=v
    $('cSnakeSpeedV').textContent=v+'ms'
    saveSettings()
    if(snakeRunning){
      clearInterval(snakeInterval)
      snakeInterval=setInterval(tickSnake,v)
    }
  }
  $('cTNoOver').onchange=()=>{
    gameCheats.tetris.noGameOver=$('cTNoOver').checked
    saveSettings()
    toast('Cheat','Tetris No Game Over '+(gameCheats.tetris.noGameOver?'ON':'OFF'),'warn')
  }
  $('cTLevel').onchange=()=>{
    const v=clamp(parseInt($('cTLevel').value||1,10),1,20)
    gameCheats.tetris.startLevel=v
    $('cTLevel').value=v
    saveSettings()
    toast('Cheat','Tetris Start Level '+v,'warn')
  }

  $('gReset').onclick=()=>{buildGraph();renderGraph()}
  $('gPhys').onclick=()=>{graphPhysics=!graphPhysics;toast('Graph','Physics '+(graphPhysics?'ON':'OFF'),'warn')}
  $('gCenter').onclick=()=>{gView={x:0,y:0,scale:1};renderGraph()}

  $('signOut').onclick=signOut

  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      if($('paletteBack').style.display==='flex') closePalette()
      if($('modalPdf').style.display==='flex') closePdfModal()
      if($('modalSettings').style.display==='flex') closeSettings()
      if(document.body.classList.contains('previewFull')) toggleFullPreview()
      closeMobileSidebar()
      return
    }
    const k=e.key.toLowerCase()
    if((e.ctrlKey||e.metaKey) && k==='k'){e.preventDefault();openPalette();return}
    if((e.ctrlKey||e.metaKey) && k==='s'){e.preventDefault();saveNote();return}

    if($('viewGames').classList.contains('active')){
      const snake=$('snakeCanvas').style.display!=='none'
      if(snake && snakeRunning){
        if((k==='arrowup'||k==='w') && dir.y===0) dir={x:0,y:-1}
        else if((k==='arrowdown'||k==='s') && dir.y===0) dir={x:0,y:1}
        else if((k==='arrowleft'||k==='a') && dir.x===0) dir={x:-1,y:0}
        else if((k==='arrowright'||k==='d') && dir.x===0) dir={x:1,y:0}
      }else if(!snake && tRunning){
        if(e.key==='ArrowLeft') tMove(-1,0)
        else if(e.key==='ArrowRight') tMove(1,0)
        else if(e.key==='ArrowDown') tMove(0,1)
        else if(e.key==='ArrowUp') tRotate()
        else if(e.key===' '){tHardDrop();e.preventDefault()}
      }
    }
  })

  $('backdrop').onclick=closeMobileSidebar
  $('mobileMenu').onclick=openMobileSidebar

  window.addEventListener('resize',maybeMobileUI)
  maybeMobileUI()

  window.addEventListener('online',()=>{if(activeId) setStatus('saved')})
  window.addEventListener('offline',()=>setStatus('offline'))
}

async function boot(){
  initAuth()
  initSplitResize()
  initGraph()
  initGames()
  wireUI()

  const sess=await supabase.auth.getSession()
  if(sess.data?.session){
    user=sess.data.session.user
    $('authBack').style.display='none'
    $('userEmail').textContent=user.email||'Signed in'
    $('avatar').textContent=((user.email||'U')[0]||'U').toUpperCase()
    await ensureSettings()
    await fetchNotes()
    setSplit('split')
    setStatus(navigator.onLine?'saved':'offline')
  }else{
    $('authBack').style.display='flex'
  }

  supabase.auth.onAuthStateChange(async (ev,session)=>{
    if(session){
      user=session.user
      $('authBack').style.display='none'
      $('userEmail').textContent=user.email||'Signed in'
      $('avatar').textContent=((user.email||'U')[0]||'U').toUpperCase()
      await ensureSettings()
      await fetchNotes()
      setSplit('split')
      setStatus(navigator.onLine?'saved':'offline')
    }else{
      $('authBack').style.display='flex'
    }
  })
}

boot()
</script>

</body>
</html>
