<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>StudyOS</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg:#07080a;
  --panel:#0e1116;
  --panel2:#10151d;
  --stroke:rgba(255,255,255,.10);
  --stroke2:rgba(255,255,255,.14);
  --text:#eef2ff;
  --muted:rgba(238,242,255,.55);
  --muted2:rgba(238,242,255,.35);
  --brand:#ff6a00;
  --brand2:#ffb100;
  --ok:#22c55e;
  --bad:#ff3b3b;
  --warn:#ffb100;
  --mono:'JetBrains Mono',ui-monospace,Menlo,monospace;
  --font:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --shadow:0 16px 55px rgba(0,0,0,.55);
  --shadow2:0 22px 80px rgba(0,0,0,.75);
  --side:320px;
  --top:66px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(255,106,0,.14), transparent 55%),
    radial-gradient(900px 600px at 110% 15%, rgba(255,177,0,.12), transparent 60%),
    linear-gradient(#07080a,#07080a);
  color:var(--text);
  font-family:var(--font);
  overflow:hidden;
}
button,input,select,textarea{font-family:var(--font)}
::selection{background:rgba(255,106,0,.35)}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px;border:2px solid rgba(0,0,0,0)}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18)}
::-webkit-scrollbar-track{background:transparent}

#dbBanner{
  position:fixed;top:0;left:0;right:0;z-index:9999;
  background:linear-gradient(90deg,rgba(180,20,20,.97),rgba(220,60,0,.97));
  color:#fff;padding:11px 20px;font-size:12px;font-weight:800;
  display:none;align-items:center;gap:10px;
  box-shadow:0 4px 24px rgba(0,0,0,.5);
}
#dbBanner code{background:rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;font-family:var(--mono);font-size:11px}
#dbBanner .dbx{margin-left:auto;cursor:pointer;font-size:18px;opacity:.7;line-height:1}
#dbBanner .dbx:hover{opacity:1}

.toastWrap{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:4000;pointer-events:none}
.toast{
  width:320px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(14,17,22,.88);
  backdrop-filter:blur(10px);
  box-shadow:var(--shadow);
  padding:12px 12px;
  pointer-events:none;
  transition:opacity .25s, transform .25s;
}
.toast .t1{font-weight:950;font-size:12px;margin-bottom:3px}
.toast .t2{font-weight:750;font-size:11px;color:rgba(238,242,255,.62);line-height:1.5}
.toast.ok{border-color:rgba(34,197,94,.28)}
.toast.warn{border-color:rgba(255,177,0,.28)}
.toast.bad{border-color:rgba(255,59,59,.32)}

.authBack{
  position:fixed;inset:0;
  background:
    radial-gradient(900px 650px at 20% 10%, rgba(255,106,0,.14), transparent 60%),
    radial-gradient(700px 520px at 90% 25%, rgba(255,177,0,.12), transparent 65%),
    rgba(0,0,0,.82);
  display:flex;align-items:center;justify-content:center;
  z-index:5000;
}
.authCard{
  width:92%;
  max-width:460px;
  border-radius:26px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(14,17,22,.90);
  box-shadow:var(--shadow2);
  padding:22px;
}
.authHead{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.logo{
  width:42px;height:42px;
  border-radius:14px;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:#fff;
  box-shadow:0 0 0 1px rgba(255,255,255,.14) inset, 0 14px 40px rgba(255,106,0,.18);
  user-select:none;
}
.authHead .t{font-weight:950;font-size:18px;letter-spacing:-.4px}
.authHead .s{font-weight:800;font-size:11px;color:rgba(238,242,255,.55);margin-top:2px}
.authTabs{display:flex;gap:10px;margin:10px 0 14px}
.atab{
  flex:1;text-align:center;
  padding:10px 10px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  font-weight:950;font-size:12px;
  cursor:pointer;user-select:none;
}
.atab.active{border-color:rgba(255,106,0,.55);background:linear-gradient(135deg, rgba(255,106,0,.18), rgba(255,177,0,.08))}
.authCard input{
  width:100%;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:var(--text);
  font-weight:850;
  margin-bottom:10px;
}
.authCard input:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:0 0 0 5px rgba(255,106,0,.10)}
.btn{
  border:1px solid var(--stroke2);
  background:rgba(255,255,255,.04);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:800;
  font-size:12px;
  transition:transform .15s, border-color .15s, background .15s, box-shadow .15s;
  user-select:none;
}
.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:rgba(255,106,0,.45);box-shadow:0 14px 38px rgba(0,0,0,.35)}
.btn:active{transform:translateY(0)}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#111}
.btn.primary:hover{border-color:transparent;box-shadow:0 18px 55px rgba(255,106,0,.16)}
.btn.ghost{background:transparent;border-color:rgba(255,255,255,.12)}
.authRow{display:flex;gap:10px;margin-top:6px}
.authRow .btn{flex:1}
.authErr{margin-top:10px;font-weight:850;font-size:12px;color:rgba(255,170,170,.95);min-height:16px}
.authSmall{margin-top:10px;display:flex;justify-content:space-between;gap:12px;color:rgba(238,242,255,.55);font-weight:850;font-size:11px}
.authSmall span{cursor:pointer;user-select:none}
.authSmall span:hover{color:rgba(255,220,200,.95)}

.app{height:100%;display:grid;grid-template-columns: var(--side) 1fr}
.sidebar{
  position:relative;
  background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
  border-right:1px solid var(--stroke);
  overflow:hidden;
}
.side-inner{height:100%;display:flex;flex-direction:column}
.brand{
  padding:18px 18px 14px;
  border-bottom:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,106,0,.08), rgba(255,255,255,0));
}
.brand-top{display:flex;align-items:center;gap:12px}
.brand-name{display:flex;flex-direction:column;gap:2px;min-width:0}
.brand-name .tt{font-weight:900;letter-spacing:-.5px;font-size:18px;white-space:nowrap}
.brand-name .ss{font-weight:700;color:var(--muted);font-size:11px}
.schoolRow{margin-top:10px;display:flex;gap:10px;align-items:center}
.schoolRow select{
  flex:1;border-radius:999px;border:1px solid rgba(255,106,0,.35);
  background:rgba(255,106,0,.10);color:rgba(255,220,200,.92);
  font-weight:900;font-size:11px;padding:8px 10px;cursor:pointer;
}
.side-actions{margin-top:12px;display:flex;gap:10px}

.search-wrap{padding:12px 18px 10px}
.search{
  width:100%;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.20);
  color:var(--text);
  padding:12px 12px;
  font-weight:750;
  font-size:12px;
  transition:border-color .15s, box-shadow .15s;
}
.search:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:0 0 0 4px rgba(255,106,0,.12)}
.search::placeholder{color:rgba(238,242,255,.35);font-weight:700}

.side-filters{padding:0 18px 10px;display:flex;gap:10px;align-items:center}
.side-filters select{
  flex:1;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);color:var(--text);
  padding:10px 10px;font-weight:850;font-size:11px;cursor:pointer;
}
.note-list{flex:1;overflow:auto;padding:10px 12px 14px}
.note-card{
  margin:8px 6px;padding:12px 12px;border-radius:16px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.10);
  cursor:pointer;
  transition:transform .13s, border-color .13s, background .13s, box-shadow .13s;
}
.note-card:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.35);background:rgba(255,255,255,.055);box-shadow:0 18px 45px rgba(0,0,0,.35)}
.note-card.active{border-color:rgba(255,106,0,.75);background:linear-gradient(180deg, rgba(255,106,0,.14), rgba(255,255,255,.04));box-shadow:0 25px 65px rgba(0,0,0,.45)}
.note-title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
.note-title .t{font-weight:900;font-size:13px;letter-spacing:-.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-title .tag{
  font-size:10px;padding:4px 9px;border-radius:999px;
  border:1px solid rgba(255,177,0,.30);color:rgba(255,212,150,.95);
  background:rgba(255,177,0,.08);font-weight:950;flex-shrink:0;
}
.note-snippet{color:rgba(238,242,255,.55);font-weight:650;font-size:11px;line-height:1.4;height:30px;overflow:hidden}
.note-meta{margin-top:10px;display:flex;justify-content:space-between;align-items:center;color:rgba(238,242,255,.35);font-weight:800;font-size:10px}

.side-footer{
  padding:12px 18px 14px;border-top:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.03));
  display:flex;flex-direction:column;gap:10px;
}
.timerbar{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;border-radius:16px;
}
.timerbar .time{
  font-family:var(--mono);font-size:18px;font-weight:950;letter-spacing:1px;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.timerbar .tbtns{display:flex;gap:8px}
.timerbar .tbtn{
  width:38px;height:34px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-weight:950;color:rgba(238,242,255,.9);
  transition:transform .12s, border-color .12s, background .12s;
}
.timerbar .tbtn:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.4);background:rgba(255,255,255,.06)}
.timer-modes{display:flex;gap:8px;flex-wrap:wrap}
.pill{
  padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);color:rgba(238,242,255,.75);
  font-weight:900;font-size:10px;cursor:pointer;user-select:none;
  transition:transform .12s,border-color .12s,background .12s;
}
.pill:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.4);background:rgba(255,255,255,.06)}
.userline{display:flex;align-items:center;justify-content:space-between;gap:12px;color:rgba(238,242,255,.65);font-weight:800;font-size:11px}
.userline .left{display:flex;align-items:center;gap:10px;min-width:0}
.avatar{
  width:34px;height:34px;border-radius:12px;
  background:linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.12);
  display:flex;align-items:center;justify-content:center;
  font-weight:950;color:rgba(238,242,255,.92);user-select:none;
}
.userline .email{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px;color:rgba(238,242,255,.8)}
.userline .out{padding:8px 10px;border-radius:14px}

.main{position:relative;overflow:hidden}
.topbar{
  height:var(--top);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 18px;border-bottom:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,0));
}
.top-left{display:flex;align-items:center;gap:12px;min-width:0}
.mode-tabs{display:flex;gap:8px;align-items:center}
.tab{
  padding:9px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);color:rgba(238,242,255,.78);
  font-weight:900;font-size:12px;cursor:pointer;user-select:none;
  transition:transform .12s, border-color .12s, background .12s;
}
.tab:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.35);background:rgba(255,255,255,.06)}
.tab.active{background:linear-gradient(135deg, rgba(255,106,0,.22), rgba(255,177,0,.10));border-color:rgba(255,106,0,.6);color:rgba(255,245,240,.98);box-shadow:0 18px 48px rgba(0,0,0,.35)}
.notecrumb{display:flex;flex-direction:column;gap:2px;min-width:0}
.notecrumb .title{font-weight:950;letter-spacing:-.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
.notecrumb .sub{font-weight:800;color:rgba(238,242,255,.55);font-size:11px;display:flex;gap:10px;flex-wrap:wrap}
.chip{padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(238,242,255,.7);font-weight:900;font-size:10px}

.top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.status{
  display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);
  font-weight:900;font-size:11px;color:rgba(238,242,255,.75);user-select:none;
}
.status.is-saving{border-color:rgba(255,177,0,.4)}
.status.is-saved{border-color:rgba(34,197,94,.35)}
.status.is-error{border-color:rgba(255,59,59,.4)}
.dot{width:8px;height:8px;border-radius:50%;transition:all .3s}
.dot.ok{background:var(--ok);box-shadow:0 0 16px rgba(34,197,94,.35)}
.dot.warn{background:var(--warn);box-shadow:0 0 16px rgba(255,177,0,.35);animation:dotPulse 1.1s ease infinite}
.dot.bad{background:var(--bad);box-shadow:0 0 16px rgba(255,59,59,.35)}
@keyframes dotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

.iconbtn{
  width:44px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-weight:950;font-size:13px;
  transition:transform .12s, border-color .12s, background .12s;
  user-select:none;
}
.iconbtn:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.35);background:rgba(255,255,255,.06)}
.iconbtn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#131313}
.iconbtn.primary:hover{border-color:transparent;box-shadow:0 18px 55px rgba(255,106,0,.18)}
.iconbtn.danger{border-color:rgba(255,59,59,.35);color:rgba(255,180,180,.95)}
.iconbtn.danger:hover{border-color:rgba(255,59,59,.7);background:rgba(255,59,59,.10)}
.iconbtn.wide{width:auto;padding:0 12px;gap:10px}
.iconbtn.wide span{font-weight:950;font-size:12px}

.content{height:calc(100% - var(--top));position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:none}
.view.active{display:block}

.editor-shell{height:100%;display:grid;grid-template-rows: 64px 1fr}
.toolbar{
  padding:12px 18px;border-bottom:1px solid var(--stroke);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
}
.lefttools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tool{
  padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);cursor:pointer;
  font-weight:950;font-size:11px;color:rgba(238,242,255,.84);
  transition:transform .12s, border-color .12s, background .12s;
  user-select:none;
}
.tool:hover{transform:translateY(-1px);border-color:rgba(255,106,0,.35);background:rgba(255,255,255,.06)}
.metapick{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.metapick select,.metapick input{
  border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);color:var(--text);
  padding:10px 10px;font-weight:850;font-size:11px;
}
.metapick input{width:260px}
.metapick input::placeholder{color:rgba(238,242,255,.35);font-weight:750}
.metapick input:focus,.metapick select:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:0 0 0 4px rgba(255,106,0,.10)}

.split{height:100%;display:grid;grid-template-columns: 1fr 12px 1fr;overflow:hidden}
.split.singleEditor{grid-template-columns: 1fr}
.split.singlePreview{grid-template-columns: 1fr}
.pane{height:100%;overflow:auto;padding:18px 18px 22px}
.divider{display:flex;align-items:center;justify-content:center;cursor:col-resize;user-select:none}
.divider::before{
  content:'';
  width:6px;height:55%;
  border-radius:999px;background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
  transition:background .12s,border-color .12s;
}
.divider:hover::before{background:rgba(255,106,0,.16);border-color:rgba(255,106,0,.35)}

.titleInput{
  width:100%;border:none;background:transparent;color:var(--text);
  font-weight:950;letter-spacing:-.9px;font-size:38px;padding:8px 0 12px;
}
.titleInput:focus{outline:none}
.titleInput::placeholder{color:rgba(238,242,255,.18)}

.bodyInput{
  width:100%;min-height:calc(100% - 70px);
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.18);
  color:rgba(238,242,255,.92);
  border-radius:18px;
  padding:16px 16px;
  font-family:var(--mono);
  font-size:14px;
  line-height:1.75;
  resize:none;
  transition:border-color .12s, box-shadow .12s;
}
.bodyInput:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:0 0 0 5px rgba(255,106,0,.10)}
.bodyInput::placeholder{color:rgba(238,242,255,.25)}

.preview{max-width:980px;margin:0 auto;padding:22px 24px 40px}
.preview h1{
  font-size:52px;font-weight:950;letter-spacing:-1.25px;margin-bottom:10px;
  background:linear-gradient(135deg, rgba(255,240,230,.98), rgba(255,210,170,.88));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.preview .metaRow{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
.preview .metaRow .chip{font-size:11px;padding:6px 10px}
.preview .body{font-size:16px;line-height:1.95;color:rgba(238,242,255,.92)}
.preview .body h2{margin-top:2.2em;margin-bottom:.7em;font-size:28px;color:rgba(255,210,170,.92);font-weight:950;letter-spacing:-.5px}
.preview .body h3{margin-top:1.8em;margin-bottom:.6em;font-size:22px;color:rgba(255,177,0,.92);font-weight:950}
.preview .body p{margin:1em 0}
.preview .body a{color:rgba(255,190,150,.95);font-weight:900;text-decoration:none;border-bottom:2px solid transparent}
.preview .body a:hover{border-bottom-color:rgba(255,190,150,.65)}
.preview .body code{
  font-family:var(--mono);font-size:.9em;padding:2px 7px;border-radius:10px;
  border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);
  color:rgba(255,220,170,.95);
}
.preview .body pre{
  margin:1.2em 0;border-radius:18px;border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.22);overflow:auto;padding:14px;
}
.preview .body pre code{background:transparent;border:none;padding:0;color:rgba(238,242,255,.92)}
.preview .body blockquote{
  margin:1.2em 0;padding:14px 16px;border-left:4px solid rgba(255,106,0,.85);
  background:rgba(255,255,255,.04);border-radius:0 18px 18px 0;
  color:rgba(238,242,255,.72);font-style:italic;
}
.preview .body ul,.preview .body ol{margin:1em 0 1em 1.4em}
.preview .body li{margin:.35em 0}

.graphWrap{height:100%;position:relative;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0))}
#graph{width:100%;height:100%;display:block}
.graphUI{position:absolute;top:14px;right:14px;display:flex;gap:10px}
.graphHint{
  position:absolute;left:14px;bottom:14px;padding:10px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);
  color:rgba(238,242,255,.70);font-weight:850;font-size:11px;
}

.modalBack{
  position:fixed;inset:0;background:rgba(0,0,0,.72);
  display:none;align-items:center;justify-content:center;z-index:3000;
  backdrop-filter:blur(10px);
}
.modal{
  width:92%;max-width:760px;border-radius:22px;border:1px solid rgba(255,255,255,.12);
  background:rgba(14,17,22,.92);box-shadow:var(--shadow2);overflow:hidden;
}
.modalTop{
  padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;align-items:center;justify-content:space-between;gap:14px;
}
.modalTop .h{font-weight:950;font-size:14px;letter-spacing:-.25px}
.modalBody{padding:16px 18px 18px}
.modalBody p{color:rgba(238,242,255,.62);font-weight:700;font-size:12px;line-height:1.7;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row input,.row select,.row textarea{
  flex:1;min-width:190px;padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);color:var(--text);font-weight:850;font-size:12px;
}
.row textarea{min-height:260px;font-family:var(--mono);font-weight:700;line-height:1.5}
.row input:focus,.row select:focus,.row textarea:focus{outline:none;border-color:rgba(255,106,0,.55);box-shadow:0 0 0 5px rgba(255,106,0,.10)}
.modalActions{padding:14px 18px 18px;display:flex;gap:10px;justify-content:flex-end}
.modalActions .btn{border-radius:16px}

.backdrop{
  position:fixed;inset:0;display:none;background:rgba(0,0,0,.6);z-index:2400;
}
.backdrop.show{display:block}
@media (max-width:900px){
  .app{grid-template-columns:1fr}
  .sidebar{position:fixed;left:-340px;top:0;bottom:0;width:320px;z-index:2500;transition:left .18s ease}
  .sidebar.open{left:0}
  #mobileMenu{display:flex!important}
  #mobileClose{display:flex!important}
  .metapick input{width:190px}
  .notecrumb .title{max-width:240px}
}
body.previewFull .sidebar{display:none}
body.previewFull .topbar{display:none}
body.previewFull .app{grid-template-columns:1fr}
body.previewFull .content{height:100%}
body.previewFull #viewPreview .preview{max-width:none;padding:44px 70px}
body.previewFull #viewPreview .preview h1{font-size:60px}
</style>
</head>

<body>
<div id="dbBanner">
  DB not ready. Open Settings ‚Üí copy SQL ‚Üí run in Supabase SQL editor.
  <code>notes</code> <code>note_links</code> <code>user_settings</code>
  <span class="dbx" onclick="this.parentElement.style.display='none'">‚úï</span>
</div>

<div class="toastWrap" id="toastWrap"></div>

<div class="modalBack" id="modalSettings">
  <div class="modal">
    <div class="modalTop">
      <div class="h">Settings</div>
      <div class="iconbtn" id="setClose">‚úï</div>
    </div>
    <div class="modalBody">
      <p>These sync across devices.</p>
      <div class="row">
        <select id="setPreviewFull">
          <option value="0">Preview Full-screen: Off</option>
          <option value="1">Preview Full-screen: On</option>
        </select>
        <select id="setSort">
          <option value="updated_desc">Sort: Updated</option>
          <option value="title_asc">Sort: Title</option>
          <option value="grade_asc">Sort: Grade</option>
        </select>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <input id="setFocus" type="number" min="1" max="180" placeholder="Focus minutes" />
        <input id="setBreak" type="number" min="1" max="60" placeholder="Break minutes" />
        <input id="setLong" type="number" min="1" max="120" placeholder="Long break minutes" />
      </div>
      <div style="height:10px"></div>
      <p>DB Setup (Supabase SQL Editor ‚Üí run). Safe to run multiple times.</p>
      <div class="row">
        <textarea id="dbSql" spellcheck="false"></textarea>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="copySql">Copy SQL</button>
        <button class="btn" id="testDb">Test DB</button>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="setCancel">Cancel</button>
      <button class="btn primary" id="setSave">Save</button>
    </div>
  </div>
</div>

<div class="authBack" id="authBack">
  <div class="authCard">
    <div class="authHead">
      <div class="logo">S</div>
      <div>
        <div class="t">StudyOS</div>
        <div class="s">Notes that actually stick.</div>
      </div>
    </div>
    <div class="authTabs">
      <div class="atab active" id="tabSignIn">Sign In</div>
      <div class="atab" id="tabSignUp">Sign Up</div>
    </div>
    <input id="authEmail" type="email" placeholder="Email" />
    <input id="authPass" type="password" placeholder="Password" />
    <div class="authRow">
      <button class="btn primary" id="authGo">Enter</button>
      <button class="btn ghost" id="authMagic">Magic Link</button>
    </div>
    <div class="authSmall">
      <span id="authReset">Forgot password?</span>
      <span id="authTip">Ctrl+S to save</span>
    </div>
    <div class="authErr" id="authErr"></div>
  </div>
</div>

<div class="backdrop" id="backdrop"></div>

<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="side-inner">
      <div class="brand">
        <div class="brand-top">
          <div class="logo">S</div>
          <div class="brand-name">
            <div class="tt">StudyOS</div>
            <div class="ss">edit ¬∑ preview ¬∑ graph</div>
          </div>
        </div>
        <div class="schoolRow">
          <select id="schoolSel"></select>
        </div>
        <div class="side-actions">
          <button class="btn primary" id="btnNew">New Note</button>
          <button class="btn" id="btnOpenSettings">Settings</button>
        </div>
      </div>

      <div class="search-wrap">
        <input class="search" id="search" placeholder="Search titles + content" />
      </div>

      <div class="side-filters">
        <select id="sort">
          <option value="updated_desc">Sort: Updated</option>
          <option value="title_asc">Sort: Title</option>
          <option value="grade_asc">Sort: Grade</option>
        </select>
        <button class="btn" id="mobileClose" style="display:none">‚úï</button>
      </div>

      <div class="note-list" id="noteList"></div>

      <div class="side-footer">
        <div class="timerbar">
          <div class="time" id="timerText">25:00</div>
          <div class="tbtns">
            <div class="tbtn" id="tStart">‚ñ∂</div>
            <div class="tbtn" id="tPause">‚è∏</div>
            <div class="tbtn" id="tReset">‚Ü∫</div>
          </div>
        </div>
        <div class="timer-modes">
          <div class="pill" id="mFocus">Focus</div>
          <div class="pill" id="mBreak">Break</div>
          <div class="pill" id="mLong">Long</div>
        </div>
        <div class="userline">
          <div class="left">
            <div class="avatar" id="avatar">U</div>
            <div class="email" id="userEmail">Signed out</div>
          </div>
          <button class="btn ghost out" id="signOut">Sign out</button>
        </div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="top-left">
        <div class="mode-tabs">
          <div class="tab active" id="modeEdit">Edit</div>
          <div class="tab" id="modePreview">Preview</div>
          <div class="tab" id="modeGraph">Graph</div>
        </div>
        <div class="notecrumb">
          <div class="title" id="crumbTitle">No note selected</div>
          <div class="sub" id="crumbSub"></div>
        </div>
      </div>

      <div class="top-right">
        <div class="status" id="saveStatus"><span class="dot warn"></span><span>Not saved</span></div>
        <div class="iconbtn wide" id="toggleSplit"><span>Split</span></div>
        <div class="iconbtn wide" id="toggleFull"><span>Full</span></div>
        <div class="iconbtn wide" id="doPdf"><span>PDF</span></div>
        <div class="iconbtn primary" id="saveNow">Save</div>
        <div class="iconbtn danger" id="delNote">üóë</div>
        <div class="iconbtn" id="mobileMenu" style="display:none">‚ò∞</div>
      </div>
    </div>

    <div class="content">
      <section class="view active" id="viewEditor">
        <div class="editor-shell">
          <div class="toolbar">
            <div class="lefttools">
              <div class="tool" data-md="bold">B</div>
              <div class="tool" data-md="italic">I</div>
              <div class="tool" data-md="h1">H1</div>
              <div class="tool" data-md="h2">H2</div>
              <div class="tool" data-md="ul">‚Ä¢ List</div>
              <div class="tool" data-md="ol">1. List</div>
              <div class="tool" data-md="quote">Quote</div>
              <div class="tool" data-md="code">Code</div>
              <div class="tool" data-md="link">Link</div>
            </div>
            <div class="metapick">
              <select id="grade">
                <option value="">Grade: (none)</option>
                <option value="7th">7th</option>
                <option value="8th">8th</option>
                <option value="9th">9th</option>
                <option value="10th">10th</option>
                <option value="11th">11th</option>
                <option value="12th">12th</option>
              </select>
              <input id="linkSearch" placeholder="Type a note title to link..." />
            </div>
          </div>

          <div class="split" id="split">
            <div class="pane" id="paneLeft">
              <input class="titleInput" id="title" placeholder="Untitled" />
              <textarea class="bodyInput" id="body" placeholder="Write in Markdown..."></textarea>
            </div>

            <div class="divider" id="divider"></div>

            <div class="pane" id="paneRight">
              <div class="preview" id="sidePreview">
                <h1 id="pTitle">Untitled</h1>
                <div class="metaRow" id="pMeta"></div>
                <div class="body" id="pBody"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="viewPreview">
        <div class="preview" id="mainPreview">
          <h1 id="pTitle2">Untitled</h1>
          <div class="metaRow" id="pMeta2"></div>
          <div class="body" id="pBody2"></div>
        </div>
      </section>

      <section class="view" id="viewGraph">
        <div class="graphWrap">
          <canvas id="graph"></canvas>
          <div class="graphUI">
            <div class="iconbtn wide" id="gReset"><span>Reset</span></div>
            <div class="iconbtn wide" id="gPhys"><span>Physics</span></div>
            <div class="iconbtn wide" id="gCenter"><span>Center</span></div>
          </div>
          <div class="graphHint">Drag to pan ¬∑ Scroll to zoom ¬∑ Drag nodes ¬∑ Click node to open</div>
        </div>
      </section>
    </div>
  </main>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"

const SUPABASE_URL = "https://cgmazcvmpcgistoimqlw.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc"
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

marked.setOptions({
  breaks: true,
  highlight: (code, lang) => {
    try{
      if(lang && hljs.getLanguage(lang)) return hljs.highlight(code,{language:lang}).value
      return hljs.highlightAuto(code).value
    }catch(e){
      return code
    }
  }
})

const $ = id => document.getElementById(id)

const SCHOOLS = ["Salesianum","St Peter Cathedral","Conrad Schools of Science","Charter School of Wilmington","Cab Calloway","Appoquinimink","Other"]
const gradeOrder = {"":99,"7th":0,"8th":1,"9th":2,"10th":3,"11th":4,"12th":5}

const DB_SQL =
`create extension if not exists pgcrypto;

create table if not exists public.notes(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  title text not null default '',
  content text not null default '',
  grade text not null default '',
  school text not null default '',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create or replace function public.set_updated_at() returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end;
$$;

do $$
begin
  if not exists(select 1 from pg_trigger where tgname='notes_set_updated_at') then
    create trigger notes_set_updated_at before update on public.notes for each row execute function public.set_updated_at();
  end if;
end$$;

create table if not exists public.note_links(
  id bigserial primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  note_a uuid not null references public.notes(id) on delete cascade,
  note_b uuid not null references public.notes(id) on delete cascade,
  created_at timestamptz not null default now(),
  constraint note_links_order check (note_a < note_b)
);

do $$
begin
  if not exists(select 1 from pg_indexes where schemaname='public' and indexname='note_links_unique') then
    create unique index note_links_unique on public.note_links(user_id, note_a, note_b);
  end if;
end$$;

create table if not exists public.user_settings(
  user_id uuid primary key references auth.users(id) on delete cascade,
  current_school text not null default '',
  ui jsonb not null default '{}'::jsonb,
  timer jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

do $$
begin
  if not exists(select 1 from pg_trigger where tgname='user_settings_set_updated_at') then
    create trigger user_settings_set_updated_at before update on public.user_settings for each row execute function public.set_updated_at();
  end if;
end$$;

do $$ begin execute 'alter table public.notes enable row level security'; exception when others then end $$;
do $$ begin execute 'alter table public.note_links enable row level security'; exception when others then end $$;
do $$ begin execute 'alter table public.user_settings enable row level security'; exception when others then end $$;

do $$
begin
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='notes' and policyname='notes_select_own') then
    create policy notes_select_own on public.notes for select using (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='notes' and policyname='notes_insert_own') then
    create policy notes_insert_own on public.notes for insert with check (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='notes' and policyname='notes_update_own') then
    create policy notes_update_own on public.notes for update using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='notes' and policyname='notes_delete_own') then
    create policy notes_delete_own on public.notes for delete using (auth.uid() = user_id);
  end if;

  if not exists(select 1 from pg_policies where schemaname='public' and tablename='note_links' and policyname='links_select_own') then
    create policy links_select_own on public.note_links for select using (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='note_links' and policyname='links_insert_own') then
    create policy links_insert_own on public.note_links for insert with check (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='note_links' and policyname='links_delete_own') then
    create policy links_delete_own on public.note_links for delete using (auth.uid() = user_id);
  end if;

  if not exists(select 1 from pg_policies where schemaname='public' and tablename='user_settings' and policyname='settings_select_own') then
    create policy settings_select_own on public.user_settings for select using (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='user_settings' and policyname='settings_upsert_own') then
    create policy settings_upsert_own on public.user_settings for insert with check (auth.uid() = user_id);
  end if;
  if not exists(select 1 from pg_policies where schemaname='public' and tablename='user_settings' and policyname='settings_update_own') then
    create policy settings_update_own on public.user_settings for update using (auth.uid() = user_id) with check (auth.uid() = user_id);
  end if;
end$$;`

let user = null
let notes = []
let links = []
let activeId = null

let uiPrefs = { sort:"updated_desc", previewFull:false, lastOpenNoteId:null }
let timerPresets = { focus:25, break:5, long:15 }
let currentSchool = "Salesianum"

let autosaveT = null
let autosaveDirty = false

let timerInterval = null
let timeLeft = 25*60
let timerMode = "focus"

let splitMode = "split"

let graphCanvas = null
let graphCtx = null
let graphNodes = []
let graphEdges = []
let graphPhysics = true
let gView = { x:0, y:0, scale:1 }
let gPan = false
let gPanStart = null
let gDragNode = null

function clamp(n,a,b){ return Math.max(a,Math.min(b,n)) }
function orderedPair(a,b){ return a<b ? [a,b] : [b,a] }
function esc(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;") }
function relTime(iso){
  if(!iso) return ""
  const t = new Date(iso).getTime()
  const diff = Math.max(0, Date.now()-t)
  const m = Math.floor(diff/60000)
  if(m<1) return "just now"
  if(m<60) return m+"m ago"
  const h = Math.floor(m/60)
  if(h<24) return h+"h ago"
  const d = Math.floor(h/24)
  if(d<7) return d+"d ago"
  try{ return new Date(iso).toLocaleDateString(undefined,{month:"short",day:"numeric"}) }catch(e){ return "" }
}

function toast(title, body, type="ok"){
  const wrap = $("toastWrap")
  const el = document.createElement("div")
  el.className = "toast "+(type==="ok"?"ok":type==="warn"?"warn":"bad")
  el.innerHTML = '<div class="t1"></div><div class="t2"></div>'
  el.querySelector(".t1").textContent = title
  el.querySelector(".t2").textContent = body
  wrap.appendChild(el)
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)" },2400)
  setTimeout(()=>{ el.remove() },2900)
}

function setStatus(mode){
  const el = $("saveStatus")
  const dot = el.querySelector(".dot")
  const txt = el.querySelectorAll("span")[1]
  el.classList.remove("is-saving","is-saved","is-error")
  if(mode==="saving"){
    dot.className="dot warn"
    txt.textContent="Saving‚Ä¶"
    el.classList.add("is-saving")
  }else if(mode==="saved"){
    dot.className="dot ok"
    txt.textContent="Saved"
    el.classList.add("is-saved")
  }else if(mode==="error"){
    dot.className="dot bad"
    txt.textContent="Save failed"
    el.classList.add("is-error")
    $("dbBanner").style.display="flex"
  }else{
    dot.className="dot warn"
    txt.textContent="Not saved"
  }
}

function openView(which){
  $("viewEditor").classList.remove("active")
  $("viewPreview").classList.remove("active")
  $("viewGraph").classList.remove("active")
  $("modeEdit").classList.remove("active")
  $("modePreview").classList.remove("active")
  $("modeGraph").classList.remove("active")
  if(which==="edit"){
    $("viewEditor").classList.add("active")
    $("modeEdit").classList.add("active")
  }else if(which==="preview"){
    $("viewPreview").classList.add("active")
    $("modePreview").classList.add("active")
  }else{
    $("viewGraph").classList.add("active")
    $("modeGraph").classList.add("active")
    requestGraphRender()
  }
}

function setSplitMode(mode){
  splitMode = mode
  const s = $("split")
  s.classList.remove("singleEditor","singlePreview")
  if(mode==="editor") s.classList.add("singleEditor")
  if(mode==="preview") s.classList.add("singlePreview")
}

function metaChips(note){
  const chips = []
  if(note.school) chips.push({t:note.school})
  if(note.grade) chips.push({t:note.grade})
  if(note.updated_at) chips.push({t:"Updated "+relTime(note.updated_at)})
  return chips
}

function renderPreview(note){
  const title = note?.title || "Untitled"
  const grade = note?.grade || ""
  const school = note?.school || ""
  const body = note?.content || ""

  $("pTitle").textContent = title
  $("pTitle2").textContent = title

  const chips = metaChips({grade,school,updated_at:note?.updated_at})
  const html = chips.map(c=>'<div class="chip">'+esc(c.t)+'</div>').join("")
  $("pMeta").innerHTML = html
  $("pMeta2").innerHTML = html

  const out = marked.parse(body)
  $("pBody").innerHTML = out
  $("pBody2").innerHTML = out
  $("pBody").querySelectorAll("pre code").forEach(b=>hljs.highlightElement(b))
  $("pBody2").querySelectorAll("pre code").forEach(b=>hljs.highlightElement(b))
}

function setCrumb(note){
  if(!note){
    $("crumbTitle").textContent = "No note selected"
    $("crumbSub").innerHTML = ""
    return
  }
  $("crumbTitle").textContent = note.title || "Untitled"
  const chips = []
  if(note.school) chips.push(note.school)
  if(note.grade) chips.push(note.grade)
  if(note.linked_notes?.length) chips.push(note.linked_notes.length+" link"+(note.linked_notes.length===1?"":"s"))
  $("crumbSub").innerHTML = chips.map(t=>'<div class="chip">'+esc(t)+'</div>').join("")
}

function currentNote(){
  return notes.find(n=>n.id===activeId) || null
}

function listFiltered(){
  const q = ($("search").value||"").trim().toLowerCase()
  let arr = notes.filter(n => (currentSchool ? n.school===currentSchool : true))
  if(q){
    arr = arr.filter(n => (n.title||"").toLowerCase().includes(q) || (n.content||"").toLowerCase().includes(q))
  }
  const sort = $("sort").value
  if(sort==="updated_desc"){
    arr.sort((a,b)=>new Date(b.updated_at||0)-new Date(a.updated_at||0))
  }else if(sort==="title_asc"){
    arr.sort((a,b)=>(a.title||"").localeCompare((b.title||""),undefined,{sensitivity:"base"}))
  }else if(sort==="grade_asc"){
    arr.sort((a,b)=>(gradeOrder[a.grade||""]-gradeOrder[b.grade||""]) || (a.title||"").localeCompare((b.title||"")))
  }
  return arr
}

function renderList(){
  const wrap = $("noteList")
  const arr = listFiltered()
  wrap.innerHTML = ""
  arr.forEach(n=>{
    const card = document.createElement("div")
    card.className = "note-card"+(n.id===activeId?" active":"")
    const tag = n.grade ? '<div class="tag">'+esc(n.grade)+'</div>' : ""
    const snippet = (n.content||"").replace(/\s+/g," ").trim().slice(0,80)
    card.innerHTML =
      '<div class="note-title"><div class="t"></div>'+tag+'</div>'+
      '<div class="note-snippet"></div>'+
      '<div class="note-meta"><div>'+esc(n.school||"")+'</div><div>'+esc(relTime(n.updated_at))+'</div></div>'
    card.querySelector(".t").textContent = n.title || "Untitled"
    card.querySelector(".note-snippet").textContent = snippet || "..."
    card.onclick = ()=>openNote(n.id,true)
    wrap.appendChild(card)
  })
  if(!arr.length){
    const empty = document.createElement("div")
    empty.style.padding="18px 12px"
    empty.style.color="rgba(238,242,255,.55)"
    empty.style.fontWeight="800"
    empty.style.fontSize="12px"
    empty.textContent = "No notes yet. Hit New Note."
    wrap.appendChild(empty)
  }
}

function fillSchoolSelect(){
  const sel = $("schoolSel")
  sel.innerHTML = ""
  SCHOOLS.forEach(s=>{
    const o = document.createElement("option")
    o.value = s
    o.textContent = s
    sel.appendChild(o)
  })
  sel.value = currentSchool
}

async function fetchLinks(){
  const { data, error } = await supabase.from("note_links").select("note_a,note_b").eq("user_id", user.id)
  if(error){ links=[]; return }
  links = data || []
}

function rebuildLinkedOnClient(){
  const map = {}
  notes.forEach(n=>map[n.id]=[])
  links.forEach(l=>{
    if(map[l.note_a]) map[l.note_a].push(l.note_b)
    if(map[l.note_b]) map[l.note_b].push(l.note_a)
  })
  notes = notes.map(n=>({...n, linked_notes: map[n.id] || []}))
}

async function fetchNotes(){
  const { data, error } = await supabase.from("notes").select("*").eq("user_id", user.id).order("updated_at",{ascending:false})
  if(error){
    $("dbBanner").style.display="flex"
    toast("Could not load notes", error.message, "bad")
    return
  }
  $("dbBanner").style.display="none"
  notes = (data||[]).map(n=>({...n, linked_notes:[]}))
  await fetchLinks()
  rebuildLinkedOnClient()
  renderList()
}

async function ensureSettings(){
  const { data, error } = await supabase.from("user_settings").select("*").eq("user_id", user.id).maybeSingle()
  if(error){
    await supabase.from("user_settings").upsert({ user_id:user.id, current_school:currentSchool, ui:uiPrefs, timer:timerPresets },{ onConflict:"user_id" })
    return
  }
  if(!data){
    await supabase.from("user_settings").upsert({ user_id:user.id, current_school:currentSchool, ui:uiPrefs, timer:timerPresets },{ onConflict:"user_id" })
    return
  }
  currentSchool = data.current_school || currentSchool
  uiPrefs = data.ui || uiPrefs
  timerPresets = data.timer || timerPresets
  $("sort").value = uiPrefs.sort || "updated_desc"
  $("setSort").value = uiPrefs.sort || "updated_desc"
  $("setPreviewFull").value = uiPrefs.previewFull ? "1" : "0"
  $("setFocus").value = timerPresets.focus || 25
  $("setBreak").value = timerPresets.break || 5
  $("setLong").value = timerPresets.long || 15
  if(uiPrefs.previewFull) document.body.classList.add("previewFull")
  else document.body.classList.remove("previewFull")
  fillSchoolSelect()
  $("schoolSel").value = currentSchool
  setTimerMode(timerMode,false)
}

let settingsSaveT = null
function saveSettings(){
  if(!user) return
  clearTimeout(settingsSaveT)
  settingsSaveT = setTimeout(async ()=>{
    await supabase.from("user_settings").upsert({
      user_id:user.id,
      current_school:currentSchool,
      ui:uiPrefs,
      timer:timerPresets
    },{ onConflict:"user_id" })
  },250)
}

function setUserUI(u){
  $("userEmail").textContent = u ? (u.email||"Signed in") : "Signed out"
  const letter = (u?.email||"U").trim().slice(0,1).toUpperCase()
  $("avatar").textContent = letter || "U"
}

function showAuth(show){
  $("authBack").style.display = show ? "flex" : "none"
}

function setAuthErr(msg){
  $("authErr").textContent = msg || ""
}

async function hardRefresh(){
  await ensureSettings()
  await fetchNotes()
  const last = uiPrefs.lastOpenNoteId
  if(last && notes.some(n=>n.id===last)) openNote(last,false)
  else if(notes.length) openNote(notes[0].id,false)
  else setEmptyEditor()
  buildGraph()
  requestGraphRender()
}

function setEmptyEditor(){
  activeId = null
  $("title").value = ""
  $("body").value = ""
  $("grade").value = ""
  $("linkSearch").value = ""
  renderPreview({title:"Untitled",content:"",grade:"",school:currentSchool})
  setCrumb(null)
  setStatus("idle")
}

function setEditorFromNote(note){
  $("title").value = note.title || ""
  $("body").value = note.content || ""
  $("grade").value = note.grade || ""
  renderPreview(note)
  setCrumb(note)
}

async function openNote(id, closeMobile){
  const note = notes.find(n=>n.id===id)
  if(!note) return
  activeId = id
  uiPrefs.lastOpenNoteId = id
  saveSettings()
  renderList()
  setEditorFromNote(note)
  buildGraph()
  requestGraphRender()
  if(closeMobile) closeSidebar()
}

function scheduleAutosave(){
  if(!activeId) return
  autosaveDirty = true
  setStatus("idle")
  clearTimeout(autosaveT)
  autosaveT = setTimeout(()=>saveActive(false), 650)
}

async function saveActive(forceToast){
  const note = currentNote()
  if(!note) return
  const title = $("title").value || ""
  const content = $("body").value || ""
  const grade = $("grade").value || ""
  const school = currentSchool || ""
  if(!autosaveDirty && !forceToast) return

  setStatus("saving")
  autosaveDirty = false

  const { data, error } = await supabase.from("notes").update({
    title, content, grade, school
  }).eq("id", note.id).eq("user_id", user.id).select("*").single()

  if(error){
    setStatus("error")
    toast("Save failed", error.message, "bad")
    return
  }

  setStatus("saved")
  if(forceToast) toast("Saved", "Your note is synced.", "ok")

  notes = notes.map(n=>n.id===note.id ? ({...data, linked_notes:n.linked_notes||[]}) : n)
  renderList()
  setEditorFromNote(currentNote())
  buildGraph()
  requestGraphRender()
}

async function newNote(){
  const payload = {
    user_id: user.id,
    title: "Untitled",
    content: "",
    grade: "",
    school: currentSchool || "Salesianum"
  }
  const { data, error } = await supabase.from("notes").insert(payload).select("*").single()
  if(error){
    setStatus("error")
    toast("Could not create note", error.message, "bad")
    return
  }
  notes = [({...data, linked_notes:[]}), ...notes]
  renderList()
  openNote(data.id,true)
  toast("New note", "Created.", "ok")
}

async function deleteNote(){
  const note = currentNote()
  if(!note) return
  const ok = confirm("Delete this note? This cannot be undone.")
  if(!ok) return
  const { error } = await supabase.from("notes").delete().eq("id", note.id).eq("user_id", user.id)
  if(error){
    toast("Delete failed", error.message, "bad")
    return
  }
  notes = notes.filter(n=>n.id!==note.id)
  links = links.filter(l=>l.note_a!==note.id && l.note_b!==note.id)
  rebuildLinkedOnClient()
  renderList()
  if(notes.length) openNote(notes[0].id,false)
  else setEmptyEditor()
  buildGraph()
  requestGraphRender()
  toast("Deleted", "Note removed.", "ok")
}

function findNoteByTitleExact(t){
  const q = (t||"").trim().toLowerCase()
  if(!q) return null
  return notes.find(n => (n.title||"").trim().toLowerCase() === q) || null
}

async function toggleLinkByTitle(titleText){
  const note = currentNote()
  if(!note) return
  const target = findNoteByTitleExact(titleText)
  if(!target){
    toast("No match", "Type the exact title of another note to link.", "warn")
    return
  }
  if(target.id === note.id){
    toast("Nope", "Can't link a note to itself.", "warn")
    return
  }

  const [a,b] = orderedPair(note.id, target.id)
  const exists = links.some(l=>l.note_a===a && l.note_b===b)
  if(exists){
    const { error } = await supabase.from("note_links").delete().eq("user_id", user.id).eq("note_a", a).eq("note_b", b)
    if(error){ toast("Unlink failed", error.message, "bad"); return }
    links = links.filter(l=>!(l.note_a===a && l.note_b===b))
    toast("Unlinked", "Removed connection.", "ok")
  }else{
    const { error } = await supabase.from("note_links").insert({ user_id:user.id, note_a:a, note_b:b })
    if(error){ toast("Link failed", error.message, "bad"); return }
    links = [...links, { note_a:a, note_b:b }]
    toast("Linked", "Connection added.", "ok")
  }

  rebuildLinkedOnClient()
  notes = notes.map(n=>n.id===note.id ? ({...n, linked_notes:(n.linked_notes||[])}) : n)
  renderList()
  setEditorFromNote(currentNote())
  buildGraph()
  requestGraphRender()
}

function updatePreviewFromInputs(){
  const note = currentNote()
  const temp = {
    title: $("title").value || "Untitled",
    content: $("body").value || "",
    grade: $("grade").value || "",
    school: currentSchool || "",
    updated_at: note?.updated_at
  }
  renderPreview(temp)
  setCrumb({ ...temp, linked_notes: note?.linked_notes || [] })
}

function pad2(n){ return String(n).padStart(2,"0") }
function updateTimerDisplay(){
  const m = Math.floor(timeLeft/60)
  const s = timeLeft%60
  $("timerText").textContent = pad2(m)+":"+pad2(s)
}
function setTimerMode(mode, resetClock=true){
  timerMode = mode
  const mins = mode==="focus" ? (timerPresets.focus||25) : mode==="break" ? (timerPresets.break||5) : (timerPresets.long||15)
  if(resetClock){
    timeLeft = mins*60
    updateTimerDisplay()
  }
}
function startTimer(){
  if(timerInterval) return
  timerInterval = setInterval(()=>{
    timeLeft = Math.max(0, timeLeft-1)
    updateTimerDisplay()
    if(timeLeft<=0){
      pauseTimer()
      const next = timerMode==="focus" ? "break" : "focus"
      setTimerMode(next,true)
      toast("Timer", (next==="focus"?"Focus":"Break")+" time.", "ok")
    }
  },1000)
}
function pauseTimer(){
  if(!timerInterval) return
  clearInterval(timerInterval)
  timerInterval = null
}

function showSettings(open){
  $("modalSettings").style.display = open ? "flex" : "none"
}
function closeSidebar(){
  $("sidebar").classList.remove("open")
  $("backdrop").classList.remove("show")
}
function openSidebar(){
  $("sidebar").classList.add("open")
  $("backdrop").classList.add("show")
}

async function exportPDF(){
  const note = currentNote()
  if(!note){
    toast("No note", "Open a note first.", "warn")
    return
  }
  openView("preview")
  await new Promise(r=>setTimeout(r,60))
  const node = $("mainPreview")
  const canvas = await html2canvas(node, { scale: 2, backgroundColor: null })
  const img = canvas.toDataURL("image/png")
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF("p","pt","a4")
  const pw = pdf.internal.pageSize.getWidth()
  const ph = pdf.internal.pageSize.getHeight()
  const ratio = Math.min(pw/canvas.width, ph/canvas.height)
  const w = canvas.width*ratio
  const h = canvas.height*ratio
  const x = (pw-w)/2
  const y = 24
  pdf.addImage(img,"PNG",x,y,w,h)
  pdf.save((note.title||"StudyOS").replace(/[^\w\- ]+/g,"").slice(0,80) + ".pdf")
}

function buildGraph(){
  const visible = listFiltered()
  const idSet = new Set(visible.map(n=>n.id))
  const map = new Map(visible.map(n=>[n.id,n]))
  graphNodes = visible.map((n,i)=>({
    id:n.id,
    title:n.title||"Untitled",
    x:(Math.random()*2-1)*260,
    y:(Math.random()*2-1)*200,
    vx:0, vy:0,
    r: 22 + Math.min(26, (n.title||"").length*0.4)
  }))
  const idx = new Map(graphNodes.map((n,i)=>[n.id,i]))
  graphEdges = []
  links.forEach(l=>{
    if(idSet.has(l.note_a) && idSet.has(l.note_b)){
      const a = idx.get(l.note_a)
      const b = idx.get(l.note_b)
      if(a!=null && b!=null) graphEdges.push([a,b])
    }
  })
  if(activeId && idx.has(activeId)){
    const k = idx.get(activeId)
    graphNodes[k].r += 10
  }
}

function graphToScreen(px,py){
  const cx = graphCanvas.width/2
  const cy = graphCanvas.height/2
  return {
    x: cx + (px + gView.x)*gView.scale,
    y: cy + (py + gView.y)*gView.scale
  }
}
function screenToGraph(sx,sy){
  const cx = graphCanvas.width/2
  const cy = graphCanvas.height/2
  return {
    x: ((sx - cx)/gView.scale) - gView.x,
    y: ((sy - cy)/gView.scale) - gView.y
  }
}

function tickPhysics(){
  if(!graphPhysics) return
  const kRepel = 24000
  const kSpring = 0.012
  const springLen = 220
  const damp = 0.86

  for(let i=0;i<graphNodes.length;i++){
    const a = graphNodes[i]
    for(let j=i+1;j<graphNodes.length;j++){
      const b = graphNodes[j]
      const dx = b.x-a.x
      const dy = b.y-a.y
      const d2 = dx*dx+dy*dy + 0.01
      const f = kRepel / d2
      const inv = 1/Math.sqrt(d2)
      const fx = f*dx*inv
      const fy = f*dy*inv
      a.vx -= fx
      a.vy -= fy
      b.vx += fx
      b.vy += fy
    }
  }

  for(const [ia,ib] of graphEdges){
    const a = graphNodes[ia]
    const b = graphNodes[ib]
    const dx = b.x-a.x
    const dy = b.y-a.y
    const d = Math.max(0.01, Math.sqrt(dx*dx+dy*dy))
    const delta = d - springLen
    const f = kSpring * delta
    const fx = f * (dx/d)
    const fy = f * (dy/d)
    a.vx += fx
    a.vy += fy
    b.vx -= fx
    b.vy -= fy
  }

  graphNodes.forEach(n=>{
    if(gDragNode && gDragNode.id===n.id) return
    n.vx *= damp
    n.vy *= damp
    n.x += n.vx
    n.y += n.vy
  })
}

function drawGraph(){
  if(!graphCanvas) return
  graphCtx.clearRect(0,0,graphCanvas.width,graphCanvas.height)

  graphCtx.save()
  graphCtx.translate(graphCanvas.width/2, graphCanvas.height/2)
  graphCtx.scale(gView.scale, gView.scale)
  graphCtx.translate(gView.x, gView.y)

  graphCtx.lineWidth = 2 / gView.scale
  graphCtx.strokeStyle = "rgba(255,255,255,.10)"
  graphEdges.forEach(([ia,ib])=>{
    const a = graphNodes[ia]
    const b = graphNodes[ib]
    graphCtx.beginPath()
    graphCtx.moveTo(a.x,a.y)
    graphCtx.lineTo(b.x,b.y)
    graphCtx.stroke()
  })

  graphNodes.forEach(n=>{
    const isActive = n.id===activeId
    graphCtx.beginPath()
    graphCtx.fillStyle = isActive ? "rgba(255,106,0,.22)" : "rgba(255,255,255,.06)"
    graphCtx.strokeStyle = isActive ? "rgba(255,106,0,.85)" : "rgba(255,255,255,.14)"
    graphCtx.arc(n.x,n.y,n.r,0,Math.PI*2)
    graphCtx.fill()
    graphCtx.stroke()

    graphCtx.font = `${Math.max(12, Math.min(16, 14 / gView.scale))}px Inter`
    graphCtx.fillStyle = "rgba(238,242,255,.90)"
    const t = n.title
    const max = 22
    const text = t.length>max ? t.slice(0,max-1)+"‚Ä¶" : t
    graphCtx.fillText(text, n.x - n.r + 10, n.y + 5)
  })

  graphCtx.restore()
}

let graphRAF = null
function requestGraphRender(){
  if(graphRAF) return
  graphRAF = requestAnimationFrame(()=>{
    graphRAF = null
    tickPhysics()
    drawGraph()
    if(graphPhysics) requestGraphRender()
  })
}

function resizeGraph(){
  const c = $("graph")
  graphCanvas = c
  graphCtx = c.getContext("2d")
  const dpr = Math.max(1, Math.floor(window.devicePixelRatio||1))
  c.width = c.clientWidth * dpr
  c.height = c.clientHeight * dpr
  graphCtx.setTransform(dpr,0,0,dpr,0,0)
  requestGraphRender()
}

function pickNodeAtScreen(sx,sy){
  const p = screenToGraph(sx,sy)
  for(let i=graphNodes.length-1;i>=0;i--){
    const n = graphNodes[i]
    const dx = p.x - n.x
    const dy = p.y - n.y
    if(dx*dx+dy*dy <= n.r*n.r) return n
  }
  return null
}

function initGraphEvents(){
  const c = $("graph")
  c.addEventListener("wheel",(e)=>{
    e.preventDefault()
    const delta = e.deltaY>0 ? 0.92 : 1.08
    const before = screenToGraph(e.offsetX, e.offsetY)
    gView.scale = clamp(gView.scale*delta, 0.25, 2.6)
    const after = screenToGraph(e.offsetX, e.offsetY)
    gView.x += (after.x - before.x)
    gView.y += (after.y - before.y)
    requestGraphRender()
  },{passive:false})

  c.addEventListener("mousedown",(e)=>{
    const n = pickNodeAtScreen(e.offsetX, e.offsetY)
    if(n){
      gDragNode = n
      const p = screenToGraph(e.offsetX, e.offsetY)
      gDragNode._dx = n.x - p.x
      gDragNode._dy = n.y - p.y
    }else{
      gPan = true
      gPanStart = { x:e.clientX, y:e.clientY, ox:gView.x, oy:gView.y }
    }
  })

  window.addEventListener("mousemove",(e)=>{
    if(gDragNode){
      const rect = c.getBoundingClientRect()
      const sx = e.clientX - rect.left
      const sy = e.clientY - rect.top
      const p = screenToGraph(sx,sy)
      gDragNode.x = p.x + gDragNode._dx
      gDragNode.y = p.y + gDragNode._dy
      gDragNode.vx = 0
      gDragNode.vy = 0
      requestGraphRender()
      return
    }
    if(!gPan || !gPanStart) return
    const dx = (e.clientX - gPanStart.x) / gView.scale
    const dy = (e.clientY - gPanStart.y) / gView.scale
    gView.x = gPanStart.ox + dx
    gView.y = gPanStart.oy + dy
    requestGraphRender()
  })

  window.addEventListener("mouseup",(e)=>{
    if(gDragNode){
      gDragNode = null
      requestGraphRender()
    }
    gPan = false
    gPanStart = null
  })

  c.addEventListener("click",(e)=>{
    const n = pickNodeAtScreen(e.offsetX, e.offsetY)
    if(n){
      openView("edit")
      openNote(n.id,true)
    }
  })
}

async function testDb(){
  const r1 = await supabase.from("notes").select("id").limit(1)
  if(r1.error) return r1.error.message
  const r2 = await supabase.from("note_links").select("id").limit(1)
  if(r2.error) return r2.error.message
  const r3 = await supabase.from("user_settings").select("user_id").limit(1)
  if(r3.error) return r3.error.message
  return ""
}

function wireUI(){
  $("dbSql").value = DB_SQL

  $("modeEdit").onclick = ()=>openView("edit")
  $("modePreview").onclick = ()=>openView("preview")
  $("modeGraph").onclick = ()=>openView("graph")

  $("toggleSplit").onclick = ()=>{
    if(splitMode==="split") setSplitMode("editor")
    else if(splitMode==="editor") setSplitMode("preview")
    else setSplitMode("split")
  }

  $("toggleFull").onclick = ()=>{
    uiPrefs.previewFull = !uiPrefs.previewFull
    if(uiPrefs.previewFull) document.body.classList.add("previewFull")
    else document.body.classList.remove("previewFull")
    $("setPreviewFull").value = uiPrefs.previewFull ? "1" : "0"
    saveSettings()
  }

  $("btnOpenSettings").onclick = ()=>showSettings(true)
  $("openSettings")?.addEventListener?.("click",()=>showSettings(true))

  $("setClose").onclick = ()=>showSettings(false)
  $("setCancel").onclick = ()=>showSettings(false)

  $("copySql").onclick = async ()=>{
    await navigator.clipboard.writeText(DB_SQL)
    toast("Copied", "SQL copied.", "ok")
  }

  $("testDb").onclick = async ()=>{
    const msg = await testDb()
    if(msg){
      $("dbBanner").style.display="flex"
      toast("DB test failed", msg, "bad")
    }else{
      $("dbBanner").style.display="none"
      toast("DB OK", "Tables + RLS look good.", "ok")
    }
  }

  $("setSave").onclick = ()=>{
    uiPrefs.previewFull = $("setPreviewFull").value==="1"
    uiPrefs.sort = $("setSort").value
    timerPresets.focus = clamp(parseInt($("setFocus").value||"25",10),1,180)
    timerPresets.break = clamp(parseInt($("setBreak").value||"5",10),1,60)
    timerPresets.long = clamp(parseInt($("setLong").value||"15",10),1,120)
    $("sort").value = uiPrefs.sort
    if(uiPrefs.previewFull) document.body.classList.add("previewFull")
    else document.body.classList.remove("previewFull")
    saveSettings()
    setTimerMode(timerMode,true)
    showSettings(false)
    renderList()
    toast("Saved", "Settings updated.", "ok")
  }

  $("btnNew").onclick = ()=>newNote()
  $("saveNow").onclick = ()=>saveActive(true)
  $("delNote").onclick = ()=>deleteNote()
  $("doPdf").onclick = ()=>exportPDF()

  $("search").oninput = ()=>{ renderList(); buildGraph(); requestGraphRender() }
  $("sort").onchange = ()=>{ uiPrefs.sort = $("sort").value; $("setSort").value = uiPrefs.sort; saveSettings(); renderList(); buildGraph(); requestGraphRender() }

  $("schoolSel").onchange = ()=>{
    currentSchool = $("schoolSel").value
    saveSettings()
    renderList()
    buildGraph()
    requestGraphRender()
    const note = currentNote()
    if(note){
      note.school = currentSchool
      scheduleAutosave()
      updatePreviewFromInputs()
    }else{
      renderPreview({title:"Untitled",content:"",grade:"",school:currentSchool})
    }
  }

  $("title").oninput = ()=>{ updatePreviewFromInputs(); scheduleAutosave() }
  $("body").oninput = ()=>{ updatePreviewFromInputs(); scheduleAutosave() }
  $("grade").onchange = ()=>{ updatePreviewFromInputs(); scheduleAutosave() }

  $("linkSearch").addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){
      e.preventDefault()
      const v = $("linkSearch").value
      $("linkSearch").value = ""
      toggleLinkByTitle(v)
    }
  })

  document.querySelectorAll(".tool").forEach(t=>{
    t.onclick = ()=>{
      const mode = t.getAttribute("data-md")
      const ta = $("body")
      ta.focus()
      const start = ta.selectionStart||0
      const end = ta.selectionEnd||0
      const sel = ta.value.slice(start,end)
      let ins = ""
      if(mode==="bold") ins = "**"+(sel||"bold")+"**"
      if(mode==="italic") ins = "*"+(sel||"italic")+"*"
      if(mode==="h1") ins = "# "+(sel||"Heading")
      if(mode==="h2") ins = "## "+(sel||"Heading")
      if(mode==="ul") ins = "- "+(sel||"item")
      if(mode==="ol") ins = "1. "+(sel||"item")
      if(mode==="quote") ins = "> "+(sel||"quote")
      if(mode==="code") ins = "```\\n"+(sel||"code")+"\\n```"
      if(mode==="link") ins = "["+(sel||"text")+"](https://example.com)"
      ta.setRangeText(ins, start, end, "end")
      updatePreviewFromInputs()
      scheduleAutosave()
    }
  })

  $("mFocus").onclick = ()=>setTimerMode("focus",true)
  $("mBreak").onclick = ()=>setTimerMode("break",true)
  $("mLong").onclick = ()=>setTimerMode("long",true)
  $("tStart").onclick = ()=>startTimer()
  $("tPause").onclick = ()=>pauseTimer()
  $("tReset").onclick = ()=>setTimerMode(timerMode,true)

  $("signOut").onclick = async ()=>{
    await supabase.auth.signOut()
    user = null
    setUserUI(null)
    showAuth(true)
    setEmptyEditor()
    notes=[]
    links=[]
    renderList()
    toast("Signed out", "See you.", "ok")
  }

  $("mobileMenu").onclick = ()=>openSidebar()
  $("mobileClose").onclick = ()=>closeSidebar()
  $("backdrop").onclick = ()=>closeSidebar()

  $("gReset").onclick = ()=>{ gView={x:0,y:0,scale:1}; buildGraph(); requestGraphRender() }
  $("gPhys").onclick = ()=>{ graphPhysics = !graphPhysics; toast("Graph", graphPhysics?"Physics on":"Physics off", "ok"); requestGraphRender() }
  $("gCenter").onclick = ()=>{ gView.x=0; gView.y=0; requestGraphRender() }

  window.addEventListener("keydown",(e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault()
      saveActive(true)
    }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="p"){
      e.preventDefault()
      openView("preview")
    }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){
      e.preventDefault()
      $("search").focus()
    }
  })
}

let authMode = "signin"
function setAuthMode(m){
  authMode = m
  $("tabSignIn").classList.toggle("active", m==="signin")
  $("tabSignUp").classList.toggle("active", m==="signup")
  setAuthErr("")
}
async function doAuth(){
  const email = ($("authEmail").value||"").trim()
  const pass = $("authPass").value||""
  if(!email){ setAuthErr("Enter an email."); return }
  if(authMode==="signup" && pass.length<6){ setAuthErr("Password needs 6+ characters."); return }
  setAuthErr("")
  let res
  if(authMode==="signup"){
    res = await supabase.auth.signUp({ email, password: pass })
  }else{
    res = await supabase.auth.signInWithPassword({ email, password: pass })
  }
  if(res.error){ setAuthErr(res.error.message); return }
  toast("Auth", authMode==="signup"?"Check your email if confirmations are on.":"Signed in.", "ok")
}
async function doMagic(){
  const email = ($("authEmail").value||"").trim()
  if(!email){ setAuthErr("Enter an email."); return }
  setAuthErr("")
  const res = await supabase.auth.signInWithOtp({ email })
  if(res.error){ setAuthErr(res.error.message); return }
  toast("Magic link", "Check your email.", "ok")
}
async function doReset(){
  const email = ($("authEmail").value||"").trim()
  if(!email){ setAuthErr("Enter your email first."); return }
  const res = await supabase.auth.resetPasswordForEmail(email)
  if(res.error){ setAuthErr(res.error.message); return }
  toast("Reset", "Check your email.", "ok")
}

function initAuthUI(){
  $("tabSignIn").onclick = ()=>setAuthMode("signin")
  $("tabSignUp").onclick = ()=>setAuthMode("signup")
  $("authGo").onclick = ()=>doAuth()
  $("authMagic").onclick = ()=>doMagic()
  $("authReset").onclick = ()=>doReset()
}

async function boot(){
  wireUI()
  initAuthUI()
  fillSchoolSelect()
  $("dbSql").value = DB_SQL

  graphCanvas = $("graph")
  resizeGraph()
  initGraphEvents()
  window.addEventListener("resize", resizeGraph)

  const { data } = await supabase.auth.getSession()
  user = data?.session?.user || null
  setUserUI(user)

  supabase.auth.onAuthStateChange(async (evt, session)=>{
    user = session?.user || null
    setUserUI(user)
    if(user){
      showAuth(false)
      await hardRefresh()
      toast("Welcome", "Synced and ready.", "ok")
    }else{
      showAuth(true)
      setEmptyEditor()
    }
  })

  if(user){
    showAuth(false)
    await hardRefresh()
  }else{
    showAuth(true)
    renderList()
  }
}

boot()
</script>
</body>
</html>
