<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyOS</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module" src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    :root {
        /* Supabase-inspired Palette */
        --bg: #121212;
        --sidebar: #181818;
        --border: #2e2e2e;
        --surface: #232323;
        --surface-hover: #2a2a2a;
        
        --text-main: #ededed;
        --text-muted: #878787;
        
        --brand: #3ecf8e; /* Supabase Green */
        --brand-hover: #34b27b;
        --danger: #ff4b4b;
        
        --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { box-sizing: border-box; outline: none; }

    body {
        margin: 0;
        background: var(--bg);
        color: var(--text-main);
        font-family: var(--font);
        height: 100vh;
        display: flex;
        overflow: hidden;
        font-size: 14px;
    }

    /* --- SIDEBAR --- */
    aside {
        width: 260px;
        background: var(--sidebar);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        letter-spacing: -0.02em;
    }

    .sidebar-header .logo {
        width: 20px; height: 20px;
        background: var(--brand);
        border-radius: 4px;
    }

    .nav-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .nav-item {
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-muted);
        transition: 0.1s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .nav-item:hover {
        background: var(--surface-hover);
        color: var(--text-main);
    }

    .nav-item.active {
        background: var(--surface);
        color: var(--text-main);
        font-weight: 500;
    }

    .nav-item.active .fav-icon { display: block; }
    
    .fav-icon { color: #eab308; font-size: 12px; }

    .sidebar-footer {
        padding: 12px;
        border-top: 1px solid var(--border);
    }

    /* --- MAIN AREA --- */
    main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg);
    }

    .top-bar {
        height: 50px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
    }

    .breadcrumbs {
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .breadcrumbs span { color: var(--text-main); }

    .actions { display: flex; gap: 8px; }

    /* --- BUTTONS --- */
    button {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-family: var(--font);
        font-size: 13px;
        transition: 0.15s;
    }

    button:hover { background: var(--surface); border-color: #404040; }
    
    button.primary {
        background: var(--brand);
        border-color: var(--brand);
        color: #000;
        font-weight: 500;
    }
    button.primary:hover { background: var(--brand-hover); border-color: var(--brand-hover); }

    button.danger:hover { color: var(--danger); border-color: var(--danger); }

    /* --- EDITOR --- */
    .editor-container {
        flex: 1;
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
        padding: 40px;
        display: flex;
        flex-direction: column;
    }

    input.title-input {
        background: transparent;
        border: none;
        color: var(--text-main);
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 20px;
        width: 100%;
    }
    input.title-input::placeholder { color: #404040; }

    textarea.body-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #d4d4d4;
        font-size: 15px;
        line-height: 1.6;
        resize: none;
    }
    textarea.body-input::placeholder { color: #404040; }

    /* --- AUTH OVERLAY (Supabase Style) --- */
    #auth-overlay {
        position: fixed; inset: 0;
        background: var(--bg);
        display: flex; align-items: center; justify-content: center;
        z-index: 100;
    }

    .auth-card {
        width: 350px;
        background: var(--sidebar);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 30px;
        text-align: center;
    }

    .auth-card h2 { margin-top: 0; font-weight: 500; }

    .input-field {
        width: 100%;
        background: var(--bg);
        border: 1px solid var(--border);
        color: white;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 12px;
        font-size: 14px;
    }
    .input-field:focus { border-color: var(--brand); }

    .full-width { width: 100%; margin-top: 10px; }
    
    .link {
        display: block; margin-top: 15px;
        color: var(--text-muted); cursor: pointer; font-size: 12px;
    }
    .link:hover { color: var(--brand); }

</style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <div style="margin-bottom:20px; display:flex; justify-content:center; gap:8px; align-items:center">
            <div style="width:24px; height:24px; background:var(--brand); border-radius:4px"></div>
            <h2 style="margin:0; font-size:18px">StudyOS</h2>
        </div>
        <input type="email" id="email" class="input-field" placeholder="name@example.com">
        <input type="password" id="password" class="input-field" placeholder="Password">
        <button class="primary full-width" onclick="handleAuth()">Sign In</button>
        <span class="link" onclick="toggleAuth()" id="auth-msg">No account? Sign up</span>
        <div id="auth-err" style="color:var(--danger); margin-top:10px; font-size:12px"></div>
    </div>
</div>

<aside>
    <div class="sidebar-header">
        <div class="logo"></div>
        <span>StudyOS</span>
    </div>
    <div class="nav-list" id="list">
        </div>
    <div class="sidebar-footer">
        <button class="primary" style="width:100%" onclick="createNote()">New Note</button>
        <button style="width:100%; margin-top:8px; border:none; color:var(--text-muted)" onclick="signOut()">Sign out</button>
    </div>
</aside>

<main>
    <div class="top-bar">
        <div class="breadcrumbs">
            Notes / <span id="status">Ready</span>
        </div>
        <div class="actions">
            <button onclick="toggleFav()">Favorite</button>
            <button onclick="exportPDF()">Export</button>
            <button class="primary" onclick="saveNote()">Save</button>
            <button class="danger" onclick="deleteNote()">Delete</button>
        </div>
    </div>

    <div class="editor-container">
        <input type="text" class="title-input" id="title-in" placeholder="Untitled Note">
        <textarea class="body-input" id="body-in" placeholder="Start writing..."></textarea>
    </div>
</main>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // --- YOUR CREDENTIALS ---
    const SUPABASE_URL = 'https://cgmazcvmpcgistoimqlw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let notes = [];
    let activeId = null;
    let isSignUp = false;
    let user = null;

    // --- AUTH ---
    window.toggleAuth = () => {
        isSignUp = !isSignUp;
        document.querySelector('.primary.full-width').innerText = isSignUp ? "Create Account" : "Sign In";
        document.getElementById('auth-msg').innerText = isSignUp ? "Have an account? Sign In" : "No account? Sign up";
    }

    window.handleAuth = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const err = document.getElementById('auth-err');
        err.innerText = "";

        const { error } = isSignUp 
            ? await supabase.auth.signUp({ email: e, password: p })
            : await supabase.auth.signInWithPassword({ email: e, password: p });

        if (error) err.innerText = error.message;
        else if (isSignUp) alert("Account created! You can now sign in.");
        else location.reload();
    }

    window.signOut = async () => { await supabase.auth.signOut(); location.reload(); }

    supabase.auth.onAuthStateChange((evt, session) => {
        if (session) {
            user = session.user;
            document.getElementById('auth-overlay').style.display = 'none';
            fetchNotes();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    // --- DATA ---
    async function fetchNotes() {
        const { data } = await supabase.from('notes').select('*').order('updated_at', { ascending: false });
        if (data) {
            notes = data;
            renderList();
            if(notes.length) loadNote(notes[0].id);
        }
    }

    window.createNote = async () => {
        const { data } = await supabase.from('notes').insert({ user_id: user.id, title: "", content: "" }).select();
        if(data) { notes.unshift(data[0]); loadNote(data[0].id); renderList(); }
    }

    window.saveNote = async () => {
        if(!activeId) return;
        const t = document.getElementById('title-in').value;
        const c = document.getElementById('body-in').value;
        
        document.getElementById('status').innerText = "Saving...";
        
        await supabase.from('notes').update({ title: t, content: c, updated_at: new Date() }).eq('id', activeId);
        
        const n = notes.find(x => x.id === activeId);
        n.title = t; n.content = c;
        
        document.getElementById('status').innerText = "Saved";
        setTimeout(() => document.getElementById('status').innerText = "Ready", 2000);
        renderList();
    }

    window.deleteNote = async () => {
        if(!activeId || !confirm("Delete this note?")) return;
        await supabase.from('notes').delete().eq('id', activeId);
        notes = notes.filter(x => x.id !== activeId);
        activeId = notes.length ? notes[0].id : null;
        renderList();
        if(activeId) loadNote(activeId);
        else { document.getElementById('title-in').value = ""; document.getElementById('body-in').value = ""; }
    }

    window.loadNote = (id) => {
        activeId = id;
        const n = notes.find(x => x.id === id);
        document.getElementById('title-in').value = n.title || "";
        document.getElementById('body-in').value = n.content || "";
        renderList();
    }

    window.toggleFav = async () => {
        if(!activeId) return;
        const n = notes.find(x => x.id === activeId);
        n.is_fav = !n.is_fav;
        await supabase.from('notes').update({ is_fav: n.is_fav }).eq('id', activeId);
        renderList();
    }

    function renderList() {
        document.getElementById('list').innerHTML = notes.map(n => `
            <div class="nav-item ${n.id === activeId ? 'active' : ''}" onclick="loadNote('${n.id}')">
                <span>${n.title || 'Untitled'}</span>
                ${n.is_fav ? '<span class="fav-icon">â˜…</span>' : ''}
            </div>
        `).join('');
    }

    window.exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold"); doc.text(document.getElementById('title-in').value, 20, 20);
        doc.setFont("helvetica", "normal"); doc.text(doc.splitTextToSize(document.getElementById('body-in').value, 170), 20, 35);
        doc.save("note.pdf");
    }
</script>
</body>
</html>
