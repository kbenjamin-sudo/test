<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>StudyOS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root{
  --bg:#07080a;
  --panel:#0e1116;
  --panel2:#10151d;
  --card:#0b0e13;
  --stroke:rgba(255,255,255,.10);
  --stroke2:rgba(255,255,255,.14);
  --text:#eef2ff;
  --muted:rgba(238,242,255,.55);
  --muted2:rgba(238,242,255,.35);
  --brand:#ff6a00;
  --brand2:#ffb100;
  --ok:#22c55e;
  --bad:#ff3b3b;
  --warn:#ffb100;
  --mono:'JetBrains Mono',ui-monospace,Menlo,monospace;
  --font:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --shadow:0 16px 55px rgba(0,0,0,.55);
  --shadow2:0 22px 80px rgba(0,0,0,.75);
  --side:332px;
  --top:66px;
  --r12:12px;
  --r14:14px;
  --r16:16px;
  --r18:18px;
  --r22:22px;
}
body[data-theme="ember"]{--brand:#ff6a00;--brand2:#ffb100}
body[data-theme="mint"]{--brand:#2dd4bf;--brand2:#22c55e}
body[data-theme="haze"]{--brand:#a855f7;--brand2:#ec4899}
body[data-theme="ocean"]{--brand:#38bdf8;--brand2:#60a5fa}
body[data-theme="mono"]{--brand:#e5e7eb;--brand2:#9ca3af}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:
    radial-gradient(1200px 700px at 20% -10%, color-mix(in srgb, var(--brand) 18%, transparent), transparent 55%),
    radial-gradient(900px 600px at 110% 15%, color-mix(in srgb, var(--brand2) 14%, transparent), transparent 60%),
    linear-gradient(#07080a,#07080a);
  color:var(--text);
  font-family:var(--font);
  overflow:hidden;
}
a{color:inherit}
button,input,select,textarea{font-family:var(--font)}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px;border:2px solid rgba(0,0,0,0)}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18)}
::-webkit-scrollbar-track{background:transparent}
.app{height:100%;display:grid;grid-template-columns:var(--side) 1fr}
.sidebar{border-right:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));overflow:hidden}
.side-inner{height:100%;display:flex;flex-direction:column}
.brand{padding:18px 18px 12px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 10%, transparent), rgba(255,255,255,0))}
.brand-top{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:flex;align-items:center;justify-content:center;font-weight:950;color:#0b0b0b;user-select:none;box-shadow:0 0 0 1px rgba(255,255,255,.14) inset, 0 18px 55px color-mix(in srgb, var(--brand) 45%, transparent)}
.brand-name{display:flex;flex-direction:column;gap:2px;min-width:0}
.brand-name .t{font-weight:950;letter-spacing:-.6px;font-size:18px;white-space:nowrap}
.brand-name .s{font-weight:800;color:var(--muted);font-size:11px}
.quickRow{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.selectPill{flex:1;min-width:160px;border-radius:999px;border:1px solid color-mix(in srgb, var(--brand) 35%, transparent);background:color-mix(in srgb, var(--brand) 10%, transparent);color:rgba(255,240,230,.95);padding:8px 10px;font-weight:900;font-size:11px;cursor:pointer}
.pillBtn{width:46px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:950;transition:transform .12s,border-color .12s,background .12s;user-select:none}
.pillBtn:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 40%, transparent);background:rgba(255,255,255,.06)}
.side-actions{margin-top:12px;display:flex;gap:10px}
.btn{border:1px solid var(--stroke2);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:900;font-size:12px;transition:transform .15s,border-color .15s,background .15s,box-shadow .15s;user-select:none}
.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06);border-color:color-mix(in srgb, var(--brand) 45%, transparent);box-shadow:0 14px 38px rgba(0,0,0,.35)}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#111}
.btn.primary:hover{box-shadow:0 18px 55px color-mix(in srgb, var(--brand) 45%, transparent)}
.btn.ghost{background:transparent;border-color:rgba(255,255,255,.12)}
.btn.danger{border-color:rgba(255,59,59,.35);color:rgba(255,180,180,.95)}
.btn.danger:hover{border-color:rgba(255,59,59,.7);background:rgba(255,59,59,.10)}
.search-wrap{padding:12px 18px 10px}
.search{width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);color:var(--text);padding:12px 12px;font-weight:850;font-size:12px}
.search:focus{border-color:color-mix(in srgb, var(--brand) 55%, transparent);box-shadow:0 0 0 4px color-mix(in srgb, var(--brand) 14%, transparent);outline:none}
.filters{padding:0 18px 10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.filters select{flex:1;min-width:120px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);padding:10px 10px;font-weight:900;font-size:11px;cursor:pointer}
.kbtn{width:48px;display:flex;justify-content:center;align-items:center;font-weight:950}
.note-list{flex:1;overflow:auto;padding:10px 12px 14px}
.group{margin:10px 6px 14px}
.group-head{display:flex;align-items:center;justify-content:space-between;padding:9px 10px;color:rgba(238,242,255,.65);font-weight:950;font-size:10px;letter-spacing:1.15px;text-transform:uppercase;user-select:none}
.group-head .count{font-size:10px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);color:rgba(238,242,255,.78);font-weight:950;letter-spacing:.4px}
.note-card{margin:8px 6px;padding:12px 12px;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);cursor:pointer;transition:transform .13s,border-color .13s,background .13s,box-shadow .13s;position:relative;overflow:hidden}
.note-card:before{content:'';position:absolute;inset:-2px;background:radial-gradient(500px 130px at -20% 0%, color-mix(in srgb, var(--brand) 22%, transparent), transparent 70%);opacity:.55;pointer-events:none}
.note-card:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 35%, transparent);background:rgba(255,255,255,.055);box-shadow:0 18px 45px rgba(0,0,0,.35)}
.note-card.active{border-color:color-mix(in srgb, var(--brand) 75%, transparent);background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 18%, transparent), rgba(255,255,255,.04));box-shadow:0 25px 65px rgba(0,0,0,.45)}
.note-title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;position:relative}
.note-title .t{font-weight:950;font-size:13px;letter-spacing:-.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-title .tag{font-size:10px;padding:4px 9px;border-radius:999px;border:1px solid color-mix(in srgb, var(--brand2) 30%, transparent);color:color-mix(in srgb, var(--brand2) 88%, #fff);background:color-mix(in srgb, var(--brand2) 10%, transparent);font-weight:950;flex-shrink:0}
.note-snippet{color:rgba(238,242,255,.55);font-weight:700;font-size:11px;line-height:1.4;height:30px;overflow:hidden;position:relative}
.note-meta{margin-top:10px;display:flex;justify-content:space-between;align-items:center;color:rgba(238,242,255,.35);font-weight:900;font-size:10px;position:relative}
.badges{display:flex;gap:6px;align-items:center}
.badge{font-size:9px;font-weight:950;padding:3px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:rgba(238,242,255,.7)}
.badge.link{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.08);color:rgba(152,255,200,.95)}
.badge.pin{border-color:color-mix(in srgb, var(--brand) 35%, transparent);background:color-mix(in srgb, var(--brand) 10%, transparent);color:rgba(255,240,230,.95)}
.side-footer{padding:12px 18px 14px;border-top:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.03));display:flex;flex-direction:column;gap:10px}
.levelbar,.timerbar{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:16px}
.levelbar .lvl{display:flex;flex-direction:column;gap:2px;min-width:0}
.levelbar .lvl .a{font-weight:950;font-size:12px;letter-spacing:-.2px}
.levelbar .lvl .b{font-weight:900;font-size:10px;color:rgba(238,242,255,.55)}
.levelbar .coins,.timerbar .time{font-family:var(--mono);font-size:18px;font-weight:950;letter-spacing:1px;background:linear-gradient(135deg,var(--brand),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.timerbar .tbtns{display:flex;gap:8px}
.timerbar .tbtn{width:38px;height:34px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:950;color:rgba(238,242,255,.9);transition:transform .12s,border-color .12s,background .12s}
.timerbar .tbtn:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 40%, transparent);background:rgba(255,255,255,.06)}
.timer-modes{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:rgba(238,242,255,.75);font-weight:950;font-size:10px;cursor:pointer;user-select:none;transition:transform .12s,border-color .12s,background .12s}
.pill:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 40%, transparent);background:rgba(255,255,255,.06)}
.userline{display:flex;align-items:center;justify-content:space-between;gap:12px;color:rgba(238,242,255,.65);font-weight:900;font-size:11px}
.userline .left{display:flex;align-items:center;gap:10px;min-width:0}
.avatar{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-weight:950;color:rgba(238,242,255,.92);user-select:none}
.userline .email{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px;color:rgba(238,242,255,.8)}
.userline .out{padding:8px 10px;border-radius:14px}
.main{position:relative;overflow:hidden}
.topbar{height:var(--top);display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,0))}
.top-left{display:flex;align-items:center;gap:12px;min-width:0}
.mode-tabs{display:flex;gap:8px;align-items:center}
.tab{padding:9px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:rgba(238,242,255,.78);font-weight:950;font-size:12px;cursor:pointer;user-select:none;transition:transform .12s,border-color .12s,background .12s}
.tab:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 35%, transparent);background:rgba(255,255,255,.06)}
.tab.active{background:linear-gradient(135deg, color-mix(in srgb, var(--brand) 22%, transparent), color-mix(in srgb, var(--brand2) 10%, transparent));border-color:color-mix(in srgb, var(--brand) 60%, transparent);color:rgba(255,245,240,.98);box-shadow:0 18px 48px rgba(0,0,0,.35)}
.notecrumb{display:flex;flex-direction:column;gap:2px;min-width:0}
.notecrumb .title{font-weight:950;letter-spacing:-.4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
.notecrumb .sub{font-weight:900;color:rgba(238,242,255,.55);font-size:11px;display:flex;gap:10px;flex-wrap:wrap}
.chip{padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(238,242,255,.7);font-weight:950;font-size:10px}
.top-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.status{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);font-weight:950;font-size:11px;color:rgba(238,242,255,.75);user-select:none;transition:border-color .3s}
.status.is-saving{border-color:rgba(255,177,0,.4)}
.status.is-saved{border-color:rgba(34,197,94,.35)}
.status.is-error{border-color:rgba(255,59,59,.4)}
.dot{width:8px;height:8px;border-radius:50%;transition:all .3s}
.dot.ok{background:var(--ok);box-shadow:0 0 16px rgba(34,197,94,.35)}
.dot.warn{background:var(--warn);box-shadow:0 0 16px rgba(255,177,0,.35);animation:dotPulse 1.1s ease infinite}
.dot.bad{background:var(--bad);box-shadow:0 0 16px rgba(255,59,59,.35)}
@keyframes dotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}
.iconbtn{width:44px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:950;font-size:13px;transition:transform .12s,border-color .12s,background .12s;user-select:none}
.iconbtn:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 35%, transparent);background:rgba(255,255,255,.06)}
.iconbtn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:transparent;color:#131313}
.iconbtn.primary:hover{box-shadow:0 18px 55px color-mix(in srgb, var(--brand) 45%, transparent)}
.iconbtn.danger{border-color:rgba(255,59,59,.35);color:rgba(255,180,180,.95)}
.iconbtn.danger:hover{border-color:rgba(255,59,59,.7);background:rgba(255,59,59,.10)}
.iconbtn.wide{width:auto;padding:0 12px;gap:10px}
.iconbtn.wide span{font-weight:950;font-size:12px}
.content{height:calc(100% - var(--top));position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:none}
.view.active{display:block}
.editor-shell{height:100%;display:grid;grid-template-rows: 68px 1fr}
.toolbar{padding:12px 18px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0))}
.lefttools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tool{padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;font-weight:950;font-size:11px;color:rgba(238,242,255,.84);transition:transform .12s,border-color .12s,background .12s;user-select:none}
.tool:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 35%, transparent);background:rgba(255,255,255,.06)}
.metapick{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.metapick select,.metapick input{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);padding:10px 10px;font-weight:900;font-size:11px}
.metapick input{width:180px}
.metapick input.tags{width:230px}
.metapick input::placeholder{color:rgba(238,242,255,.35);font-weight:850}
.metapick input:focus,.metapick select:focus{border-color:color-mix(in srgb, var(--brand) 55%, transparent);box-shadow:0 0 0 4px color-mix(in srgb, var(--brand) 12%, transparent);outline:none}
.split{height:100%;display:grid;grid-template-columns:1fr 12px 1fr;overflow:hidden}
.split.singleEditor{grid-template-columns:1fr}
.split.singlePreview{grid-template-columns:1fr}
.pane{height:100%;overflow:auto;padding:18px 18px 22px}
.divider{display:flex;align-items:center;justify-content:center;cursor:col-resize;user-select:none}
.divider::before{content:'';width:6px;height:55%;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);transition:background .12s,border-color .12s}
.divider:hover::before{background:color-mix(in srgb, var(--brand) 16%, transparent);border-color:color-mix(in srgb, var(--brand) 35%, transparent)}
.titleInput{width:100%;border:none;background:transparent;color:var(--text);font-weight:950;letter-spacing:-.9px;font-size:38px;padding:8px 0 12px}
.titleInput:focus{outline:none}
.bodyInput{width:100%;min-height:calc(100% - 70px);border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:rgba(238,242,255,.92);border-radius:18px;padding:16px 16px;font-family:var(--mono);font-size:14px;line-height:1.75;resize:none}
.bodyInput:focus{border-color:color-mix(in srgb, var(--brand) 55%, transparent);box-shadow:0 0 0 5px color-mix(in srgb, var(--brand) 10%, transparent);outline:none}
.rightpane{display:flex;flex-direction:column;gap:14px}
.card{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:14px}
.cardhead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.cardhead .h{font-weight:950;font-size:11px;letter-spacing:1.1px;text-transform:uppercase;color:rgba(238,242,255,.65)}
.cardhead .act{display:flex;gap:8px}
.linkbtn{font-weight:950;font-size:11px;color:rgba(255,200,160,.92);cursor:pointer;user-select:none}
.linkbtn:hover{color:rgba(255,220,200,.98)}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pillnote{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:rgba(238,242,255,.82);font-weight:900;font-size:11px;cursor:pointer;user-select:none;display:flex;gap:8px;align-items:center;transition:transform .12s,border-color .12s,background .12s}
.pillnote:hover{transform:translateY(-1px);border-color:color-mix(in srgb, var(--brand) 35%, transparent);background:rgba(255,255,255,.06)}
.pillnote .x{width:18px;height:18px;border-radius:999px;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-weight:950;font-size:12px}
.pillnote:hover .x{border-color:rgba(255,59,59,.35);background:rgba(255,59,59,.10);color:rgba(255,200,200,.95)}
.smallHint{color:rgba(238,242,255,.55);font-weight:850;font-size:11px;line-height:1.6}
kbd{font-family:var(--mono);padding:3px 7px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);font-size:11px}
.preview{max-width:980px;margin:0 auto;padding:22px 24px 40px}
.preview h1{font-size:52px;font-weight:950;letter-spacing:-1.25px;margin-bottom:10px;background:linear-gradient(135deg, rgba(255,240,230,.98), rgba(255,210,170,.88));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.preview .metaRow{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
.preview .metaRow .chip{font-size:11px;padding:6px 10px}
.preview .body{font-size:16px;line-height:1.95;color:rgba(238,242,255,.92)}
.preview .body h2{margin-top:2.2em;margin-bottom:.7em;font-size:28px;color:rgba(255,210,170,.92);font-weight:950;letter-spacing:-.5px}
.preview .body h3{margin-top:1.8em;margin-bottom:.6em;font-size:22px;color:rgba(255,177,0,.92);font-weight:950}
.preview .body p{margin:1em 0}
.preview .body a{color:rgba(255,190,150,.95);font-weight:900;text-decoration:none;border-bottom:2px solid transparent}
.preview .body a:hover{border-bottom-color:rgba(255,190,150,.65)}
.preview .body code{font-family:var(--mono);font-size:.9em;padding:2px 7px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:rgba(255,220,170,.95)}
.preview .body pre{margin:1.2em 0;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);overflow:auto;padding:14px}
.preview .body pre code{background:transparent;border:none;padding:0;color:rgba(238,242,255,.92)}
.graphWrap{height:100%;position:relative;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0))}
#graph{width:100%;height:100%;display:block}
.graphUI{position:absolute;top:14px;right:14px;display:flex;gap:10px;flex-wrap:wrap}
.graphHint{position:absolute;left:14px;bottom:14px;padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);color:rgba(238,242,255,.70);font-weight:900;font-size:11px}
.graphMode{position:absolute;left:14px;top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22)}
.graphMode select{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);padding:10px 10px;font-weight:900;font-size:11px;cursor:pointer}
.graphMode .mini{color:rgba(238,242,255,.6);font-weight:900;font-size:11px}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;z-index:3000;backdrop-filter:blur(10px)}
.modal{width:92%;max-width:680px;border-radius:22px;border:1px solid rgba(255,255,255,.12);background:rgba(14,17,22,.92);box-shadow:var(--shadow2);overflow:hidden}
.modalTop{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:14px}
.modalTop .h{font-weight:950;font-size:14px;letter-spacing:-.25px}
.modalBody{padding:16px 18px 18px}
.modalBody p{color:rgba(238,242,255,.62);font-weight:800;font-size:12px;line-height:1.7;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row input,.row select{flex:1;min-width:190px;padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:var(--text);font-weight:900;font-size:12px}
.row input:focus,.row select:focus{border-color:color-mix(in srgb, var(--brand) 55%, transparent);box-shadow:0 0 0 5px color-mix(in srgb, var(--brand) 10%, transparent);outline:none}
.modalActions{padding:14px 18px 18px;display:flex;gap:10px;justify-content:flex-end}
.modalActions .btn{border-radius:16px}
.toastWrap{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:4000;pointer-events:none}
.toast{pointer-events:none;width:340px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(14,17,22,.88);backdrop-filter:blur(10px);box-shadow:var(--shadow);padding:12px 12px}
.toast .t1{font-weight:950;font-size:12px;margin-bottom:3px}
.toast .t2{font-weight:800;font-size:11px;color:rgba(238,242,255,.62);line-height:1.5}
.toast.ok{border-color:rgba(34,197,94,.28)}
.toast.warn{border-color:rgba(255,177,0,.28)}
.toast.bad{border-color:rgba(255,59,59,.32)}
.paletteBack{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:flex-start;justify-content:center;padding-top:95px;z-index:3500;backdrop-filter:blur(10px)}
.palette{width:92%;max-width:820px;border-radius:22px;border:1px solid rgba(255,255,255,.12);background:rgba(14,17,22,.92);box-shadow:var(--shadow2);overflow:hidden}
.paletteTop{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;gap:12px;align-items:center}
.paletteTop input{flex:1;padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:var(--text);font-weight:950}
.paletteTop input:focus{border-color:color-mix(in srgb, var(--brand) 55%, transparent);box-shadow:0 0 0 5px color-mix(in srgb, var(--brand) 10%, transparent);outline:none}
.paletteTop .hint{color:rgba(238,242,255,.55);font-weight:950;font-size:11px;white-space:nowrap}
.paletteList{max-height:430px;overflow:auto}
.pItem{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer;border-top:1px solid rgba(255,255,255,.06);transition:background .12s}
.pItem:hover{background:rgba(255,255,255,.05)}
.pItem .l{display:flex;gap:12px;align-items:center;min-width:0}
.pIco{width:34px;height:34px;border-radius:14px;display:flex;align-items:center;justify-content:center;border:1px solid color-mix(in srgb, var(--brand) 25%, transparent);background:color-mix(in srgb, var(--brand) 10%, transparent)}
.pTxt{min-width:0}
.pA{font-weight:950;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pB{margin-top:2px;font-weight:800;font-size:11px;color:rgba(238,242,255,.55);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pK{color:rgba(238,242,255,.55);font-weight:950;font-size:11px;white-space:nowrap}
.authBack{position:fixed;inset:0;background:radial-gradient(900px 650px at 20% 10%, color-mix(in srgb, var(--brand) 18%, transparent), transparent 60%),radial-gradient(700px 520px at 90% 25%, color-mix(in srgb, var(--brand2) 14%, transparent), transparent 65%),rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;z-index:5000}
.authCard{width:92%;max-width:470px;border-radius:26px;border:1px solid rgba(255,255,255,.14);background:rgba(14,17,22,.90);box-shadow:var(--shadow2);padding:22px}
.authHead{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.authHead .t{font-weight:950;font-size:18px;letter-spacing:-.4px}
.authHead .s{font-weight:900;font-size:11px;color:rgba(238,242,255,.55);margin-top:2px}
.authTabs{display:flex;gap:10px;margin:10px 0 14px}
.atab{flex:1;text-align:center;padding:10px 10px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-weight:950;font-size:12px;cursor:pointer;user-select:none}
.atab.active{border-color:color-mix(in srgb, var(--brand) 55%, transparent);background:linear-gradient(135deg, color-mix(in srgb, var(--brand) 18%, transparent), color-mix(in srgb, var(--brand2) 8%, transparent))}
.authCard input{width:100%;padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:var(--text);font-weight:900;margin-bottom:10px}
.authCard input:focus{border-color:color-mix(in srgb, var(--brand) 55%, transparent);box-shadow:0 0 0 5px color-mix(in srgb, var(--brand) 10%, transparent);outline:none}
.authRow{display:flex;gap:10px;margin-top:6px}
.authRow .btn{flex:1}
.authErr{margin-top:10px;font-weight:900;font-size:12px;color:rgba(255,170,170,.95);min-height:16px}
.authSmall{margin-top:10px;display:flex;justify-content:space-between;gap:12px;color:rgba(238,242,255,.55);font-weight:900;font-size:11px}
.authSmall span{cursor:pointer;user-select:none}
.authSmall span:hover{color:rgba(255,220,200,.95)}
.gamesWrap{height:100%;display:flex;align-items:center;justify-content:center;padding:18px}
.gameCard{width:min(1100px,96vw);border-radius:24px;border:1px solid color-mix(in srgb, var(--brand) 35%, transparent);background:rgba(14,17,22,.88);box-shadow:var(--shadow2);padding:16px}
.gameTop{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:6px 8px 12px}
.gTabs{display:flex;gap:10px;flex-wrap:wrap}
.gTab{padding:10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer;font-weight:950;font-size:12px;user-select:none}
.gTab.active{border-color:color-mix(in srgb, var(--brand) 55%, transparent);background:linear-gradient(135deg, color-mix(in srgb, var(--brand) 18%, transparent), color-mix(in srgb, var(--brand2) 8%, transparent))}
.gameTitle{font-weight:950;font-size:14px;color:rgba(255,220,200,.95)}
.gameBody{display:grid;grid-template-columns:1.25fr .75fr;gap:12px}
.canvasWrap{border-radius:20px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);padding:12px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
canvas{display:block;border-radius:16px;border:1px solid color-mix(in srgb, var(--brand) 25%, transparent);background:#050505;box-shadow:0 0 40px color-mix(in srgb, var(--brand) 45%, transparent)}
.gameSide{display:flex;flex-direction:column;gap:12px}
.scoreBox,.cheatBox{border-radius:20px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:14px}
.scoreBox .r{display:flex;justify-content:space-between;gap:10px;margin:7px 0;font-weight:950}
.scoreBox .r span{color:rgba(255,210,170,.95)}
.cheatBox .h{font-weight:950;font-size:12px;color:rgba(255,220,200,.95);margin-bottom:10px}
.cheatTabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.cheatTab{padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);font-weight:950;font-size:10px;cursor:pointer;user-select:none;color:rgba(238,242,255,.78)}
.cheatTab.active{border-color:color-mix(in srgb, var(--brand) 55%, transparent);background:color-mix(in srgb, var(--brand) 10%, transparent);color:rgba(255,245,240,.95)}
.cheatGrid{display:flex;flex-direction:column;gap:10px}
.cheatRow{display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:900;font-size:12px;color:rgba(238,242,255,.84)}
.cheatRow .aff{font-size:9px;font-weight:950;padding:3px 7px;border-radius:999px;border:1px solid rgba(255,177,0,.28);background:rgba(255,177,0,.08);color:rgba(255,230,180,.95)}
.cheatRow input[type="checkbox"]{accent-color:var(--brand)}
.cheatRow input[type="range"]{accent-color:var(--brand);width:170px}
.cheatRow input[type="number"],.cheatRow select{width:120px;padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.22);color:var(--text);font-weight:950}
.modBadge{position:absolute;top:12px;left:12px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,177,0,.35);background:rgba(255,177,0,.10);color:rgba(255,235,200,.95);font-weight:950;font-size:10px;display:none}
.modBadge.show{display:block}
#dbBanner{position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(90deg,rgba(180,20,20,.97),rgba(220,60,0,.97));color:#fff;padding:11px 20px;font-size:12px;font-weight:900;display:none;align-items:center;gap:10px;box-shadow:0 4px 24px rgba(0,0,0,.5)}
#dbBanner code{background:rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;font-family:var(--mono);font-size:11px}
#dbBanner .dbx{margin-left:auto;cursor:pointer;font-size:18px;opacity:.7;line-height:1}
#dbBanner .dbx:hover{opacity:1}
@media (max-width:900px){
  .app{grid-template-columns:1fr}
  .sidebar{position:fixed;left:-360px;top:0;bottom:0;width:332px;z-index:2500;transition:left .18s ease}
  .sidebar.open{left:0}
  .backdrop{position:fixed;inset:0;display:none;background:rgba(0,0,0,.6);z-index:2400}
  .backdrop.show{display:block}
  .topbar{padding:0 12px}
  .notecrumb .title{max-width:240px}
  .gameBody{grid-template-columns:1fr}
}
.backdrop{display:none}
</style>
</head>
<body data-theme="ember">
<div id="dbBanner">Database not set up or blocked. Run the SQL in Supabase. Check console for the exact error. <span class="dbx" onclick="this.parentElement.style.display='none'">‚úï</span></div>
<div class="toastWrap" id="toastWrap"></div>
<div class="paletteBack" id="paletteBack">
  <div class="palette">
    <div class="paletteTop">
      <input id="paletteQ" placeholder="Search notes or type a command...">
      <div class="hint">Enter ¬∑ Esc ¬∑ Ctrl+K</div>
    </div>
    <div class="paletteList" id="paletteList"></div>
  </div>
</div>

<div class="modalBack" id="modalPdf">
  <div class="modal">
    <div class="modalTop">
      <div class="h">Export PDF</div>
      <div class="iconbtn" id="pdfClose">‚úï</div>
    </div>
    <div class="modalBody">
      <p>Clean paginated PDF. Optionally appends linked notes.</p>
      <div class="row">
        <select id="pdfIncludeLinks">
          <option value="1">Include linked notes</option>
          <option value="0">Only this note</option>
        </select>
        <select id="pdfTheme">
          <option value="light">PDF Style: Light</option>
          <option value="dark">PDF Style: Dark</option>
        </select>
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="pdfCancel">Cancel</button>
      <button class="btn primary" id="pdfGo">Export</button>
    </div>
  </div>
</div>

<div class="modalBack" id="modalSettings">
  <div class="modal">
    <div class="modalTop">
      <div class="h">Settings</div>
      <div class="iconbtn" id="setClose">‚úï</div>
    </div>
    <div class="modalBody">
      <p>Syncs across devices.</p>
      <div class="row">
        <select id="setTheme">
          <option value="ember">Theme: Ember</option>
          <option value="mint">Theme: Mint Chill</option>
          <option value="haze">Theme: Purple Haze</option>
          <option value="ocean">Theme: Ocean</option>
          <option value="mono">Theme: Mono</option>
        </select>
        <select id="setPreviewFull">
          <option value="0">Preview Full-screen: Off</option>
          <option value="1">Preview Full-screen: On</option>
        </select>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <input id="setFocus" type="number" min="1" max="180" placeholder="Focus minutes">
        <input id="setBreak" type="number" min="1" max="60" placeholder="Break minutes">
        <input id="setLong" type="number" min="1" max="120" placeholder="Long break minutes">
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <input id="setNewSchool" placeholder="Add a school (Enter)">
        <input id="setNewSubject" placeholder="Add a subject (Enter)">
      </div>
    </div>
    <div class="modalActions">
      <button class="btn ghost" id="setCancel">Cancel</button>
      <button class="btn primary" id="setSave">Save</button>
    </div>
  </div>
</div>

<div class="authBack" id="authBack">
  <div class="authCard">
    <div class="authHead">
      <div class="logo">S</div>
      <div>
        <div class="t">StudyOS</div>
        <div class="s">notes ¬∑ graph ¬∑ arcade</div>
      </div>
    </div>
    <div class="authTabs">
      <div class="atab active" id="tabSignIn">Sign In</div>
      <div class="atab" id="tabSignUp">Sign Up</div>
    </div>
    <input id="authEmail" type="email" placeholder="Email">
    <input id="authPass" type="password" placeholder="Password">
    <div class="authRow">
      <button class="btn primary" id="authGo">Enter</button>
      <button class="btn ghost" id="authMagic">Magic Link</button>
    </div>
    <div class="authSmall">
      <span id="authReset">Forgot password?</span>
      <span id="authTip">Ctrl+K inside app</span>
    </div>
    <div class="authErr" id="authErr"></div>
  </div>
</div>

<div class="backdrop" id="backdrop"></div>

<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="side-inner">
      <div class="brand">
        <div class="brand-top">
          <div class="logo">S</div>
          <div class="brand-name">
            <div class="t">StudyOS</div>
            <div class="s">fast notes. real saves.</div>
          </div>
        </div>
        <div class="quickRow">
          <select class="selectPill" id="schoolSelect"></select>
          <div class="pillBtn" id="addSchoolBtn">Ôºã</div>
        </div>
        <div class="side-actions">
          <button class="btn primary" id="btnNew">New Note</button>
          <button class="btn" id="btnGames">Arcade</button>
        </div>
      </div>

      <div class="search-wrap">
        <input class="search" id="search" placeholder="Search title, body, tags (Ctrl+K)">
      </div>

      <div class="filters">
        <select id="sort">
          <option value="updated_desc">Sort: Updated</option>
          <option value="title_asc">Sort: Title</option>
          <option value="grade_asc">Sort: Grade</option>
          <option value="subject_asc">Sort: Subject</option>
        </select>
        <select id="fGrade">
          <option value="">Grade: All</option>
          <option value="8th">8th</option>
          <option value="9th">9th</option>
          <option value="10th">10th</option>
          <option value="11th">11th</option>
          <option value="12th">12th</option>
        </select>
        <select id="fSubject"></select>
        <button class="btn kbtn" id="openPalette">‚åò</button>
      </div>

      <div class="note-list" id="noteList"></div>

      <div class="side-footer">
        <div class="levelbar">
          <div class="lvl">
            <div class="a" id="lvlText">Level 1</div>
            <div class="b" id="xpText">0 XP</div>
          </div>
          <div class="coins" id="coinText">0 ‚ú¶</div>
        </div>

        <div class="timerbar">
          <div class="time" id="timerText">25:00</div>
          <div class="tbtns">
            <div class="tbtn" id="tStart">‚ñ∂</div>
            <div class="tbtn" id="tPause">‚è∏</div>
            <div class="tbtn" id="tReset">‚Ü∫</div>
          </div>
        </div>
        <div class="timer-modes">
          <div class="pill" id="mFocus">Focus</div>
          <div class="pill" id="mBreak">Break</div>
          <div class="pill" id="mLong">Long</div>
          <div class="pill" id="mBreakGame">Break+Arcade</div>
        </div>

        <div class="userline">
          <div class="left">
            <div class="avatar" id="avatar">U</div>
            <div class="email" id="userEmail">Signed out</div>
          </div>
          <button class="btn ghost out" id="signOut">Sign out</button>
        </div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="top-left">
        <div class="mode-tabs">
          <div class="tab active" id="modeEdit">Edit</div>
          <div class="tab" id="modePreview">Preview</div>
          <div class="tab" id="modeGraph">Graph</div>
        </div>
        <div class="notecrumb">
          <div class="title" id="crumbTitle">No note selected</div>
          <div class="sub" id="crumbSub"></div>
        </div>
      </div>

      <div class="top-right">
        <div class="status" id="saveStatus"><span class="dot warn"></span><span>Not saved</span></div>
        <div class="iconbtn wide" id="toggleSplit"><span>Split</span></div>
        <div class="iconbtn wide" id="toggleFull"><span>Full</span></div>
        <div class="iconbtn wide" id="doPdf"><span>PDF</span></div>
        <div class="iconbtn" id="openSettings">‚öô</div>
        <div class="iconbtn primary" id="saveNow">Save</div>
        <div class="iconbtn danger" id="delNote">üóë</div>
        <div class="iconbtn" id="mobileMenu" style="display:none">‚ò∞</div>
      </div>
    </div>

    <div class="content">
      <section class="view active" id="viewEditor">
        <div class="editor-shell">
          <div class="toolbar">
            <div class="lefttools">
              <div class="tool" data-md="bold">B</div>
              <div class="tool" data-md="italic">I</div>
              <div class="tool" data-md="h1">H1</div>
              <div class="tool" data-md="h2">H2</div>
              <div class="tool" data-md="ul">‚Ä¢ List</div>
              <div class="tool" data-md="ol">1. List</div>
              <div class="tool" data-md="quote">Quote</div>
              <div class="tool" data-md="code">Code</div>
              <div class="tool" data-md="link">Link</div>
            </div>
            <div class="metapick">
              <select id="grade">
                <option value="">Grade: (none)</option>
                <option value="8th">8th</option>
                <option value="9th">9th</option>
                <option value="10th">10th</option>
                <option value="11th">11th</option>
                <option value="12th">12th</option>
              </select>
              <select id="subject"></select>
              <input id="tags" class="tags" placeholder="Tags (comma separated)">
              <input id="linkSearch" placeholder="Link notes by title...">
            </div>
          </div>

          <div class="split" id="split">
            <div class="pane" id="paneLeft">
              <input class="titleInput" id="title" placeholder="Untitled">
              <textarea class="bodyInput" id="body" placeholder="Write in Markdown..."></textarea>
            </div>

            <div class="divider" id="divider"></div>

            <div class="pane" id="paneRight">
              <div class="rightpane">
                <div class="card" id="cardLinks" style="display:none">
                  <div class="cardhead">
                    <div class="h">Linked notes</div>
                    <div class="act">
                      <div class="linkbtn" id="unlinkAll">Unlink all</div>
                      <div class="linkbtn" id="jumpPreview">Preview</div>
                    </div>
                  </div>
                  <div class="pills" id="linksPills"></div>
                </div>

                <div class="card" id="cardBack" style="display:none">
                  <div class="cardhead">
                    <div class="h">Backlinks</div>
                    <div class="act"><div class="linkbtn" id="jumpGraph">Graph</div></div>
                  </div>
                  <div class="pills" id="backPills"></div>
                </div>

                <div class="card" id="cardDrop" style="display:none">
                  <div class="cardhead">
                    <div class="h">Link results</div>
                    <div class="act"><div class="linkbtn" id="closeDrop">Close</div></div>
                  </div>
                  <div id="dropList"></div>
                </div>

                <div class="card">
                  <div class="cardhead"><div class="h">Shortcuts</div></div>
                  <div class="smallHint">
                    <div><kbd>Ctrl</kbd> + <kbd>S</kbd> save</div>
                    <div><kbd>Ctrl</kbd> + <kbd>K</kbd> command palette</div>
                    <div><kbd>Alt</kbd> + <kbd>P</kbd> pin/unpin</div>
                    <div><kbd>Shift</kbd> + <kbd>Click</kbd> node to link in graph</div>
                  </div>
                </div>

              </div>
            </div>
          </div>

        </div>
      </section>

      <section class="view" id="viewPreview">
        <div class="preview">
          <h1 id="pTitle">Untitled</h1>
          <div class="metaRow" id="pMeta"></div>
          <div class="body" id="pBody"></div>
          <div class="card" id="pLinksCard" style="margin-top:20px;display:none">
            <div class="cardhead">
              <div class="h">Linked notes</div>
              <div class="act"><div class="linkbtn" id="backToEdit">Back</div></div>
            </div>
            <div class="pills" id="pLinks"></div>
          </div>
        </div>
      </section>

      <section class="view" id="viewGraph">
        <div class="graphWrap">
          <canvas id="graph"></canvas>
          <div class="graphMode">
            <div class="mini">Mode</div>
            <select id="graphStyle">
              <option value="chill">Chill Neon</option>
              <option value="arcade">Arcade Pulse</option>
              <option value="study">Study Clean</option>
            </select>
            <div class="mini" id="graphMini">Drag ¬∑ Scroll ¬∑ Click</div>
          </div>
          <div class="graphUI">
            <div class="iconbtn wide" id="gReset"><span>Reset</span></div>
            <div class="iconbtn wide" id="gPhys"><span>Physics</span></div>
            <div class="iconbtn wide" id="gCenter"><span>Center</span></div>
          </div>
          <div class="graphHint">Drag to pan ¬∑ Scroll to zoom ¬∑ Click a node to open ¬∑ Shift+Click to link</div>
        </div>
      </section>

      <section class="view" id="viewGames">
        <div class="gamesWrap">
          <div class="gameCard">
            <div class="gameTop">
              <div class="gameTitle" id="gTitle">Arcade</div>
              <div class="gTabs">
                <div class="gTab active" id="tabPulse">Pulse Run</div>
                <div class="gTab" id="tabSnake">Neon Snake+</div>
              </div>
              <div class="gameBtns">
                <button class="btn primary" id="gStart">Start</button>
                <button class="btn" id="gClose">Back</button>
              </div>
            </div>

            <div class="gameBody">
              <div class="canvasWrap">
                <div class="modBadge" id="modBadge">MODDED RUN</div>
                <canvas id="pulseCanvas" width="720" height="420"></canvas>
                <canvas id="snakeCanvas" width="540" height="540" style="display:none"></canvas>
              </div>

              <div class="gameSide">
                <div class="scoreBox" id="pulseScoreBox">
                  <div class="r">Best (Legit) <span id="pBestLegit">0</span></div>
                  <div class="r">Best (Modded) <span id="pBestMod">0</span></div>
                  <div class="r">Run Score <span id="pScore">0</span></div>
                  <div class="smallHint">Jump: <kbd>Space</kbd> / Click ¬∑ Checkpoint: <kbd>C</kbd></div>
                </div>

                <div class="scoreBox" id="snakeScoreBox" style="display:none">
                  <div class="r">Best (Legit) <span id="sBestLegit">0</span></div>
                  <div class="r">Best (Modded) <span id="sBestMod">0</span></div>
                  <div class="r">Run Score <span id="sScore">0</span></div>
                  <div class="smallHint">Move: <kbd>WASD</kbd> / Arrows ¬∑ Dash: <kbd>Shift</kbd></div>
                </div>

                <div class="cheatBox">
                  <div class="h">Cheats / Mutators (saved)</div>
                  <div class="cheatTabs">
                    <div class="cheatTab active" id="cTabPractice">Practice</div>
                    <div class="cheatTab" id="cTabSandbox">Sandbox</div>
                    <div class="cheatTab" id="cTabCosmetic">Cosmetic</div>
                  </div>
                  <div class="cheatGrid" id="cheatGrid"></div>
                </div>

                <div class="card">
                  <div class="cardhead"><div class="h">Tip</div></div>
                  <div class="smallHint">If any cheat is on, the run is flagged as Modded and saves to Modded best.</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL='https://cgmazcvmpcgistoimqlw.supabase.co'
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc'
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY)

marked.setOptions({
  breaks:true,
  highlight:(code,lang)=>{
    try{
      if(lang && hljs.getLanguage(lang)) return hljs.highlight(code,{language:lang}).value
      return hljs.highlightAuto(code).value
    }catch(e){ return code }
  }
})

const $=id=>document.getElementById(id)
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function escHtml(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function hashStr(s){let h=2166136261;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)}return (h>>>0).toString(16)}
function parseTags(s){const t=(s||'').split(',').map(x=>x.trim()).filter(Boolean);const seen=new Set();const out=[];for(const x of t){const k=x.toLowerCase();if(seen.has(k)) continue;seen.add(k);out.push(x.slice(0,28))}return out.slice(0,12)}
function orderedPair(a,b){return a<b?[a,b]:[b,a]}
function toast(title,body,type='ok'){const wrap=$('toastWrap');const el=document.createElement('div');el.className='toast '+(type==='ok'?'ok':type==='warn'?'warn':'bad');el.innerHTML='<div class="t1"></div><div class="t2"></div>';el.querySelector('.t1').textContent=title;el.querySelector('.t2').textContent=body;wrap.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(6px)'},2600);setTimeout(()=>{el.remove()},3100)}
function setStatus(mode,msg=''){const el=$('saveStatus');const dot=el.querySelector('.dot');const txt=el.querySelectorAll('span')[1];el.classList.remove('is-saving','is-saved','is-error');if(mode==='saving'){dot.className='dot warn';txt.textContent=msg||'Saving‚Ä¶';el.classList.add('is-saving')}else if(mode==='saved'){dot.className='dot ok';txt.textContent=msg||'Synced';el.classList.add('is-saved')}else if(mode==='error'){dot.className='dot bad';txt.textContent=msg||'Save failed';el.classList.add('is-error');$('dbBanner').style.display='flex'}else if(mode==='offline'){dot.className='dot bad';txt.textContent='Offline';el.classList.add('is-error')}else{dot.className='dot warn';txt.textContent=msg||'Not saved'}}
function relTime(iso){if(!iso) return '';const t=new Date(iso).getTime();const diff=Math.max(0,Date.now()-t);const m=Math.floor(diff/60000);if(m<1) return 'just now';if(m<60) return m+'m ago';const h=Math.floor(m/60);if(h<24) return h+'h ago';const d=Math.floor(h/24);if(d<7) return d+'d ago';try{return new Date(iso).toLocaleDateString(undefined,{month:'short',day:'numeric'})}catch(e){return ''}}

let user=null
let notes=[]
let links=[]
let subjects=[]
let schools=[]
let activeId=null
let currentSchool=''
let currentTheme='ember'
let uiPrefs={sort:'updated_desc',previewFull:false,fGrade:'',fSubject:'',lastOpenNoteId:null}
let timerPresets={focus:25,break:5,long:15}
let progress={xp:0,coins:0,level:1,opened:{}}
let gameState={
  active:'pulse',
  cheatTab:'practice',
  pulse:{bestLegit:0,bestMod:0,practice:{enabled:false,autoCheckpoint:true,slowmo:1},sandbox:{invincible:false,speed:1,autoJump:false},cosmetic:{trail:true,shake:1,theme:'neon'}},
  snake:{bestLegit:0,bestMod:0,practice:{slowmo:1,step:false},sandbox:{noDie:false,speed:1,powerups:1},cosmetic:{trail:true,shake:1,theme:'neon'}}
}

let autosaveT=null
let dirty=false
let lastSig=''
let splitMode='split'
let splitSizes=[50,50]
let draggingDivider=false
let timerInterval=null
let timeLeft=25*60

let graphCanvas=null
let graphCtx=null
let graphNodes=[]
let graphEdges=[]
let graphPhysics=true
let gView={x:0,y:0,scale:1}
let gPan=false
let gPanStart=null
let gDragNode=null
let gAnim=null
let gStyle='chill'
let gHover=null
let gParticles=[]

let pulseCanvas=null
let pulseCtx=null
let pulseRun=null
let pulseRAF=null
let snakeCanvas=null
let snakeCtx=null
let snakeRun=null
let snakeRAF=null

function updateProgressUI(){
  const xp=progress.xp||0
  const lvl=progress.level||1
  $('lvlText').textContent='Level '+lvl
  $('xpText').textContent=xp+' XP'
  $('coinText').textContent=(progress.coins||0)+' ‚ú¶'
}
function bumpXP(n){
  progress.xp=Math.max(0,(progress.xp||0)+n)
  const lvl=Math.floor((progress.xp||0)/250)+1
  if(lvl>(progress.level||1)){progress.level=lvl;toast('Level up','Level '+lvl,'ok')}
  updateProgressUI()
  saveSettingsDebounced()
}
function bumpCoins(n){
  progress.coins=Math.max(0,(progress.coins||0)+n)
  updateProgressUI()
  saveSettingsDebounced()
}

async function ensureDefaults(){
  const baseSchools=['Salesianum','St Peter Cathedral']
  const baseSubjects=[{name:'Math',icon:'‚ûó'},{name:'English',icon:'üìó'},{name:'Science',icon:'üß™'},{name:'History',icon:'üèõ'}]
  for(const s of baseSchools) await supabase.from('user_schools').upsert({user_id:user.id,name:s},{onConflict:'user_id,name'})
  for(const subj of baseSubjects) await supabase.from('user_subjects').upsert({user_id:user.id,name:subj.name,icon:subj.icon},{onConflict:'user_id,name'})
  await supabase.from('user_settings').upsert({user_id:user.id},{onConflict:'user_id'})
}

let settingsT=null
function saveSettingsDebounced(){
  if(!user) return
  clearTimeout(settingsT)
  settingsT=setTimeout(async ()=>{
    const payload={user_id:user.id,current_school:currentSchool||'',theme:currentTheme||'ember',ui:uiPrefs,timer:timerPresets,game:gameState,progress:progress}
    const r=await supabase.from('user_settings').upsert(payload,{onConflict:'user_id'})
    if(r.error) console.warn(r.error.message)
  },300)
}

async function loadSettings(){
  const r=await supabase.from('user_settings').select('*').eq('user_id',user.id).maybeSingle()
  if(r.error){console.warn(r.error.message);return}
  if(r.data){
    currentSchool=r.data.current_school||''
    currentTheme=r.data.theme||'ember'
    uiPrefs={...uiPrefs,...(r.data.ui||{})}
    timerPresets={...timerPresets,...(r.data.timer||{})}
    gameState={...gameState,...(r.data.game||{})}
    progress={...progress,...(r.data.progress||{})}
  }
  document.body.setAttribute('data-theme',currentTheme||'ember')
  $('setTheme').value=currentTheme||'ember'
  $('sort').value=uiPrefs.sort||'updated_desc'
  $('setPreviewFull').value=uiPrefs.previewFull?'1':'0'
  $('fGrade').value=uiPrefs.fGrade||''
  updateProgressUI()
  $('setFocus').value=timerPresets.focus||25
  $('setBreak').value=timerPresets.break||5
  $('setLong').value=timerPresets.long||15
  setTimer(timerPresets.focus||25)
}

async function fetchSchools(){
  const r=await supabase.from('user_schools').select('name').eq('user_id',user.id).order('name',{ascending:true})
  if(r.error){schools=[];return}
  schools=(r.data||[]).map(x=>x.name)
  if(!schools.length) schools=['Salesianum','St Peter Cathedral']
  const sel=$('schoolSelect')
  sel.innerHTML=schools.map(n=>'<option value="'+escHtml(n)+'">'+escHtml(n)+'</option>').join('')
  if(!currentSchool) currentSchool=schools[0]
  if(!schools.includes(currentSchool)) currentSchool=schools[0]
  sel.value=currentSchool
}

async function fetchSubjects(){
  const r=await supabase.from('user_subjects').select('name,icon').eq('user_id',user.id).order('name',{ascending:true})
  if(r.error){subjects=[];return}
  subjects=r.data||[]
  const sel=$('subject')
  const fsel=$('fSubject')
  const opt=['<option value="">Subject: (none)</option>'].concat(subjects.map(s=>'<option value="'+escHtml(s.name)+'">'+escHtml((s.icon||'üìò')+' '+s.name)+'</option>'))
  sel.innerHTML=opt.join('')
  const opt2=['<option value="">Subject: All</option>'].concat(subjects.map(s=>'<option value="'+escHtml(s.name)+'">'+escHtml((s.icon||'üìò')+' '+s.name)+'</option>'))
  fsel.innerHTML=opt2.join('')
  fsel.value=uiPrefs.fSubject||''
}

async function addSchool(name){
  const n=(name||'').trim()
  if(!n) return
  const r=await supabase.from('user_schools').upsert({user_id:user.id,name:n},{onConflict:'user_id,name'})
  if(r.error){toast('School',r.error.message,'bad');return}
  await fetchSchools()
  currentSchool=n
  $('schoolSelect').value=currentSchool
  saveSettingsDebounced()
  renderList()
  updateCrumb()
  autosave()
  toast('School added',n,'ok')
}

async function addSubject(name){
  const n=(name||'').trim()
  if(!n) return
  const r=await supabase.from('user_subjects').upsert({user_id:user.id,name:n,icon:'üìò'},{onConflict:'user_id,name'})
  if(r.error){toast('Subject',r.error.message,'bad');return}
  await fetchSubjects()
  $('subject').value=n
  saveSettingsDebounced()
  toast('Subject added',n,'ok')
}

async function fetchLinks(){
  const r=await supabase.from('note_links').select('note_a,note_b').eq('user_id',user.id)
  if(r.error){links=[];return}
  links=r.data||[]
}
function rebuildLinked(){
  const map={}
  notes.forEach(n=>map[n.id]=[])
  links.forEach(l=>{
    if(map[l.note_a]) map[l.note_a].push(l.note_b)
    if(map[l.note_b]) map[l.note_b].push(l.note_a)
  })
  notes=notes.map(n=>({...n,linked_notes:map[n.id]||[]}))
}

async function fetchNotes(){
  const r=await supabase.from('notes').select('*').eq('user_id',user.id).eq('archived',false).order('updated_at',{ascending:false})
  if(r.error){
    console.error(r.error)
    toast('Load failed',r.error.message,'bad')
    $('dbBanner').style.display='flex'
    return
  }
  $('dbBanner').style.display='none'
  notes=(r.data||[]).map(n=>({...n,linked_notes:[]}))
  await fetchLinks()
  rebuildLinked()
  renderList()
  const last=uiPrefs.lastOpenNoteId
  if(last && notes.some(n=>n.id===last)) loadNote(last,true)
  else if(notes.length) loadNote(notes[0].id,true)
  else setEmptyState()
}

function noteSnippet(n){
  const s=(n.content||'').replace(/\s+/g,' ').trim()
  if(!s) return 'No content yet.'
  return s.length>90? s.slice(0,90)+'‚Ä¶' : s
}
const gradeOrder={ '':99, '8th':0, '9th':1, '10th':2, '11th':3, '12th':4 }
function sortNotes(arr){
  const mode=uiPrefs.sort||'updated_desc'
  const copy=[...arr]
  if(mode==='title_asc') copy.sort((a,b)=>((a.title||'').toLowerCase()).localeCompare((b.title||'').toLowerCase()))
  else if(mode==='grade_asc') copy.sort((a,b)=>(gradeOrder[a.grade||'']-gradeOrder[b.grade||''])||(((b.updated_at||'')>(a.updated_at||''))?1:-1))
  else if(mode==='subject_asc') copy.sort((a,b)=>((a.subject||'').toLowerCase()).localeCompare((b.subject||'').toLowerCase())||(((b.updated_at||'')>(a.updated_at||''))?1:-1))
  else copy.sort((a,b)=>((b.updated_at||'')>(a.updated_at||''))?1:-1)
  return copy
}
function renderList(){
  const q=($('search').value||'').trim().toLowerCase()
  const gF=uiPrefs.fGrade||''
  const sF=uiPrefs.fSubject||''
  const sorted=sortNotes(notes)
  const groups={}
  let total=0
  sorted.forEach(n=>{
    const title=(n.title||'').toLowerCase()
    const body=(n.content||'').toLowerCase()
    const tags=(n.tags||[]).join(',').toLowerCase()
    if(q && !(title.includes(q)||body.includes(q)||tags.includes(q))) return
    if(gF && (n.grade||'')!==gF) return
    if(sF && (n.subject||'')!==sF) return
    const key=(n.subject||'')||'No Subject'
    if(!groups[key]) groups[key]=[]
    groups[key].push(n)
    total++
  })
  const wrap=$('noteList')
  if(total===0){
    wrap.innerHTML='<div style="padding:22px 12px;color:rgba(238,242,255,.55);font-weight:900;line-height:1.7">No notes found.</div>'
    return
  }
  const keys=Object.keys(groups).sort((a,b)=>a.localeCompare(b))
  let html=''
  for(const k of keys){
    const arr=groups[k]
    html+='<div class="group"><div class="group-head"><div>'+escHtml(k)+'</div><div class="count">'+arr.length+'</div></div>'
    for(const n of arr){
      const t=(n.title&&n.title.trim()?n.title:'Untitled')
      const tag=(n.grade?'<div class="tag">'+escHtml(n.grade)+'</div>':'')
      const badges=[]
      if((n.linked_notes||[]).length) badges.push('<div class="badge link">LINK</div>')
      if(n.pinned) badges.push('<div class="badge pin">PIN</div>')
      const isActive=n.id===activeId
      html+='<div class="note-card '+(isActive?'active':'')+'" data-id="'+n.id+'">'
      html+='<div class="note-title"><div class="t">'+escHtml(t)+'</div>'+tag+'</div>'
      html+='<div class="note-snippet">'+escHtml(noteSnippet(n))+'</div>'
      html+='<div class="note-meta"><div>'+escHtml(relTime(n.updated_at||n.created_at))+'</div><div class="badges">'+badges.join('')+'</div></div>'
      html+='</div>'
    }
    html+='</div>'
  }
  wrap.innerHTML=html
  wrap.querySelectorAll('.note-card').forEach(c=>c.onclick=()=>{loadNote(c.getAttribute('data-id')); if(window.innerWidth<=900) closeMobileSidebar()})
}

function setEmptyState(){
  activeId=null
  $('crumbTitle').textContent='No notes yet'
  $('crumbSub').innerHTML=''
  $('title').value=''
  $('body').value=''
  $('grade').value=''
  $('subject').value=''
  $('tags').value=''
  $('pTitle').textContent='Untitled'
  $('pMeta').innerHTML=''
  $('pBody').innerHTML='<div style="color:rgba(238,242,255,.55);font-weight:900;line-height:1.7">Create your first note using New Note.</div>'
  $('cardLinks').style.display='none'
  $('cardBack').style.display='none'
  $('cardDrop').style.display='none'
}

function getActiveNote(){return notes.find(x=>x.id===activeId)||null}

function draftKey(){return user ? 'studyos_draft_'+user.id+'_'+(activeId||'') : ''}
function saveDraftLocal(){
  if(!user || !activeId) return
  const payload={at:Date.now(),title:$('title').value,content:$('body').value,grade:$('grade').value||'',subject:$('subject').value||'',tags:parseTags($('tags').value)}
  try{localStorage.setItem(draftKey(),JSON.stringify(payload))}catch(e){}
}
function clearDraftLocal(){
  if(!user || !activeId) return
  try{localStorage.removeItem(draftKey())}catch(e){}
}
function maybeRecoverDraft(note){
  if(!user || !note) return
  let raw=''
  try{raw=localStorage.getItem('studyos_draft_'+user.id+'_'+note.id)||''}catch(e){}
  if(!raw) return
  let d=null
  try{d=JSON.parse(raw)}catch(e){}
  if(!d || !d.at) return
  const serverT=new Date(note.updated_at||note.created_at||0).getTime()
  if(d.at>serverT+1500){
    $('title').value=d.title||''
    $('body').value=d.content||''
    $('grade').value=d.grade||''
    $('subject').value=d.subject||''
    $('tags').value=(d.tags||[]).join(', ')
    toast('Recovered','Unsaved edits restored','warn')
  }
}

function updateCrumb(){
  const n=getActiveNote()
  const title=(($('title').value||n?.title||'')||'Untitled').trim()||'Untitled'
  $('crumbTitle').textContent=title
  const chips=[]
  const g=$('grade').value||n?.grade||''
  const s=$('subject').value||n?.subject||''
  if(g) chips.push('<span class="chip">Grade '+escHtml(g)+'</span>')
  if(s) chips.push('<span class="chip">'+escHtml(s)+'</span>')
  chips.push('<span class="chip">'+escHtml(currentSchool||'')+'</span>')
  if(n?.updated_at) chips.push('<span class="chip">'+escHtml(relTime(n.updated_at))+'</span>')
  $('crumbSub').innerHTML=chips.join('')
}

function loadNote(id,quiet=false){
  const n=notes.find(x=>x.id===id)
  if(!n) return
  activeId=id
  uiPrefs.lastOpenNoteId=id
  saveSettingsDebounced()
  $('title').value=n.title||''
  $('body').value=n.content||''
  $('grade').value=n.grade||''
  $('subject').value=n.subject||''
  $('tags').value=(n.tags||[]).join(', ')
  maybeRecoverDraft(n)
  updateCrumb()
  renderList()
  updatePreview()
  refreshLinksUI()
  setStatus('saved','Synced')
  if(!quiet){
    const opened=progress.opened||{}
    if(!opened[id]){
      opened[id]=1
      progress.opened=opened
      bumpCoins(2)
      bumpXP(2)
    }
  }
}

async function createNote(){
  if(!user){toast('Not signed in','Sign in first','bad');return}
  const payload={user_id:user.id,title:'',content:'',grade:'',school:currentSchool||'',subject:'',tags:[],pinned:false,archived:false,rev:0}
  const r=await supabase.from('notes').insert(payload).select().single()
  if(r.error){toast('Create failed',r.error.message,'bad');return}
  notes.unshift({...r.data,linked_notes:[]})
  renderList()
  loadNote(r.data.id,true)
  toast('New note','Created','ok')
  bumpXP(5)
}

async function deleteNote(){
  if(!activeId) return
  const n=getActiveNote()
  const t=(n?.title&&n.title.trim()?n.title:'Untitled')
  if(!confirm('Delete "'+t+'"?')) return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  const r=await supabase.from('notes').delete().eq('id',activeId).eq('user_id',user.id)
  if(r.error){toast('Delete failed',r.error.message,'bad');return}
  try{localStorage.removeItem('studyos_draft_'+user.id+'_'+activeId)}catch(e){}
  notes=notes.filter(x=>x.id!==activeId)
  links=links.filter(l=>l.note_a!==activeId && l.note_b!==activeId)
  rebuildLinked()
  renderList()
  toast('Deleted',t,'warn')
  if(notes.length) loadNote(notes[0].id,true)
  else setEmptyState()
  bumpXP(1)
}

function togglePinned(){
  const n=getActiveNote()
  if(!n) return
  n.pinned=!n.pinned
  autosave()
  renderList()
  toast(n.pinned?'Pinned':'Unpinned','',n.pinned?'ok':'warn')
}

function updatePreview(){
  const n=getActiveNote()
  const title=( $('title').value || (n?.title||'') || 'Untitled' ).trim() || 'Untitled'
  $('pTitle').textContent=title
  const meta=[]
  const g=$('grade').value||n?.grade||''
  const s=$('subject').value||n?.subject||''
  if(g) meta.push('<span class="chip">Grade '+escHtml(g)+'</span>')
  if(s) meta.push('<span class="chip">'+escHtml(s)+'</span>')
  meta.push('<span class="chip">'+escHtml(currentSchool||'')+'</span>')
  const tags=parseTags($('tags').value)
  if(tags.length) meta.push('<span class="chip">#'+escHtml(tags.join(' ¬∑ '))+'</span>')
  $('pMeta').innerHTML=meta.join('')
  const md=$('body').value||n?.content||''
  $('pBody').innerHTML=marked.parse(md)
  $('pBody').querySelectorAll('pre code').forEach(b=>{try{hljs.highlightElement(b)}catch(e){}})
  updatePreviewLinks()
}
function updatePreviewLinks(){
  const n=getActiveNote()
  const ids=(n?.linked_notes||[])
  if(ids.length){
    $('pLinksCard').style.display='block'
    $('pLinks').innerHTML=ids.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-open="'+id+'">'+escHtml(t)+'</div>'
    }).join('')
    $('pLinks').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>loadNote(p.getAttribute('data-open')))
  }else $('pLinksCard').style.display='none'
}

function refreshLinksUI(){
  const cur=getActiveNote()
  if(!cur){$('cardLinks').style.display='none';$('cardBack').style.display='none';return}
  const linked=cur.linked_notes||[]
  if(linked.length){
    $('cardLinks').style.display='block'
    $('linksPills').innerHTML=linked.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-open="'+id+'" data-id="'+id+'">'+escHtml(t)+'<div class="x" data-x="'+id+'">√ó</div></div>'
    }).join('')
    $('linksPills').querySelectorAll('.pillnote').forEach(p=>{
      p.onclick=e=>{
        const xid=e.target?.getAttribute?.('data-x')
        if(xid){unlinkNote(xid);return}
        loadNote(p.getAttribute('data-open'))
      }
    })
  }else $('cardLinks').style.display='none'
  const bl=[]
  for(const n of notes){
    if(n.id===activeId) continue
    if((n.linked_notes||[]).includes(activeId)) bl.push(n.id)
  }
  if(bl.length){
    $('cardBack').style.display='block'
    $('backPills').innerHTML=bl.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      return '<div class="pillnote" data-open="'+id+'">'+escHtml(t)+'</div>'
    }).join('')
    $('backPills').querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>loadNote(p.getAttribute('data-open')))
  }else $('cardBack').style.display='none'
}

function showLinkDrop(list){
  $('cardDrop').style.display='block'
  const wrap=$('dropList')
  if(!list.length){
    wrap.innerHTML='<div style="padding:10px;color:rgba(238,242,255,.55);font-weight:900">No matches</div>'
    return
  }
  wrap.innerHTML=list.map(n=>{
    const t=(n.title&&n.title.trim()?n.title:'Untitled')
    const g=n.grade?(' ¬∑ '+n.grade):''
    return '<div class="pillnote" style="width:100%;justify-content:space-between" data-pick="'+n.id+'"><span>'+escHtml(t)+'</span><span style="color:rgba(238,242,255,.45);font-weight:950;font-size:11px">'+escHtml(g)+'</span></div>'
  }).join('')
  wrap.querySelectorAll('.pillnote').forEach(p=>p.onclick=()=>linkNote(p.getAttribute('data-pick')))
}
function searchLinkCandidates(){
  if(!activeId) return
  const cur=getActiveNote()
  if(!cur) return
  const q=($('linkSearch').value||'').trim().toLowerCase()
  if(!q){$('cardDrop').style.display='none';return}
  const already=new Set(cur.linked_notes||[])
  const list=notes.filter(n=>n.id!==activeId).filter(n=>!already.has(n.id)).filter(n=>((n.title||'').toLowerCase().includes(q))).slice(0,8)
  showLinkDrop(list)
}
async function linkNote(lid){
  if(!activeId || !lid || activeId===lid) return
  const [a,b]=orderedPair(activeId,lid)
  const r=await supabase.from('note_links').upsert({user_id:user.id,note_a:a,note_b:b},{onConflict:'user_id,note_a,note_b'})
  if(r.error){toast('Link failed',r.error.message,'bad');return}
  $('linkSearch').value=''
  $('cardDrop').style.display='none'
  await fetchLinks()
  rebuildLinked()
  refreshLinksUI()
  renderList()
  toast('Linked','', 'ok')
  bumpXP(2)
}
async function unlinkNote(lid){
  if(!activeId || !lid) return
  const [a,b]=orderedPair(activeId,lid)
  const r=await supabase.from('note_links').delete().eq('user_id',user.id).eq('note_a',a).eq('note_b',b)
  if(r.error){toast('Unlink failed',r.error.message,'bad');return}
  await fetchLinks()
  rebuildLinked()
  refreshLinksUI()
  renderList()
  toast('Unlinked','', 'warn')
}
async function unlinkAll(){
  if(!activeId) return
  if(!confirm('Unlink all?')) return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  await fetchLinks()
  rebuildLinked()
  refreshLinksUI()
  renderList()
  toast('Unlinked','All connections removed','warn')
}

function autosave(){
  if(!activeId) return
  if(!navigator.onLine){setStatus('offline');return}
  dirty=true
  setStatus('saving','Typing‚Ä¶')
  saveDraftLocal()
  clearTimeout(autosaveT)
  autosaveT=setTimeout(async ()=>{if(!dirty) return; await saveNote()},850)
}

async function saveNote(){
  if(!activeId || !user) return
  if(!navigator.onLine){setStatus('offline');return}
  const n=getActiveNote()
  if(!n) return
  const title=$('title').value
  const content=$('body').value
  const grade=$('grade').value||''
  const subject=$('subject').value||''
  const tags=parseTags($('tags').value)
  const pinned=!!n.pinned
  const sig=hashStr([title,content,grade,subject,tags.join('|'),String(pinned),String(currentSchool)].join('¬ß'))
  if(sig===lastSig && !dirty){setStatus('saved','Synced');return}
  dirty=false
  setStatus('saving','Saving‚Ä¶')
  const payload={title,content,grade,subject,tags,school:currentSchool||'',pinned,rev:(n.rev||0)+1}
  const r=await supabase.from('notes').update(payload).eq('id',activeId).eq('user_id',user.id).select().single()
  if(r.error){
    setStatus('error',r.error.message)
    toast('Save failed',r.error.message,'bad')
    return
  }
  const idx=notes.findIndex(x=>x.id===activeId)
  if(idx>=0) notes[idx]={...notes[idx],...r.data,linked_notes:notes[idx].linked_notes||[]}
  lastSig=sig
  clearDraftLocal()
  setStatus('saved','Synced')
  updateCrumb()
  renderList()
  updatePreview()
  refreshLinksUI()
}

function applyMd(action){
  const ta=$('body')
  const start=ta.selectionStart
  const end=ta.selectionEnd
  const sel=ta.value.slice(start,end)
  const before=ta.value.slice(0,start)
  const after=ta.value.slice(end)
  let rep=''
  if(action==='bold') rep='**'+(sel||'bold')+'**'
  if(action==='italic') rep='*'+(sel||'italic')+'*'
  if(action==='h1') rep='# '+(sel||'Heading')
  if(action==='h2') rep='## '+(sel||'Heading')
  if(action==='ul') rep='- '+(sel||'Item')
  if(action==='ol') rep='1. '+(sel||'Item')
  if(action==='quote') rep='> '+(sel||'Quote')
  if(action==='code') rep='```\\n'+(sel||'code')+'\\n```'
  if(action==='link') rep='['+(sel||'text')+'](https://)'
  ta.value=before+rep+after
  const pos=before.length+rep.length
  ta.setSelectionRange(pos,pos)
  ta.focus()
  autosave()
}

function setView(v){
  $('viewEditor').classList.toggle('active',v==='editor')
  $('viewPreview').classList.toggle('active',v==='preview')
  $('viewGraph').classList.toggle('active',v==='graph')
  $('viewGames').classList.toggle('active',v==='games')
  $('modeEdit').classList.toggle('active',v==='editor')
  $('modePreview').classList.toggle('active',v==='preview')
  $('modeGraph').classList.toggle('active',v==='graph')
  if(v==='preview') updatePreview()
  if(v==='graph') drawGraph()
}
function setSplit(mode){
  splitMode=mode
  const split=$('split')
  split.classList.remove('singleEditor','singlePreview')
  $('divider').style.display='flex'
  $('paneRight').style.display='block'
  $('paneLeft').style.display='block'
  if(mode==='editor'){split.classList.add('singleEditor');$('paneRight').style.display='none';$('divider').style.display='none'}
  else if(mode==='preview'){split.classList.add('singlePreview');$('paneLeft').style.display='none';$('divider').style.display='none';updatePreview();setView('preview')}
  else applySplitSizes()
}
function applySplitSizes(){
  const split=$('split')
  const a=clamp(splitSizes[0],22,78)
  const b=100-a
  split.style.gridTemplateColumns=a+'% 12px '+b+'%'
}

function initSplitResize(){
  $('divider').addEventListener('mousedown',()=>{draggingDivider=true;document.body.style.cursor='col-resize'})
  window.addEventListener('mouseup',()=>{if(!draggingDivider) return;draggingDivider=false;document.body.style.cursor=''})
  window.addEventListener('mousemove',e=>{
    if(!draggingDivider) return
    const split=$('split')
    const rect=split.getBoundingClientRect()
    const x=e.clientX-rect.left
    const pct=clamp((x/rect.width)*100,22,78)
    splitSizes=[pct,100-pct]
    applySplitSizes()
  })
}

function setTimer(min){
  pauseTimer()
  timeLeft=min*60
  updateTimerDisplay()
}
function updateTimerDisplay(){
  const m=Math.floor(timeLeft/60).toString().padStart(2,'0')
  const s=(timeLeft%60).toString().padStart(2,'0')
  $('timerText').textContent=m+':'+s
}
function startTimer(){
  if(timerInterval) return
  timerInterval=setInterval(()=>{
    if(timeLeft>0){timeLeft--;updateTimerDisplay()}
    else{
      pauseTimer()
      toast('Timer',"Time's up",'ok')
      bumpXP(10)
    }
  },1000)
}
function pauseTimer(){clearInterval(timerInterval);timerInterval=null}
function resetTimer(){pauseTimer();setTimer(timerPresets.focus||25)}

function openSettings(){ $('modalSettings').style.display='flex' }
function closeSettings(){ $('modalSettings').style.display='none' }
async function saveSettingsFromModal(){
  currentTheme=$('setTheme').value||'ember'
  document.body.setAttribute('data-theme',currentTheme)
  uiPrefs.previewFull=$('setPreviewFull').value==='1'
  timerPresets.focus=clamp(parseInt($('setFocus').value||25,10),1,180)
  timerPresets.break=clamp(parseInt($('setBreak').value||5,10),1,60)
  timerPresets.long=clamp(parseInt($('setLong').value||15,10),1,120)
  const ns=($('setNewSchool').value||'').trim()
  const nsub=($('setNewSubject').value||'').trim()
  $('setNewSchool').value=''
  $('setNewSubject').value=''
  saveSettingsDebounced()
  closeSettings()
  toast('Saved','Settings synced','ok')
  if(ns) await addSchool(ns)
  if(nsub) await addSubject(nsub)
}

function openPdfModal(){ $('modalPdf').style.display='flex' }
function closePdfModal(){ $('modalPdf').style.display='none' }

async function exportPdf(){
  const n=getActiveNote()
  if(!n) return
  const includeLinks=$('pdfIncludeLinks').value==='1'
  const mode=$('pdfTheme').value||'light'
  toast('Exporting','Rendering‚Ä¶','warn')
  const wrap=document.createElement('div')
  wrap.style.width='820px'
  wrap.style.padding='34px'
  wrap.style.fontFamily='Inter,Arial,sans-serif'
  wrap.style.lineHeight='1.7'
  wrap.style.background=mode==='dark' ? '#0b0b10' : '#ffffff'
  wrap.style.color=mode==='dark' ? '#f3f4f6' : '#111111'
  const h=document.createElement('div')
  h.style.fontSize='34px'
  h.style.fontWeight='900'
  h.style.marginBottom='10px'
  h.textContent=(n.title&&n.title.trim()?n.title:'Untitled')
  wrap.appendChild(h)
  const meta=document.createElement('div')
  meta.style.display='flex'
  meta.style.flexWrap='wrap'
  meta.style.gap='8px'
  meta.style.marginBottom='18px'
  const chip=(txt)=>{
    const s=document.createElement('span')
    s.textContent=txt
    s.style.fontSize='12px'
    s.style.fontWeight='800'
    s.style.padding='6px 10px'
    s.style.borderRadius='999px'
    s.style.border=mode==='dark'?'1px solid rgba(255,255,255,.14)':'1px solid #e7e7e7'
    s.style.background=mode==='dark'?'rgba(255,255,255,.06)':'#fafafa'
    return s
  }
  if(n.grade) meta.appendChild(chip('Grade: '+n.grade))
  if(n.subject) meta.appendChild(chip('Subject: '+n.subject))
  meta.appendChild(chip('School: '+(n.school||currentSchool||'')))
  const tags=n.tags||[]
  if(tags.length) meta.appendChild(chip('#'+tags.join(' ¬∑ ')))
  wrap.appendChild(meta)
  const body=document.createElement('div')
  body.innerHTML=marked.parse(n.content||'')
  body.querySelectorAll('pre').forEach(p=>{
    p.style.borderRadius='12px'
    p.style.padding='14px'
    p.style.overflowX='auto'
    p.style.background='#0f1117'
    p.style.color='#f5f5f5'
  })
  body.querySelectorAll('code').forEach(c=>{
    c.style.fontFamily='JetBrains Mono,Consolas,monospace'
    c.style.fontSize='12px'
  })
  wrap.appendChild(body)
  if(includeLinks && (n.linked_notes||[]).length){
    const tt=document.createElement('div')
    tt.style.marginTop='22px'
    tt.style.fontWeight='900'
    tt.style.fontSize='16px'
    tt.textContent='Linked Notes'
    wrap.appendChild(tt)
    for(const id of (n.linked_notes||[])){
      const ln=notes.find(x=>x.id===id)
      if(!ln) continue
      const sec=document.createElement('div')
      sec.style.marginTop='14px'
      sec.style.paddingTop='12px'
      sec.style.borderTop=mode==='dark'?'1px solid rgba(255,255,255,.14)':'1px solid #e7e7e7'
      const th=document.createElement('div')
      th.style.fontSize='18px'
      th.style.fontWeight='900'
      th.textContent=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      sec.appendChild(th)
      const bb=document.createElement('div')
      bb.style.marginTop='8px'
      bb.innerHTML=marked.parse(ln.content||'')
      sec.appendChild(bb)
      wrap.appendChild(sec)
    }
  }
  const holder=document.createElement('div')
  holder.style.position='fixed'
  holder.style.left='-99999px'
  holder.style.top='0'
  holder.appendChild(wrap)
  document.body.appendChild(holder)
  const canvas=await html2canvas(wrap,{scale:2,backgroundColor:mode==='dark'?'#0b0b10':'#ffffff'})
  const imgData=canvas.toDataURL('image/png')
  holder.remove()
  const {jsPDF}=window.jspdf
  const pdf=new jsPDF('p','pt','a4')
  const pageW=pdf.internal.pageSize.getWidth()
  const pageH=pdf.internal.pageSize.getHeight()
  const imgW=pageW
  const imgH=canvas.height*(imgW/canvas.width)
  let y=0
  let remaining=imgH
  pdf.addImage(imgData,'PNG',0,y,imgW,imgH)
  remaining-=pageH
  while(remaining>0){
    y=remaining-imgH
    pdf.addPage()
    pdf.addImage(imgData,'PNG',0,y,imgW,imgH)
    remaining-=pageH
  }
  const fname=((n.title&&n.title.trim()?n.title:'note')+'.pdf').replace(/[\\/:*?"<>|]+/g,'_')
  pdf.save(fname)
  closePdfModal()
  toast('Exported','PDF saved','ok')
  bumpXP(3)
}

function openPalette(){ $('paletteBack').style.display='flex'; $('paletteQ').value=''; renderPalette(''); setTimeout(()=>$('paletteQ').focus(),0) }
function closePalette(){ $('paletteBack').style.display='none' }
function renderPalette(q){
  const query=(q||'').toLowerCase().trim()
  const items=[]
  const add=(ico,a,b,k,fn)=>items.push({ico,a,b,k,fn})
  add('‚úè','New note','Create a note','Enter',()=>createNote())
  add('üìù','Edit','Go to editor','Enter',()=>setView('editor'))
  add('üëÅ','Preview','Go to preview','Enter',()=>setView('preview'))
  add('üï∏','Graph','Open graph','Enter',()=>setView('graph'))
  add('üéÆ','Arcade','Open arcade','Enter',()=>setView('games'))
  add('üìå','Pin/unpin','Pin current note','Enter',()=>togglePinned())
  add('üìÑ','Export PDF','Export current note','Enter',()=>openPdfModal())
  add('‚öô','Settings','Open settings','Enter',()=>openSettings())
  if(activeId) add('üíæ','Save now','Force save','Enter',()=>saveNote())
  const themeNames={ember:'Ember',mint:'Mint Chill',haze:'Purple Haze',ocean:'Ocean',mono:'Mono'}
  for(const key of Object.keys(themeNames)){
    add('üé®','Theme: '+themeNames[key],'Switch theme','Enter',()=>{
      currentTheme=key
      document.body.setAttribute('data-theme',key)
      $('setTheme').value=key
      saveSettingsDebounced()
      toast('Theme',themeNames[key],'ok')
    })
  }
  const noteHits=notes.map(n=>({id:n.id,title:(n.title&&n.title.trim()?n.title:'Untitled'),body:(n.content||'')})).filter(n=>{
    if(!query) return false
    return n.title.toLowerCase().includes(query) || n.body.toLowerCase().includes(query)
  }).slice(0,10)
  for(const n of noteHits) add('üìå',n.title,'Open note','Enter',()=>loadNote(n.id))
  const filtered=items.filter(it=>{if(!query) return true; return it.a.toLowerCase().includes(query) || it.b.toLowerCase().includes(query)})
  const list=$('paletteList')
  list.innerHTML=filtered.map((it,i)=>{
    return '<div class="pItem" data-i="'+i+'"><div class="l"><div class="pIco">'+it.ico+'</div><div class="pTxt"><div class="pA">'+escHtml(it.a)+'</div><div class="pB">'+escHtml(it.b)+'</div></div></div><div class="pK">'+escHtml(it.k)+'</div></div>'
  }).join('')
  list.querySelectorAll('.pItem').forEach(row=>{
    row.onclick=()=>{
      const idx=parseInt(row.getAttribute('data-i'),10)
      closePalette()
      filtered[idx].fn()
    }
  })
}

function openMobileSidebar(){$('sidebar').classList.add('open');$('backdrop').classList.add('show')}
function closeMobileSidebar(){$('sidebar').classList.remove('open');$('backdrop').classList.remove('show')}
function maybeMobileUI(){const isMobile=window.innerWidth<=900;$('mobileMenu').style.display=isMobile?'flex':'none'}

function initGraph(){
  graphCanvas=$('graph')
  graphCtx=graphCanvas.getContext('2d')
  resizeGraph()
  window.addEventListener('resize',()=>{resizeGraph();renderGraph()})
  graphCanvas.addEventListener('mousedown',gDown)
  graphCanvas.addEventListener('mousemove',gMove)
  graphCanvas.addEventListener('mouseup',gUp)
  graphCanvas.addEventListener('wheel',gWheel,{passive:false})
  seedParticles()
}
function resizeGraph(){
  const r=graphCanvas.getBoundingClientRect()
  graphCanvas.width=Math.floor(r.width*devicePixelRatio)
  graphCanvas.height=Math.floor(r.height*devicePixelRatio)
  graphCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0)
}
function seedParticles(){
  gParticles=[]
  const r=graphCanvas.getBoundingClientRect()
  const W=r.width,H=r.height
  const count=gStyle==='study'?45:gStyle==='arcade'?95:75
  for(let i=0;i<count;i++){
    gParticles.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*(gStyle==='arcade'?0.55:0.25),vy:(Math.random()-.5)*(gStyle==='arcade'?0.55:0.25),s:Math.random()*(gStyle==='arcade'?2.2:1.6)+0.6,a:Math.random()*0.8+0.15})
  }
}
function buildGraph(){
  const r=graphCanvas.getBoundingClientRect()
  const W=r.width,H=r.height
  const N=notes.length||1
  graphNodes=notes.map((n,i)=>{
    const a=(i/N)*Math.PI*2
    const rad=Math.min(W,H)*(0.22+Math.random()*0.08)
    const size=clamp(18+Math.min(18,(n.content||'').length/250),18,36)
    const ln=(n.linked_notes||[]).length
    const boost=Math.min(12,ln*2.5)
    return{ id:n.id,label:(n.title&&n.title.trim()?n.title:'Untitled'),x:Math.cos(a)*rad,y:Math.sin(a)*rad,vx:0,vy:0,r:size+boost*0.25,w:0.25 }
  })
  graphEdges=links.map(l=>({a:l.note_a,b:l.note_b}))
  gView={x:0,y:0,scale:1}
}
function screenToWorld(sx,sy){
  const r=graphCanvas.getBoundingClientRect()
  const cx=r.width/2, cy=r.height/2
  return { x:(sx - cx - gView.x)/gView.scale, y:(sy - cy - gView.y)/gView.scale }
}
function hitNode(wx,wy){
  let best=null
  let bestD=1e9
  for(const n of graphNodes){
    const dx=n.x-wx
    const dy=n.y-wy
    const d=Math.sqrt(dx*dx+dy*dy)
    if(d<(n.r+6) && d<bestD){best=n;bestD=d}
  }
  return best
}
function drawParticles(){
  const r=graphCanvas.getBoundingClientRect()
  const W=r.width,H=r.height
  for(const p of gParticles){
    p.x+=p.vx
    p.y+=p.vy
    if(p.x<0){p.x=W;p.y=Math.random()*H}
    if(p.x>W){p.x=0;p.y=Math.random()*H}
    if(p.y<0){p.y=H;p.x=Math.random()*W}
    if(p.y>H){p.y=0;p.x=Math.random()*W}
    graphCtx.globalAlpha=p.a
    graphCtx.beginPath()
    graphCtx.arc(p.x,p.y,p.s,0,Math.PI*2)
    graphCtx.fill()
  }
  graphCtx.globalAlpha=1
}
function renderGraph(){
  const r=graphCanvas.getBoundingClientRect()
  const W=r.width,H=r.height
  graphCtx.clearRect(0,0,W,H)
  const bgA=gStyle==='study'?0.06:gStyle==='arcade'?0.12:0.09
  graphCtx.fillStyle='rgba(255,255,255,'+bgA+')'
  graphCtx.fillRect(0,0,W,H)
  graphCtx.fillStyle='rgba(255,255,255,'+(gStyle==='study'?0.12:0.16)+')'
  drawParticles()
  graphCtx.save()
  graphCtx.translate(W/2+gView.x, H/2+gView.y)
  graphCtx.scale(gView.scale,gView.scale)
  const t=Date.now()*0.001
  const pulse=gStyle==='arcade' ? (0.4+Math.sin(t*3)*0.2) : (0.28+Math.sin(t*1.2)*0.08)
  const edgeAlpha=gStyle==='study'?0.12:(0.16+pulse*0.08)
  graphCtx.lineWidth=(gStyle==='study'?1.5:2.3)/gView.scale
  for(const e of graphEdges){
    const a=graphNodes.find(n=>n.id===e.a)
    const b=graphNodes.find(n=>n.id===e.b)
    if(!a||!b) continue
    graphCtx.strokeStyle='rgba(255,255,255,'+edgeAlpha+')'
    graphCtx.beginPath()
    graphCtx.moveTo(a.x,a.y)
    graphCtx.lineTo(b.x,b.y)
    graphCtx.stroke()
  }
  for(const n of graphNodes){
    const isActive=n.id===activeId
    const isLinked=graphEdges.some(e=>(e.a===activeId && e.b===n.id)||(e.b===activeId && e.a===n.id))
    const isHover=gHover && gHover.id===n.id
    const rr=n.r*(isHover?1.12:1)
    let fill='rgba(255,255,255,.18)'
    if(gStyle==='study') fill=isActive?'rgba(255,255,255,.85)':(isLinked?'rgba(34,197,94,.55)':'rgba(255,255,255,.14)')
    else fill=isActive?'rgba(255,106,0,.95)':(isLinked?'rgba(34,197,94,.78)':'rgba(255,255,255,.18)')
    graphCtx.save()
    graphCtx.shadowBlur=(isActive||isHover)?(34/gView.scale):(18/gView.scale)
    graphCtx.shadowColor=isActive?'rgba(255,106,0,.55)':'rgba(255,255,255,.18)'
    graphCtx.fillStyle=fill
    graphCtx.beginPath()
    graphCtx.arc(n.x,n.y,rr,0,Math.PI*2)
    graphCtx.fill()
    graphCtx.lineWidth=(2.2/gView.scale)
    graphCtx.strokeStyle=isActive?'rgba(255,255,255,.30)':(isLinked?'rgba(255,255,255,.18)':'rgba(0,0,0,.25)')
    graphCtx.stroke()
    graphCtx.restore()
    const ch=(n.label||'U').trim()[0]?.toUpperCase()||'U'
    graphCtx.fillStyle='rgba(10,10,10,.88)'
    graphCtx.font=(950/gView.scale)+'px Inter'
    graphCtx.textAlign='center'
    graphCtx.textBaseline='middle'
    graphCtx.fillText(ch,n.x,n.y)
    graphCtx.fillStyle='rgba(238,242,255,.92)'
    graphCtx.font=(900/gView.scale)+'px Inter'
    graphCtx.textAlign='center'
    graphCtx.textBaseline='alphabetic'
    const label=n.label.length>18?n.label.slice(0,18)+'‚Ä¶':n.label
    graphCtx.fillText(label,n.x,n.y+rr+24)
  }
  graphCtx.restore()
}
function stepGraph(){
  if(graphPhysics){
    for(const n of graphNodes){
      let fx=0,fy=0
      for(const o of graphNodes){
        if(o===n) continue
        const dx=n.x-o.x
        const dy=n.y-o.y
        const d=Math.sqrt(dx*dx+dy*dy)||1
        const rep=(gStyle==='study'?650:1200)/(d*d)
        fx+=(dx/d)*rep
        fy+=(dy/d)*rep
      }
      for(const e of graphEdges){
        if(e.a!==n.id && e.b!==n.id) continue
        const oid=(e.a===n.id?e.b:e.a)
        const o=graphNodes.find(x=>x.id===oid)
        if(!o) continue
        const spring=gStyle==='study'?0.010:0.014
        fx+=(o.x-n.x)*spring
        fy+=(o.y-n.y)*spring
      }
      fx+=(-n.x)*(n.w||0.18)
      fy+=(-n.y)*(n.w||0.18)
      n.vx=(n.vx+fx)*0.86
      n.vy=(n.vy+fy)*0.86
    }
    for(const n of graphNodes){n.x+=n.vx;n.y+=n.vy}
  }
  renderGraph()
  gAnim=requestAnimationFrame(stepGraph)
}
function drawGraph(){
  if(!graphCanvas) return
  buildGraph()
  renderGraph()
  if(gAnim) cancelAnimationFrame(gAnim)
  gAnim=requestAnimationFrame(stepGraph)
}
function gDown(e){
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const w=screenToWorld(sx,sy)
  const node=hitNode(w.x,w.y)
  if(node){
    if(e.shiftKey && activeId && node.id!==activeId){linkNote(node.id);return}
    gDragNode=node
    graphPhysics=false
    return
  }
  gPan=true
  gPanStart={sx,sy,ox:gView.x,oy:gView.y}
}
function gMove(e){
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const w=screenToWorld(sx,sy)
  gHover=hitNode(w.x,w.y)
  if(gDragNode){gDragNode.x=w.x;gDragNode.y=w.y;renderGraph();return}
  if(gPan && gPanStart){gView.x=gPanStart.ox+(sx-gPanStart.sx);gView.y=gPanStart.oy+(sy-gPanStart.sy);renderGraph()}
}
function gUp(e){
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const w=screenToWorld(sx,sy)
  if(gDragNode){
    const id=gDragNode.id
    gDragNode=null
    graphPhysics=true
    const clickNode=hitNode(w.x,w.y)
    if(clickNode && clickNode.id===id){loadNote(id);setView('editor')}
    return
  }
  gPan=false
  gPanStart=null
}
function gWheel(e){
  e.preventDefault()
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const before=screenToWorld(sx,sy)
  const delta=Math.sign(e.deltaY)
  const f=delta>0?0.92:1.08
  gView.scale=clamp(gView.scale*f,0.45,3.1)
  const after=screenToWorld(sx,sy)
  gView.x+=(after.x-before.x)*gView.scale
  gView.y+=(after.y-before.y)*gView.scale
  renderGraph()
}

function initGames(){
  pulseCanvas=$('pulseCanvas');pulseCtx=pulseCanvas.getContext('2d')
  snakeCanvas=$('snakeCanvas');snakeCtx=snakeCanvas.getContext('2d')
  renderCheats()
  syncScoreUI()
  drawPulseIdle()
  drawSnakeIdle()
}
function anyCheatOn(gameKey){
  const g=gameState[gameKey]
  const chk=(o)=>Object.values(o||{}).some(v=>v===true)||Object.entries(o||{}).some(([k,v])=>typeof v==='number' && k!=='shake' && v!==1 && v!==0)
  return chk(g.practice)||chk(g.sandbox)
}
function syncScoreUI(){
  $('pBestLegit').textContent=String(gameState.pulse.bestLegit||0)
  $('pBestMod').textContent=String(gameState.pulse.bestMod||0)
  $('sBestLegit').textContent=String(gameState.snake.bestLegit||0)
  $('sBestMod').textContent=String(gameState.snake.bestMod||0)
}
function showModBadge(){ $('modBadge').classList.toggle('show', anyCheatOn(gameState.active)) }
function switchGame(mode){
  gameState.active=mode
  $('tabPulse').classList.toggle('active',mode==='pulse')
  $('tabSnake').classList.toggle('active',mode==='snake')
  $('pulseCanvas').style.display=mode==='pulse'?'block':'none'
  $('snakeCanvas').style.display=mode==='snake'?'block':'none'
  $('pulseScoreBox').style.display=mode==='pulse'?'block':'none'
  $('snakeScoreBox').style.display=mode==='snake'?'block':'none'
  $('gTitle').textContent=mode==='pulse'?'Pulse Run':'Neon Snake+'
  renderCheats()
  showModBadge()
  syncScoreUI()
}
function setCheatTab(tab){
  gameState.cheatTab=tab
  $('cTabPractice').classList.toggle('active',tab==='practice')
  $('cTabSandbox').classList.toggle('active',tab==='sandbox')
  $('cTabCosmetic').classList.toggle('active',tab==='cosmetic')
  renderCheats()
}
function cheatRow(label,ctrlHtml,affects=false){
  return '<div class="cheatRow"><div style="display:flex;gap:8px;align-items:center;min-width:0"><span>'+escHtml(label)+'</span>'+(affects?'<span class="aff">MODDED</span>':'')+'</div><div>'+ctrlHtml+'</div></div>'
}
function renderCheats(){
  const g=gameState[gameState.active]
  const tab=gameState.cheatTab
  const wrap=$('cheatGrid')
  const rows=[]
  if(gameState.active==='pulse'){
    if(tab==='practice'){
      rows.push(cheatRow('Practice Mode','<input type="checkbox" id="pPractice">',true))
      rows.push(cheatRow('Auto Checkpoint','<input type="checkbox" id="pAutoCP">',true))
      rows.push(cheatRow('Slow-Mo','<input type="range" id="pSlow" min="0.35" max="1" step="0.05">',true))
    }
    if(tab==='sandbox'){
      rows.push(cheatRow('Invincible','<input type="checkbox" id="pInv">',true))
      rows.push(cheatRow('Speed','<input type="range" id="pSpeed" min="0.6" max="2" step="0.05">',true))
      rows.push(cheatRow('Auto Jump','<input type="checkbox" id="pAutoJump">',true))
    }
    if(tab==='cosmetic'){
      rows.push(cheatRow('Trail','<input type="checkbox" id="pTrail">',false))
      rows.push(cheatRow('Screen Shake','<input type="range" id="pShake" min="0" max="2" step="0.1">',false))
      rows.push(cheatRow('Visual Theme','<select id="pVTheme"><option value="neon">Neon</option><option value="soft">Soft</option><option value="mono">Mono</option></select>',false))
    }
  }
  if(gameState.active==='snake'){
    if(tab==='practice'){
      rows.push(cheatRow('Step Mode','<input type="checkbox" id="sStep">',true))
      rows.push(cheatRow('Slow-Mo','<input type="range" id="sSlow" min="0.35" max="1" step="0.05">',true))
    }
    if(tab==='sandbox'){
      rows.push(cheatRow('No-Die','<input type="checkbox" id="sNoDie">',true))
      rows.push(cheatRow('Speed','<input type="range" id="sSpeed" min="0.6" max="2" step="0.05">',true))
      rows.push(cheatRow('Powerups','<input type="range" id="sPow" min="0.4" max="2" step="0.05">',true))
    }
    if(tab==='cosmetic'){
      rows.push(cheatRow('Trail','<input type="checkbox" id="sTrail">',false))
      rows.push(cheatRow('Screen Shake','<input type="range" id="sShake" min="0" max="2" step="0.1">',false))
      rows.push(cheatRow('Visual Theme','<select id="sVTheme"><option value="neon">Neon</option><option value="soft">Soft</option><option value="mono">Mono</option></select>',false))
    }
  }
  wrap.innerHTML=rows.join('')
  if(gameState.active==='pulse'){
    $('pPractice').checked=!!g.practice.enabled
    $('pAutoCP').checked=!!g.practice.autoCheckpoint
    $('pSlow').value=String(g.practice.slowmo??1)
    $('pInv').checked=!!g.sandbox.invincible
    $('pSpeed').value=String(g.sandbox.speed??1)
    $('pAutoJump').checked=!!g.sandbox.autoJump
    $('pTrail').checked=!!g.cosmetic.trail
    $('pShake').value=String(g.cosmetic.shake??1)
    $('pVTheme').value=g.cosmetic.theme||'neon'
    $('pPractice').onchange=()=>{g.practice.enabled=$('pPractice').checked;saveSettingsDebounced();showModBadge()}
    $('pAutoCP').onchange=()=>{g.practice.autoCheckpoint=$('pAutoCP').checked;saveSettingsDebounced();showModBadge()}
    $('pSlow').oninput=()=>{g.practice.slowmo=parseFloat($('pSlow').value);saveSettingsDebounced();showModBadge()}
    $('pInv').onchange=()=>{g.sandbox.invincible=$('pInv').checked;saveSettingsDebounced();showModBadge()}
    $('pSpeed').oninput=()=>{g.sandbox.speed=parseFloat($('pSpeed').value);saveSettingsDebounced();showModBadge()}
    $('pAutoJump').onchange=()=>{g.sandbox.autoJump=$('pAutoJump').checked;saveSettingsDebounced();showModBadge()}
    $('pTrail').onchange=()=>{g.cosmetic.trail=$('pTrail').checked;saveSettingsDebounced();drawPulseIdle()}
    $('pShake').oninput=()=>{g.cosmetic.shake=parseFloat($('pShake').value);saveSettingsDebounced()}
    $('pVTheme').onchange=()=>{g.cosmetic.theme=$('pVTheme').value;saveSettingsDebounced();drawPulseIdle()}
  }
  if(gameState.active==='snake'){
    $('sStep').checked=!!g.practice.step
    $('sSlow').value=String(g.practice.slowmo??1)
    $('sNoDie').checked=!!g.sandbox.noDie
    $('sSpeed').value=String(g.sandbox.speed??1)
    $('sPow').value=String(g.sandbox.powerups??1)
    $('sTrail').checked=!!g.cosmetic.trail
    $('sShake').value=String(g.cosmetic.shake??1)
    $('sVTheme').value=g.cosmetic.theme||'neon'
    $('sStep').onchange=()=>{g.practice.step=$('sStep').checked;saveSettingsDebounced();showModBadge()}
    $('sSlow').oninput=()=>{g.practice.slowmo=parseFloat($('sSlow').value);saveSettingsDebounced();showModBadge()}
    $('sNoDie').onchange=()=>{g.sandbox.noDie=$('sNoDie').checked;saveSettingsDebounced();showModBadge()}
    $('sSpeed').oninput=()=>{g.sandbox.speed=parseFloat($('sSpeed').value);saveSettingsDebounced();showModBadge()}
    $('sPow').oninput=()=>{g.sandbox.powerups=parseFloat($('sPow').value);saveSettingsDebounced();showModBadge()}
    $('sTrail').onchange=()=>{g.cosmetic.trail=$('sTrail').checked;saveSettingsDebounced();drawSnakeIdle()}
    $('sShake').oninput=()=>{g.cosmetic.shake=parseFloat($('sShake').value);saveSettingsDebounced()}
    $('sVTheme').onchange=()=>{g.cosmetic.theme=$('sVTheme').value;saveSettingsDebounced();drawSnakeIdle()}
  }
}

function drawPulseIdle(){
  const W=pulseCanvas.width,H=pulseCanvas.height
  const ctx=pulseCtx
  ctx.clearRect(0,0,W,H)
  ctx.fillStyle='#050505'
  ctx.fillRect(0,0,W,H)
  const t=Date.now()*0.001
  const theme=gameState.pulse.cosmetic.theme||'neon'
  const glow=theme==='mono'?'rgba(255,255,255,.08)':theme==='soft'?'rgba(255,255,255,.06)':'rgba(255,106,0,.10)'
  ctx.fillStyle=glow
  for(let i=0;i<10;i++){
    const x=(i/10)*W
    const y=H*0.55+Math.sin(t*1.2+i)*18
    ctx.beginPath()
    ctx.arc(x,y,80,0,Math.PI*2)
    ctx.fill()
  }
  ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.85)':'rgba(255,240,230,.92)'
  ctx.font='950 24px Inter'
  ctx.textAlign='center'
  ctx.fillText('Pulse Run',W/2,60)
  ctx.fillStyle='rgba(238,242,255,.62)'
  ctx.font='900 12px Inter'
  ctx.fillText('Space / Click to jump ¬∑ Start to play',W/2,86)
  ctx.strokeStyle='rgba(255,255,255,.08)'
  ctx.lineWidth=2
  ctx.beginPath()
  ctx.moveTo(0,H*0.74)
  ctx.lineTo(W,H*0.74)
  ctx.stroke()
  ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.75)':'rgba(255,106,0,.92)'
  ctx.fillRect(140,H*0.74-26,26,26)
  ctx.fillStyle='rgba(255,255,255,.18)'
  ctx.beginPath()
  ctx.moveTo(320,H*0.74)
  ctx.lineTo(334,H*0.74-24)
  ctx.lineTo(348,H*0.74)
  ctx.closePath()
  ctx.fill()
}

function drawSnakeIdle(){
  const W=snakeCanvas.width,H=snakeCanvas.height
  const ctx=snakeCtx
  ctx.fillStyle='#050505'
  ctx.fillRect(0,0,W,H)
  ctx.fillStyle='rgba(255,255,255,.06)'
  for(let i=0;i<24;i++){
    ctx.beginPath()
    ctx.arc(Math.random()*W,Math.random()*H,Math.random()*2+0.6,0,Math.PI*2)
    ctx.fill()
  }
  ctx.fillStyle='rgba(255,240,230,.92)'
  ctx.font='950 22px Inter'
  ctx.textAlign='center'
  ctx.fillText('Neon Snake+',W/2,50)
  ctx.fillStyle='rgba(238,242,255,.62)'
  ctx.font='900 12px Inter'
  ctx.fillText('Powerups ¬∑ Dash ¬∑ Combos',W/2,76)
}

function startArcade(){
  showModBadge()
  if(gameState.active==='pulse') startPulse()
  if(gameState.active==='snake') startSnake()
}
function stopArcade(){
  stopPulse()
  stopSnake()
}

function startPulse(){
  stopPulse()
  const W=pulseCanvas.width,H=pulseCanvas.height
  pulseRun={W,H,ground:Math.floor(H*0.74),x:160,y:0,vy:0,alive:true,dist:0,score:0,mods:anyCheatOn('pulse'),cp:null,trail:[]}
  pulseRun.y=pulseRun.ground-26
  const hazards=[]
  let hx=520
  for(let i=0;i<70;i++){
    hx+=260+Math.random()*240
    hazards.push({x:hx,type:Math.random()<0.65?'spike':'block'})
  }
  pulseRun.haz=hazards
  const loop=(t)=>{
    if(!pulseRun) return
    const g=gameState.pulse
    const slow=g.practice.slowmo??1
    const sp=g.sandbox.speed??1
    const dt=(pulseRun.lastT? (t-pulseRun.lastT):16.7)/1000
    pulseRun.lastT=t
    const step=dt*slow
    if(pulseRun.alive){
      pulseRun.dist+=320*sp*step
      pulseRun.score=Math.floor(pulseRun.dist/10)
      $('pScore').textContent=String(pulseRun.score)
      pulseRun.vy+=1800*step
      pulseRun.y+=pulseRun.vy*step
      if(pulseRun.y>pulseRun.ground-26){pulseRun.y=pulseRun.ground-26;pulseRun.vy=0}
      if(g.sandbox.autoJump){
        const next=pulseNextHaz()
        if(next && next.dx<165 && pulseRun.y>=pulseRun.ground-26-0.5) pulseJump()
      }
      if(g.practice.enabled && g.practice.autoCheckpoint){
        if(pulseRun.cp==null || pulseRun.dist-pulseRun.cp>1200) pulseRun.cp=pulseRun.dist
      }
      if(g.cosmetic.trail){
        pulseRun.trail.push({x:pulseRun.x,y:pulseRun.y,at:performance.now()})
        while(pulseRun.trail.length>28) pulseRun.trail.shift()
      }else pulseRun.trail=[]
      if(!g.sandbox.invincible){
        if(pulseHit()){pulseFail()}
      }
    }
    drawPulseFrame()
    pulseRAF=requestAnimationFrame(loop)
  }
  pulseRAF=requestAnimationFrame(loop)
  showModBadge()
}
function stopPulse(){if(pulseRAF) cancelAnimationFrame(pulseRAF);pulseRAF=null;pulseRun=null;drawPulseIdle()}
function pulseJump(){
  if(!pulseRun || !pulseRun.alive) return
  if(pulseRun.y<pulseRun.ground-26-0.5) return
  pulseRun.vy=-700
}
function pulseNextHaz(){
  if(!pulseRun) return null
  const gx=pulseRun.dist
  let best=null
  for(const h of pulseRun.haz){
    const wx=h.x-gx+pulseRun.x
    const dx=wx-pulseRun.x
    if(dx<0) continue
    if(best==null || dx<best.dx) best={h,dx,wx}
  }
  return best
}
function pulseHit(){
  const next=pulseNextHaz()
  if(!next) return false
  const gx=pulseRun.dist
  for(const h of pulseRun.haz){
    const wx=h.x-gx+pulseRun.x
    if(wx<-80 || wx>pulseRun.W+80) continue
    const px=pulseRun.x, py=pulseRun.y, pw=26, ph=26
    if(h.type==='spike'){
      const bx={x:wx,y:pulseRun.ground-24,w:30,h:24}
      if(px < bx.x+bx.w && px+pw > bx.x && py < bx.y+bx.h && py+ph > bx.y) return true
    }else{
      const bx={x:wx,y:pulseRun.ground-42,w:42,h:42}
      if(px < bx.x+bx.w && px+pw > bx.x && py < bx.y+bx.h && py+ph > bx.y) return true
    }
  }
  return false
}
function pulseFail(){
  const g=gameState.pulse
  if(g.practice.enabled && (pulseRun.cp!=null)){
    pulseRun.dist=pulseRun.cp
    pulseRun.vy=0
    pulseRun.y=pulseRun.ground-26
    return
  }
  pulseRun.alive=false
  endPulseRun()
}
function endPulseRun(){
  const score=pulseRun.score||0
  const mod=pulseRun.mods
  if(mod) gameState.pulse.bestMod=Math.max(gameState.pulse.bestMod||0,score)
  else gameState.pulse.bestLegit=Math.max(gameState.pulse.bestLegit||0,score)
  syncScoreUI()
  saveSettingsDebounced()
  toast('Run ended','Score '+score+(mod?' (Modded)':''),'warn')
  bumpXP(mod?2:6)
  bumpCoins(Math.floor(score/120))
  setTimeout(()=>{stopPulse()},650)
}
function drawPulseFrame(){
  const ctx=pulseCtx
  const W=pulseRun.W,H=pulseRun.H
  ctx.clearRect(0,0,W,H)
  ctx.fillStyle='#050505'
  ctx.fillRect(0,0,W,H)
  const theme=gameState.pulse.cosmetic.theme||'neon'
  const glow=theme==='mono'?'rgba(255,255,255,.08)':theme==='soft'?'rgba(255,255,255,.06)':'rgba(255,106,0,.10)'
  ctx.fillStyle=glow
  for(let i=0;i<10;i++){
    const x=(i/10)*W
    const y=H*0.55+Math.sin((performance.now()*0.001)*1.2+i)*18
    ctx.beginPath()
    ctx.arc(x,y,80,0,Math.PI*2)
    ctx.fill()
  }
  ctx.strokeStyle='rgba(255,255,255,.08)'
  ctx.lineWidth=2
  ctx.beginPath()
  ctx.moveTo(0,pulseRun.ground)
  ctx.lineTo(W,pulseRun.ground)
  ctx.stroke()
  const gx=pulseRun.dist
  for(const h of pulseRun.haz){
    const wx=h.x-gx+pulseRun.x
    if(wx<-80 || wx>W+80) continue
    if(h.type==='spike'){
      ctx.fillStyle='rgba(255,255,255,.18)'
      ctx.beginPath()
      ctx.moveTo(wx,pulseRun.ground)
      ctx.lineTo(wx+15,pulseRun.ground-24)
      ctx.lineTo(wx+30,pulseRun.ground)
      ctx.closePath()
      ctx.fill()
    }else{
      ctx.fillStyle='rgba(255,255,255,.14)'
      ctx.fillRect(wx,pulseRun.ground-42,42,42)
    }
  }
  if(pulseRun.trail.length){
    ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.10)':theme==='soft'?'rgba(255,255,255,.08)':'rgba(255,106,0,.12)'
    for(const p of pulseRun.trail){
      const a=clamp(1-(performance.now()-p.at)/420,0,1)
      ctx.globalAlpha=a
      ctx.fillRect(p.x,p.y,26,26)
    }
    ctx.globalAlpha=1
  }
  ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.75)':theme==='soft'?'rgba(255,255,255,.70)':'rgba(255,106,0,.92)'
  ctx.fillRect(pulseRun.x,pulseRun.y,26,26)
}

function startSnake(){
  stopSnake()
  const W=snakeCanvas.width,H=snakeCanvas.height
  const cell=18
  const cols=Math.floor(W/cell)
  const rows=Math.floor(H/cell)
  const cx=Math.floor(cols/2)
  const cy=Math.floor(rows/2)
  snakeRun={
    W,H,cell,cols,rows,
    dir:{x:1,y:0},
    next:{x:1,y:0},
    body:[{x:cx,y:cy},{x:cx-1,y:cy},{x:cx-2,y:cy}],
    alive:true,
    score:0,
    mods:anyCheatOn('snake'),
    lastStep:performance.now(),
    dash:0,
    food:null,
    powers:[],
    trail:[]
  }
  spawnFood()
  spawnPower()
  const loop=(t)=>{
    if(!snakeRun) return
    const g=gameState.snake
    const slow=g.practice.slowmo??1
    const sp=g.sandbox.speed??1
    const stepMs=clamp(120/sp,45,180)/slow
    const canStep=!g.practice.step || snakeRun.stepOnce
    if(snakeRun.alive && canStep && (t-snakeRun.lastStep)>=stepMs){
      snakeRun.lastStep=t
      snakeRun.stepOnce=false
      snakeStep()
    }
    drawSnakeFrame()
    snakeRAF=requestAnimationFrame(loop)
  }
  snakeRAF=requestAnimationFrame(loop)
  showModBadge()
}
function stopSnake(){if(snakeRAF) cancelAnimationFrame(snakeRAF);snakeRAF=null;snakeRun=null;drawSnakeIdle()}
function spawnFood(){
  if(!snakeRun) return
  const taken=new Set(snakeRun.body.map(p=>p.x+','+p.y))
  let x=0,y=0
  do{x=Math.floor(Math.random()*snakeRun.cols);y=Math.floor(Math.random()*snakeRun.rows)}while(taken.has(x+','+y))
  snakeRun.food={x,y}
}
function spawnPower(){
  if(!snakeRun) return
  if(Math.random()>0.55*(gameState.snake.sandbox.powerups??1)) return
  const taken=new Set(snakeRun.body.map(p=>p.x+','+p.y))
  taken.add(snakeRun.food.x+','+snakeRun.food.y)
  let x=0,y=0
  do{x=Math.floor(Math.random()*snakeRun.cols);y=Math.floor(Math.random()*snakeRun.rows)}while(taken.has(x+','+y))
  const kind=Math.random()<0.5?'boost':'shield'
  snakeRun.powers.push({x,y,kind,ttl:240})
}
function snakeStep(){
  const g=gameState.snake
  snakeRun.dir=snakeRun.next
  const head=snakeRun.body[0]
  const nx=head.x+snakeRun.dir.x
  const ny=head.y+snakeRun.dir.y
  let x=nx,y=ny
  if(x<0) x=snakeRun.cols-1
  if(x>=snakeRun.cols) x=0
  if(y<0) y=snakeRun.rows-1
  if(y>=snakeRun.rows) y=0
  const hit=snakeRun.body.some((p,i)=>i>0 && p.x===x && p.y===y)
  if(hit && !g.sandbox.noDie){
    snakeRun.alive=false
    endSnakeRun()
    return
  }
  snakeRun.body.unshift({x,y})
  let grew=false
  if(snakeRun.food && x===snakeRun.food.x && y===snakeRun.food.y){
    snakeRun.score+=10
    grew=true
    spawnFood()
    spawnPower()
  }
  for(const p of snakeRun.powers){
    if(p.x===x && p.y===y){
      if(p.kind==='boost') snakeRun.score+=25
      else snakeRun.score+=15
      p.ttl=0
    }
  }
  snakeRun.powers=snakeRun.powers.filter(p=>p.ttl>0)
  if(!grew) snakeRun.body.pop()
  snakeRun.score+=1
  $('sScore').textContent=String(snakeRun.score)
  snakeRun.powers.forEach(p=>p.ttl--)
  if(gameState.snake.cosmetic.trail){
    snakeRun.trail.push({body:snakeRun.body.map(p=>({x:p.x,y:p.y})),at:performance.now()})
    while(snakeRun.trail.length>8) snakeRun.trail.shift()
  }else snakeRun.trail=[]
}
function endSnakeRun(){
  const score=snakeRun.score||0
  const mod=snakeRun.mods
  if(mod) gameState.snake.bestMod=Math.max(gameState.snake.bestMod||0,score)
  else gameState.snake.bestLegit=Math.max(gameState.snake.bestLegit||0,score)
  syncScoreUI()
  saveSettingsDebounced()
  toast('Run ended','Score '+score+(mod?' (Modded)':''),'warn')
  bumpXP(mod?2:6)
  bumpCoins(Math.floor(score/90))
  setTimeout(()=>{stopSnake()},650)
}
function drawSnakeFrame(){
  const ctx=snakeCtx
  const W=snakeRun.W,H=snakeRun.H,c=snakeRun.cell
  ctx.clearRect(0,0,W,H)
  ctx.fillStyle='#050505'
  ctx.fillRect(0,0,W,H)
  ctx.fillStyle='rgba(255,255,255,.05)'
  for(let x=0;x<snakeRun.cols;x+=4){
    ctx.fillRect(x*c,0,1,H)
  }
  for(let y=0;y<snakeRun.rows;y+=4){
    ctx.fillRect(0,y*c,W,1)
  }
  const theme=gameState.snake.cosmetic.theme||'neon'
  if(snakeRun.trail.length){
    for(const t of snakeRun.trail){
      const a=clamp(1-(performance.now()-t.at)/240,0,1)
      ctx.globalAlpha=a*0.35
      ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.25)':theme==='soft'?'rgba(255,255,255,.20)':'rgba(56,189,248,.28)'
      for(const p of t.body) ctx.fillRect(p.x*c,p.y*c,c,c)
    }
    ctx.globalAlpha=1
  }
  for(const p of snakeRun.powers){
    ctx.fillStyle=p.kind==='boost'?'rgba(255,177,0,.30)':'rgba(34,197,94,.25)'
    ctx.fillRect(p.x*c,p.y*c,c,c)
  }
  if(snakeRun.food){
    ctx.fillStyle='rgba(255,255,255,.18)'
    ctx.beginPath()
    ctx.arc((snakeRun.food.x*c)+c/2,(snakeRun.food.y*c)+c/2,c*0.35,0,Math.PI*2)
    ctx.fill()
  }
  const head=snakeRun.body[0]
  ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.75)':theme==='soft'?'rgba(255,255,255,.70)':'rgba(56,189,248,.85)'
  ctx.fillRect(head.x*c,head.y*c,c,c)
  ctx.fillStyle=theme==='mono'?'rgba(255,255,255,.45)':theme==='soft'?'rgba(255,255,255,.38)':'rgba(255,255,255,.14)'
  for(let i=1;i<snakeRun.body.length;i++){
    const p=snakeRun.body[i]
    ctx.fillRect(p.x*c,p.y*c,c,c)
  }
}

function handleGameKey(e){
  if(gameState.active==='pulse'){
    if(e.code==='Space'){e.preventDefault();pulseJump();return}
    if(e.key==='c' || e.key==='C'){const g=gameState.pulse; if(g.practice.enabled){pulseRun.cp=pulseRun.dist; toast('Checkpoint','Set','ok'); saveSettingsDebounced()}}
  }else{
    if(!snakeRun) return
    const k=e.key
    if(k==='ArrowUp' || k==='w' || k==='W'){if(snakeRun.dir.y!==1) snakeRun.next={x:0,y:-1}}
    if(k==='ArrowDown' || k==='s' || k==='S'){if(snakeRun.dir.y!==-1) snakeRun.next={x:0,y:1}}
    if(k==='ArrowLeft' || k==='a' || k==='A'){if(snakeRun.dir.x!==1) snakeRun.next={x:-1,y:0}}
    if(k==='ArrowRight' || k==='d' || k==='D'){if(snakeRun.dir.x!==-1) snakeRun.next={x:1,y:0}}
    if(k==='Shift'){snakeRun.dash=12; if(gameState.snake.sandbox.speed<2) {gameState.snake.sandbox.speed=clamp(gameState.snake.sandbox.speed+0.2,0.6,2); saveSettingsDebounced(); renderCheats(); showModBadge()}}
    if(gameState.snake.practice.step && (k===' ' || k==='Enter')) snakeRun.stepOnce=true
  }
}

function initArcadeClick(){
  pulseCanvas.addEventListener('mousedown',()=>pulseJump())
}

function openAuth(){ $('authBack').style.display='flex' }
function closeAuth(){ $('authBack').style.display='none' }

let authMode='in'
function setAuthMode(m){
  authMode=m
  $('tabSignIn').classList.toggle('active',m==='in')
  $('tabSignUp').classList.toggle('active',m==='up')
  $('authErr').textContent=''
}

async function doAuth(){
  const email=($('authEmail').value||'').trim()
  const pass=$('authPass').value||''
  if(!email || !pass){$('authErr').textContent='Enter email and password';return}
  $('authErr').textContent=''
  if(authMode==='up'){
    const r=await supabase.auth.signUp({email,password:pass})
    if(r.error){$('authErr').textContent=r.error.message;return}
    toast('Signed up','Check email if confirmation is required','ok')
  }else{
    const r=await supabase.auth.signInWithPassword({email,password:pass})
    if(r.error){$('authErr').textContent=r.error.message;return}
  }
}
async function doMagic(){
  const email=($('authEmail').value||'').trim()
  if(!email){$('authErr').textContent='Enter email';return}
  $('authErr').textContent=''
  const r=await supabase.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.origin}})
  if(r.error){$('authErr').textContent=r.error.message;return}
  toast('Magic link','Check your email','ok')
}
async function doReset(){
  const email=($('authEmail').value||'').trim()
  if(!email){$('authErr').textContent='Enter email';return}
  const r=await supabase.auth.resetPasswordForEmail(email,{redirectTo:window.location.origin})
  if(r.error){$('authErr').textContent=r.error.message;return}
  toast('Reset email','Check your inbox','ok')
}

async function onSignedIn(u){
  user=u
  const email=user.email||''
  $('userEmail').textContent=email
  $('avatar').textContent=(email.trim()[0]||'U').toUpperCase()
  closeAuth()
  await ensureDefaults()
  await loadSettings()
  await fetchSchools()
  await fetchSubjects()
  $('schoolSelect').value=currentSchool
  $('fSubject').value=uiPrefs.fSubject||''
  await fetchNotes()
  initGraph()
  initGames()
  showModBadge()
  syncScoreUI()
  setStatus('saved','Synced')
}

async function boot(){
  maybeMobileUI()
  window.addEventListener('resize',maybeMobileUI)

  $('btnNew').onclick=createNote
  $('btnGames').onclick=()=>setView('games')
  $('gClose').onclick=()=>{stopArcade();setView('editor')}
  $('gStart').onclick=()=>startArcade()
  $('tabPulse').onclick=()=>switchGame('pulse')
  $('tabSnake').onclick=()=>switchGame('snake')
  $('cTabPractice').onclick=()=>setCheatTab('practice')
  $('cTabSandbox').onclick=()=>setCheatTab('sandbox')
  $('cTabCosmetic').onclick=()=>setCheatTab('cosmetic')
  $('graphStyle').onchange=()=>{gStyle=$('graphStyle').value;seedParticles();renderGraph()}
  $('gReset').onclick=()=>{gView={x:0,y:0,scale:1};renderGraph()}
  $('gPhys').onclick=()=>{graphPhysics=!graphPhysics;toast('Physics',graphPhysics?'On':'Off',graphPhysics?'ok':'warn')}
  $('gCenter').onclick=()=>{gView.x=0;gView.y=0;renderGraph()}

  $('modeEdit').onclick=()=>setView('editor')
  $('modePreview').onclick=()=>setView('preview')
  $('modeGraph').onclick=()=>setView('graph')
  $('jumpPreview').onclick=()=>setView('preview')
  $('jumpGraph').onclick=()=>setView('graph')
  $('backToEdit').onclick=()=>setView('editor')

  $('toggleSplit').onclick=()=>{
    if(splitMode==='split'){setSplit('editor');$('toggleSplit').querySelector('span').textContent='Editor'}
    else if(splitMode==='editor'){setSplit('preview');$('toggleSplit').querySelector('span').textContent='Preview'}
    else{setSplit('split');$('toggleSplit').querySelector('span').textContent='Split'}
  }
  $('toggleFull').onclick=()=>{
    uiPrefs.previewFull=!uiPrefs.previewFull
    $('setPreviewFull').value=uiPrefs.previewFull?'1':'0'
    saveSettingsDebounced()
    toast('Preview',uiPrefs.previewFull?'Full mode on':'Full mode off','ok')
  }
  $('doPdf').onclick=openPdfModal
  $('pdfClose').onclick=closePdfModal
  $('pdfCancel').onclick=closePdfModal
  $('pdfGo').onclick=exportPdf

  $('openSettings').onclick=openSettings
  $('setClose').onclick=closeSettings
  $('setCancel').onclick=closeSettings
  $('setSave').onclick=saveSettingsFromModal
  $('setNewSchool').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();const v=$('setNewSchool').value.trim();$('setNewSchool').value='';if(v) addSchool(v)}})
  $('setNewSubject').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();const v=$('setNewSubject').value.trim();$('setNewSubject').value='';if(v) addSubject(v)}})

  $('schoolSelect').onchange=()=>{currentSchool=$('schoolSelect').value;saveSettingsDebounced();renderList();updateCrumb();autosave()}
  $('addSchoolBtn').onclick=()=>{const n=prompt('Add school');if(n) addSchool(n)}
  $('sort').onchange=()=>{uiPrefs.sort=$('sort').value;saveSettingsDebounced();renderList()}
  $('fGrade').onchange=()=>{uiPrefs.fGrade=$('fGrade').value;saveSettingsDebounced();renderList()}
  $('fSubject').onchange=()=>{uiPrefs.fSubject=$('fSubject').value;saveSettingsDebounced();renderList()}
  $('search').oninput=renderList

  $('title').oninput=()=>{updateCrumb();autosave();updatePreview()}
  $('body').oninput=()=>{autosave();updatePreview()}
  $('grade').onchange=()=>{autosave();updateCrumb();updatePreview()}
  $('subject').onchange=()=>{autosave();updateCrumb();updatePreview()}
  $('tags').oninput=()=>{autosave();updatePreview()}
  $('linkSearch').oninput=searchLinkCandidates
  $('closeDrop').onclick=()=>{$('cardDrop').style.display='none';$('linkSearch').value=''}
  $('unlinkAll').onclick=unlinkAll

  document.querySelectorAll('.tool').forEach(b=>b.onclick=()=>applyMd(b.getAttribute('data-md')))

  $('saveNow').onclick=saveNote
  $('delNote').onclick=deleteNote

  $('openPalette').onclick=openPalette
  $('paletteBack').addEventListener('mousedown',e=>{if(e.target.id==='paletteBack') closePalette()})
  $('paletteQ').oninput=()=>renderPalette($('paletteQ').value)

  window.addEventListener('keydown',e=>{
    if(e.ctrlKey && (e.key==='k' || e.key==='K')){e.preventDefault();openPalette();return}
    if(e.ctrlKey && (e.key==='s' || e.key==='S')){e.preventDefault();saveNote();return}
    if(e.altKey && (e.key==='p' || e.key==='P')){e.preventDefault();togglePinned();return}
    if(e.key==='Escape'){closePalette();closePdfModal();closeSettings();return}
    if($('viewGames').classList.contains('active')){handleGameKey(e);return}
  })

  $('tStart').onclick=startTimer
  $('tPause').onclick=pauseTimer
  $('tReset').onclick=resetTimer
  $('mFocus').onclick=()=>{setTimer(timerPresets.focus||25);setView('editor')}
  $('mBreak').onclick=()=>{setTimer(timerPresets.break||5);setView('editor')}
  $('mLong').onclick=()=>{setTimer(timerPresets.long||15);setView('editor')}
  $('mBreakGame').onclick=()=>{setTimer(timerPresets.break||5);setView('games')}

  $('mobileMenu').onclick=openMobileSidebar
  $('backdrop').onclick=closeMobileSidebar

  $('signOut').onclick=async ()=>{await supabase.auth.signOut();notes=[];links=[];subjects=[];schools=[];activeId=null;setEmptyState();openAuth()}

  initSplitResize()
  initArcadeClick()

  $('tabSignIn').onclick=()=>setAuthMode('in')
  $('tabSignUp').onclick=()=>setAuthMode('up')
  $('authGo').onclick=doAuth
  $('authMagic').onclick=doMagic
  $('authReset').onclick=doReset

  const s=await supabase.auth.getSession()
  if(s.data?.session?.user) onSignedIn(s.data.session.user)
  else openAuth()
  supabase.auth.onAuthStateChange((evt,session)=>{
    if(session?.user) onSignedIn(session.user)
    else openAuth()
  })
}

boot()
</script>
</body>
</html>
