<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StudyOS | Kenneth's Edition</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg:#0a0a0a;
  --sidebar:#111111;
  --border:#2a2a2a;
  --surface:#181818;
  --surface-hover:#222222;
  --text-main:#f5f5f5;
  --text-muted:#888888;
  --brand:#ff6500;
  --brand-hover:#e05500;
  --brand-light:#ff8533;
  --accent:#ffaa00;
  --danger:#ff3333;
  --success:#22c55e;
  --font:'Montserrat',-apple-system,BlinkMacSystemFont,sans-serif;
  --mono:'JetBrains Mono','Courier New',monospace;
  --shadow:0 4px 16px rgba(0,0,0,0.6);
  --shadow-lg:0 20px 40px rgba(0,0,0,0.8);
  --glow:0 0 24px rgba(255,101,0,0.4);
  --sidebar-width:320px;
  --sidebar-mini:68px;
}

*{box-sizing:border-box;outline:none;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{
  background:var(--bg);
  color:var(--text-main);
  font-family:var(--font);
  height:100vh;
  display:flex;
  overflow:hidden;
  font-size:13px;
  -webkit-font-smoothing:antialiased;
}

aside{
  width:var(--sidebar-width);
  background:var(--sidebar);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  transition:width .32s cubic-bezier(.4,0,.2,1);
  overflow:hidden;
  position:relative;
  z-index:10;
  flex-shrink:0;
}
aside.collapsed{width:var(--sidebar-mini)}
aside.collapsed .sidebar-content{opacity:0;pointer-events:none}
aside.collapsed .sidebar-mini-icons{opacity:1;pointer-events:auto}

.sidebar-content{
  display:flex;
  flex-direction:column;
  flex:1;
  overflow:hidden;
  transition:opacity .18s ease;
  min-width:calc(var(--sidebar-width) - 2px);
}

.sidebar-mini-icons{
  position:absolute;
  top:0;left:0;
  width:var(--sidebar-mini);
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:18px 0;
  gap:8px;
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
}
.mini-icon{
  width:42px;height:42px;
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:17px;
  cursor:pointer;
  transition:all .2s;
  border:1px solid transparent;
  user-select:none;
}
.mini-icon:hover{background:var(--surface-hover);border-color:var(--brand)}
.mini-icon.logo-mini{
  background:linear-gradient(135deg,var(--brand),var(--accent));
  color:#fff;font-weight:900;font-size:13px;
  box-shadow:var(--glow);
}

.sidebar-toggle{
  position:absolute;
  top:17px;right:-14px;
  width:28px;height:28px;
  background:var(--brand);
  border:2px solid var(--bg);
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  z-index:30;
  font-size:11px;
  color:#fff;
  box-shadow:var(--glow);
  transition:all .3s;
  flex-shrink:0;
  font-weight:900;
  user-select:none;
}
.sidebar-toggle:hover{transform:scale(1.18);box-shadow:var(--shadow-lg),var(--glow)}

.sidebar-header{
  padding:22px 18px 14px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(160deg,rgba(255,101,0,.07),rgba(255,170,0,.03));
  flex-shrink:0;
}
.brand-area{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.logo{
  width:44px;height:44px;
  background:linear-gradient(135deg,var(--brand),var(--accent));
  border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:#fff;font-size:20px;
  flex-shrink:0;
  font-family:var(--font);
  animation:logoPulse 3s ease infinite;
}
@keyframes logoPulse{
  0%,100%{box-shadow:0 0 14px rgba(255,101,0,.5)}
  50%{box-shadow:0 0 28px rgba(255,170,0,.7),0 0 44px rgba(255,101,0,.2)}
}
.brand-info{flex:1;min-width:0}
.brand-text{
  font-weight:900;font-size:22px;letter-spacing:-.4px;
  background:linear-gradient(135deg,var(--brand-light),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  white-space:nowrap;
}
.author-tag{font-size:11px;color:var(--text-muted);font-weight:600;margin-top:2px}

.school-badge{
  display:inline-flex;
  gap:8px;
  align-items:center;
  background:rgba(255,101,0,.1);
  border:1px solid rgba(255,101,0,.35);
  padding:4px 10px;border-radius:7px;
  font-size:9px;font-weight:900;
  color:var(--brand-light);
  text-transform:uppercase;
  letter-spacing:.9px;
  margin-top:8px;
  cursor:pointer;
  transition:all .25s;
  user-select:none;
}
.school-badge:hover{background:var(--brand);color:#fff;transform:translateY(-1px);box-shadow:var(--glow)}

.search-box{
  width:100%;
  background:var(--surface);
  border:1.5px solid var(--border);
  color:#fff;
  padding:10px 13px;
  border-radius:10px;
  margin-bottom:10px;
  transition:all .3s;
  font-size:12px;
  font-weight:650;
  font-family:var(--font);
}
.search-box:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,101,0,.12);background:#0f0f0f}
.search-box::placeholder{color:var(--text-muted)}
.new-note-btn{
  width:100%;
  padding:11px 14px;
  background:linear-gradient(135deg,var(--brand),var(--accent));
  border:none;color:#fff;border-radius:10px;
  font-weight:900;font-size:12px;
  cursor:pointer;transition:all .25s;
  font-family:var(--font);
  letter-spacing:.3px;
  box-shadow:var(--glow);
}
.new-note-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg),var(--glow)}

.sidebar-controls{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.sidebar-controls select{
  flex:1;
  background:var(--surface);
  border:1.5px solid var(--border);
  color:var(--text-main);
  padding:9px 12px;
  border-radius:10px;
  font-size:11px;
  font-weight:800;
  cursor:pointer;
}
.sidebar-controls button{
  width:44px;
  background:var(--surface);
  border:1.5px solid rgba(255,255,255,.12);
  color:var(--text-main);
  padding:9px 0;
  border-radius:10px;
  cursor:pointer;
  transition:all .2s;
  font-weight:900;
}
.sidebar-controls button:hover{background:var(--surface-hover);border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--shadow),0 0 12px rgba(255,101,0,.18)}

.nav-list{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px}

.grade-section{display:flex;flex-direction:column;gap:6px}
.grade-header{
  padding:10px 12px;background:var(--surface);
  border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:space-between;
  transition:all .22s;border:1px solid var(--border);
  user-select:none;
}
.grade-header:hover{background:var(--surface-hover);border-color:rgba(255,101,0,.35)}
.grade-header.active{background:linear-gradient(135deg,rgba(255,101,0,.09),rgba(255,170,0,.05));border-color:rgba(255,101,0,.35)}
.grade-title{font-weight:850;font-size:11px;color:var(--text-main);display:flex;align-items:center;gap:8px}
.grade-count{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;padding:2px 8px;border-radius:999px;font-size:9px;font-weight:900}
.grade-arrow{color:var(--text-muted);transition:transform .25s;font-size:10px}
.grade-header.active .grade-arrow{transform:rotate(90deg)}
.grade-notes{max-height:0;overflow:hidden;transition:max-height .35s ease}
.grade-notes.expanded{max-height:900px}

.nav-item{
  padding:10px 12px;border-radius:10px;
  cursor:pointer;
  color:var(--text-muted);
  display:flex;justify-content:space-between;align-items:center;
  transition:all .18s;
  font-size:12px;font-weight:700;
  border:1px solid transparent;
  background:transparent;
}
.nav-item:hover{background:var(--surface-hover);color:var(--text-main);transform:translateX(3px);border-color:var(--border)}
.nav-item.active{
  background:linear-gradient(135deg,rgba(255,101,0,.16),rgba(255,170,0,.09));
  color:var(--text-main);
  font-weight:850;
  border-color:rgba(255,101,0,.45);
  box-shadow:0 2px 8px rgba(255,101,0,.12);
}
.nav-item .meta{
  display:flex;
  align-items:center;
  gap:7px;
}
.badge{
  font-size:10px;
  font-weight:900;
  padding:2px 7px;
  border-radius:999px;
  border:1px solid rgba(255,170,0,.35);
  color:var(--accent);
  background:rgba(255,170,0,.08);
}
.badge.linked{border-color:rgba(34,197,94,.35);color:rgba(34,197,94,.95);background:rgba(34,197,94,.08)}
.badge.draft{border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7);background:rgba(255,255,255,.06)}

.stats-widget{
  padding:12px;border-top:1px solid var(--border);
  background:linear-gradient(180deg,var(--sidebar),var(--surface));
  flex-shrink:0;
}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat-card{
  background:var(--bg);
  padding:10px;border-radius:11px;
  border:1px solid var(--border);
  transition:all .25s;
}
.stat-card:hover{border-color:rgba(255,101,0,.35);transform:translateY(-2px)}
.stat-value{
  font-size:24px;font-weight:950;
  background:linear-gradient(135deg,var(--brand-light),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  font-family:var(--mono);
}
.stat-label{font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:3px;font-weight:850}

.pomodoro-box{
  padding:14px;border-top:1px solid var(--border);
  background:var(--surface);
  flex-shrink:0;
}
.timer-display{
  font-family:var(--mono);
  font-size:34px;font-weight:950;
  margin-bottom:10px;letter-spacing:3px;
  background:linear-gradient(135deg,var(--brand-light),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  text-align:center;
}
.timer-controls{display:flex;gap:7px;justify-content:center;margin-bottom:9px}
.timer-mode{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.timer-mode span{
  cursor:pointer;
  padding:7px 12px;border-radius:10px;
  transition:all .22s;
  font-size:10px;font-weight:950;
  border:1.5px solid var(--border);
  background:var(--bg);
  color:var(--text-muted);
  font-family:var(--font);
  user-select:none;
}
.timer-mode span:hover{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--glow)}

.signout-area{padding:10px;border-top:1px solid var(--border);flex-shrink:0}
.signout-btn{
  width:100%;
  background:transparent;
  border:1px solid var(--border);
  color:var(--text-muted);
  font-weight:850;
  font-size:11px;
  padding:9px;
  border-radius:10px;
  transition:all .22s;
  font-family:var(--font);
  cursor:pointer;
}
.signout-btn:hover{border-color:var(--danger);color:var(--danger);background:rgba(255,51,51,.07)}

main{flex:1;display:flex;flex-direction:column;background:var(--bg);position:relative;min-width:0}

.top-bar{
  height:68px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 22px;
  background:linear-gradient(180deg,#111 0%,var(--bg) 100%);
  flex-shrink:0;
  gap:12px;
}
.tabs{display:flex;gap:6px;height:100%;align-items:center}
.tab{
  display:flex;align-items:center;gap:8px;
  cursor:pointer;
  color:var(--text-muted);
  padding:10px 16px;
  border-radius:12px;
  font-weight:850;
  font-size:12px;
  transition:all .2s;
  border:1.5px solid transparent;
  font-family:var(--font);
  user-select:none;
}
.tab:hover{color:var(--text-main);background:var(--surface);border-color:var(--border)}
.tab.active{color:#fff;background:linear-gradient(135deg,var(--brand),var(--accent));border-color:var(--brand);box-shadow:var(--glow)}
.tab-icon{font-size:15px}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

button{
  background:var(--surface);
  border:1.5px solid rgba(255,255,255,.13);
  color:var(--text-main);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  font-size:12px;
  transition:all .2s;
  font-weight:850;
  font-family:var(--font);
}
button:hover{background:var(--surface-hover);border-color:var(--brand);transform:translateY(-2px);box-shadow:var(--shadow),0 0 12px rgba(255,101,0,.18);color:#fff}
button:active{transform:translateY(0);box-shadow:none}
button.primary{background:linear-gradient(135deg,var(--brand),var(--accent));border:1.5px solid transparent;color:#fff;box-shadow:var(--glow)}
button.primary:hover{background:linear-gradient(135deg,var(--brand-hover),var(--brand));transform:translateY(-2px);box-shadow:var(--shadow-lg),var(--glow)}
button.danger{border-color:rgba(255,51,51,.28);color:#ff8888}
button.danger:hover{background:var(--danger);color:#fff;border-color:var(--danger);box-shadow:0 0 14px rgba(255,51,51,.4)}
button.sm{padding:7px 12px;font-size:11px;border-radius:10px}

.autosave-indicator{font-size:11px;color:var(--success);display:flex;align-items:center;gap:7px;font-weight:850}
.autosave-dot{width:7px;height:7px;border-radius:50%;background:var(--success);animation:blink 1.5s infinite;box-shadow:0 0 8px var(--success)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

.content-area{flex:1;position:relative;overflow:hidden}

.editor-pane,.preview-pane,.graph-pane{
  position:absolute;inset:0;
  padding:34px 46px;
  overflow-y:auto;
  background:var(--bg);
  display:none;
}
.editor-pane.active,.preview-pane.active,.graph-pane.active{display:block}

input.title-input{
  background:transparent;border:none;
  color:var(--text-main);
  font-size:36px;font-weight:950;
  margin-bottom:18px;width:100%;
  font-family:var(--font);
  letter-spacing:-1px;
}
input.title-input::placeholder{color:var(--text-muted);opacity:.3}

.row-top{
  display:flex;
  gap:12px;
  align-items:flex-end;
  flex-wrap:wrap;
  margin-bottom:14px;
}
.grade-selector label{
  display:block;font-size:9px;font-weight:900;color:var(--text-muted);
  margin-bottom:7px;text-transform:uppercase;letter-spacing:1.5px;
}
select.grade-dropdown{
  background:var(--surface);
  border:1.5px solid var(--border);
  color:var(--text-main);
  padding:10px 13px;
  border-radius:12px;
  font-size:12px;font-weight:850;
  cursor:pointer;transition:all .2s;
  width:240px;font-family:var(--font);
}
select.grade-dropdown:hover{border-color:rgba(255,101,0,.45)}
select.grade-dropdown:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,101,0,.12)}

.link-input-container{flex:1;min-width:260px;position:relative}
.link-input{
  width:100%;
  background:var(--surface);
  border:1.5px solid var(--border);
  color:#fff;
  padding:10px 13px;
  border-radius:12px;
  font-size:12px;
  transition:all .2s;
  font-weight:750;
  font-family:var(--font);
}
.link-input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,101,0,.1)}
#link-dropdown{
  position:absolute;
  top:48px;left:0;right:0;
  background:#121212;
  border:1.5px solid var(--border);
  border-radius:12px;
  max-height:260px;
  overflow-y:auto;
  display:none;
  z-index:100;
  box-shadow:var(--shadow-lg);
}
.link-dd-item{
  padding:11px 15px;
  cursor:pointer;
  border-bottom:1px solid var(--border);
  font-size:12px;
  font-weight:750;
  transition:all .15s;
  color:var(--text-main);
}
.link-dd-item:hover{background:var(--surface-hover);color:var(--brand)}
.link-dd-empty{padding:12px;color:var(--text-muted);font-size:12px;font-weight:700}

textarea.body-input{
  width:100%;
  height:calc(100% - 235px);
  background:var(--surface);
  border:1.5px solid var(--border);
  color:#f0f0f0;
  font-size:14px;
  line-height:1.85;
  resize:none;
  font-family:var(--mono);
  padding:20px;
  border-radius:14px;
  transition:border-color .2s;
}
textarea.body-input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,101,0,.1)}
textarea.body-input::placeholder{color:var(--text-muted);opacity:.45}

.pills{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:14px;
}
.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  background:var(--surface);
  border:1.5px solid rgba(255,170,0,.35);
  color:var(--accent);
  padding:7px 12px;
  border-radius:999px;
  font-size:11px;
  cursor:pointer;
  transition:all .2s;
  font-weight:850;
  user-select:none;
}
.pill:hover{background:var(--accent);color:#000;transform:translateY(-2px);box-shadow:0 0 18px rgba(255,170,0,.35)}
.pill .x{
  width:18px;height:18px;border-radius:999px;
  display:inline-flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.25);
  color:inherit;
  font-weight:950;
  border:1px solid rgba(255,255,255,.12);
}
.pill:hover .x{background:rgba(0,0,0,.18);border-color:rgba(0,0,0,.18)}

.section-card{
  margin-top:14px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#101010,var(--bg));
  border-radius:14px;
  padding:14px;
}
.section-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
}
.section-title{
  color:var(--text-muted);
  font-size:10px;
  font-weight:950;
  letter-spacing:1.4px;
  text-transform:uppercase;
}
.section-actions{display:flex;gap:8px;align-items:center}
.small-link{
  color:var(--brand-light);
  font-weight:900;
  cursor:pointer;
  font-size:11px;
  user-select:none;
}
.small-link:hover{color:var(--accent)}

.preview-pane{
  line-height:2;
  color:#f0f0f0;
  max-width:920px;
  font-size:15px;
}
.preview-pane h1{
  border-bottom:3px solid var(--brand);
  padding-bottom:14px;
  margin-top:0;
  margin-bottom:30px;
  background:linear-gradient(135deg,var(--brand-light),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  font-size:44px;font-weight:950;letter-spacing:-1.5px;
}
.preview-pane h2{margin-top:2.2em;margin-bottom:.7em;color:var(--brand-light);font-size:26px;font-weight:900}
.preview-pane h3{margin-top:1.6em;margin-bottom:.6em;color:var(--accent);font-size:20px;font-weight:850}
.preview-pane p{margin-bottom:1.2em}
.preview-pane code{background:var(--surface);padding:3px 7px;border-radius:7px;font-family:var(--mono);font-size:.86em;border:1px solid var(--border);color:var(--accent)}
.preview-pane pre{background:var(--surface);padding:20px;border-radius:14px;overflow-x:auto;border:1px solid var(--border);margin:1.6em 0}
.preview-pane pre code{background:transparent;border:none;padding:0;color:#f0f0f0}
.preview-pane blockquote{border-left:4px solid var(--brand);margin:1.6em 0;padding:14px 18px;color:var(--text-muted);background:var(--surface);border-radius:0 12px 12px 0;font-style:italic}
.preview-pane a{color:var(--brand-light);text-decoration:none;border-bottom:2px solid transparent;transition:border-color .2s;font-weight:850}
.preview-pane a:hover{border-bottom-color:var(--brand-light)}
.preview-pane ul,.preview-pane ol{margin:1.2em 0;padding-left:2.2em}
.preview-pane li{margin:.5em 0}

.graph-pane{background:var(--bg);padding:0}
#graph-canvas{width:100%;height:100%;cursor:grab}
#graph-canvas:active{cursor:grabbing}
.graph-controls{
  position:absolute;top:18px;right:18px;
  background:#111;border:1px solid var(--border);
  border-radius:14px;padding:12px;
  display:flex;gap:8px;box-shadow:var(--shadow-lg);
  align-items:center;
}
.graph-legend{
  position:absolute;bottom:18px;left:18px;
  background:#111;border:1px solid var(--border);
  border-radius:14px;padding:14px;
  box-shadow:var(--shadow-lg);
}
.legend-item{display:flex;align-items:center;gap:9px;margin:7px 0;font-size:12px;font-weight:750}
.legend-dot{width:13px;height:13px;border-radius:50%;box-shadow:0 0 9px currentColor}

#auth-overlay{
  position:fixed;inset:0;
  background:var(--bg);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.auth-card{
  width:92%;
  max-width:440px;
  background:#111;
  border:1px solid var(--border);
  padding:44px;
  border-radius:22px;
  text-align:center;
  box-shadow:var(--shadow-lg),var(--glow);
}
.input-field{
  width:100%;
  background:var(--surface);
  border:1.5px solid var(--border);
  color:#fff;
  padding:13px 15px;
  border-radius:12px;
  margin-bottom:12px;
  transition:all .2s;
  font-size:13px;
  font-family:var(--font);
  font-weight:700;
}
.input-field:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,101,0,.12)}

.modal-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.93);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1200;
  backdrop-filter:blur(10px);
}
.modal{
  background:#111;
  border:1px solid var(--border);
  border-radius:22px;
  padding:30px;
  max-width:560px;
  width:92%;
  box-shadow:var(--shadow-lg);
}
.modal h3{margin-top:0;color:var(--brand-light);font-size:24px;font-weight:950}
.modal p{color:var(--text-muted);font-size:13px;margin:12px 0 18px;font-weight:600;line-height:1.7}
.modal-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.modal-row label{display:flex;align-items:center;gap:10px;color:var(--text-main);font-size:13px;font-weight:800}
.modal-row input[type="checkbox"]{accent-color:var(--brand)}
.modal-row input[type="number"]{
  background:var(--surface);
  border:1.5px solid var(--border);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  width:120px;
  font-weight:900;
}

#game-modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.97);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1400;
  backdrop-filter:blur(12px);
}
.game-wrapper{
  background:#111;
  border:1.5px solid rgba(255,101,0,.35);
  border-radius:22px;
  padding:22px 22px;
  text-align:center;
  box-shadow:var(--shadow-lg),var(--glow);
  max-width:96vw;
  max-height:96vh;
  overflow-y:auto;
}
.game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:14px;flex-wrap:wrap}
.game-selector{display:flex;gap:8px}
.game-tab{
  padding:8px 16px;
  border-radius:12px;
  border:1.5px solid var(--border);
  background:var(--surface);
  color:var(--text-muted);
  cursor:pointer;
  font-weight:900;
  font-size:12px;
  transition:all .18s;
  user-select:none;
}
.game-tab.active{background:linear-gradient(135deg,var(--brand),var(--accent));border-color:var(--brand);color:#fff;box-shadow:var(--glow)}
.game-title{
  font-size:26px;
  font-weight:950;
  background:linear-gradient(135deg,var(--brand-light),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  font-family:var(--font);
}
.game-score-bar{font-size:14px;color:var(--text-main);margin-bottom:12px;font-weight:850;display:flex;gap:16px;justify-content:center;flex-wrap:wrap}
.game-score-bar span{color:var(--accent)}
#game-canvas,#tetris-canvas{
  border:1.5px solid rgba(255,101,0,.25);
  border-radius:12px;
  background:#050505;
  margin:0 auto;
  display:block;
  box-shadow:0 0 28px rgba(255,101,0,.15);
}
.game-controls-bar{margin-top:14px;display:flex;gap:9px;justify-content:center;flex-wrap:wrap}
.game-instructions{margin-top:12px;color:var(--text-muted);font-size:11px;font-weight:650;line-height:1.6}
.cheats-panel{
  display:none;
  margin-top:14px;
  border:1px solid var(--border);
  background:#0c0c0c;
  border-radius:16px;
  padding:14px;
  text-align:left;
}
.cheats-title{font-weight:950;color:var(--brand-light);margin-bottom:10px}
.cheats-grid{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
.cheats-grid label{font-weight:800;font-size:12px;color:var(--text-main);display:flex;align-items:center;gap:8px}
.cheats-grid input[type="checkbox"]{accent-color:var(--brand)}
.cheats-grid input[type="range"]{accent-color:var(--brand)}
.cheats-grid input[type="number"]{
  background:var(--surface);
  border:1.5px solid var(--border);
  color:#fff;
  padding:8px 10px;
  border-radius:12px;
  width:80px;
  font-weight:950;
}

.toast-wrap{
  position:fixed;
  bottom:18px;
  right:18px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:2000;
  pointer-events:none;
}
.toast{
  pointer-events:none;
  min-width:280px;
  max-width:380px;
  background:rgba(17,17,17,.92);
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:12px 14px;
  box-shadow:var(--shadow-lg);
  backdrop-filter:blur(10px);
}
.toast .t1{font-weight:950;color:#fff;font-size:12px;margin-bottom:3px}
.toast .t2{font-weight:700;color:rgba(255,255,255,.7);font-size:11px;line-height:1.5}
.toast.ok{border-color:rgba(34,197,94,.35)}
.toast.warn{border-color:rgba(255,170,0,.35)}
.toast.bad{border-color:rgba(255,51,51,.4)}

#palette{
  position:fixed;
  inset:0;
  display:none;
  align-items:flex-start;
  justify-content:center;
  padding-top:110px;
  z-index:1600;
  background:rgba(0,0,0,.72);
  backdrop-filter:blur(10px);
}
.palette-card{
  width:92%;
  max-width:720px;
  background:rgba(17,17,17,.96);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow:var(--shadow-lg),0 0 50px rgba(255,101,0,.12);
  overflow:hidden;
}
.palette-top{
  padding:14px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;
  gap:10px;
  align-items:center;
}
.palette-top input{
  flex:1;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
  padding:12px 12px;
  border-radius:14px;
  font-family:var(--font);
  font-weight:850;
}
.palette-top input:focus{border-color:rgba(255,101,0,.45);box-shadow:0 0 0 3px rgba(255,101,0,.12)}
.palette-hint{color:rgba(255,255,255,.55);font-weight:800;font-size:11px;white-space:nowrap}
.palette-list{max-height:420px;overflow:auto}
.palette-item{
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition:all .12s;
  border-top:1px solid rgba(255,255,255,.06);
}
.palette-item:hover{background:rgba(255,255,255,.06)}
.palette-item .l{
  display:flex;
  gap:10px;
  align-items:center;
  min-width:0;
}
.palette-item .ico{width:30px;height:30px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,101,0,.12);border:1px solid rgba(255,101,0,.25)}
.palette-item .txt{display:flex;flex-direction:column;gap:2px;min-width:0}
.palette-item .a{font-weight:950;color:#fff;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.palette-item .b{font-weight:750;color:rgba(255,255,255,.6);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.palette-item .k{font-weight:950;color:rgba(255,255,255,.55);font-size:11px;white-space:nowrap}

body.preview-full aside{display:none !important}
body.preview-full .top-bar{display:none !important}
body.preview-full main{width:100vw}
body.preview-full #pane-read{max-width:none;padding:48px 92px}
body.preview-full #pane-read h1{font-size:56px}

.mobile-menu-btn{display:none}
.mobile-overlay{display:none}

@media (max-width:1024px){
  aside{position:fixed;left:-340px;top:0;bottom:0;z-index:1500;transition:left .28s ease,width .28s ease}
  aside.mobile-open{left:0}
  .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1490}
  .mobile-overlay.active{display:block}
  .mobile-menu-btn{
    display:flex !important;
    position:fixed;
    top:13px;left:13px;
    z-index:1480;
    background:var(--brand);
    color:#fff;
    border:none;
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
    box-shadow:var(--glow);
    font-size:17px;
    font-weight:950;
  }
  .sidebar-toggle{display:none}
  .top-bar{padding:0 18px 0 60px}
}
@media (max-width:768px){
  .editor-pane,.preview-pane,.graph-pane{padding:22px}
  input.title-input{font-size:28px}
  .tab-text,.btn-text{display:none}
  button{padding:10px 12px}
}
::-webkit-scrollbar{width:9px;height:9px}
::-webkit-scrollbar-track{background:var(--sidebar)}
::-webkit-scrollbar-thumb{background:#282828;border-radius:6px;border:2px solid var(--sidebar)}
::-webkit-scrollbar-thumb:hover{background:rgba(255,101,0,.38)}
</style>
</head>

<body>

<button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
<div class="mobile-overlay" id="mobile-overlay"></div>

<div class="toast-wrap" id="toast-wrap"></div>

<div id="palette">
  <div class="palette-card">
    <div class="palette-top">
      <input id="palette-q" placeholder="Type a command or search notes...">
      <div class="palette-hint">Enter ¬∑ Esc</div>
    </div>
    <div class="palette-list" id="palette-list"></div>
  </div>
</div>

<div id="auth-overlay">
  <div class="auth-card">
    <div style="display:flex;align-items:center;justify-content:center;gap:13px;margin-bottom:26px;">
      <div class="logo">K</div>
      <div style="text-align:left">
        <h2 style="margin:0;font-size:28px;font-weight:950;font-family:var(--font);letter-spacing:-0.5px;">StudyOS</h2>
        <p style="margin:5px 0 0 0;font-size:11px;color:var(--text-muted);font-weight:850;">by Kenneth</p>
      </div>
    </div>
    <input type="email" id="email" class="input-field" placeholder="Email">
    <input type="password" id="password" class="input-field" placeholder="Password">
    <button class="primary" id="auth-btn" style="width:100%;padding:13px;font-size:14px;border-radius:14px;">Enter System</button>
    <p id="auth-msg" style="font-size:12px;color:var(--text-muted);cursor:pointer;margin-top:16px;font-weight:850;user-select:none;">Switch to Sign Up</p>
    <div id="auth-err" style="color:var(--danger);font-size:12px;margin-top:10px;font-weight:700;"></div>
  </div>
</div>

<div class="modal-overlay" id="pdf-modal">
  <div class="modal">
    <h3>Export to PDF</h3>
    <p>Exports your note with real Markdown styling (headings, lists, code blocks). You can include linked notes too.</p>
    <div class="modal-row" style="margin-top:10px;">
      <label><input type="checkbox" id="pdf-include-links" checked> Include linked notes</label>
      <label><input type="checkbox" id="pdf-include-date" checked> Include creation date</label>
    </div>
    <div style="display:flex;gap:10px;margin-top:18px;">
      <button style="flex:1;" id="pdf-cancel">Cancel</button>
      <button class="primary" style="flex:1;" id="pdf-export">Export PDF</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <h3>Settings</h3>
    <p>These settings sync across devices.</p>
    <div class="modal-row" style="margin-top:10px;">
      <label><input type="checkbox" id="set-sidebar-collapsed"> Sidebar collapsed</label>
      <label><input type="checkbox" id="set-preview-full"> Preview full-screen</label>
    </div>
    <div style="height:12px"></div>
    <div class="modal-row">
      <label>Focus <input type="number" id="set-focus" min="1" max="180"></label>
      <label>Break <input type="number" id="set-break" min="1" max="60"></label>
      <label>Long <input type="number" id="set-long" min="1" max="120"></label>
    </div>
    <div style="display:flex;gap:10px;margin-top:18px;">
      <button style="flex:1;" id="settings-cancel">Close</button>
      <button class="primary" style="flex:1;" id="settings-save">Save</button>
    </div>
  </div>
</div>

<div id="game-modal">
  <div class="game-wrapper">
    <div class="game-header">
      <div class="game-title" id="game-title-text">Snake Break</div>
      <div class="game-selector">
        <div class="game-tab active" id="gtab-snake">Snake</div>
        <div class="game-tab" id="gtab-tetris">Tetris</div>
      </div>
    </div>

    <div id="snake-section">
      <div class="game-score-bar">
        <div>Score: <span id="game-score">0</span></div>
        <div>Best: <span id="high-score">0</span></div>
      </div>
      <canvas id="game-canvas" width="400" height="400"></canvas>
      <div class="game-controls-bar">
        <button class="primary" id="snake-start">Start</button>
        <button id="cheats-toggle">Cheats</button>
        <button id="game-close">Back</button>
      </div>
      <div class="game-instructions">Arrows or WASD ¬∑ Walls wrap ¬∑ Don‚Äôt hit yourself ¬∑ Speed scales</div>
    </div>

    <div id="tetris-section" style="display:none;">
      <div class="game-score-bar">
        <div>Score: <span id="tetris-score">0</span></div>
        <div>Best: <span id="tetris-best">0</span></div>
        <div>Level: <span id="tetris-level">1</span></div>
        <div>Lines: <span id="tetris-lines">0</span></div>
      </div>
      <canvas id="tetris-canvas" width="240" height="480"></canvas>
      <div class="game-controls-bar">
        <button class="primary" id="tetris-start">Start</button>
        <button id="cheats-toggle-2">Cheats</button>
        <button id="game-close-2">Back</button>
      </div>
      <div class="game-instructions">‚Üê ‚Üí Move ¬∑ ‚Üë Rotate ¬∑ ‚Üì Soft Drop ¬∑ Space Hard Drop</div>
    </div>

    <div class="cheats-panel" id="cheats-panel">
      <div class="cheats-title">Cheats (saved)</div>
      <div class="cheats-grid">
        <label><input type="checkbox" id="cheat-snake-nodie"> Snake No-Die</label>
        <label>Snake Speed <input type="range" id="cheat-snake-speed" min="40" max="200" step="5"> <span id="cheat-snake-speed-val" style="color:var(--accent);font-weight:950"></span></label>
        <label><input type="checkbox" id="cheat-tetris-nogameover"> Tetris No Game Over</label>
        <label>Tetris Start Level <input type="number" id="cheat-tetris-level" min="1" max="20"></label>
      </div>
    </div>
  </div>
</div>

<aside id="sidebar">
  <div class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">‚óÄ</div>

  <div class="sidebar-content">
    <div class="sidebar-header">
      <div class="brand-area">
        <div class="logo">K</div>
        <div class="brand-info">
          <div class="brand-text">StudyOS</div>
          <div class="author-tag">by Kenneth</div>
          <div class="school-badge" id="school-badge">Salesianum</div>
        </div>
      </div>

      <input type="text" class="search-box" id="search-box" placeholder="Search titles + content (Ctrl+K)">
      <button class="new-note-btn" id="new-note">New Note</button>

      <div class="sidebar-controls">
        <select id="sort-notes">
          <option value="updated_desc">Sort: Updated</option>
          <option value="title_asc">Sort: Title</option>
          <option value="grade_asc">Sort: Grade</option>
        </select>
        <button id="open-palette" title="Command Palette">‚åò</button>
      </div>
    </div>

    <div class="nav-list" id="list"></div>

    <div class="stats-widget">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="total-notes">0</div><div class="stat-label">Notes</div></div>
        <div class="stat-card"><div class="stat-value" id="total-links">0</div><div class="stat-label">Links</div></div>
      </div>
    </div>

    <div class="pomodoro-box">
      <div class="timer-display" id="timer">25:00</div>
      <div class="timer-controls">
        <button class="sm" id="timer-start" title="Start">‚ñ∂</button>
        <button class="sm" id="timer-pause" title="Pause">‚è∏</button>
        <button class="sm" id="timer-reset" title="Reset">‚Ü∫</button>
      </div>
      <div class="timer-mode">
        <span id="timer-focus">Focus</span>
        <span id="timer-break">Break</span>
        <span id="timer-long">Long</span>
        <span id="timer-break-game">Break + Game</span>
      </div>
    </div>

    <div class="signout-area">
      <button class="signout-btn" id="signout">Sign out</button>
    </div>
  </div>

  <div class="sidebar-mini-icons">
    <div class="mini-icon logo-mini">K</div>
    <div class="mini-icon" id="mini-new" title="New Note">‚úèÔ∏è</div>
    <div class="mini-icon" id="mini-game" title="Games">üéÆ</div>
    <div class="mini-icon" id="mini-timer" title="Start Timer">‚è±Ô∏è</div>
    <div class="mini-icon" id="mini-out" title="Sign Out" style="margin-top:auto;margin-bottom:10px;">üö™</div>
  </div>
</aside>

<main>
  <div class="top-bar">
    <div class="tabs">
      <div class="tab active" id="tab-write"><span class="tab-icon">‚úçÔ∏è</span><span class="tab-text">Write</span></div>
      <div class="tab" id="tab-read"><span class="tab-icon">üìñ</span><span class="tab-text">Preview</span></div>
      <div class="tab" id="tab-graph"><span class="tab-icon">üï∏Ô∏è</span><span class="tab-text">Graph</span></div>
    </div>
    <div class="actions">
      <div class="autosave-indicator" id="save-status" style="display:none;"><div class="autosave-dot"></div><span>Autosaving</span></div>
      <button id="btn-full">‚õ∂ <span class="btn-text">Full</span></button>
      <button id="btn-export">PDF <span class="btn-text">Export</span></button>
      <button class="primary" id="btn-save">Save <span class="btn-text">Now</span></button>
      <button id="btn-settings">‚öô <span class="btn-text">Settings</span></button>
      <button class="danger" id="btn-delete">Delete <span class="btn-text">Note</span></button>
    </div>
  </div>

  <div class="content-area">
    <div id="pane-write" class="editor-pane active">
      <div class="row-top">
        <div class="grade-selector">
          <label>Grade Level</label>
          <select class="grade-dropdown" id="note-grade">
            <option value="">Select Grade</option>
            <option value="8th">8th Grade</option>
            <option value="9th">9th Grade (Freshman)</option>
            <option value="10th">10th Grade (Sophomore)</option>
            <option value="11th">11th Grade (Junior)</option>
            <option value="12th">12th Grade (Senior)</option>
          </select>
        </div>

        <div class="link-input-container">
          <label style="display:block;font-size:9px;font-weight:950;color:var(--text-muted);margin-bottom:7px;text-transform:uppercase;letter-spacing:1.5px;">Link notes</label>
          <input type="text" class="link-input" id="link-search" placeholder="Type a note title to link...">
          <div id="link-dropdown"></div>
        </div>
      </div>

      <input type="text" class="title-input" id="title-in" placeholder="Untitled Note">
      <textarea class="body-input" id="body-in" placeholder="Write here. Markdown supported.

# Heading
## Subheading
**bold** *italic* ~~strike~~
- list
1. list
> quote
`code`"></textarea>

      <div class="section-card" id="linked-card" style="display:none;">
        <div class="section-head">
          <div class="section-title">Linked notes</div>
          <div class="section-actions">
            <div class="small-link" id="unlink-all">Unlink all</div>
          </div>
        </div>
        <div class="pills" id="linked-display"></div>
      </div>

      <div class="section-card" id="backlinks-card" style="display:none;">
        <div class="section-head">
          <div class="section-title">Backlinks</div>
          <div class="section-actions">
            <div class="small-link" id="open-preview">Preview</div>
          </div>
        </div>
        <div class="pills" id="backlinks-display"></div>
      </div>

      <div class="section-card" id="mentions-card" style="display:none;">
        <div class="section-head">
          <div class="section-title">Unlinked mentions</div>
          <div class="section-actions">
            <div class="small-link" id="link-all-mentions">Link all</div>
          </div>
        </div>
        <div class="pills" id="mentions-display"></div>
      </div>
    </div>

    <div id="pane-read" class="preview-pane">
      <h1 id="prev-title"></h1>
      <div id="prev-meta" style="color:var(--text-muted);font-weight:800;margin:-16px 0 20px;display:flex;gap:12px;flex-wrap:wrap;"></div>
      <div id="prev-body"></div>
      <div class="section-card" id="preview-links-card" style="display:none;max-width:920px;">
        <div class="section-head">
          <div class="section-title">Linked notes</div>
          <div class="section-actions">
            <div class="small-link" id="preview-open-write">Back</div>
          </div>
        </div>
        <div class="pills" id="preview-links"></div>
      </div>
    </div>

    <div id="pane-graph" class="graph-pane">
      <canvas id="graph-canvas"></canvas>
      <div class="graph-controls">
        <button class="sm" id="graph-reset">Reset</button>
        <button class="sm" id="graph-physics">Physics</button>
        <button class="sm" id="graph-center">Center</button>
      </div>
      <div class="graph-legend">
        <div style="font-size:10px;font-weight:950;margin-bottom:10px;color:var(--brand-light);letter-spacing:1.2px;text-transform:uppercase;">Legend</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--brand);"></div><span>Current</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div><span>Linked</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#555;"></div><span>Other</span></div>
      </div>
    </div>
  </div>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL='https://cgmazcvmpcgistoimqlw.supabase.co'
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc'
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY)

marked.setOptions({breaks:true})

let user=null
let notes=[]
let links=[]
let activeId=null
let isSignUp=false
let autoSaveTimeout=null
let timerInterval=null
let timeLeft=25*60

let currentSchool='Salesianum'
let sidebarCollapsed=false
let previewFull=false

let uiPrefs={sidebarCollapsed:false,previewFull:false,sort:'updated_desc',lastOpenNoteId:null}
let timerPresets={focus:25,break:5,long:15}
let gameCheats={snake:{highScore:0,noDie:false,speed:110},tetris:{highScore:0,noGameOver:false,startLevel:1}}

let settingsSaveT=null

let graphCanvas=null
let graphCtx=null
let graphNodes=[]
let graphLinks=[]
let graphPhysicsEnabled=true
let graphDragging=false
let graphDragNode=null
let graphPan=false
let graphPanStart=null
let graphView={x:0,y:0,scale:1}
let graphAnim=null

let gameOpen=false
let gameCanvas=null
let gameCtx=null
let snake=[]
let food=null
let direction={x:0,y:0}
let score=0
let gameInterval=null
let gameRunning=false
const gridSize=20
const tileCount=20

let tetrisCanvas=null
let tetrisCtx=null
let tetrisBoard=null
let tetrisPiece=null
let tetrisScore=0
let tetrisBest=0
let tetrisLevel=1
let tetrisLines=0
let tetrisRunning=false
let tetrisDropCounter=0
let tetrisLastTime=0
const TC=12,TR=24,TS=20
const T_COLORS=[null,'#ff6500','#ffaa00','#ff8533','#cc2200','#ff3300','#ff9900','#ffcc00']
const T_SHAPES=[null,[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]]

const grades=['8th','9th','10th','11th','12th']
const gradeLabels={'8th':'8th Grade','9th':'9th Grade (Freshman)','10th':'10th Grade (Sophomore)','11th':'11th Grade (Junior)','12th':'12th Grade (Senior)'}
const gradeOrder={'':99,'8th':0,'9th':1,'10th':2,'11th':3,'12th':4}

const $=id=>document.getElementById(id)

function toast(title,body,type='ok'){
  const wrap=$('toast-wrap')
  const el=document.createElement('div')
  el.className='toast '+(type==='ok'?'ok':type==='warn'?'warn':'bad')
  el.innerHTML='<div class="t1"></div><div class="t2"></div>'
  el.querySelector('.t1').textContent=title
  el.querySelector('.t2').textContent=body
  wrap.appendChild(el)
  setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(6px)'},2400)
  setTimeout(()=>{el.remove()},2900)
}

function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function esc(s){return (s||'').replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}
function orderedPair(a,b){return a<b?[a,b]:[b,a]}

async function loadSettings(){
  const {data}=await supabase.from('user_settings').select('*').eq('user_id',user.id).maybeSingle()
  if(!data){
    const ins=await supabase.from('user_settings').insert({user_id:user.id}).select().single()
    if(ins.data) applySettings(ins.data)
  }else{
    applySettings(data)
  }
}

function applySettings(s){
  currentSchool=s.current_school||'Salesianum'
  uiPrefs=s.ui||uiPrefs
  timerPresets=s.timer||timerPresets
  gameCheats=s.game||gameCheats

  sidebarCollapsed=!!uiPrefs.sidebarCollapsed
  previewFull=!!uiPrefs.previewFull

  $('school-badge').textContent=currentSchool
  $('sort-notes').value=uiPrefs.sort||'updated_desc'

  if(sidebarCollapsed){
    $('sidebar').classList.add('collapsed')
    $('sidebar-toggle').textContent='‚ñ∂'
  }else{
    $('sidebar').classList.remove('collapsed')
    $('sidebar-toggle').textContent='‚óÄ'
  }

  if(previewFull) document.body.classList.add('preview-full')
  else document.body.classList.remove('preview-full')

  $('timer-focus').textContent='Focus '+(timerPresets.focus||25)
  $('timer-break').textContent='Break '+(timerPresets.break||5)
  $('timer-long').textContent='Long '+(timerPresets.long||15)

  $('high-score').textContent=gameCheats.snake?.highScore||0
  $('tetris-best').textContent=gameCheats.tetris?.highScore||0
}

function saveSettingsDebounced(){
  clearTimeout(settingsSaveT)
  settingsSaveT=setTimeout(async ()=>{
    await supabase.from('user_settings').upsert({
      user_id:user.id,
      current_school:currentSchool,
      ui:uiPrefs,
      timer:timerPresets,
      game:gameCheats
    })
  },320)
}

async function fetchLinks(){
  const {data}=await supabase.from('note_links').select('note_a,note_b').eq('user_id',user.id)
  links=data||[]
}

function rebuildLinkedNotesOnClient(){
  const map={}
  notes.forEach(n=>map[n.id]=[])
  links.forEach(l=>{
    if(map[l.note_a]) map[l.note_a].push(l.note_b)
    if(map[l.note_b]) map[l.note_b].push(l.note_a)
  })
  notes=notes.map(n=>({...n,linked_notes:map[n.id]||[]}))
}

async function fetchNotes(){
  const {data}=await supabase.from('notes').select('*').eq('user_id',user.id).order('updated_at',{ascending:false})
  notes=(data||[]).map(n=>({...n,linked_notes:[]}))
  await fetchLinks()
  rebuildLinkedNotesOnClient()
  renderList()
  updateStats()
  const last=uiPrefs.lastOpenNoteId
  if(last && notes.some(n=>n.id===last)) loadNote(last)
  else if(notes.length) loadNote(notes[0].id)
  else activeId=null
}

function sortNotes(arr){
  const mode=uiPrefs.sort||'updated_desc'
  const copy=[...arr]
  if(mode==='title_asc'){
    copy.sort((a,b)=>((a.title||'').toLowerCase()).localeCompare((b.title||'').toLowerCase()))
  }else if(mode==='grade_asc'){
    copy.sort((a,b)=>(gradeOrder[a.grade||'']-gradeOrder[b.grade||''])||(((b.updated_at||'')>(a.updated_at||''))?1:-1))
  }else{
    copy.sort((a,b)=>((b.updated_at||'')>(a.updated_at||''))?1:-1)
  }
  return copy
}

function renderList(q=''){
  const list=$('list')
  const query=(q||'').trim().toLowerCase()
  const byGrade={}
  grades.forEach(g=>byGrade[g]=[])
  byGrade.ungraded=[]
  const sorted=sortNotes(notes)
  sorted.forEach(n=>{
    const title=(n.title||'').toLowerCase()
    const body=(n.content||'').toLowerCase()
    if(query && !(title.includes(query)||body.includes(query))) return
    if(n.grade && grades.includes(n.grade)) byGrade[n.grade].push(n)
    else byGrade.ungraded.push(n)
  })
  let html=''
  const section=(key,label,arr)=>{
    if(!arr.length) return ''
    const items=arr.map(n=>{
      const linked=(n.linked_notes||[]).length>0
      const t=n.title&&n.title.trim()?n.title:'Untitled'
      const isActive=n.id===activeId
      const g=n.grade||''
      const badges=[]
      if(linked) badges.push('<span class="badge linked">LINKS</span>')
      if(!n.title && !n.content) badges.push('<span class="badge draft">DRAFT</span>')
      const right=badges.length?'<span class="meta">'+badges.join('')+'</span>':''
      return '<div class="nav-item '+(isActive?'active':'')+'" data-id="'+n.id+'"><span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+t+'</span>'+right+'</div>'
    }).join('')
    return '<div class="grade-section"><div class="grade-header active" data-grade="'+key+'"><div class="grade-title"><span>'+label+'</span><span class="grade-count">'+arr.length+'</span></div><div class="grade-arrow">‚ñ∂</div></div><div class="grade-notes expanded" id="grade-'+key+'">'+items+'</div></div>'
  }
  grades.forEach(g=>{html+=section(g,gradeLabels[g],byGrade[g])})
  html+=section('ungraded','Ungraded',byGrade.ungraded)
  list.innerHTML=html

  list.querySelectorAll('.grade-header').forEach(h=>{
    h.onclick=e=>{
      const g=h.getAttribute('data-grade')
      const d=$('grade-'+g)
      h.classList.toggle('active')
      d.classList.toggle('expanded')
    }
  })
  list.querySelectorAll('.nav-item').forEach(item=>{
    item.onclick=()=>{
      const id=item.getAttribute('data-id')
      loadNote(id)
    }
  })
}

function updateStats(){
  $('total-notes').innerText=notes.length
  $('total-links').innerText=links.length
}

function setSaveStatus(mode){
  const ss=$('save-status')
  if(mode==='saving'){
    ss.style.display='flex'
    ss.innerHTML='<div class="autosave-dot"></div><span>Autosaving</span>'
  }else if(mode==='saved'){
    ss.style.display='flex'
    ss.innerHTML='<div style="width:7px;height:7px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success);"></div><span style="color:var(--success);font-weight:950;">Saved</span>'
    setTimeout(()=>{ss.style.display='none'},1400)
  }else if(mode==='error'){
    ss.style.display='flex'
    ss.innerHTML='<div style="width:7px;height:7px;border-radius:50%;background:var(--danger);box-shadow:0 0 8px var(--danger);"></div><span style="color:var(--danger);font-weight:950;">Save failed</span>'
    setTimeout(()=>{ss.style.display='none'},2200)
  }else{
    ss.style.display='none'
  }
}

async function createNote(){
  const {data,error}=await supabase.from('notes').insert({user_id:user.id,title:'',content:'',grade:'',school:currentSchool}).select().single()
  if(error){toast('Could not create note',error.message,'bad');return}
  const n={...data,linked_notes:[]}
  notes.unshift(n)
  uiPrefs.lastOpenNoteId=n.id
  saveSettingsDebounced()
  renderList($('search-box').value)
  updateStats()
  loadNote(n.id)
  toast('New note','Created','ok')
}

function loadNote(id){
  const n=notes.find(x=>x.id===id)
  if(!n) return
  activeId=id
  uiPrefs.lastOpenNoteId=id
  saveSettingsDebounced()

  $('title-in').value=n.title||''
  $('body-in').value=n.content||''
  $('note-grade').value=n.grade||''

  switchTab('write')
  renderList($('search-box').value)
  refreshLinkUI()
}

async function saveNote(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  if(!n) return
  const title=$('title-in').value
  const content=$('body-in').value
  const grade=$('note-grade').value||''
  setSaveStatus('saving')
  const {error}=await supabase.from('notes').update({
    title:title,
    content:content,
    grade:grade,
    school:currentSchool,
    updated_at:new Date().toISOString()
  }).eq('id',activeId)
  if(error){
    setSaveStatus('error')
    toast('Save failed',error.message,'bad')
    return
  }
  n.title=title
  n.content=content
  n.grade=grade
  setSaveStatus('saved')
  renderList($('search-box').value)
  updatePreview()
  refreshLinkUI()
  updateStats()
}

function handleAutoSave(){
  clearTimeout(autoSaveTimeout)
  setSaveStatus('saving')
  autoSaveTimeout=setTimeout(()=>saveNote(),900)
}

async function deleteNote(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  const title=(n?.title||'Untitled')
  const ok=confirm('Delete "'+title+'"? This is permanent.')
  if(!ok) return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  const {error}=await supabase.from('notes').delete().eq('id',activeId)
  if(error){toast('Delete failed',error.message,'bad');return}
  notes=notes.filter(x=>x.id!==activeId)
  links=links.filter(l=>l.note_a!==activeId && l.note_b!==activeId)
  rebuildLinkedNotesOnClient()
  updateStats()
  renderList($('search-box').value)
  toast('Deleted',title,'ok')
  if(notes.length) loadNote(notes[0].id)
  else{
    activeId=null
    $('title-in').value=''
    $('body-in').value=''
    $('note-grade').value=''
    refreshLinkUI()
  }
}

function switchTab(mode){
  $('tab-write').classList.toggle('active',mode==='write')
  $('tab-read').classList.toggle('active',mode==='read')
  $('tab-graph').classList.toggle('active',mode==='graph')
  $('pane-write').classList.toggle('active',mode==='write')
  $('pane-read').classList.toggle('active',mode==='read')
  $('pane-graph').classList.toggle('active',mode==='graph')
  if(mode==='read') updatePreview()
  if(mode==='graph') drawGraph()
}

function updatePreview(){
  const n=notes.find(x=>x.id===activeId)
  $('prev-title').innerText=$('title-in').value||'Untitled Note'
  const g=$('note-grade').value||''
  const meta=[]
  if(g) meta.push('Grade: '+(gradeLabels[g]||g))
  meta.push('School: '+currentSchool)
  if(n?.updated_at) meta.push('Updated: '+new Date(n.updated_at).toLocaleString())
  $('prev-meta').innerHTML=meta.map(m=>'<span class="badge" style="border-color:rgba(255,255,255,.12);color:rgba(255,255,255,.75);background:rgba(255,255,255,.06)">'+m+'</span>').join('')
  $('prev-body').innerHTML=marked.parse($('body-in').value||'')
  const linked=(n?.linked_notes||[])
  if(linked.length){
    $('preview-links-card').style.display='block'
    $('preview-links').innerHTML=linked.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=ln.title&&ln.title.trim()?ln.title:'Untitled'
      return '<span class="pill" data-open="'+id+'">'+t+'</span>'
    }).join('')
    $('preview-links').querySelectorAll('.pill').forEach(p=>{
      p.onclick=()=>loadNote(p.getAttribute('data-open'))
    })
  }else{
    $('preview-links-card').style.display='none'
  }
}

function refreshLinkUI(){
  const n=notes.find(x=>x.id===activeId)
  const linked=(n?.linked_notes||[])
  if(linked.length){
    $('linked-card').style.display='block'
    $('linked-display').innerHTML=linked.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=ln.title&&ln.title.trim()?ln.title:'Untitled'
      return '<span class="pill" data-open="'+id+'" data-id="'+id+'">'+t+'<span class="x" data-x="'+id+'">√ó</span></span>'
    }).join('')
    $('linked-display').querySelectorAll('.pill').forEach(p=>{
      p.onclick=e=>{
        const xid=e.target?.getAttribute?.('data-x')
        if(xid){unlinkNote(xid);return}
        loadNote(p.getAttribute('data-open'))
      }
    })
  }else{
    $('linked-card').style.display='none'
  }

  const bl=getBacklinks(activeId)
  if(bl.length){
    $('backlinks-card').style.display='block'
    $('backlinks-display').innerHTML=bl.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=ln.title&&ln.title.trim()?ln.title:'Untitled'
      return '<span class="pill" data-open="'+id+'">'+t+'</span>'
    }).join('')
    $('backlinks-display').querySelectorAll('.pill').forEach(p=>{
      p.onclick=()=>loadNote(p.getAttribute('data-open'))
    })
  }else{
    $('backlinks-card').style.display='none'
  }

  const mentions=getUnlinkedMentions()
  if(mentions.length){
    $('mentions-card').style.display='block'
    $('mentions-display').innerHTML=mentions.map(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return ''
      const t=ln.title&&ln.title.trim()?ln.title:'Untitled'
      return '<span class="pill" data-open="'+id+'" data-link="'+id+'">'+t+'</span>'
    }).join('')
    $('mentions-display').querySelectorAll('.pill').forEach(p=>{
      p.onclick=()=>linkNote(p.getAttribute('data-link'))
    })
  }else{
    $('mentions-card').style.display='none'
  }
}

function getBacklinks(id){
  if(!id) return []
  const res=[]
  notes.forEach(n=>{
    if(n.id===id) return
    if((n.linked_notes||[]).includes(id)) res.push(n.id)
  })
  return res
}

function getUnlinkedMentions(){
  const n=notes.find(x=>x.id===activeId)
  if(!n) return []
  const content=($('body-in').value||'').toLowerCase()
  const linked=new Set(n.linked_notes||[])
  const res=[]
  notes.forEach(o=>{
    if(o.id===activeId) return
    const t=(o.title||'').trim()
    if(!t) return
    const key=t.toLowerCase()
    if(key.length<4) return
    if(linked.has(o.id)) return
    if(content.includes(key)) res.push(o.id)
  })
  return res.slice(0,18)
}

function showLinkDropdown(){
  $('link-dropdown').style.display='block'
  searchForLinks()
}
function hideLinkDropdown(){
  setTimeout(()=>{$('link-dropdown').style.display='none'},180)
}

function searchForLinks(){
  const q=($('link-search').value||'').toLowerCase().trim()
  const dd=$('link-dropdown')
  if(!activeId){dd.style.display='none';return}
  const cur=notes.find(x=>x.id===activeId)
  const already=new Set(cur?.linked_notes||[])
  const items=notes
    .filter(n=>n.id!==activeId)
    .filter(n=>{
      const t=(n.title||'').toLowerCase()
      return (!q || t.includes(q))
    })
    .filter(n=>!already.has(n.id))
    .slice(0,8)

  if(!items.length){
    dd.innerHTML='<div class="link-dd-empty">No notes found</div>'
    return
  }
  dd.innerHTML=items.map(n=>{
    const t=n.title&&n.title.trim()?n.title:'Untitled'
    const g=n.grade?(' ¬∑ '+(gradeLabels[n.grade]||n.grade)):''
    return '<div class="link-dd-item" data-id="'+n.id+'">'+t+'<span style="color:var(--text-muted);font-weight:850;font-size:11px;">'+g+'</span></div>'
  }).join('')
  dd.querySelectorAll('.link-dd-item').forEach(it=>{
    it.onmousedown=()=>linkNote(it.getAttribute('data-id'))
  })
}

async function linkNote(lid){
  if(!activeId || !lid || activeId===lid) return
  const [a,b]=orderedPair(activeId,lid)
  const {error}=await supabase.from('note_links').upsert({user_id:user.id,note_a:a,note_b:b},{onConflict:'user_id,note_a,note_b'})
  if(error){toast('Link failed',error.message,'bad');return}
  $('link-search').value=''
  await fetchLinks()
  rebuildLinkedNotesOnClient()
  refreshLinkUI()
  renderList($('search-box').value)
  updateStats()
  toast('Linked','Notes connected','ok')
}

async function unlinkNote(lid){
  if(!activeId || !lid || activeId===lid) return
  const [a,b]=orderedPair(activeId,lid)
  const {error}=await supabase.from('note_links').delete().eq('user_id',user.id).eq('note_a',a).eq('note_b',b)
  if(error){toast('Unlink failed',error.message,'bad');return}
  await fetchLinks()
  rebuildLinkedNotesOnClient()
  refreshLinkUI()
  renderList($('search-box').value)
  updateStats()
  toast('Unlinked','Connection removed','warn')
}

async function unlinkAll(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  const ids=(n?.linked_notes||[])
  if(!ids.length) return
  const ok=confirm('Unlink all connections for this note?')
  if(!ok) return
  await supabase.from('note_links').delete().eq('user_id',user.id).or('note_a.eq.'+activeId+',note_b.eq.'+activeId)
  await fetchLinks()
  rebuildLinkedNotesOnClient()
  refreshLinkUI()
  renderList($('search-box').value)
  updateStats()
  toast('Unlinked','All connections removed','warn')
}

async function linkAllMentions(){
  const ids=getUnlinkedMentions()
  for(const id of ids) await linkNote(id)
}

function toggleSidebar(){
  sidebarCollapsed=!sidebarCollapsed
  $('sidebar').classList.toggle('collapsed',sidebarCollapsed)
  $('sidebar-toggle').textContent=sidebarCollapsed?'‚ñ∂':'‚óÄ'
  uiPrefs.sidebarCollapsed=sidebarCollapsed
  saveSettingsDebounced()
}

function toggleMobileMenu(){
  $('sidebar').classList.toggle('mobile-open')
  $('mobile-overlay').classList.toggle('active')
}

function togglePreviewFull(){
  previewFull=!previewFull
  document.body.classList.toggle('preview-full',previewFull)
  uiPrefs.previewFull=previewFull
  saveSettingsDebounced()
}

function openPDFModal(){ $('pdf-modal').style.display='flex' }
function closePDFModal(){ $('pdf-modal').style.display='none' }

async function exportPDF(){
  if(!activeId) return
  const n=notes.find(x=>x.id===activeId)
  if(!n) return
  const includeLinks=$('pdf-include-links').checked
  const includeDate=$('pdf-include-date').checked

  const wrap=document.createElement('div')
  wrap.style.width='800px'
  wrap.style.padding='34px'
  wrap.style.background='#ffffff'
  wrap.style.color='#111111'
  wrap.style.fontFamily='Montserrat,Arial,sans-serif'
  wrap.style.lineHeight='1.7'
  wrap.style.borderRadius='18px'

  const title=document.createElement('div')
  title.style.fontSize='34px'
  title.style.fontWeight='900'
  title.style.marginBottom='8px'
  title.textContent=(n.title&&n.title.trim()?n.title:'Untitled Note')
  wrap.appendChild(title)

  const meta=document.createElement('div')
  meta.style.display='flex'
  meta.style.flexWrap='wrap'
  meta.style.gap='8px'
  meta.style.marginBottom='18px'
  const chip=(txt)=>{
    const s=document.createElement('span')
    s.textContent=txt
    s.style.fontSize='12px'
    s.style.fontWeight='800'
    s.style.padding='6px 10px'
    s.style.borderRadius='999px'
    s.style.border='1px solid #e6e6e6'
    s.style.background='#fafafa'
    return s
  }
  if(n.grade) meta.appendChild(chip('Grade: '+(gradeLabels[n.grade]||n.grade)))
  meta.appendChild(chip('School: '+(n.school||currentSchool)))
  if(includeDate && n.created_at) meta.appendChild(chip('Created: '+new Date(n.created_at).toLocaleDateString()))
  if(n.updated_at) meta.appendChild(chip('Updated: '+new Date(n.updated_at).toLocaleString()))
  wrap.appendChild(meta)

  const body=document.createElement('div')
  body.innerHTML=marked.parse(n.content||'')
  body.querySelectorAll('pre').forEach(p=>{
    p.style.background='#0f0f0f'
    p.style.color='#f5f5f5'
    p.style.padding='14px'
    p.style.borderRadius='12px'
    p.style.overflowX='auto'
  })
  body.querySelectorAll('code').forEach(c=>{
    c.style.fontFamily='JetBrains Mono,Consolas,monospace'
    c.style.fontSize='12px'
  })
  body.querySelectorAll('h1,h2,h3').forEach(h=>{
    h.style.fontWeight='900'
    h.style.marginTop='20px'
  })
  wrap.appendChild(body)

  if(includeLinks && (n.linked_notes||[]).length){
    const h=document.createElement('div')
    h.style.marginTop='22px'
    h.style.fontWeight='900'
    h.style.fontSize='16px'
    h.textContent='Linked Notes'
    wrap.appendChild(h)
    const ul=document.createElement('ul')
    ul.style.marginTop='8px'
    ul.style.paddingLeft='18px'
    ;(n.linked_notes||[]).forEach(id=>{
      const ln=notes.find(x=>x.id===id)
      if(!ln) return
      const li=document.createElement('li')
      li.textContent=(ln.title&&ln.title.trim()?ln.title:'Untitled')
      li.style.fontWeight='750'
      li.style.margin='6px 0'
      ul.appendChild(li)
    })
    wrap.appendChild(ul)
  }

  const {jsPDF}=window.jspdf
  const doc=new jsPDF('p','pt','a4')
  toast('Exporting','Rendering PDF‚Ä¶','warn')
  await doc.html(wrap,{
    x:24,
    y:24,
    width:547,
    windowWidth:800,
    html2canvas:{scale:1.25,backgroundColor:'#ffffff'}
  })
  doc.save(((n.title&&n.title.trim()?n.title:'note')+'.pdf').replace(/[\\/:*?"<>|]+/g,'_'))
  closePDFModal()
  toast('Exported','PDF saved','ok')
}

function setTimer(min){
  pauseTimer()
  timeLeft=min*60
  updateTimerDisplay()
}
function startTimer(){
  if(timerInterval) return
  timerInterval=setInterval(()=>{
    if(timeLeft>0){timeLeft--;updateTimerDisplay()}
    else{
      pauseTimer()
      toast("Timer","Time's up","ok")
      try{new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play()}catch(e){}
    }
  },1000)
}
function pauseTimer(){clearInterval(timerInterval);timerInterval=null}
function resetTimer(){pauseTimer();setTimer(timerPresets.focus||25)}
function updateTimerDisplay(){
  const m=Math.floor(timeLeft/60).toString().padStart(2,'0')
  const s=(timeLeft%60).toString().padStart(2,'0')
  $('timer').innerText=m+':'+s
}

function openSettings(){
  $('settings-modal').style.display='flex'
  $('set-sidebar-collapsed').checked=!!uiPrefs.sidebarCollapsed
  $('set-preview-full').checked=!!uiPrefs.previewFull
  $('set-focus').value=timerPresets.focus||25
  $('set-break').value=timerPresets.break||5
  $('set-long').value=timerPresets.long||15
}
function closeSettings(){ $('settings-modal').style.display='none' }
function saveSettingsFromModal(){
  uiPrefs.sidebarCollapsed=$('set-sidebar-collapsed').checked
  uiPrefs.previewFull=$('set-preview-full').checked
  timerPresets.focus=clamp(parseInt($('set-focus').value||25,10),1,180)
  timerPresets.break=clamp(parseInt($('set-break').value||5,10),1,60)
  timerPresets.long=clamp(parseInt($('set-long').value||15,10),1,120)
  applySettings({current_school:currentSchool,ui:uiPrefs,timer:timerPresets,game:gameCheats})
  saveSettingsDebounced()
  closeSettings()
  toast('Saved','Settings synced','ok')
}

function openPalette(){
  $('palette').style.display='flex'
  $('palette-q').value=''
  renderPalette('')
  setTimeout(()=>$('palette-q').focus(),0)
}
function closePalette(){
  $('palette').style.display='none'
}
function renderPalette(q){
  const query=(q||'').toLowerCase().trim()
  const items=[]
  const add=(ico,a,b,k,fn)=>items.push({ico,a,b,k,fn})
  add('‚úèÔ∏è','New note','Create a new note','Enter',()=>createNote())
  add('üìñ','Preview','Switch to Preview tab','Enter',()=>switchTab('read'))
  add('‚úçÔ∏è','Write','Switch to Write tab','Enter',()=>switchTab('write'))
  add('üï∏Ô∏è','Graph','Open graph view','Enter',()=>switchTab('graph'))
  add('‚õ∂','Toggle full screen','Preview full-screen on/off','Enter',()=>togglePreviewFull())
  add('üéÆ','Open games','Snake/Tetris break','Enter',()=>openGame())
  add('üìÑ','Export PDF','Export current note','Enter',()=>openPDFModal())
  add('‚öô','Settings','Open settings panel','Enter',()=>openSettings())
  if(activeId) add('üíæ','Save now','Force save','Enter',()=>saveNote())

  const noteHits=notes
    .map(n=>({id:n.id,title:(n.title&&n.title.trim()?n.title:'Untitled'),body:(n.content||'')}))
    .filter(n=>{
      if(!query) return false
      return n.title.toLowerCase().includes(query) || n.body.toLowerCase().includes(query)
    })
    .slice(0,8)

  noteHits.forEach(n=>{
    add('üìù',n.title,'Open note','Enter',()=>loadNote(n.id))
  })

  const filtered=items.filter(it=>{
    if(!query) return true
    return it.a.toLowerCase().includes(query) || it.b.toLowerCase().includes(query)
  })

  const list=$('palette-list')
  list.innerHTML=filtered.map((it,i)=>{
    return '<div class="palette-item" data-i="'+i+'"><div class="l"><div class="ico">'+it.ico+'</div><div class="txt"><div class="a">'+it.a+'</div><div class="b">'+it.b+'</div></div></div><div class="k">'+it.k+'</div></div>'
  }).join('')
  list.querySelectorAll('.palette-item').forEach(row=>{
    row.onclick=()=>{
      const idx=parseInt(row.getAttribute('data-i'),10)
      closePalette()
      filtered[idx].fn()
    }
  })
}

function openGame(){
  gameOpen=true
  $('game-modal').style.display='flex'
  switchGame('snake')
  syncCheatUI()
}
function closeGame(){
  gameOpen=false
  $('game-modal').style.display='none'
  stopSnake()
  stopTetris()
}
function switchGame(mode){
  $('gtab-snake').classList.toggle('active',mode==='snake')
  $('gtab-tetris').classList.toggle('active',mode==='tetris')
  $('snake-section').style.display=mode==='snake'?'block':'none'
  $('tetris-section').style.display=mode==='tetris'?'block':'none'
  $('game-title-text').textContent=mode==='snake'?'Snake Break':'Tetris Break'
  if(mode==='snake'){
    stopTetris()
    initSnake()
  }else{
    stopSnake()
    initTetris()
  }
  syncCheatUI()
}

function toggleCheats(){
  const p=$('cheats-panel')
  p.style.display=(p.style.display==='none'||!p.style.display)?'block':'none'
  syncCheatUI()
}

function syncCheatUI(){
  $('cheat-snake-nodie').checked=!!gameCheats.snake?.noDie
  $('cheat-snake-speed').value=gameCheats.snake?.speed??110
  $('cheat-snake-speed-val').textContent=(gameCheats.snake?.speed??110)+'ms'
  $('cheat-tetris-nogameover').checked=!!gameCheats.tetris?.noGameOver
  $('cheat-tetris-level').value=gameCheats.tetris?.startLevel??1
  $('high-score').textContent=gameCheats.snake?.highScore||0
  $('tetris-best').textContent=gameCheats.tetris?.highScore||0
}

function initSnake(){
  if(!gameCanvas){
    gameCanvas=$('game-canvas')
    gameCtx=gameCanvas.getContext('2d')
  }
  resetSnake()
  $('high-score').textContent=gameCheats.snake?.highScore||0
}
function resetSnake(){
  snake=[{x:10,y:10}]
  direction={x:0,y:0}
  score=0
  spawnFood()
  $('game-score').textContent='0'
  drawSnake()
}
function spawnFood(){
  food={x:Math.floor(Math.random()*tileCount),y:Math.floor(Math.random()*tileCount)}
  if(snake.some(s=>s.x===food.x&&s.y===food.y)) spawnFood()
}
function startSnake(){
  if(gameRunning) return
  resetSnake()
  gameRunning=true
  direction={x:1,y:0}
  const sp=gameCheats.snake?.speed??110
  gameInterval=setInterval(updateSnake,sp)
}
function stopSnake(){
  gameRunning=false
  if(gameInterval){clearInterval(gameInterval);gameInterval=null}
}
function updateSnake(){
  const head={x:((snake[0].x+direction.x)+tileCount)%tileCount,y:((snake[0].y+direction.y)+tileCount)%tileCount}
  if(!gameCheats.snake?.noDie){
    if(snake.some(s=>s.x===head.x&&s.y===head.y)){snakeGameOver();return}
  }
  snake.unshift(head)
  if(head.x===food.x&&head.y===food.y){
    score++
    $('game-score').textContent=score
    spawnFood()
    const hs=gameCheats.snake?.highScore??0
    if(score>hs){
      gameCheats.snake.highScore=score
      $('high-score').textContent=score
      saveSettingsDebounced()
    }
    if(score%5===0&&score>0){
      const base=gameCheats.snake?.speed??110
      const newSpeed=Math.max(45,base-score*3)
      gameCheats.snake.speed=newSpeed
      $('cheat-snake-speed').value=newSpeed
      $('cheat-snake-speed-val').textContent=newSpeed+'ms'
      saveSettingsDebounced()
      if(gameInterval){clearInterval(gameInterval);gameInterval=setInterval(updateSnake,newSpeed)}
    }
  }else{
    snake.pop()
  }
  drawSnake()
}
function drawSnake(){
  const W=gameCanvas.width,H=gameCanvas.height
  gameCtx.fillStyle='#050505'
  gameCtx.fillRect(0,0,W,H)

  gameCtx.strokeStyle='rgba(255,101,0,0.05)'
  gameCtx.lineWidth=0.5
  for(let i=0;i<=tileCount;i++){
    gameCtx.beginPath();gameCtx.moveTo(i*gridSize,0);gameCtx.lineTo(i*gridSize,H);gameCtx.stroke()
    gameCtx.beginPath();gameCtx.moveTo(0,i*gridSize);gameCtx.lineTo(W,i*gridSize);gameCtx.stroke()
  }

  snake.forEach((seg,idx)=>{
    const x=seg.x*gridSize,y=seg.y*gridSize
    if(idx===0){
      gameCtx.shadowBlur=16
      gameCtx.shadowColor='#ff6500'
      gameCtx.fillStyle='#ff6500'
    }else{
      const t=idx/snake.length
      gameCtx.fillStyle='rgb('+Math.round(255-t*60)+','+Math.round(101-t*40)+',0)'
      gameCtx.shadowBlur=0
    }
    gameCtx.beginPath()
    if(gameCtx.roundRect) gameCtx.roundRect(x+1,y+1,gridSize-2,gridSize-2,idx===0?6:4)
    else gameCtx.rect(x+1,y+1,gridSize-2,gridSize-2)
    gameCtx.fill()
  })
  gameCtx.shadowBlur=0

  if(snake.length){
    const h=snake[0]
    const hx=h.x*gridSize,hy=h.y*gridSize
    gameCtx.fillStyle='#fff'
    const eye=(cx,cy)=>{gameCtx.beginPath();gameCtx.arc(cx,cy,2.2,0,Math.PI*2);gameCtx.fill()}
    if(direction.x===1){eye(hx+14,hy+6);eye(hx+14,hy+14)}
    else if(direction.x===-1){eye(hx+6,hy+6);eye(hx+6,hy+14)}
    else if(direction.y===-1){eye(hx+6,hy+6);eye(hx+14,hy+6)}
    else{eye(hx+6,hy+14);eye(hx+14,hy+14)}
  }

  gameCtx.shadowBlur=18
  gameCtx.shadowColor='#ffaa00'
  gameCtx.fillStyle='#ffaa00'
  gameCtx.beginPath()
  gameCtx.arc(food.x*gridSize+gridSize/2,food.y*gridSize+gridSize/2,gridSize/2-3,0,Math.PI*2)
  gameCtx.fill()
  gameCtx.shadowBlur=0
}
function snakeGameOver(){
  stopSnake()
  drawSnake()
  const W=gameCanvas.width,H=gameCanvas.height
  gameCtx.fillStyle='rgba(0,0,0,0.72)'
  gameCtx.fillRect(0,0,W,H)
  gameCtx.fillStyle='#ff6500'
  gameCtx.font='900 30px Montserrat,sans-serif'
  gameCtx.textAlign='center'
  gameCtx.fillText('GAME OVER',W/2,H/2-18)
  gameCtx.fillStyle='#ffaa00'
  gameCtx.font='900 18px Montserrat,sans-serif'
  gameCtx.fillText('Score: '+score,W/2,H/2+16)
  gameCtx.fillStyle='#666'
  gameCtx.font='12px Montserrat,sans-serif'
  gameCtx.fillText('Press Start to play again',W/2,H/2+50)
}

function initTetris(){
  if(!tetrisCanvas){
    tetrisCanvas=$('tetris-canvas')
    tetrisCtx=tetrisCanvas.getContext('2d')
    tetrisCanvas.width=TC*TS
    tetrisCanvas.height=TR*TS
  }
  resetTetris()
}
function resetTetris(){
  tetrisBoard=Array.from({length:TR},()=>Array(TC).fill(0))
  tetrisScore=0
  tetrisLines=0
  tetrisLevel=Math.max(1,gameCheats.tetris?.startLevel??1)
  $('tetris-score').textContent='0'
  $('tetris-lines').textContent='0'
  $('tetris-level').textContent=String(tetrisLevel)
  tetrisBest=gameCheats.tetris?.highScore||0
  $('tetris-best').textContent=String(tetrisBest)
  tetrisPiece=makePiece()
  drawTetris()
}
function makePiece(){
  const t=Math.floor(Math.random()*7)+1
  const s=T_SHAPES[t]
  return{type:t,shape:s.map(r=>[...r]),x:Math.floor(TC/2)-Math.floor(s[0].length/2),y:0}
}
function tCollide(){
  for(let r=0;r<tetrisPiece.shape.length;r++){
    for(let c=0;c<tetrisPiece.shape[r].length;c++){
      if(!tetrisPiece.shape[r][c]) continue
      const nx=tetrisPiece.x+c
      const ny=tetrisPiece.y+r
      if(nx<0||nx>=TC||ny>=TR) return true
      if(ny>=0&&tetrisBoard[ny][nx]) return true
    }
  }
  return false
}
function tMove(dx,dy){
  tetrisPiece.x+=dx
  tetrisPiece.y+=dy
  if(tCollide()){
    tetrisPiece.x-=dx
    tetrisPiece.y-=dy
    if(dy>0) tLock()
  }
  drawTetris()
}
function tRotate(){
  const orig=tetrisPiece.shape
  tetrisPiece.shape=tetrisPiece.shape[0].map((_,ci)=>tetrisPiece.shape.map(row=>row[ci]).reverse())
  if(tCollide()) tetrisPiece.shape=orig
  drawTetris()
}
function tHardDrop(){
  while(!tCollide()) tetrisPiece.y++
  tetrisPiece.y--
  tLock()
}
function tLock(){
  for(let r=0;r<tetrisPiece.shape.length;r++){
    for(let c=0;c<tetrisPiece.shape[r].length;c++){
      if(!tetrisPiece.shape[r][c]) continue
      const ny=tetrisPiece.y+r
      if(ny<0){
        if(gameCheats.tetris?.noGameOver){
          resetTetris()
          tetrisRunning=true
          requestAnimationFrame(tLoop)
          return
        }
        tGameOver()
        return
      }
      tetrisBoard[ny][tetrisPiece.x+c]=tetrisPiece.type
    }
  }
  tClearLines()
  tetrisPiece=makePiece()
  if(tCollide()){
    if(gameCheats.tetris?.noGameOver){
      resetTetris()
      tetrisRunning=true
      requestAnimationFrame(tLoop)
      return
    }
    tGameOver()
  }
}
function tClearLines(){
  let cleared=0
  for(let r=TR-1;r>=0;r--){
    if(tetrisBoard[r].every(c=>c!==0)){
      tetrisBoard.splice(r,1)
      tetrisBoard.unshift(Array(TC).fill(0))
      cleared++
      r++
    }
  }
  if(cleared){
    tetrisScore+=[0,100,300,500,800][cleared]*tetrisLevel
    tetrisLines+=cleared
    tetrisLevel=Math.max(tetrisLevel,Math.floor(tetrisLines/10)+1)
    $('tetris-score').textContent=String(tetrisScore)
    $('tetris-lines').textContent=String(tetrisLines)
    $('tetris-level').textContent=String(tetrisLevel)
    if(tetrisScore>(gameCheats.tetris?.highScore||0)){
      gameCheats.tetris.highScore=tetrisScore
      $('tetris-best').textContent=String(tetrisScore)
      saveSettingsDebounced()
    }
  }
}
function drawTCell(col,row,color){
  const x=col*TS,y=row*TS
  tetrisCtx.shadowBlur=7
  tetrisCtx.shadowColor=color
  tetrisCtx.fillStyle=color
  tetrisCtx.fillRect(x+1,y+1,TS-2,TS-2)
  tetrisCtx.shadowBlur=0
  tetrisCtx.fillStyle='rgba(255,255,255,0.14)'
  tetrisCtx.fillRect(x+2,y+2,TS-8,3)
}
function drawTetris(){
  const W=tetrisCanvas.width,H=tetrisCanvas.height
  tetrisCtx.fillStyle='#050505'
  tetrisCtx.fillRect(0,0,W,H)

  tetrisCtx.strokeStyle='rgba(255,101,0,0.05)'
  tetrisCtx.lineWidth=0.5
  for(let r=0;r<=TR;r++){tetrisCtx.beginPath();tetrisCtx.moveTo(0,r*TS);tetrisCtx.lineTo(W,r*TS);tetrisCtx.stroke()}
  for(let c=0;c<=TC;c++){tetrisCtx.beginPath();tetrisCtx.moveTo(c*TS,0);tetrisCtx.lineTo(c*TS,H);tetrisCtx.stroke()}

  for(let r=0;r<TR;r++){
    for(let c=0;c<TC;c++){
      if(tetrisBoard[r][c]) drawTCell(c,r,T_COLORS[tetrisBoard[r][c]])
    }
  }

  if(!tetrisPiece) return

  let gy=tetrisPiece.y
  while(true){
    tetrisPiece.y++
    if(tCollide()){tetrisPiece.y--;break}
  }
  const savedY=tetrisPiece.y
  tetrisPiece.y=gy

  for(let r=0;r<tetrisPiece.shape.length;r++){
    for(let c=0;c<tetrisPiece.shape[r].length;c++){
      if(!tetrisPiece.shape[r][c]) continue
      tetrisCtx.strokeStyle=T_COLORS[tetrisPiece.type]+'44'
      tetrisCtx.lineWidth=1
      tetrisCtx.strokeRect((tetrisPiece.x+c)*TS+1,(savedY+r)*TS+1,TS-2,TS-2)
    }
  }

  for(let r=0;r<tetrisPiece.shape.length;r++){
    for(let c=0;c<tetrisPiece.shape[r].length;c++){
      if(tetrisPiece.shape[r][c]) drawTCell(tetrisPiece.x+c,tetrisPiece.y+r,T_COLORS[tetrisPiece.type])
    }
  }
}
function startTetris(){
  if(tetrisRunning) return
  resetTetris()
  tetrisRunning=true
  tetrisDropCounter=0
  tetrisLastTime=0
  requestAnimationFrame(tLoop)
}
function stopTetris(){tetrisRunning=false}
function tLoop(time=0){
  if(!tetrisRunning) return
  const delta=time-tetrisLastTime
  tetrisLastTime=time
  tetrisDropCounter+=delta
  const speed=Math.max(80,700-(tetrisLevel-1)*60)
  if(tetrisDropCounter>=speed){
    tMove(0,1)
    tetrisDropCounter=0
  }
  drawTetris()
  requestAnimationFrame(tLoop)
}
function tGameOver(){
  tetrisRunning=false
  drawTetris()
  const W=tetrisCanvas.width,H=tetrisCanvas.height
  tetrisCtx.fillStyle='rgba(0,0,0,0.74)'
  tetrisCtx.fillRect(0,0,W,H)
  tetrisCtx.fillStyle='#ff6500'
  tetrisCtx.font='900 22px Montserrat,sans-serif'
  tetrisCtx.textAlign='center'
  tetrisCtx.fillText('GAME OVER',W/2,H/2-18)
  tetrisCtx.fillStyle='#ffaa00'
  tetrisCtx.font='900 15px Montserrat,sans-serif'
  tetrisCtx.fillText('Score: '+tetrisScore,W/2,H/2+14)
  tetrisCtx.fillStyle='#666'
  tetrisCtx.font='11px Montserrat,sans-serif'
  tetrisCtx.fillText('Press Start again',W/2,H/2+42)
}

function handleGameKey(e){
  if(!gameOpen) return
  const key=e.key
  if(key==='Escape'){closeGame();return}
  if($('snake-section').style.display!=='none'){
    if(!gameRunning) return
    const k=key.toLowerCase()
    if((k==='arrowup'||k==='w')&&direction.y===0) direction={x:0,y:-1}
    else if((k==='arrowdown'||k==='s')&&direction.y===0) direction={x:0,y:1}
    else if((k==='arrowleft'||k==='a')&&direction.x===0) direction={x:-1,y:0}
    else if((k==='arrowright'||k==='d')&&direction.x===0) direction={x:1,y:0}
  }else{
    if(!tetrisRunning) return
    if(key==='ArrowLeft') tMove(-1,0)
    else if(key==='ArrowRight') tMove(1,0)
    else if(key==='ArrowDown') tMove(0,1)
    else if(key==='ArrowUp') tRotate()
    else if(key===' '){tHardDrop();e.preventDefault()}
  }
}

function initGraph(){
  graphCanvas=$('graph-canvas')
  graphCtx=graphCanvas.getContext('2d')
  graphCanvas.addEventListener('mousedown',gDown)
  graphCanvas.addEventListener('mousemove',gMove)
  graphCanvas.addEventListener('mouseup',gUp)
  graphCanvas.addEventListener('wheel',gWheel,{passive:false})
  graphCanvas.addEventListener('contextmenu',e=>e.preventDefault())
  graphCanvas.addEventListener('touchstart',e=>{if(e.touches.length===1){const t=e.touches[0];gDown({clientX:t.clientX,clientY:t.clientY,button:0,preventDefault:()=>{}})}},{passive:false})
  graphCanvas.addEventListener('touchmove',e=>{if(e.touches.length===1){const t=e.touches[0];gMove({clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{}})}},{passive:false})
  graphCanvas.addEventListener('touchend',e=>{gUp({preventDefault:()=>{}})},{passive:false})
  window.addEventListener('resize',resizeGraph)
  resizeGraph()
}
function resizeGraph(){
  if(!graphCanvas) return
  graphCanvas.width=graphCanvas.offsetWidth
  graphCanvas.height=graphCanvas.offsetHeight
}
function buildGraph(){
  const W=graphCanvas.width,H=graphCanvas.height
  const centerX=W/2,centerY=H/2
  graphNodes=notes.map((n,i)=>{
    const angle=(i/Math.max(1,notes.length))*Math.PI*2
    const radius=Math.min(W,H)*0.25
    return{
      id:n.id,
      label:(n.title&&n.title.trim()?n.title:'Untitled'),
      x:centerX+Math.cos(angle)*radius,
      y:centerY+Math.sin(angle)*radius,
      vx:0,vy:0,
      isActive:n.id===activeId
    }
  })
  graphLinks=[]
  links.forEach(l=>{graphLinks.push({source:l.note_a,target:l.note_b})})
  graphView={x:0,y:0,scale:1}
}
function screenToWorld(sx,sy){
  const cx=graphCanvas.width/2
  const cy=graphCanvas.height/2
  return{
    x:(sx-cx-graphView.x)/graphView.scale,
    y:(sy-cy-graphView.y)/graphView.scale
  }
}
function worldToScreen(wx,wy){
  const cx=graphCanvas.width/2
  const cy=graphCanvas.height/2
  return{
    x:cx+graphView.x+wx*graphView.scale,
    y:cy+graphView.y+wy*graphView.scale
  }
}
function renderGraph(){
  graphCtx.clearRect(0,0,graphCanvas.width,graphCanvas.height)
  graphCtx.save()
  graphCtx.translate(graphCanvas.width/2+graphView.x,graphCanvas.height/2+graphView.y)
  graphCtx.scale(graphView.scale,graphView.scale)

  graphCtx.strokeStyle='rgba(255,101,0,0.25)'
  graphCtx.lineWidth=2/graphView.scale
  graphLinks.forEach(l=>{
    const s=graphNodes.find(n=>n.id===l.source)
    const t=graphNodes.find(n=>n.id===l.target)
    if(!s||!t) return
    graphCtx.beginPath()
    graphCtx.moveTo(s.x-graphCanvas.width/2,s.y-graphCanvas.height/2)
    graphCtx.lineTo(t.x-graphCanvas.width/2,t.y-graphCanvas.height/2)
    graphCtx.stroke()
  })

  graphNodes.forEach(node=>{
    const isLinked=graphLinks.some(l=>(l.source===activeId&&l.target===node.id)||(l.target===activeId&&l.source===node.id))
    const r=22
    graphCtx.beginPath()
    graphCtx.arc(node.x-graphCanvas.width/2,node.y-graphCanvas.height/2,r,0,Math.PI*2)
    graphCtx.fillStyle=node.isActive?'#ff6500':(isLinked?'#22c55e':'#3a3a3a')
    graphCtx.fill()
    graphCtx.strokeStyle='#1a1a1a'
    graphCtx.lineWidth=2/graphView.scale
    graphCtx.stroke()
    if(node.isActive||isLinked){
      graphCtx.shadowBlur=18/graphView.scale
      graphCtx.shadowColor=node.isActive?'#ff6500':'#22c55e'
      graphCtx.beginPath()
      graphCtx.arc(node.x-graphCanvas.width/2,node.y-graphCanvas.height/2,r,0,Math.PI*2)
      graphCtx.stroke()
      graphCtx.shadowBlur=0
    }
    graphCtx.fillStyle='#f5f5f5'
    graphCtx.font=(900/graphView.scale)+'px Montserrat,sans-serif'
    graphCtx.textAlign='center'
    const label=node.label.length>16?node.label.slice(0,16)+'‚Ä¶':node.label
    graphCtx.fillText(label,node.x-graphCanvas.width/2,node.y-graphCanvas.height/2+44)
  })

  graphCtx.restore()
}
function startPhysics(){
  if(graphAnim) cancelAnimationFrame(graphAnim)
  const step=()=>{
    if(!graphPhysicsEnabled){graphAnim=requestAnimationFrame(step);renderGraph();return}
    graphNodes.forEach(node=>{
      let fx=0,fy=0
      graphNodes.forEach(other=>{
        if(node===other) return
        const dx=(node.x-other.x)
        const dy=(node.y-other.y)
        const d=Math.sqrt(dx*dx+dy*dy)||1
        const f=120/(d*d)
        fx+=(dx/d)*f
        fy+=(dy/d)*f
      })
      graphLinks.forEach(l=>{
        if(l.source===node.id||l.target===node.id){
          const oid=(l.source===node.id?l.target:l.source)
          const o=graphNodes.find(n=>n.id===oid)
          if(!o) return
          fx+=(o.x-node.x)*0.01
          fy+=(o.y-node.y)*0.01
        }
      })
      const cx=graphCanvas.width/2
      const cy=graphCanvas.height/2
      fx+=(cx-node.x)*0.001
      fy+=(cy-node.y)*0.001
      node.vx=(node.vx+fx)*0.9
      node.vy=(node.vy+fy)*0.9
      node.x+=node.vx
      node.y+=node.vy
      node.x=clamp(node.x,50,graphCanvas.width-50)
      node.y=clamp(node.y,50,graphCanvas.height-50)
    })
    renderGraph()
    graphAnim=requestAnimationFrame(step)
  }
  step()
}
function drawGraph(){
  resizeGraph()
  buildGraph()
  renderGraph()
  startPhysics()
}
function hitNode(wx,wy){
  for(const node of graphNodes){
    const dx=(node.x-graphCanvas.width/2)-wx
    const dy=(node.y-graphCanvas.height/2)-wy
    if(Math.sqrt(dx*dx+dy*dy)<22) return node
  }
  return null
}
function gDown(e){
  e.preventDefault?.()
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const w=screenToWorld(sx,sy)
  const node=hitNode(w.x,w.y)
  if(e.button===2){
    graphPan=true
    graphPanStart={sx,sy,ox:graphView.x,oy:graphView.y}
    return
  }
  if(node){
    graphDragNode=node
    graphDragging=true
    graphPhysicsEnabled=false
  }else{
    graphPan=true
    graphPanStart={sx,sy,ox:graphView.x,oy:graphView.y}
  }
}
function gMove(e){
  if(!graphDragging && !graphPan) return
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  if(graphDragging && graphDragNode){
    const w=screenToWorld(sx,sy)
    graphDragNode.x=graphCanvas.width/2+w.x
    graphDragNode.y=graphCanvas.height/2+w.y
    renderGraph()
  }else if(graphPan && graphPanStart){
    graphView.x=graphPanStart.ox+(sx-graphPanStart.sx)
    graphView.y=graphPanStart.oy+(sy-graphPanStart.sy)
    renderGraph()
  }
}
function gUp(e){
  e.preventDefault?.()
  if(graphDragging && graphDragNode){
    graphDragging=false
    const id=graphDragNode.id
    graphDragNode=null
    graphPhysicsEnabled=true
    renderGraph()
    return
  }
  if(graphPan){
    graphPan=false
    graphPanStart=null
    renderGraph()
  }
}
function gWheel(e){
  e.preventDefault()
  const rect=graphCanvas.getBoundingClientRect()
  const sx=e.clientX-rect.left
  const sy=e.clientY-rect.top
  const before=screenToWorld(sx,sy)
  const delta=Math.sign(e.deltaY)
  const factor=delta>0?0.92:1.08
  graphView.scale=clamp(graphView.scale*factor,0.45,2.6)
  const after=screenToWorld(sx,sy)
  graphView.x+=(after.x-before.x)*graphView.scale
  graphView.y+=(after.y-before.y)*graphView.scale
  renderGraph()
}

function openAuthUI(){
  $('auth-overlay').style.display='flex'
}
function closeAuthUI(){
  $('auth-overlay').style.display='none'
}

async function signOut(){
  await supabase.auth.signOut()
  location.reload()
}

function wireUI(){
  $('mobile-menu-btn').onclick=toggleMobileMenu
  $('mobile-overlay').onclick=toggleMobileMenu
  $('sidebar-toggle').onclick=toggleSidebar

  $('new-note').onclick=createNote
  $('mini-new').onclick=createNote
  $('mini-game').onclick=openGame
  $('mini-timer').onclick=startTimer
  $('mini-out').onclick=signOut

  $('tab-write').onclick=()=>switchTab('write')
  $('tab-read').onclick=()=>switchTab('read')
  $('tab-graph').onclick=()=>switchTab('graph')

  $('btn-save').onclick=saveNote
  $('btn-delete').onclick=deleteNote
  $('btn-export').onclick=openPDFModal
  $('btn-full').onclick=togglePreviewFull
  $('btn-settings').onclick=openSettings

  $('pdf-cancel').onclick=closePDFModal
  $('pdf-export').onclick=exportPDF

  $('settings-cancel').onclick=closeSettings
  $('settings-save').onclick=saveSettingsFromModal

  $('search-box').oninput=()=>renderList($('search-box').value)

  $('sort-notes').onchange=()=>{
    uiPrefs.sort=$('sort-notes').value
    saveSettingsDebounced()
    renderList($('search-box').value)
  }

  $('open-palette').onclick=openPalette

  $('title-in').oninput=()=>{handleAutoSave()}
  $('body-in').oninput=()=>{handleAutoSave();refreshLinkUI()}
  $('note-grade').onchange=()=>{handleAutoSave();refreshLinkUI()}

  $('link-search').onfocus=showLinkDropdown
  $('link-search').onblur=hideLinkDropdown
  $('link-search').oninput=searchForLinks

  $('unlink-all').onclick=unlinkAll
  $('open-preview').onclick=()=>switchTab('read')
  $('preview-open-write').onclick=()=>switchTab('write')
  $('link-all-mentions').onclick=linkAllMentions

  $('school-badge').onclick=()=>{
    currentSchool=(currentSchool==='Salesianum')?'St Peter Cathedral':'Salesianum'
    $('school-badge').textContent=currentSchool
    saveSettingsDebounced()
    handleAutoSave()
    toast('School',currentSchool,'ok')
  }

  $('timer-start').onclick=startTimer
  $('timer-pause').onclick=pauseTimer
  $('timer-reset').onclick=resetTimer
  $('timer-focus').onclick=()=>{setTimer(timerPresets.focus||25)}
  $('timer-break').onclick=()=>{setTimer(timerPresets.break||5)}
  $('timer-long').onclick=()=>{setTimer(timerPresets.long||15)}
  $('timer-break-game').onclick=()=>{setTimer(timerPresets.break||5);openGame()}

  $('snake-start').onclick=startSnake
  $('tetris-start').onclick=startTetris
  $('game-close').onclick=closeGame
  $('game-close-2').onclick=closeGame
  $('gtab-snake').onclick=()=>switchGame('snake')
  $('gtab-tetris').onclick=()=>switchGame('tetris')
  $('cheats-toggle').onclick=toggleCheats
  $('cheats-toggle-2').onclick=toggleCheats

  $('cheat-snake-nodie').onchange=()=>{
    gameCheats.snake.noDie=$('cheat-snake-nodie').checked
    saveSettingsDebounced()
    toast('Cheat','Snake No-Die '+(gameCheats.snake.noDie?'ON':'OFF'),'warn')
  }
  $('cheat-snake-speed').oninput=()=>{
    const v=parseInt($('cheat-snake-speed').value,10)
    gameCheats.snake.speed=v
    $('cheat-snake-speed-val').textContent=v+'ms'
    saveSettingsDebounced()
    if(gameRunning){
      clearInterval(gameInterval)
      gameInterval=setInterval(updateSnake,v)
    }
  }
  $('cheat-tetris-nogameover').onchange=()=>{
    gameCheats.tetris.noGameOver=$('cheat-tetris-nogameover').checked
    saveSettingsDebounced()
    toast('Cheat','Tetris No Game Over '+(gameCheats.tetris.noGameOver?'ON':'OFF'),'warn')
  }
  $('cheat-tetris-level').onchange=()=>{
    const v=clamp(parseInt($('cheat-tetris-level').value||1,10),1,20)
    gameCheats.tetris.startLevel=v
    $('cheat-tetris-level').value=v
    saveSettingsDebounced()
    toast('Cheat','Tetris Start Level '+v,'warn')
  }

  $('graph-reset').onclick=()=>{buildGraph();renderGraph()}
  $('graph-physics').onclick=()=>{
    graphPhysicsEnabled=!graphPhysicsEnabled
    toast('Graph','Physics '+(graphPhysicsEnabled?'ON':'OFF'),'warn')
  }
  $('graph-center').onclick=()=>{
    graphView.x=0
    graphView.y=0
    graphView.scale=1
    renderGraph()
  }

  $('palette').onclick=e=>{if(e.target.id==='palette') closePalette()}
  $('palette-q').oninput=()=>renderPalette($('palette-q').value)
  $('palette-q').onkeydown=e=>{
    if(e.key==='Escape'){closePalette();return}
    if(e.key==='Enter'){
      const first=$('palette-list').querySelector('.palette-item')
      if(first){first.click()}
    }
  }

  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      if(document.body.classList.contains('preview-full')) togglePreviewFull()
      if($('pdf-modal').style.display==='flex') closePDFModal()
      if($('settings-modal').style.display==='flex') closeSettings()
      if($('palette').style.display==='flex') closePalette()
      return
    }
    const k=e.key.toLowerCase()
    if((e.ctrlKey||e.metaKey) && k==='k'){
      e.preventDefault()
      openPalette()
    }
  })

  document.addEventListener('keydown',handleGameKey)

  document.addEventListener('mousedown',e=>{
    if(window.innerWidth<=1024) return
    if($('sidebar').classList.contains('mobile-open')) toggleMobileMenu()
  })
}

function wireAuth(){
  $('auth-msg').onclick=()=>{
    isSignUp=!isSignUp
    $('auth-msg').innerText=isSignUp?'Have account? Sign In':'Switch to Sign Up'
    $('auth-btn').innerText=isSignUp?'Create Account':'Enter System'
    $('auth-err').textContent=''
  }
  $('auth-btn').onclick=async ()=>{
    const email=$('email').value
    const pass=$('password').value
    if(!email||!pass){$('auth-err').textContent='Enter email + password';return}
    if(isSignUp){
      const {error}=await supabase.auth.signUp({email:email,password:pass})
      if(error){$('auth-err').textContent=error.message;return}
      toast('Check email','Confirm your account, then sign in','ok')
    }else{
      const {error}=await supabase.auth.signInWithPassword({email:email,password:pass})
      if(error){$('auth-err').textContent=error.message;return}
      location.reload()
    }
  }
}

async function boot(){
  wireUI()
  wireAuth()
  initGraph()
  updateTimerDisplay()

  const {data}=await supabase.auth.getSession()
  if(data?.session){
    user=data.session.user
    closeAuthUI()
    await loadSettings()
    await fetchNotes()
  }else{
    openAuthUI()
  }

  supabase.auth.onAuthStateChange(async (ev,session)=>{
    if(session){
      user=session.user
      closeAuthUI()
      await loadSettings()
      await fetchNotes()
    }else{
      openAuthUI()
    }
  })
}

boot()
</script>

</body>
</html>

