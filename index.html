<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyOS | Kenneth's Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module" src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

    :root {
        --bg: #0d0d0d;
        --sidebar: #161616;
        --border: #2a2a2a;
        --surface: #1e1e1e;
        --surface-hover: #282828;
        --text-main: #f8f8f8;
        --text-muted: #999999;
        --brand: #6366f1;
        --brand-hover: #4f46e5;
        --brand-light: #818cf8;
        --accent: #22d3ee;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --mono: 'JetBrains Mono', 'Courier New', monospace;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
    body { 
        background: var(--bg); 
        color: var(--text-main); 
        font-family: var(--font); 
        height: 100vh; 
        display: flex; 
        overflow: hidden; 
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* --- SIDEBAR --- */
    aside { 
        width: 320px; 
        background: var(--sidebar); 
        border-right: 1px solid var(--border); 
        display: flex; 
        flex-direction: column;
        box-shadow: 2px 0 12px rgba(0,0,0,0.3);
    }

    .sidebar-header { 
        padding: 24px 20px 20px 20px; 
        border-bottom: 1px solid var(--border);
        background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.05));
    }

    .brand-area { 
        display: flex; 
        align-items: center; 
        gap: 14px; 
        margin-bottom: 20px;
    }

    .logo { 
        width: 44px; 
        height: 44px; 
        background: linear-gradient(135deg, var(--brand), var(--accent)); 
        border-radius: 12px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-weight: 800; 
        color: #fff;
        font-size: 22px;
        box-shadow: var(--shadow);
        letter-spacing: -1px;
    }

    .brand-info { flex: 1; }
    .brand-text { 
        font-weight: 800; 
        font-size: 22px; 
        letter-spacing: -0.5px;
        background: linear-gradient(135deg, var(--brand-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .author-tag { 
        font-size: 11px; 
        color: var(--text-muted); 
        font-weight: 500;
        margin-top: 2px;
        letter-spacing: 0.3px;
    }
    
    .school-badge {
        display: inline-block;
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        color: var(--brand);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 8px;
    }

    .search-box { 
        width: 100%; 
        background: var(--surface); 
        border: 1px solid var(--border); 
        color: white; 
        padding: 10px 14px; 
        border-radius: 10px; 
        margin-bottom: 12px; 
        transition: all 0.2s;
        font-size: 13px;
    }
    .search-box:focus { 
        border-color: var(--brand); 
        box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .search-box::placeholder { color: var(--text-muted); }

    /* Grade Divisions */
    .grade-section {
        margin: 8px 0;
    }
    
    .grade-header {
        padding: 10px 12px;
        background: var(--surface);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s;
        border: 1px solid var(--border);
        margin-bottom: 6px;
    }
    
    .grade-header:hover {
        background: var(--surface-hover);
        border-color: var(--brand);
    }
    
    .grade-header.active {
        background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(34,211,238,0.1));
        border-color: var(--brand);
    }
    
    .grade-title {
        font-weight: 600;
        font-size: 13px;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .grade-count {
        background: var(--brand);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
    }
    
    .grade-arrow {
        color: var(--text-muted);
        transition: transform 0.3s;
        font-size: 12px;
    }
    
    .grade-header.active .grade-arrow {
        transform: rotate(90deg);
    }
    
    .grade-notes {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .grade-notes.expanded {
        max-height: 500px;
    }
    
    .nav-list { 
        flex: 1; 
        overflow-y: auto; 
        padding: 12px; 
        display: flex; 
        flex-direction: column; 
        gap: 2px;
    }

    .nav-item { 
        padding: 11px 14px; 
        border-radius: 10px; 
        cursor: pointer; 
        color: var(--text-muted); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        transition: all 0.2s; 
        position: relative;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid transparent;
    }
    
    .nav-item:hover { 
        background: var(--surface-hover); 
        color: var(--text-main); 
        transform: translateX(4px);
        border-color: var(--border);
    }
    
    .nav-item.active { 
        background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(34,211,238,0.15));
        color: var(--text-main); 
        font-weight: 600;
        border-color: var(--brand);
        box-shadow: var(--shadow);
    }

    .flashcard-indicator { 
        width: 9px; 
        height: 9px; 
        border-radius: 50%; 
        background: var(--success); 
        display: none; 
        animation: pulse 2s infinite;
        box-shadow: 0 0 8px var(--success);
    }
    .nav-item.due .flashcard-indicator { display: block; }
    
    @keyframes pulse { 
        0%, 100% { opacity: 1; transform: scale(1); } 
        50% { opacity: 0.6; transform: scale(1.2); } 
    }
    
    .linked-indicator { 
        font-size: 11px; 
        color: var(--accent); 
        margin-left: 6px;
    }

    /* Stats Widget */
    .stats-widget { 
        padding: 16px; 
        border-top: 1px solid var(--border); 
        background: linear-gradient(180deg, var(--sidebar), var(--surface));
    }
    
    .stats-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 10px; 
        margin-bottom: 12px;
    }
    
    .stat-card { 
        background: var(--bg); 
        padding: 12px; 
        border-radius: 10px; 
        border: 1px solid var(--border);
        transition: all 0.2s;
    }
    
    .stat-card:hover {
        border-color: var(--brand);
        transform: translateY(-2px);
    }
    
    .stat-value { 
        font-size: 24px; 
        font-weight: 800; 
        background: linear-gradient(135deg, var(--brand-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-family: var(--mono);
    }
    
    .stat-label { 
        font-size: 10px; 
        color: var(--text-muted); 
        text-transform: uppercase; 
        letter-spacing: 0.8px; 
        margin-top: 4px;
        font-weight: 600;
    }

    /* Pomodoro Widget */
    .pomodoro-box { 
        padding: 18px; 
        border-top: 1px solid var(--border); 
        background: var(--surface);
    }
    
    .timer-display { 
        font-family: var(--mono); 
        font-size: 34px; 
        font-weight: 800; 
        margin-bottom: 14px; 
        letter-spacing: 3px; 
        background: linear-gradient(135deg, var(--brand-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
    }
    
    .timer-controls { 
        display: flex; 
        gap: 8px; 
        justify-content: center;
        margin-bottom: 10px;
    }
    
    .timer-mode { 
        display: flex; 
        gap: 6px; 
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .timer-mode span { 
        cursor: pointer; 
        padding: 6px 12px; 
        border-radius: 8px; 
        transition: all 0.2s;
        font-size: 11px;
        font-weight: 600;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text-muted);
    }
    
    .timer-mode span:hover { 
        background: var(--brand); 
        color: white;
        border-color: var(--brand);
        transform: translateY(-2px);
    }
    
    /* Main Area */
    main { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        background: var(--bg); 
        position: relative;
    }
    
    .top-bar { 
        height: 64px; 
        border-bottom: 1px solid var(--border); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 0 32px;
        background: linear-gradient(180deg, var(--sidebar), var(--bg));
        backdrop-filter: blur(10px);
    }
    
    .tabs { 
        display: flex; 
        gap: 8px; 
        height: 100%;
        align-items: center;
    }
    
    .tab { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        cursor: pointer; 
        color: var(--text-muted); 
        padding: 10px 18px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .tab:hover { 
        color: var(--text-main);
        background: var(--surface);
        border-color: var(--border);
    }
    
    .tab.active { 
        color: white;
        background: linear-gradient(135deg, var(--brand), var(--brand-hover));
        border-color: var(--brand);
        box-shadow: var(--shadow);
    }
    
    .tab-icon { font-size: 16px; }
    
    .actions { 
        display: flex; 
        gap: 10px; 
        align-items: center;
    }
    
    button { 
        background: var(--surface); 
        border: 1px solid var(--border); 
        color: var(--text-main); 
        padding: 9px 18px; 
        border-radius: 10px; 
        cursor: pointer; 
        font-size: 13px; 
        transition: all 0.2s; 
        font-weight: 600;
        font-family: var(--font);
    }
    
    button:hover { 
        background: var(--surface-hover); 
        border-color: var(--brand); 
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    button:active { 
        transform: translateY(0);
    }
    
    button.primary { 
        background: linear-gradient(135deg, var(--brand), var(--brand-hover));
        border: none; 
        color: white;
        box-shadow: var(--shadow);
    }
    
    button.primary:hover { 
        background: linear-gradient(135deg, var(--brand-hover), var(--brand));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    button.danger:hover { 
        background: var(--danger);
        color: white; 
        border-color: var(--danger);
    }
    
    button.sm { 
        padding: 7px 14px; 
        font-size: 12px;
    }

    /* Editor & Preview */
    .content-area { 
        flex: 1; 
        position: relative; 
        overflow: hidden;
    }
    
    .editor-pane, .preview-pane, .flashcard-pane, .graph-pane { 
        position: absolute; 
        inset: 0; 
        padding: 48px 56px; 
        overflow-y: auto; 
        background: var(--bg); 
        display: none;
    }
    
    .editor-pane.active, .preview-pane.active, .flashcard-pane.active, .graph-pane.active { 
        display: block;
    }
    
    input.title-input { 
        background: transparent; 
        border: none; 
        color: var(--text-main); 
        font-size: 36px; 
        font-weight: 800; 
        margin-bottom: 28px; 
        width: 100%; 
        font-family: var(--font);
        letter-spacing: -1px;
    }
    
    input.title-input::placeholder {
        color: var(--text-muted);
        opacity: 0.5;
    }
    
    .grade-selector {
        margin-bottom: 24px;
    }
    
    .grade-selector label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    select.grade-dropdown {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        width: 200px;
        font-family: var(--font);
    }
    
    select.grade-dropdown:hover {
        border-color: var(--brand);
    }
    
    select.grade-dropdown:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    
    textarea.body-input { 
        width: 100%; 
        height: calc(100% - 180px); 
        background: var(--surface); 
        border: 1px solid var(--border); 
        color: #e8e8e8; 
        font-size: 15px; 
        line-height: 1.8; 
        resize: none; 
        font-family: var(--mono); 
        padding: 24px; 
        border-radius: 12px;
        transition: border-color 0.2s;
    }
    
    textarea.body-input:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    
    textarea.body-input::placeholder {
        color: var(--text-muted);
        opacity: 0.6;
    }
    
    /* Link Input */
    .link-input-container { 
        margin-bottom: 20px; 
        display: flex; 
        gap: 10px;
        position: relative;
    }
    
    .link-input { 
        flex: 1; 
        background: var(--surface); 
        border: 1px solid var(--border); 
        color: white; 
        padding: 10px 14px; 
        border-radius: 10px; 
        font-size: 13px;
        transition: all 0.2s;
    }
    
    .link-input:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    
    #link-dropdown {
        position: absolute;
        top: 48px;
        left: 0;
        right: 0;
        background: var(--sidebar);
        border: 1px solid var(--border);
        border-radius: 10px;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        z-index: 100;
        box-shadow: var(--shadow-lg);
    }
    
    /* Markdown Styles */
    .preview-pane { 
        line-height: 1.9; 
        color: #e8e8e8; 
        max-width: 850px;
        font-size: 16px;
    }
    
    .preview-pane h1 { 
        border-bottom: 3px solid var(--brand); 
        padding-bottom: 16px; 
        margin-top: 0;
        margin-bottom: 32px;
        background: linear-gradient(135deg, var(--brand-light), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 42px;
        font-weight: 800;
        letter-spacing: -1px;
    }
    
    .preview-pane h2 { 
        margin-top: 3em;
        margin-bottom: 1em;
        color: var(--brand-light);
        font-size: 28px;
        font-weight: 700;
    }
    
    .preview-pane h3 {
        margin-top: 2em;
        margin-bottom: 0.8em;
        color: var(--accent);
        font-size: 22px;
        font-weight: 600;
    }
    
    .preview-pane p {
        margin-bottom: 1.5em;
    }
    
    .preview-pane code { 
        background: var(--surface); 
        padding: 3px 8px; 
        border-radius: 6px; 
        font-family: var(--mono); 
        font-size: 0.9em; 
        border: 1px solid var(--border);
        color: var(--accent);
    }
    
    .preview-pane pre { 
        background: var(--surface); 
        padding: 24px; 
        border-radius: 12px; 
        overflow-x: auto; 
        border: 1px solid var(--border);
        margin: 1.5em 0;
    }
    
    .preview-pane pre code {
        background: transparent;
        border: none;
        padding: 0;
        color: #e8e8e8;
    }
    
    .preview-pane blockquote { 
        border-left: 4px solid var(--brand); 
        margin: 1.5em 0; 
        padding: 16px 24px; 
        color: var(--text-muted); 
        background: var(--surface); 
        border-radius: 0 12px 12px 0;
        font-style: italic;
    }
    
    .preview-pane a { 
        color: var(--accent); 
        text-decoration: none; 
        border-bottom: 2px solid transparent; 
        transition: border-color 0.2s;
        font-weight: 600;
    }
    
    .preview-pane a:hover { 
        border-bottom-color: var(--accent);
    }
    
    .preview-pane ul, .preview-pane ol {
        margin: 1.5em 0;
        padding-left: 2em;
    }
    
    .preview-pane li {
        margin: 0.5em 0;
    }

    /* Flashcard Mode */
    .flashcard-container { 
        max-width: 750px; 
        margin: 80px auto; 
        text-align: center;
    }
    
    .card { 
        background: linear-gradient(135deg, var(--surface), var(--sidebar)); 
        border: 2px solid var(--border); 
        padding: 90px 60px; 
        border-radius: 20px; 
        margin-bottom: 36px; 
        min-height: 380px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 24px; 
        cursor: pointer; 
        transition: all 0.3s; 
        box-shadow: var(--shadow-lg);
        font-weight: 500;
        line-height: 1.6;
    }
    
    .card:hover { 
        border-color: var(--brand); 
        box-shadow: 0 24px 56px rgba(99,102,241,0.3);
        transform: translateY(-6px);
    }
    
    .rating-btns { 
        display: grid; 
        grid-template-columns: 1fr 1fr 1fr 1fr; 
        gap: 14px; 
        display: none;
    }
    
    .rating-btns button { 
        padding: 18px; 
        border: 2px solid var(--border); 
        font-weight: 700;
        font-size: 14px;
        border-radius: 12px;
    }
    
    .rating-btns button:hover { 
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    /* Graph View */
    .graph-pane { 
        background: var(--bg); 
        padding: 0;
    }
    
    #graph-canvas { 
        width: 100%; 
        height: 100%;
        cursor: grab;
    }
    
    #graph-canvas:active {
        cursor: grabbing;
    }
    
    .graph-controls { 
        position: absolute; 
        top: 24px; 
        right: 24px; 
        background: var(--sidebar); 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        padding: 14px; 
        display: flex; 
        gap: 10px;
        box-shadow: var(--shadow-lg);
    }
    
    .graph-legend { 
        position: absolute; 
        bottom: 24px; 
        left: 24px; 
        background: var(--sidebar); 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        padding: 16px;
        box-shadow: var(--shadow-lg);
    }
    
    .legend-item { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        margin: 8px 0; 
        font-size: 13px;
        font-weight: 500;
    }
    
    .legend-dot { 
        width: 14px; 
        height: 14px; 
        border-radius: 50%;
        box-shadow: 0 0 8px currentColor;
    }

    /* Auth */
    #auth-overlay { 
        position: fixed; 
        inset: 0; 
        background: var(--bg); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 100;
    }
    
    .auth-card { 
        width: 440px; 
        background: var(--sidebar); 
        border: 1px solid var(--border); 
        padding: 48px; 
        border-radius: 20px; 
        text-align: center; 
        box-shadow: var(--shadow-lg);
    }
    
    .input-field { 
        width: 100%; 
        background: var(--surface); 
        border: 1px solid var(--border); 
        color: white; 
        padding: 14px; 
        border-radius: 10px; 
        margin-bottom: 16px; 
        transition: all 0.2s;
        font-size: 14px;
        font-family: var(--font);
    }
    
    .input-field:focus { 
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    
    /* PDF Export Modal */
    .modal-overlay { 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.85); 
        display: none; 
        align-items: center; 
        justify-content: center; 
        z-index: 200;
        backdrop-filter: blur(4px);
    }
    
    .modal { 
        background: var(--sidebar); 
        border: 1px solid var(--border); 
        border-radius: 20px; 
        padding: 36px; 
        max-width: 540px; 
        width: 90%;
        box-shadow: var(--shadow-lg);
    }
    
    .modal h3 { 
        margin-top: 0; 
        color: var(--brand-light);
        font-size: 24px;
        font-weight: 700;
    }
    
    /* Linked Notes Display */
    .linked-notes-section { 
        margin-top: 32px; 
        padding-top: 32px; 
        border-top: 1px solid var(--border);
    }
    
    .linked-note-tag { 
        display: inline-block; 
        background: var(--surface); 
        border: 1px solid var(--accent); 
        color: var(--accent); 
        padding: 6px 14px; 
        border-radius: 20px; 
        margin: 6px; 
        font-size: 12px; 
        cursor: pointer; 
        transition: all 0.2s;
        font-weight: 600;
    }
    
    .linked-note-tag:hover { 
        background: var(--accent); 
        color: #000;
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    /* Autosave indicator */
    .autosave-indicator { 
        font-size: 12px; 
        color: var(--success); 
        display: flex; 
        align-items: center; 
        gap: 8px;
        font-weight: 600;
    }
    
    .autosave-dot { 
        width: 7px; 
        height: 7px; 
        border-radius: 50%; 
        background: var(--success); 
        animation: blink 1.5s infinite;
        box-shadow: 0 0 8px var(--success);
    }
    
    @keyframes blink { 
        0%, 100% { opacity: 1; } 
        50% { opacity: 0.3; } 
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--sidebar);
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--surface);
        border-radius: 6px;
        border: 2px solid var(--sidebar);
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--surface-hover);
    }
</style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <div style="display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 32px;">
            <div class="logo">K</div>
            <div>
                <h2 style="margin: 0; font-size: 28px; font-weight: 800;">StudyOS</h2>
                <p style="margin: 6px 0 0 0; font-size: 13px; color: var(--text-muted); font-weight: 500;">by Kenneth</p>
            </div>
        </div>
        <input type="email" id="email" class="input-field" placeholder="Email">
        <input type="password" id="password" class="input-field" placeholder="Password">
        <button class="primary" style="width:100%; padding: 14px; font-size: 15px;" onclick="handleAuth()">Enter System</button>
        <p style="font-size:13px; color:var(--text-muted); cursor:pointer; margin-top: 20px; font-weight: 500;" onclick="toggleAuth()" id="auth-msg">Switch to Sign Up</p>
        <div id="auth-err" style="color:var(--danger); font-size:13px; margin-top: 12px;"></div>
    </div>
</div>

<!-- PDF Export Modal -->
<div class="modal-overlay" id="pdf-modal">
    <div class="modal">
        <h3>üìÑ Export to PDF</h3>
        <p style="color: var(--text-muted); font-size: 14px; margin: 16px 0 24px 0;">Your note will be exported as a beautifully formatted PDF document.</p>
        <div style="margin: 24px 0;">
            <label style="display: block; margin-bottom: 10px; font-size: 14px; font-weight: 600;">
                <input type="checkbox" id="pdf-include-links" checked style="margin-right: 8px;"> Include linked notes references
            </label>
            <label style="display: block; margin: 10px 0; font-size: 14px; font-weight: 600;">
                <input type="checkbox" id="pdf-include-date" checked style="margin-right: 8px;"> Include creation date
            </label>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 32px;">
            <button style="flex: 1;" onclick="closePDFModal()">Cancel</button>
            <button class="primary" style="flex: 1;" onclick="confirmPDFExport()">Export PDF</button>
        </div>
    </div>
</div>

<aside>
    <div class="sidebar-header">
        <div class="brand-area">
            <div class="logo">K</div>
            <div class="brand-info">
                <div class="brand-text">StudyOS</div>
                <div class="author-tag">by Kenneth</div>
                <div class="school-badge" id="school-badge">Salesianum</div>
            </div>
        </div>
        <input type="text" class="search-box" id="search-box" placeholder="üîç Search notes..." onkeyup="searchNotes()">
        <button class="primary" style="width:100%; margin-top: 12px; font-weight: 700;" onclick="createNote()">+ New Note</button>
    </div>
    
    <div class="nav-list" id="list"></div>
    
    <!-- Stats Widget -->
    <div class="stats-widget">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-notes">0</div>
                <div class="stat-label">Total Notes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-reviews">0</div>
                <div class="stat-label">Reviews Due</div>
            </div>
        </div>
    </div>
    
    <div class="pomodoro-box">
        <div class="timer-display" id="timer">25:00</div>
        <div class="timer-controls">
            <button class="sm" onclick="startTimer()" style="font-size: 14px;">‚ñ∂</button>
            <button class="sm" onclick="pauseTimer()" style="font-size: 14px;">‚è∏</button>
            <button class="sm" onclick="resetTimer()" style="font-size: 14px;">‚Ü∫</button>
        </div>
        <div class="timer-mode">
            <span onclick="setTimer(25)">Focus</span>
            <span onclick="setTimer(5)">Break</span>
            <span onclick="setTimer(15)">Long</span>
        </div>
    </div>
    
    <div style="padding:14px; border-top:1px solid var(--border)">
        <button style="width:100%; border:none; color:var(--text-muted); font-weight: 600;" onclick="signOut()">Sign out</button>
    </div>
</aside>

<main>
    <div class="top-bar">
        <div class="tabs">
            <div class="tab active" id="tab-write" onclick="switchTab('write')">
                <span class="tab-icon">‚úçÔ∏è</span> Write
            </div>
            <div class="tab" id="tab-read" onclick="switchTab('read')">
                <span class="tab-icon">üìñ</span> Preview
            </div>
            <div class="tab" id="tab-quiz" onclick="switchTab('quiz')">
                <span class="tab-icon">üéØ</span> Flashcards
            </div>
            <div class="tab" id="tab-graph" onclick="switchTab('graph')">
                <span class="tab-icon">üï∏Ô∏è</span> Graph
            </div>
        </div>
        <div class="actions">
            <div class="autosave-indicator" id="save-status" style="display: none;">
                <div class="autosave-dot"></div>
                <span>Autosaving...</span>
            </div>
            <button onclick="openPDFModal()">üìÑ Export</button>
            <button class="primary" onclick="saveNote()">üíæ Save</button>
            <button class="danger" onclick="deleteNote()">üóëÔ∏è Delete</button>
        </div>
    </div>

    <div class="content-area">
        <div id="pane-write" class="editor-pane active">
            <!-- Grade Selector -->
            <div class="grade-selector">
                <label>Grade Level</label>
                <select class="grade-dropdown" id="note-grade" onchange="handleGradeChange()">
                    <option value="">Select Grade...</option>
                    <option value="8th">8th Grade</option>
                    <option value="9th">9th Grade (Freshman)</option>
                    <option value="10th">10th Grade (Sophomore)</option>
                    <option value="11th">11th Grade (Junior)</option>
                    <option value="12th">12th Grade (Senior)</option>
                </select>
            </div>
            
            <!-- Link to Other Notes -->
            <div class="link-input-container">
                <input type="text" class="link-input" id="link-search" placeholder="üîó Link to another note... (type to search)" onkeyup="searchForLinks()" onfocus="showLinkDropdown()" onblur="hideLinkDropdown()">
                <div id="link-dropdown"></div>
            </div>
            
            <input type="text" class="title-input" id="title-in" placeholder="Untitled Note" oninput="handleAutoSave()">
            <textarea class="body-input" id="body-in" placeholder="Start writing your notes here...

Supports Markdown:
# Heading
**bold** *italic*
- bullet list
1. numbered list
> quote

‚ú® Features:
‚Ä¢ Organize by grade level
‚Ä¢ Link notes together
‚Ä¢ Export to PDF
‚Ä¢ Spaced repetition flashcards
‚Ä¢ Visual note connections" oninput="handleAutoSave()"></textarea>
            
            <!-- Linked Notes Display -->
            <div class="linked-notes-section" id="linked-section" style="display: none;">
                <h4 style="color: var(--text-muted); font-size: 14px; margin-bottom: 12px; font-weight: 600;">üîó Linked Notes</h4>
                <div id="linked-display"></div>
            </div>
        </div>

        <div id="pane-read" class="preview-pane">
            <h1 id="prev-title"></h1>
            <div id="prev-body"></div>
            <div class="linked-notes-section" id="preview-linked-section" style="display: none;">
                <h4 style="color: var(--text-muted); font-size: 16px; font-weight: 600;">üîó Linked Notes</h4>
                <div id="preview-linked-display"></div>
            </div>
        </div>

        <div id="pane-quiz" class="flashcard-pane">
            <div class="flashcard-container">
                <div style="margin-bottom:28px; color:var(--text-muted); font-size: 14px; font-weight: 600;">
                    üìö Spaced Repetition: <span id="sm-stats" style="color: var(--brand); font-weight: 700;">New Card</span>
                </div>
                <div class="card" id="flash-card" onclick="flipCard()">
                    <div id="card-content">Click to reveal answer</div>
                </div>
                <div class="rating-btns" id="rating-area">
                    <button onclick="rateCard(1)" style="border-color:var(--danger); color: var(--danger);">‚ùå Forgot</button>
                    <button onclick="rateCard(3)" style="border-color:var(--warning); color: var(--warning);">üòê Hard</button>
                    <button onclick="rateCard(4)" style="border-color:var(--brand); color: var(--brand);">üëç Good</button>
                    <button onclick="rateCard(5)" style="border-color:var(--success); color: var(--success);">‚ö° Easy</button>
                </div>
            </div>
        </div>

        <div id="pane-graph" class="graph-pane">
            <canvas id="graph-canvas"></canvas>
            <div class="graph-controls">
                <button class="sm" onclick="resetGraphView()">üîÑ Reset</button>
                <button class="sm" onclick="toggleGraphPhysics()">‚ö° Physics</button>
            </div>
            <div class="graph-legend">
                <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px; color: var(--brand-light);">Legend</div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--brand);"></div>
                    <span>Current Note</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--success);"></div>
                    <span>Linked Notes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--text-muted);"></div>
                    <span>Other Notes</span>
                </div>
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://cgmazcvmpcgistoimqlw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // --- STATE ---
    let notes = [];
    let activeId = null;
    let user = null;
    let isSignUp = false;
    let autoSaveTimeout = null;
    let currentSchool = 'Salesianum'; // or 'St Peter Cathedral'
    
    // Timer State
    let timerInterval;
    let timeLeft = 25 * 60;
    
    // Flashcard State
    let isFlipped = false;
    
    // Graph State
    let graphCanvas, graphCtx;
    let graphNodes = [];
    let graphLinks = [];
    let graphPhysicsEnabled = true;
    let isDragging = false;
    let dragNode = null;
    
    // Grade levels
    const grades = ['8th', '9th', '10th', '11th', '12th'];
    const gradeLabels = {
        '8th': '8th Grade',
        '9th': '9th Grade (Freshman)',
        '10th': '10th Grade (Sophomore)',
        '11th': '11th Grade (Junior)',
        '12th': '12th Grade (Senior)'
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        if(!window.marked) alert("Markdown library failed to load. Check internet.");
        initGraph();
        
        // Toggle school on badge click
        document.getElementById('school-badge').addEventListener('click', () => {
            currentSchool = currentSchool === 'Salesianum' ? 'St Peter Cathedral' : 'Salesianum';
            document.getElementById('school-badge').textContent = currentSchool;
        });
    }

    // --- AUTHENTICATION ---
    window.toggleAuth = () => {
        isSignUp = !isSignUp;
        document.getElementById('auth-msg').innerText = isSignUp ? "Have account? Sign In" : "Switch to Sign Up";
        document.querySelector('#auth-overlay button').innerText = isSignUp ? "Create Account" : "Enter System";
    }

    window.handleAuth = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        if(isSignUp) {
            const { error } = await supabase.auth.signUp({ email: e, password: p });
            if(error) alert(error.message); else alert("Check email for confirmation link!");
        } else {
            const { error } = await supabase.auth.signInWithPassword({ email: e, password: p });
            if(error) alert(error.message); else location.reload();
        }
    }

    window.signOut = async () => { await supabase.auth.signOut(); location.reload(); }

    supabase.auth.onAuthStateChange((e, session) => {
        if(session) {
            user = session.user;
            document.getElementById('auth-overlay').style.display = 'none';
            fetchNotes();
        }
    });

    // --- DATA HANDLING ---
    async function fetchNotes() {
        const { data } = await supabase.from('notes').select('*').order('updated_at', { ascending: false });
        if(data) {
            notes = data.map(n => ({
                ...n,
                sm_data: n.sm_data || { interval: 0, repetition: 0, efactor: 2.5, due: Date.now() },
                linked_notes: n.linked_notes || [],
                grade: n.grade || ''
            }));

            renderList();
            updateStats();
            if(notes.length) loadNote(notes[0].id);
        }
    }

    window.createNote = async () => {
        const { data } = await supabase.from('notes').insert({ 
            user_id: user.id, 
            title: "", 
            content: "",
            sm_data: { interval: 0, repetition: 0, efactor: 2.5, due: Date.now() },
            linked_notes: [],
            grade: ''
        }).select();
        if(data) {
            notes.unshift({ ...data[0], sm_data: { interval: 0, repetition: 0, efactor: 2.5, due: Date.now() }, linked_notes: [], grade: ''});
            loadNote(data[0].id);
            renderList();
            updateStats();
        }
    }

    window.saveNote = async () => {
        if(!activeId) return;
        const t = document.getElementById('title-in').value;
        const c = document.getElementById('body-in').value;
        const g = document.getElementById('note-grade').value;
        const n = notes.find(x => x.id === activeId);

        await supabase.from('notes').update({ 
            title: t, 
            content: c, 
            grade: g,
            updated_at: new Date(),
            sm_data: n.sm_data,
            linked_notes: n.linked_notes 
        }).eq('id', activeId);
        
        n.title = t; 
        n.content = c;
        n.grade = g;
        
        const saveStatus = document.getElementById('save-status');
        saveStatus.style.display = 'flex';
        saveStatus.innerHTML = '<div style="width: 7px; height: 7px; border-radius: 50%; background: var(--success);"></div><span style="color: var(--success);">Saved!</span>';
        setTimeout(() => saveStatus.style.display = 'none', 2000);
        
        renderList();
        updatePreview();
        updateStats();
    }

    // Auto-save functionality
    window.handleAutoSave = () => {
        clearTimeout(autoSaveTimeout);
        document.getElementById('save-status').style.display = 'flex';
        autoSaveTimeout = setTimeout(() => {
            saveNote();
        }, 2000);
    }
    
    window.handleGradeChange = () => {
        handleAutoSave();
    }

    window.deleteNote = async () => {
        if(!activeId || !confirm("Delete this note permanently?")) return;
        
        // Remove this note from other notes' linked_notes arrays
        notes.forEach(async (n) => {
            if(n.linked_notes && n.linked_notes.includes(activeId)) {
                n.linked_notes = n.linked_notes.filter(id => id !== activeId);
                await supabase.from('notes').update({ linked_notes: n.linked_notes }).eq('id', n.id);
            }
        });
        
        await supabase.from('notes').delete().eq('id', activeId);
        notes = notes.filter(n => n.id !== activeId);
        if(notes.length) loadNote(notes[0].id);
        else activeId = null;
        renderList();
        updateStats();
    }

    window.loadNote = (id) => {
        activeId = id;
        const n = notes.find(x => x.id === id);
        
        document.getElementById('title-in').value = n.title || "";
        document.getElementById('body-in').value = n.content || "";
        document.getElementById('note-grade').value = n.grade || "";
        
        // Reset Tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-write').classList.add('active');
        document.querySelectorAll('.editor-pane, .preview-pane, .flashcard-pane, .graph-pane').forEach(p => p.classList.remove('active'));
        document.getElementById('pane-write').classList.add('active');
        
        resetFlashcardUI(n);
        displayLinkedNotes();
        renderList();
    }

    // --- SEARCH FUNCTIONALITY ---
    window.searchNotes = () => {
        const query = document.getElementById('search-box').value.toLowerCase();
        renderList(query);
    }

    // --- TAB SWITCHING ---
    window.switchTab = (mode) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        
        document.querySelectorAll('.editor-pane, .preview-pane, .flashcard-pane, .graph-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(`pane-${mode}`).classList.add('active');

        if(mode === 'read') updatePreview();
        if(mode === 'quiz') startQuizMode();
        if(mode === 'graph') drawGraph();
    }

    function updatePreview() {
        const title = document.getElementById('title-in').value;
        const body = document.getElementById('body-in').value;
        document.getElementById('prev-title').innerText = title;
        document.getElementById('prev-body').innerHTML = marked.parse(body);
        
        // Show linked notes in preview
        const n = notes.find(x => x.id === activeId);
        if(n && n.linked_notes && n.linked_notes.length > 0) {
            document.getElementById('preview-linked-section').style.display = 'block';
            document.getElementById('preview-linked-display').innerHTML = n.linked_notes.map(linkId => {
                const linkedNote = notes.find(x => x.id === linkId);
                return linkedNote ? `<span class="linked-note-tag" onclick="loadNote('${linkId}')">${linkedNote.title || 'Untitled'}</span>` : '';
            }).join('');
        } else {
            document.getElementById('preview-linked-section').style.display = 'none';
        }
    }

    // --- NOTE LINKING SYSTEM ---
    window.showLinkDropdown = () => {
        document.getElementById('link-dropdown').style.display = 'block';
        searchForLinks();
    }

    window.hideLinkDropdown = () => {
        setTimeout(() => {
            document.getElementById('link-dropdown').style.display = 'none';
        }, 200);
    }

    window.searchForLinks = () => {
        const query = document.getElementById('link-search').value.toLowerCase();
        const dropdown = document.getElementById('link-dropdown');
        
        const filteredNotes = notes.filter(n => 
            n.id !== activeId && 
            (n.title || '').toLowerCase().includes(query)
        ).slice(0, 5);
        
        if(filteredNotes.length === 0) {
            dropdown.innerHTML = '<div style="padding: 14px; color: var(--text-muted); font-size: 13px;">No notes found</div>';
        } else {
            dropdown.innerHTML = filteredNotes.map(n => `
                <div style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 500; transition: all 0.2s;" 
                     onmousedown="linkNote('${n.id}')" 
                     onmouseover="this.style.background='var(--surface-hover)'; this.style.color='var(--brand)'" 
                     onmouseout="this.style.background='transparent'; this.style.color='var(--text-main)'">
                    ${n.title || 'Untitled'} ${n.grade ? `<span style="color: var(--text-muted); font-size: 11px;">(${gradeLabels[n.grade]})</span>` : ''}
                </div>
            `).join('');
        }
    }

    window.linkNote = (linkId) => {
        const currentNote = notes.find(x => x.id === activeId);
        if(!currentNote.linked_notes) currentNote.linked_notes = [];
        
        if(!currentNote.linked_notes.includes(linkId)) {
            currentNote.linked_notes.push(linkId);
            
            // Bidirectional linking
            const linkedNote = notes.find(x => x.id === linkId);
            if(!linkedNote.linked_notes) linkedNote.linked_notes = [];
            if(!linkedNote.linked_notes.includes(activeId)) {
                linkedNote.linked_notes.push(activeId);
            }
            
            displayLinkedNotes();
            document.getElementById('link-search').value = '';
            saveNote();
        }
    }

    function displayLinkedNotes() {
        const n = notes.find(x => x.id === activeId);
        if(!n || !n.linked_notes || n.linked_notes.length === 0) {
            document.getElementById('linked-section').style.display = 'none';
            return;
        }
        
        document.getElementById('linked-section').style.display = 'block';
        document.getElementById('linked-display').innerHTML = n.linked_notes.map(linkId => {
            const linkedNote = notes.find(x => x.id === linkId);
            return linkedNote ? `<span class="linked-note-tag" onclick="loadNote('${linkId}')">${linkedNote.title || 'Untitled'}</span>` : '';
        }).join('');
    }

    // --- PDF EXPORT ---
    window.openPDFModal = () => {
        document.getElementById('pdf-modal').style.display = 'flex';
    }

    window.closePDFModal = () => {
        document.getElementById('pdf-modal').style.display = 'none';
    }

    window.confirmPDFExport = async () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const n = notes.find(x => x.id === activeId);
        const includeLinks = document.getElementById('pdf-include-links').checked;
        const includeDate = document.getElementById('pdf-include-date').checked;
        
        // Title
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text(n.title || 'Untitled Note', 20, 20);
        
        let yPos = 28;
        
        // Grade & School
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        if(n.grade) {
            doc.text(`Grade: ${gradeLabels[n.grade]}`, 20, yPos);
            yPos += 6;
        }
        doc.text(`School: ${currentSchool}`, 20, yPos);
        yPos += 6;
        
        // Date
        if(includeDate) {
            doc.text(`Created: ${new Date(n.created_at).toLocaleDateString()}`, 20, yPos);
            yPos += 6;
        }
        
        yPos += 8;
        
        // Body content
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        const splitText = doc.splitTextToSize(n.content || '', 170);
        doc.text(splitText, 20, yPos);
        
        // Linked notes
        if(includeLinks && n.linked_notes && n.linked_notes.length > 0) {
            const textHeight = splitText.length * 7 + yPos + 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Linked Notes:', 20, textHeight);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            n.linked_notes.forEach((linkId, idx) => {
                const linkedNote = notes.find(x => x.id === linkId);
                if(linkedNote) {
                    doc.text(`‚Ä¢ ${linkedNote.title || 'Untitled'}`, 25, textHeight + 10 + (idx * 7));
                }
            });
        }
        
        doc.save(`${n.title || 'note'}.pdf`);
        closePDFModal();
    }

    // --- GRAPH VIEW ---
    function initGraph() {
        graphCanvas = document.getElementById('graph-canvas');
        graphCtx = graphCanvas.getContext('2d');
        
        graphCanvas.addEventListener('mousedown', onGraphMouseDown);
        graphCanvas.addEventListener('mousemove', onGraphMouseMove);
        graphCanvas.addEventListener('mouseup', onGraphMouseUp);
        
        window.addEventListener('resize', resizeGraph);
        resizeGraph();
    }

    function resizeGraph() {
        graphCanvas.width = graphCanvas.offsetWidth;
        graphCanvas.height = graphCanvas.offsetHeight;
    }

    window.drawGraph = () => {
        resizeGraph();
        buildGraphData();
        renderGraph();
        if(graphPhysicsEnabled) startGraphPhysics();
    }

    function buildGraphData() {
        const width = graphCanvas.width;
        const height = graphCanvas.height;
        
        graphNodes = notes.map(n => ({
            id: n.id,
            label: n.title || 'Untitled',
            x: Math.random() * (width - 100) + 50,
            y: Math.random() * (height - 100) + 50,
            vx: 0,
            vy: 0,
            isActive: n.id === activeId
        }));
        
        graphLinks = [];
        notes.forEach(n => {
            if(n.linked_notes) {
                n.linked_notes.forEach(linkId => {
                    if(!graphLinks.find(l => 
                        (l.source === n.id && l.target === linkId) || 
                        (l.source === linkId && l.target === n.id)
                    )) {
                        graphLinks.push({ source: n.id, target: linkId });
                    }
                });
            }
        });
    }

    function renderGraph() {
        graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
        
        // Draw links
        graphCtx.strokeStyle = '#2a2a2a';
        graphCtx.lineWidth = 2;
        graphLinks.forEach(link => {
            const source = graphNodes.find(n => n.id === link.source);
            const target = graphNodes.find(n => n.id === link.target);
            if(source && target) {
                graphCtx.beginPath();
                graphCtx.moveTo(source.x, source.y);
                graphCtx.lineTo(target.x, target.y);
                graphCtx.stroke();
            }
        });
        
        // Draw nodes
        graphNodes.forEach(node => {
            const isLinked = graphLinks.some(l => l.source === activeId && l.target === node.id || l.target === activeId && l.source === node.id);
            
            graphCtx.beginPath();
            graphCtx.arc(node.x, node.y, 24, 0, Math.PI * 2);
            graphCtx.fillStyle = node.isActive ? '#6366f1' : (isLinked ? '#10b981' : '#999999');
            graphCtx.fill();
            graphCtx.strokeStyle = '#fff';
            graphCtx.lineWidth = 3;
            graphCtx.stroke();
            
            // Glow effect
            if(node.isActive || isLinked) {
                graphCtx.shadowBlur = 15;
                graphCtx.shadowColor = node.isActive ? '#6366f1' : '#10b981';
                graphCtx.beginPath();
                graphCtx.arc(node.x, node.y, 24, 0, Math.PI * 2);
                graphCtx.stroke();
                graphCtx.shadowBlur = 0;
            }
            
            // Label
            graphCtx.fillStyle = '#f8f8f8';
            graphCtx.font = '600 12px Inter';
            graphCtx.textAlign = 'center';
            const label = node.label.length > 18 ? node.label.substring(0, 18) + '...' : node.label;
            graphCtx.fillText(label, node.x, node.y + 42);
        });
    }

    function startGraphPhysics() {
        const animate = () => {
            if(!graphPhysicsEnabled) return;
            
            graphNodes.forEach(node => {
                let fx = 0, fy = 0;
                
                // Repulsion
                graphNodes.forEach(other => {
                    if(node !== other) {
                        const dx = node.x - other.x;
                        const dy = node.y - other.y;
                        const dist = Math.sqrt(dx*dx + dy*dy) || 1;
                        const force = 100 / (dist * dist);
                        fx += (dx / dist) * force;
                        fy += (dy / dist) * force;
                    }
                });
                
                // Attraction to linked nodes
                graphLinks.forEach(link => {
                    if(link.source === node.id || link.target === node.id) {
                        const other = graphNodes.find(n => 
                            n.id === (link.source === node.id ? link.target : link.source)
                        );
                        if(other) {
                            const dx = other.x - node.x;
                            const dy = other.y - node.y;
                            fx += dx * 0.01;
                            fy += dy * 0.01;
                        }
                    }
                });
                
                // Center gravity
                fx += (graphCanvas.width/2 - node.x) * 0.001;
                fy += (graphCanvas.height/2 - node.y) * 0.001;
                
                // Update
                node.vx = (node.vx + fx) * 0.9;
                node.vy = (node.vy + fy) * 0.9;
                node.x += node.vx;
                node.y += node.vy;
                
                // Boundary
                node.x = Math.max(40, Math.min(graphCanvas.width - 40, node.x));
                node.y = Math.max(40, Math.min(graphCanvas.height - 40, node.y));
            });
            
            renderGraph();
            requestAnimationFrame(animate);
        };
        animate();
    }

    window.toggleGraphPhysics = () => {
        graphPhysicsEnabled = !graphPhysicsEnabled;
        if(graphPhysicsEnabled) startGraphPhysics();
    }

    window.resetGraphView = () => {
        buildGraphData();
        renderGraph();
        if(graphPhysicsEnabled) startGraphPhysics();
    }

    function onGraphMouseDown(e) {
        const rect = graphCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        dragNode = graphNodes.find(n => {
            const dx = n.x - x;
            const dy = n.y - y;
            return Math.sqrt(dx*dx + dy*dy) < 24;
        });
        
        if(dragNode) {
            isDragging = true;
            graphPhysicsEnabled = false;
        }
    }

    function onGraphMouseMove(e) {
        if(isDragging && dragNode) {
            const rect = graphCanvas.getBoundingClientRect();
            dragNode.x = e.clientX - rect.left;
            dragNode.y = e.clientY - rect.top;
            renderGraph();
        }
    }

    function onGraphMouseUp(e) {
        if(isDragging && dragNode) {
            const rect = graphCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const dx = dragNode.x - x;
            const dy = dragNode.y - y;
            
            if(Math.sqrt(dx*dx + dy*dy) < 5) {
                loadNote(dragNode.id);
                switchTab('write');
            }
        }
        
        isDragging = false;
        dragNode = null;
    }

    // --- FLASHCARD LOGIC ---
    function resetFlashcardUI(note) {
        isFlipped = false;
        document.getElementById('rating-area').style.display = 'none';
        document.getElementById('flash-card').style.transform = 'none';
        document.getElementById('card-content').innerText = note.title || "Untitled Card";
        
        const isDue = new Date(note.sm_data.due) <= new Date();
        document.getElementById('sm-stats').innerText = isDue ? "‚ö° Review Due Now" : "üìÖ Review Later";
        document.getElementById('sm-stats').style.color = isDue ? "var(--success)" : "var(--text-muted)";
    }

    window.startQuizMode = () => {
        const n = notes.find(x => x.id === activeId);
        resetFlashcardUI(n);
    }

    window.flipCard = () => {
        if(isFlipped) return;
        const n = notes.find(x => x.id === activeId);
        document.getElementById('card-content').innerText = n.content.substring(0, 300) + (n.content.length > 300 ? "..." : "");
        document.getElementById('rating-area').style.display = 'grid';
        isFlipped = true;
    }

    window.rateCard = (quality) => {
        const n = notes.find(x => x.id === activeId);
        let { interval, repetition, efactor } = n.sm_data;

        if (quality >= 3) {
            if (repetition === 0) interval = 1;
            else if (repetition === 1) interval = 6;
            else interval = Math.round(interval * efactor);
            repetition++;
        } else {
            repetition = 0;
            interval = 1;
        }

        efactor = efactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
        if (efactor < 1.3) efactor = 1.3;

        n.sm_data = { interval, repetition, efactor, due: Date.now() + (interval * 24 * 60 * 60 * 1000) };
        saveNote();
        
        const ratingText = quality === 5 ? 'Easy!' : quality === 4 ? 'Good!' : quality === 3 ? 'Hard' : 'Forgot';
        alert(`‚úÖ Rated: ${ratingText}\nüìÖ Next review in ${interval} day${interval > 1 ? 's' : ''}`);
        window.switchTab('write');
    }

    // --- STATS ---
    function updateStats() {
        document.getElementById('total-notes').innerText = notes.length;
        const dueCount = notes.filter(n => new Date(n.sm_data.due) <= new Date()).length;
        document.getElementById('total-reviews').innerText = dueCount;
    }

    // --- POMODORO TIMER ---
    window.setTimer = (min) => {
        pauseTimer();
        timeLeft = min * 60;
        updateTimerDisplay();
    }

    window.startTimer = () => {
        if(timerInterval) return;
        timerInterval = setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                updateTimerDisplay();
            } else {
                pauseTimer();
                alert("‚è∞ Time's up! Great work!");
                try {
                    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                } catch(e) {}
            }
        }, 1000);
    }

    window.pauseTimer = () => {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    window.resetTimer = () => {
        pauseTimer();
        timeLeft = 25 * 60;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const s = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }

    // --- RENDER LIST WITH GRADE DIVISIONS ---
    function renderList(searchQuery = '') {
        const list = document.getElementById('list');
        
        // Group notes by grade
        const notesByGrade = {};
        grades.forEach(g => notesByGrade[g] = []);
        notesByGrade['ungraded'] = [];
        
        notes.forEach(n => {
            if(searchQuery && !(n.title || '').toLowerCase().includes(searchQuery)) return;
            
            if(n.grade && grades.includes(n.grade)) {
                notesByGrade[n.grade].push(n);
            } else {
                notesByGrade['ungraded'].push(n);
            }
        });
        
        let html = '';
        
        // Render each grade section
        grades.forEach(grade => {
            if(notesByGrade[grade].length > 0) {
                html += `
                <div class="grade-section">
                    <div class="grade-header active" onclick="toggleGrade('${grade}')">
                        <div class="grade-title">
                            <span>${gradeLabels[grade]}</span>
                            <span class="grade-count">${notesByGrade[grade].length}</span>
                        </div>
                        <div class="grade-arrow">‚ñ∂</div>
                    </div>
                    <div class="grade-notes expanded" id="grade-${grade}">
                        ${notesByGrade[grade].map(n => {
                            const isDue = new Date(n.sm_data.due) <= new Date();
                            const hasLinks = n.linked_notes && n.linked_notes.length > 0;
                            return `
                            <div class="nav-item ${n.id === activeId ? 'active' : ''} ${isDue ? 'due' : ''}" onclick="loadNote('${n.id}')">
                                <span>${n.title || 'Untitled'}${hasLinks ? '<span class="linked-indicator">üîó</span>' : ''}</span>
                                <div class="flashcard-indicator" title="Review Due"></div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
        });
        
        // Ungraded notes
        if(notesByGrade['ungraded'].length > 0) {
            html += `
            <div class="grade-section">
                <div class="grade-header active" onclick="toggleGrade('ungraded')">
                    <div class="grade-title">
                        <span>Ungraded</span>
                        <span class="grade-count">${notesByGrade['ungraded'].length}</span>
                    </div>
                    <div class="grade-arrow">‚ñ∂</div>
                </div>
                <div class="grade-notes expanded" id="grade-ungraded">
                    ${notesByGrade['ungraded'].map(n => {
                        const isDue = new Date(n.sm_data.due) <= new Date();
                        const hasLinks = n.linked_notes && n.linked_notes.length > 0;
                        return `
                        <div class="nav-item ${n.id === activeId ? 'active' : ''} ${isDue ? 'due' : ''}" onclick="loadNote('${n.id}')">
                            <span>${n.title || 'Untitled'}${hasLinks ? '<span class="linked-indicator">üîó</span>' : ''}</span>
                            <div class="flashcard-indicator" title="Review Due"></div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }
        
        list.innerHTML = html;
    }
    
    window.toggleGrade = (grade) => {
        const header = event.currentTarget;
        const notesDiv = document.getElementById(`grade-${grade}`);
        
        header.classList.toggle('active');
        notesDiv.classList.toggle('expanded');
    }
</script>
</body>
</html>

