<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>StudyOS</title>
<style>
:root{
  --bg:#0b0b0e;
  --panel:#111118;
  --panel2:#151521;
  --text:#f4f4f7;
  --muted:#b7b7c7;
  --accent:#ff7a18;
  --accent2:#ffb55a;
  --bad:#ff4d4d;
  --good:#44d07a;
  --shadow: 0 12px 35px rgba(0,0,0,.45);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: radial-gradient(1200px 800px at 20% 0%, rgba(255,122,24,.20), transparent 55%),
              radial-gradient(1000px 700px at 85% 10%, rgba(255,181,90,.12), transparent 60%),
              var(--bg);
  color:var(--text);
  overflow:hidden;
}
button,input,select,textarea{font:inherit}
button{cursor:pointer}
a{color:inherit}
.hidden{display:none!important}

#app{
  height:100dvh;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.topbar{
  padding:12px 14px;
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
}
.brand{display:flex;align-items:center;gap:10px}
.logo{
  width:38px;height:38px;border-radius:14px;
  background: linear-gradient(135deg, rgba(255,122,24,1), rgba(255,181,90,1));
  box-shadow: 0 12px 25px rgba(255,122,24,.18);
}
.brand h1{margin:0;font-size:16px;letter-spacing:.4px}
.mini{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center}

.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.09);
}
.btn{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;border-radius:12px;
}
.btn:hover{border-color: rgba(255,255,255,.18)}
.btn.primary{
  background: linear-gradient(135deg, rgba(255,122,24,1), rgba(255,181,90,1));
  color:#151018;border:0;
}
.btn.danger{
  background: rgba(255,77,77,.12);
  border-color: rgba(255,77,77,.25);
  color:#ffd2d2;
}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.55;cursor:not-allowed}

.layout{
  flex:1;min-height:0;
  display:flex;gap:12px;
  padding:0 12px 12px;
}
.sidebar{
  width:270px;min-width:240px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  padding:12px;
  display:flex;flex-direction:column;gap:10px;
}
.navbtn{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  width:100%;
  padding:12px 12px;border-radius:14px;
  background:transparent;border:1px solid transparent;
  color:var(--text);
}
.navbtn:hover{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.08)}
.navbtn.active{background:rgba(255,122,24,.14);border-color:rgba(255,122,24,.28)}
.badge{
  font-size:12px;padding:3px 8px;border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.08);
  color:var(--muted);
}
.kbd{
  font-size:12px;padding:2px 6px;border-radius:8px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  color:var(--muted);
}

.card{
  flex:1;min-width:0;min-height:0;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;flex-direction:column;
}
.cardhead{
  padding:12px 12px 10px;
  border-bottom:1px solid rgba(255,255,255,.07);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.cardhead h2{margin:0;font-size:14px;letter-spacing:.3px}
.content{flex:1;min-height:0;overflow:auto;padding:12px}
.hr{height:1px;background:rgba(255,255,255,.07);margin:12px 0}
.inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.splitbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}

.grid2{
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:12px;
  min-height:0;
}
@media (max-width: 980px){
  body{overflow:auto}
  #app{height:auto;min-height:100dvh}
  .layout{flex-direction:column}
  .sidebar{width:auto}
  .grid2{grid-template-columns:1fr}
}

.field{display:flex;flex-direction:column;gap:6px}
label{font-size:12px;color:var(--muted)}
input[type="text"],input[type="email"],input[type="password"],select,textarea{
  width:100%;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  color:var(--text);
  border-radius:12px;
  padding:10px 10px;
  outline:none;
}
textarea{resize:none;min-height:240px;line-height:1.4}
input:focus,select:focus,textarea:focus{
  border-color: rgba(255,122,24,.45);
  box-shadow: 0 0 0 3px rgba(255,122,24,.18);
}

.list{display:flex;flex-direction:column;gap:8px}
.noteitem{
  text-align:left;width:100%;
  padding:10px 10px;border-radius:14px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
}
.noteitem:hover{border-color:rgba(255,255,255,.14)}
.noteitem.active{background:rgba(255,122,24,.14);border-color:rgba(255,122,24,.28)}
.noteitem b{display:block;font-size:13px}
.noteitem small{display:block;color:var(--muted);margin-top:2px;font-size:12px}

.canvasWrap{
  width:100%;
  height:520px;
  border-radius:18px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.canvasWrap canvas{width:100%;height:100%}

.gameRow{display:grid;grid-template-columns: 1fr 330px;gap:12px}
@media (max-width: 980px){.gameRow{grid-template-columns:1fr}}
.gameCard{
  background:rgba(0,0,0,.30);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:12px;
}
.gameCard h3{margin:0 0 8px;font-size:14px}
.smallbtn{
  padding:8px 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:var(--text);
}
.smallbtn.primary{
  background:rgba(255,122,24,.18);
  border-color:rgba(255,122,24,.28);
}
.switch{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 10px;border:1px solid rgba(255,255,255,.08);
  border-radius:14px;background:rgba(255,255,255,.03);
}
.switch b{font-size:13px}
.switch small{color:var(--muted)}

.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  padding:10px 12px;
  border-radius:14px;
  background:rgba(0,0,0,.72);
  border:1px solid rgba(255,255,255,.10);
  color:var(--text);
  box-shadow: var(--shadow);
  max-width:min(640px, calc(100% - 24px));
  display:none;
}
.toast.show{display:block}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>StudyOS</h1>
        <div class="mini" id="statusLine">Offline demo</div>
      </div>
    </div>
    <div class="row">
      <div class="pill">
        <small id="authText">Not signed in</small>
      </div>
      <button class="btn" id="btnOpenAuth">Sign in</button>
      <button class="btn ghost hidden" id="btnLogout">Log out</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <button class="navbtn active" data-tab="notes"><span>Notes</span><span class="badge" id="notesCount">0</span></button>
      <button class="navbtn" data-tab="graph"><span>Graph</span><span class="badge">links</span></button>
      <button class="navbtn" data-tab="games"><span>Games</span><span class="badge">2</span></button>
      <button class="navbtn" data-tab="timer"><span>Timer</span><span class="badge">focus</span></button>
      <button class="navbtn" data-tab="settings"><span>Settings</span><span class="badge">prefs</span></button>
      <div class="hr"></div>
      <div class="mini">Quick mute: <span class="kbd">`</span></div>
      <div class="mini">Quick new note: <span class="kbd">N</span></div>
    </div>

    <div class="card">
      <div class="cardhead">
        <h2 id="panelTitle">Notes</h2>
        <div class="inline">
          <span class="mini" id="saveState">—</span>
          <button class="btn primary" id="btnNewNote">New</button>
        </div>
      </div>

      <div class="content">
        <section id="tab-notes">
          <div class="grid2">
            <div>
              <div class="field">
                <label>Search</label>
                <input id="noteSearch" type="text" placeholder="Find a note...">
              </div>

              <div class="inline" style="margin-top:10px">
                <div class="field" style="flex:1;min-width:160px">
                  <label>School</label>
                  <select id="filterSchool">
                    <option value="">All</option>
                    <option>Salesianum</option>
                    <option>St Peter</option>
                    <option>McKean</option>
                    <option>Other</option>
                  </select>
                </div>
                <div class="field" style="flex:1;min-width:160px">
                  <label>Category</label>
                  <select id="filterCategory">
                    <option value="">All</option>
                    <option>Math</option>
                    <option>English</option>
                    <option>Science</option>
                    <option>History</option>
                    <option>Language</option>
                    <option>Other</option>
                  </select>
                </div>
              </div>

              <div class="hr"></div>
              <div class="list" id="notesList"></div>
            </div>

            <div>
              <div class="inline">
                <button class="btn" id="btnSaveNow">Save</button>
                <button class="btn" id="btnPrint">Print/PDF</button>
                <button class="btn" id="btnLink">Link</button>
                <button class="btn danger" id="btnDelete">Delete</button>
              </div>

              <div class="hr"></div>

              <div class="inline">
                <div class="field" style="flex:1;min-width:240px">
                  <label>Title</label>
                  <input id="noteTitle" type="text" placeholder="Title">
                </div>
                <div class="field" style="min-width:170px">
                  <label>School</label>
                  <select id="noteSchool">
                    <option>Salesianum</option>
                    <option>St Peter</option>
                    <option>McKean</option>
                    <option>Other</option>
                  </select>
                </div>
              </div>

              <div class="inline" style="margin-top:10px">
                <div class="field" style="min-width:170px">
                  <label>Category</label>
                  <select id="noteCategory">
                    <option>Math</option>
                    <option>English</option>
                    <option>Science</option>
                    <option>History</option>
                    <option>Language</option>
                    <option>Other</option>
                  </select>
                </div>
                <div class="field" style="min-width:170px">
                  <label>Grade</label>
                  <select id="noteGrade">
                    <option value="">—</option>
                    <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
                  </select>
                </div>
                <div class="field" style="flex:1;min-width:240px">
                  <label>Tags (comma separated)</label>
                  <input id="noteTags" type="text" placeholder="algebra, test, unit 2">
                </div>
              </div>

              <div class="field" style="margin-top:10px">
                <label>Content</label>
                <textarea id="noteContent" placeholder="Write here..."></textarea>
              </div>

              <div class="mini" style="margin-top:8px" id="noteMeta">—</div>
            </div>
          </div>
        </section>

        <section id="tab-graph" class="hidden">
          <div class="splitbar">
            <div class="mini">Drag nodes. Scroll to zoom. Click a node to open.</div>
            <button class="btn" id="btnReloadGraph">Reload</button>
          </div>
          <div class="hr"></div>
          <div class="canvasWrap"><canvas id="graphCanvas" width="1200" height="700"></canvas></div>
        </section>

        <section id="tab-games" class="hidden">
          <div class="gameRow">
            <div class="gameCard">
              <div class="inline" style="justify-content:space-between">
                <h3 id="gameTitle">Snake: Hard Mode</h3>
                <div class="inline">
                  <button class="smallbtn" id="btnGameSnake">Snake</button>
                  <button class="smallbtn" id="btnGameBeat">BeatJump</button>
                </div>
              </div>
              <div class="hr"></div>
              <div class="canvasWrap" style="height:520px"><canvas id="gameCanvas" width="900" height="650"></canvas></div>
              <div class="hr"></div>
              <div class="inline" style="justify-content:space-between">
                <div class="mini" id="gameHint">Arrow keys / WASD. Tap to turn. Space to restart.</div>
                <div class="inline">
                  <button class="smallbtn primary" id="btnGameStart">Start</button>
                  <button class="smallbtn" id="btnGameReset">Reset</button>
                </div>
              </div>
            </div>

            <div class="gameCard">
              <h3>Game settings</h3>
              <div class="switch">
                <div><b>Sound effects</b><small>Small beeps only</small></div>
                <input id="sfxEnabled" type="checkbox" checked>
              </div>
              <div class="switch" style="margin-top:10px">
                <div><b>Hard mode</b><small>Faster + obstacles</small></div>
                <input id="snakeHard" type="checkbox" checked>
              </div>

              <div class="hr"></div>
              <h3>Snake cheats</h3>

              <div class="switch">
                <div><b>Wrap walls</b><small>Teleport through edges</small></div>
                <input id="cheatWrap" type="checkbox">
              </div>
              <div class="switch" style="margin-top:10px">
                <div><b>Slow time</b><small>Chill speed</small></div>
                <input id="cheatSlow" type="checkbox">
              </div>
              <div class="switch" style="margin-top:10px">
                <div><b>Magnet food</b><small>Food drifts to you</small></div>
                <input id="cheatMagnet" type="checkbox">
              </div>
              <div class="switch" style="margin-top:10px">
                <div><b>Invincible (10s)</b><small>Press to activate</small></div>
                <button class="smallbtn" id="btnInvincible">Activate</button>
              </div>

              <div class="inline" style="margin-top:10px">
                <button class="smallbtn" id="btnAdd5">+5 length</button>
                <button class="smallbtn" id="btnClearObs">Clear obstacles</button>
              </div>

              <div class="hr"></div>
              <div class="mini" id="gameStats">—</div>
            </div>
          </div>
        </section>

        <section id="tab-timer" class="hidden">
          <div class="inline" style="justify-content:space-between">
            <div>
              <div style="font-size:40px;font-weight:700" id="timerDisplay">25:00</div>
              <div class="mini" id="timerState">Ready</div>
            </div>
            <div class="inline">
              <button class="btn primary" id="btnTimerStart">Start</button>
              <button class="btn" id="btnTimerPause">Pause</button>
              <button class="btn" id="btnTimerReset">Reset</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="inline">
            <div class="field" style="min-width:180px">
              <label>Focus minutes</label>
              <input id="focusMins" type="text" value="25">
            </div>
            <div class="field" style="min-width:180px">
              <label>Break minutes</label>
              <input id="breakMins" type="text" value="5">
            </div>
          </div>
        </section>

        <section id="tab-settings" class="hidden">
          <div class="grid2" style="grid-template-columns: 1fr 1fr">
            <div>
              <h3 style="margin:0 0 8px">Defaults</h3>
              <div class="field">
                <label>Default school</label>
                <select id="defaultSchool">
                  <option>Salesianum</option>
                  <option>St Peter</option>
                  <option>McKean</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="field" style="margin-top:10px">
                <label>Default category</label>
                <select id="defaultCategory">
                  <option>Math</option>
                  <option>English</option>
                  <option>Science</option>
                  <option>History</option>
                  <option>Language</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="hr"></div>
              <div class="mini" id="settingsSaveState">—</div>
              <button class="btn" id="btnSaveSettings">Save settings</button>
            </div>

            <div>
              <h3 style="margin:0 0 8px">Settings for nerds</h3>
              <div class="mini" style="margin-bottom:10px">Password required (local only). Audio will not autoplay.</div>

              <div class="inline">
                <input id="nerdPass" type="password" placeholder="Password">
                <button class="btn primary" id="nerdUnlock">Unlock</button>
              </div>

              <div id="nerdPanel" class="hidden" style="margin-top:12px">
                <div class="switch">
                  <div><b>Remember unlock</b><small>On this device only</small></div>
                  <input id="rememberUnlock" type="checkbox">
                </div>

                <div class="hr"></div>

                <div class="field">
                  <label>Track</label>
                  <select id="trackSelect"></select>
                </div>

                <div class="inline" style="margin-top:10px">
                  <button class="btn primary" id="btnPlayPause">Play</button>
                  <button class="btn" id="btnStop">Stop</button>
                </div>

                <div class="field" style="margin-top:10px">
                  <label>Volume</label>
                  <input id="musicVol" type="text" value="0.25">
                </div>

                <div class="mini" style="margin-top:10px">Quick mute key: <span class="kbd">`</span></div>
                <audio id="bgAudio" preload="none" class="hidden"></audio>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="authModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;padding:14px;z-index:50">
  <div style="width:min(520px,100%);background:rgba(15,15,22,.96);border:1px solid rgba(255,255,255,.10);border-radius:18px;box-shadow:var(--shadow);padding:14px">
    <div class="inline" style="justify-content:space-between">
      <div>
        <div style="font-weight:700">Account</div>
        <div class="mini">Supabase email + password</div>
      </div>
      <button class="btn" id="btnCloseAuth">Close</button>
    </div>
    <div class="hr"></div>
    <div class="grid2" style="grid-template-columns:1fr 1fr;gap:10px">
      <div class="field" style="grid-column:1/-1">
        <label>Email</label>
        <input id="authEmail" type="email" placeholder="you@example.com">
      </div>
      <div class="field" style="grid-column:1/-1">
        <label>Password</label>
        <input id="authPass" type="password" placeholder="••••••••">
      </div>
      <button class="btn primary" id="btnSignIn">Sign in</button>
      <button class="btn" id="btnSignUp">Sign up</button>
    </div>
    <div class="mini" style="margin-top:10px" id="authMsg">—</div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://cgmazcvmpcgistoimqlw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc";

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

const el = (id) => document.getElementById(id);
const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));

let toastTimer = null;
function toast(msg){
  const t = el("toast");
  if(!t) return;
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove("show"), 2200);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function fmtTime(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString([], { month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }catch(_){ return ""; }
}

function setStatus(line){
  const s = el("statusLine");
  if(s) s.textContent = line;
}

function setSaveState(t){
  const s = el("saveState");
  if(s) s.textContent = t;
}

const APP = {
  user: null,
  notes: [],
  activeNote: null,
  links: [],
  saveDebounce: null,
  settings: { defaults: { school:"Salesianum", category:"Math" }, nerd: { track:0, vol:0.25, remember:false } },
  sfxOn: true,
  audioUnlocked: false,
  invincibleUntil: 0
};

function requireUser(){
  if(!APP.user){
    toast("Sign in to save.");
    return false;
  }
  return true;
}

function setAuthedUI(){
  const authText = el("authText");
  const btnOpenAuth = el("btnOpenAuth");
  const btnLogout = el("btnLogout");
  if(APP.user){
    if(authText) authText.textContent = APP.user.email || "Signed in";
    if(btnOpenAuth) btnOpenAuth.classList.add("hidden");
    if(btnLogout) btnLogout.classList.remove("hidden");
    setStatus("Online");
  }else{
    if(authText) authText.textContent = "Not signed in";
    if(btnOpenAuth) btnOpenAuth.classList.remove("hidden");
    if(btnLogout) btnLogout.classList.add("hidden");
    setStatus("Offline demo");
  }
}

async function ensureSettingsRow(){
  if(!APP.user) return;
  const payload = {
    user_id: APP.user.id,
    current_school: APP.settings.defaults.school,
    ui: { defaults: { school: APP.settings.defaults.school, category: APP.settings.defaults.category } },
    timer: {},
    game: {},
    nerd: { track: APP.settings.nerd.track, vol: APP.settings.nerd.vol }
  };
  await sb.from("user_settings").upsert(payload, { onConflict: "user_id" });
}

async function loadSettings(){
  if(!APP.user) return;
  const { data } = await sb.from("user_settings").select("*").eq("user_id", APP.user.id).maybeSingle();
  if(!data) return;

  const defaults = (data.ui && data.ui.defaults) ? data.ui.defaults : null;
  APP.settings.defaults.school = defaults?.school || data.current_school || "Salesianum";
  APP.settings.defaults.category = defaults?.category || "Math";

  const nerd = data.nerd || {};
  APP.settings.nerd.track = Number.isFinite(nerd.track) ? nerd.track : 0;
  APP.settings.nerd.vol = Number.isFinite(nerd.vol) ? nerd.vol : 0.25;

  const ds = el("defaultSchool");
  const dc = el("defaultCategory");
  if(ds) ds.value = APP.settings.defaults.school;
  if(dc) dc.value = APP.settings.defaults.category;

  const ns = el("noteSchool");
  const nc = el("noteCategory");
  if(ns) ns.value = APP.settings.defaults.school;
  if(nc) nc.value = APP.settings.defaults.category;

  const v = el("musicVol");
  if(v) v.value = String(APP.settings.nerd.vol);
}

async function saveSettings(){
  if(!requireUser()) return;
  APP.settings.defaults.school = el("defaultSchool")?.value || "Salesianum";
  APP.settings.defaults.category = el("defaultCategory")?.value || "Math";

  const payload = {
    user_id: APP.user.id,
    current_school: APP.settings.defaults.school,
    ui: { defaults: { school: APP.settings.defaults.school, category: APP.settings.defaults.category } },
    nerd: { track: APP.settings.nerd.track, vol: APP.settings.nerd.vol }
  };
  const { error } = await sb.from("user_settings").upsert(payload, { onConflict: "user_id" });
  const s = el("settingsSaveState");
  if(error){
    if(s) s.textContent = "Save failed";
    toast("Settings save failed");
    return;
  }
  if(s) s.textContent = "Saved";
  toast("Saved settings");
}

function setEditorEnabled(on){
  const ids = ["btnSaveNow","btnPrint","btnLink","btnDelete","noteTitle","noteSchool","noteCategory","noteGrade","noteTags","noteContent"];
  for(const id of ids){
    const x = el(id);
    if(x) x.disabled = !on;
  }
}

function fillEditor(note){
  APP.activeNote = note;

  if(el("noteTitle")) el("noteTitle").value = note?.title ?? "";
  if(el("noteSchool")) el("noteSchool").value = note?.school || APP.settings.defaults.school;
  if(el("noteCategory")) el("noteCategory").value = note?.category || APP.settings.defaults.category;
  if(el("noteGrade")) el("noteGrade").value = note?.grade ?? "";
  if(el("noteTags")) el("noteTags").value = (note?.tags || []).join(", ");
  if(el("noteContent")) el("noteContent").value = note?.content ?? "";

  const meta = el("noteMeta");
  if(meta){
    const parts = [];
    if(note?.created_at) parts.push("Created " + fmtTime(note.created_at));
    if(note?.updated_at) parts.push("Updated " + fmtTime(note.updated_at));
    meta.textContent = parts.length ? parts.join(" • ") : "—";
  }

  setEditorEnabled(!!note);
  renderNotesList();
}

function editorToPayload(){
  const title = el("noteTitle")?.value ?? "";
  const school = el("noteSchool")?.value ?? APP.settings.defaults.school;
  const category = el("noteCategory")?.value ?? APP.settings.defaults.category;
  const grade = el("noteGrade")?.value ?? "";
  const tagsRaw = el("noteTags")?.value ?? "";
  const tags = tagsRaw.split(",").map(s=>s.trim()).filter(Boolean).slice(0, 30);
  const content = el("noteContent")?.value ?? "";
  return { title, school, category, grade, tags, content };
}

function renderNotesList(){
  const list = el("notesList");
  if(!list) return;
  list.innerHTML = "";

  const q = (el("noteSearch")?.value || "").trim().toLowerCase();
  const fs = el("filterSchool")?.value || "";
  const fc = el("filterCategory")?.value || "";

  const filtered = APP.notes.filter(n=>{
    const t = (n.title || "").toLowerCase();
    const c = (n.content || "").toLowerCase();
    const okQ = !q || t.includes(q) || c.includes(q);
    const okS = !fs || (n.school || "") === fs;
    const okC = !fc || (n.category || "") === fc;
    return okQ && okS && okC;
  }).sort((a,b)=> new Date(b.updated_at) - new Date(a.updated_at));

  if(el("notesCount")) el("notesCount").textContent = String(filtered.length);

  if(filtered.length === 0){
    const div = document.createElement("div");
    div.className = "mini";
    div.textContent = APP.user ? "No notes yet. Hit New." : "Sign in to save notes.";
    list.appendChild(div);
    return;
  }

  for(const n of filtered){
    const b = document.createElement("button");
    b.className = "noteitem" + (APP.activeNote && APP.activeNote.id === n.id ? " active" : "");
    const title = (n.title || "").trim() || "(untitled)";
    const meta = `${n.school || ""}${n.category ? " • " + n.category : ""}${n.grade ? " • grade " + n.grade : ""}`;
    b.innerHTML = `<b>${escapeHtml(title)}</b><small>${escapeHtml(meta)} • ${escapeHtml(fmtTime(n.updated_at))}</small>`;
    b.addEventListener("click", ()=> openNote(n.id));
    list.appendChild(b);
  }
}

async function fetchNotes(){
  if(!APP.user){
    APP.notes = [];
    fillEditor(null);
    renderNotesList();
    return;
  }
  setSaveState("Loading...");
  const { data, error } = await sb.from("notes")
    .select("id,title,content,school,category,grade,tags,created_at,updated_at")
    .order("updated_at", { ascending:false })
    .limit(250);

  if(error){
    setSaveState("Load failed");
    toast("Notes load failed");
    return;
  }
  APP.notes = data || [];
  setSaveState("Ready");
  renderNotesList();
  if(!APP.activeNote && APP.notes.length) await openNote(APP.notes[0].id);
  if(!APP.notes.length) fillEditor(null);
}

async function openNote(id){
  if(!APP.user){
    toast("Sign in to open notes.");
    return;
  }
  setSaveState("Loading note...");
  const { data, error } = await sb.from("notes").select("*").eq("id", id).single();
  if(error){
    setSaveState("Open failed");
    toast("Open failed");
    return;
  }
  fillEditor(data);
  setSaveState("Ready");
}

async function createNote(){
  if(!requireUser()) return;
  setSaveState("Creating...");
  const payload = {
    user_id: APP.user.id,
    title:"",
    content:"",
    school: APP.settings.defaults.school,
    category: APP.settings.defaults.category,
    grade:"",
    tags:[]
  };
  const { data, error } = await sb.from("notes").insert(payload).select("*").single();
  if(error){
    setSaveState("Create failed");
    toast("Create failed");
    return;
  }
  APP.notes.unshift(data);
  fillEditor(data);
  setSaveState("Ready");
  toast("New note");
}

async function deleteNote(){
  if(!requireUser()) return;
  if(!APP.activeNote) return;
  const id = APP.activeNote.id;
  setSaveState("Deleting...");
  const { error } = await sb.from("notes").delete().eq("id", id);
  if(error){
    setSaveState("Delete failed");
    toast("Delete failed");
    return;
  }
  APP.notes = APP.notes.filter(n=>n.id !== id);
  fillEditor(null);
  renderNotesList();
  setSaveState("Ready");
  toast("Deleted");
}

async function saveNow(){
  if(!requireUser()) return;
  if(!APP.activeNote) return;
  const id = APP.activeNote.id;
  setSaveState("Saving...");
  const patch = editorToPayload();
  const { data, error } = await sb.from("notes").update(patch).eq("id", id).select("*").single();
  if(error){
    setSaveState("Save failed");
    toast("Save failed");
    return;
  }
  APP.activeNote = data;
  const idx = APP.notes.findIndex(n=>n.id===id);
  if(idx>=0) APP.notes[idx]=data;
  fillEditor(data);
  setSaveState("Saved");
}

function scheduleAutosave(){
  clearTimeout(APP.saveDebounce);
  APP.saveDebounce = setTimeout(()=>saveNow(), 600);
}

function printActive(){
  if(!APP.activeNote){
    toast("Open a note first");
    return;
  }
  const note = { ...APP.activeNote, ...editorToPayload() };
  const w = window.open("", "_blank", "noopener,noreferrer");
  if(!w){
    toast("Popup blocked");
    return;
  }
  const safeTitle = escapeHtml(note.title || "Note");
  const safeMeta = escapeHtml(`${note.school || ""}${note.category ? " • "+note.category : ""}${note.grade ? " • grade "+note.grade : ""}`);
  const safeTags = escapeHtml((note.tags || []).join(", "));
  const safeContent = escapeHtml(note.content || "").replace(/\n/g, "<br>");
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${safeTitle}</title><style>body{font-family:system-ui,Segoe UI,Arial;margin:24px;line-height:1.4}h1{margin:0 0 6px}small{color:#555}hr{border:0;border-top:1px solid #ddd;margin:14px 0}.tags{color:#555;font-size:12px;margin-top:6px}</style></head><body><h1>${safeTitle}</h1><small>${safeMeta}</small><div class="tags">${safeTags}</div><hr><div>${safeContent}</div></body></html>`);
  w.document.close();
  w.focus();
  w.print();
}

async function fetchLinks(){
  if(!APP.user){
    APP.links=[];
    return;
  }
  const { data } = await sb.from("note_links").select("note_a,note_b,created_at").limit(1000);
  APP.links = data || [];
}

async function linkNoteFlow(){
  if(!requireUser()) return;
  if(!APP.activeNote){
    toast("Open a note first");
    return;
  }
  const others = APP.notes.filter(n=>n.id!==APP.activeNote.id);
  if(!others.length){
    toast("Need at least 2 notes");
    return;
  }
  const pick = prompt("Type part of the note title to link to:");
  if(!pick) return;
  const p = pick.trim().toLowerCase();
  const found = others.find(n=> (n.title||"").toLowerCase().includes(p));
  if(!found){
    toast("No match");
    return;
  }
  const payload = { user_id: APP.user.id, note_a: APP.activeNote.id, note_b: found.id };
  const { error } = await sb.from("note_links").insert(payload);
  if(error){
    toast("Link failed");
    return;
  }
  await fetchLinks();
  toast("Linked");
}

let graph = null;

function initGraph(){
  const canvas = el("graphCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const state = { canvas, ctx, nodes:[], edges:[], dragging:null, pan:{x:40,y:40}, zoom:1, last:performance.now() };

  function resize(){
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function rebuild(){
    const nodes = APP.notes.map((n,i)=>({
      id:n.id,
      title:(n.title||"(untitled)").slice(0,24),
      x: 260 + Math.cos(i)*140,
      y: 220 + Math.sin(i)*140,
      vx:0, vy:0
    }));
    const idx = new Map(nodes.map((n,i)=>[n.id,i]));
    const edges = [];
    for(const e of APP.links){
      const ia = idx.get(e.note_a);
      const ib = idx.get(e.note_b);
      if(ia==null||ib==null) continue;
      edges.push([ia,ib]);
    }
    state.nodes = nodes;
    state.edges = edges;
  }

  function screenToWorld(mx,my){
    return { x: (mx - state.pan.x)/state.zoom, y: (my - state.pan.y)/state.zoom };
  }

  function pickNode(mx,my){
    const p = screenToWorld(mx,my);
    let best=null, bestD=1e9;
    for(const n of state.nodes){
      const dx=p.x-n.x, dy=p.y-n.y;
      const d=dx*dx+dy*dy;
      if(d<bestD && d<18*18){ best=n; bestD=d; }
    }
    return best;
  }

  function draw(){
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width,rect.height);
    ctx.save();
    ctx.translate(state.pan.x, state.pan.y);
    ctx.scale(state.zoom, state.zoom);

    ctx.lineWidth = 2/state.zoom;
    ctx.strokeStyle = "rgba(255,255,255,.20)";
    for(const [ia,ib] of state.edges){
      const a=state.nodes[ia], b=state.nodes[ib];
      ctx.beginPath();
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
      ctx.stroke();
    }

    for(const n of state.nodes){
      ctx.beginPath();
      ctx.fillStyle = "rgba(255,122,24,.20)";
      ctx.strokeStyle = "rgba(255,122,24,.55)";
      ctx.arc(n.x,n.y, 16, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = "rgba(244,244,247,.92)";
      ctx.font = `${12/state.zoom}px system-ui`;
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText(n.title, n.x, n.y+18);
    }

    ctx.restore();
  }

  function tick(){
    const now = performance.now();
    const dt = Math.min(0.03, (now - state.last)/1000);
    state.last = now;

    const cx = 520, cy = 320;
    for(const n of state.nodes){
      n.vx += (cx - n.x)*0.012;
      n.vy += (cy - n.y)*0.012;
    }

    for(let i=0;i<state.nodes.length;i++){
      for(let j=i+1;j<state.nodes.length;j++){
        const a=state.nodes[i], b=state.nodes[j];
        const dx=a.x-b.x, dy=a.y-b.y;
        const d2=dx*dx+dy*dy+0.001;
        const f=12000/d2;
        const inv=Math.sqrt(d2);
        a.vx += (dx/inv)*f*dt;
        a.vy += (dy/inv)*f*dt;
        b.vx -= (dx/inv)*f*dt;
        b.vy -= (dy/inv)*f*dt;
      }
    }

    for(const [ia,ib] of state.edges){
      const a=state.nodes[ia], b=state.nodes[ib];
      const dx=b.x-a.x, dy=b.y-a.y;
      const dist=Math.sqrt(dx*dx+dy*dy)+0.001;
      const desired=180;
      const diff=(dist-desired);
      const fx=(dx/dist)*diff*0.020;
      const fy=(dy/dist)*diff*0.020;
      a.vx += fx; a.vy += fy;
      b.vx -= fx; b.vy -= fy;
    }

    for(const n of state.nodes){
      if(state.dragging && state.dragging.id===n.id) continue;
      n.x += n.vx; n.y += n.vy;
      n.vx *= 0.86; n.vy *= 0.86;
    }

    draw();
    requestAnimationFrame(tick);
  }

  canvas.addEventListener("pointerdown", (e)=>{
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    const n = pickNode(mx,my);
    if(n){
      state.dragging = { id:n.id };
      canvas.setPointerCapture(e.pointerId);
    }else{
      state.dragging = { pan:true, ox: mx, oy: my, px: state.pan.x, py: state.pan.y };
      canvas.setPointerCapture(e.pointerId);
    }
  });

  canvas.addEventListener("pointermove", (e)=>{
    if(!state.dragging) return;
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;

    if(state.dragging.pan){
      state.pan.x = state.dragging.px + (mx - state.dragging.ox);
      state.pan.y = state.dragging.py + (my - state.dragging.oy);
      return;
    }

    const node = state.nodes.find(x=>x.id===state.dragging.id);
    if(!node) return;
    const p = screenToWorld(mx,my);
    node.x = p.x; node.y = p.y;
    node.vx = 0; node.vy = 0;
  });

  canvas.addEventListener("pointerup", (e)=>{
    if(!state.dragging) return;
    if(!state.dragging.pan){
      const r = canvas.getBoundingClientRect();
      const mx = e.clientX - r.left;
      const my = e.clientY - r.top;
      const n = pickNode(mx,my);
      if(n) openNote(n.id);
    }
    state.dragging = null;
    canvas.releasePointerCapture(e.pointerId);
  });

  canvas.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    const p = screenToWorld(mx,my);
    const factor = e.deltaY > 0 ? 0.92 : 1.08;
    state.zoom = Math.max(0.35, Math.min(2.2, state.zoom*factor));
    state.pan.x = mx - p.x*state.zoom;
    state.pan.y = my - p.y*state.zoom;
  }, { passive:false });

  window.addEventListener("resize", ()=>{ resize(); });

  graph = { resize, rebuild };
  resize();
  rebuild();
  requestAnimationFrame(tick);
}

async function reloadGraph(){
  await fetchLinks();
  if(graph){
    graph.rebuild();
    graph.resize();
  }else{
    initGraph();
  }
  toast("Graph updated");
}

const TRACKS = [
  { key:"A", name:"A - autumn! - one way (instrumental)", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/autumn!%20-%20one%20way%20(instrumental).mp3" },
  { key:"J", name:"J - free jaydes pluggnb type beat", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/free%20jaydes%20%20pluggnb%20type%20beat%20self%20(1).mp3" },
  { key:"J", name:"J - jaydes convenience (instrumental)", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/jaydes%20%20convenience%20(fixed%20instrumental)%20(1).mp3" },
  { key:"M", name:"M - Me vs Me (instrumental)", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/Me%20vs%20Me%20(Instrumental)%20-%20Jaeychino%20and%20SlimeGetEm%20(1).mp3" },
  { key:"K", name:"K - Kyle Richh x Sdot Go - Drive me crazy (instrumental)", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/Kyle%20Richh%20x%20Sdot%20Go%20-%20Drive%20me%20crazyOblivious%20(official%20instrumental)%20(1).mp3" }
];

function clamp01(n){
  n = Number(n);
  return Number.isFinite(n) ? Math.max(0, Math.min(1, n)) : 0.25;
}

function setupNerdAudio(){
  const sel = el("trackSelect");
  if(sel){
    sel.innerHTML = "";
    for(let i=0;i<TRACKS.length;i++){
      const o = document.createElement("option");
      o.value = String(i);
      o.textContent = TRACKS[i].name;
      sel.appendChild(o);
    }
    sel.value = String(APP.settings.nerd.track || 0);
  }
  const audio = el("bgAudio");
  if(audio){
    audio.loop = true;
    audio.volume = clamp01(APP.settings.nerd.vol);
  }
  const v = el("musicVol");
  if(v) v.value = String(APP.settings.nerd.vol);
}

function setTrack(idx){
  const audio = el("bgAudio");
  if(!audio) return;
  const i = Math.max(0, Math.min(TRACKS.length-1, Number(idx)||0));
  APP.settings.nerd.track = i;
  audio.src = TRACKS[i].url;
}

function stopMusic(){
  const audio = el("bgAudio");
  const btn = el("btnPlayPause");
  if(audio){
    audio.pause();
    audio.currentTime = 0;
  }
  if(btn) btn.textContent = "Play";
}

function playPauseMusic(){
  if(!APP.audioUnlocked){
    toast("Unlock first");
    return;
  }
  const audio = el("bgAudio");
  if(!audio) return;

  if(!audio.src) setTrack(el("trackSelect")?.value ?? 0);

  const btn = el("btnPlayPause");
  if(audio.paused){
    audio.play().then(()=>{
      if(btn) btn.textContent = "Pause";
    }).catch(()=>{
      toast("Tap Play again");
    });
  }else{
    audio.pause();
    if(btn) btn.textContent = "Play";
  }
}

function applyMusicVol(){
  const audio = el("bgAudio");
  const v = clamp01(el("musicVol")?.value ?? 0.25);
  APP.settings.nerd.vol = v;
  if(audio) audio.volume = v;
}

function unlockNerd(){
  const pass = el("nerdPass")?.value ?? "";
  if(pass !== "9999"){
    toast("Wrong password");
    return;
  }
  APP.audioUnlocked = true;
  const panel = el("nerdPanel");
  if(panel) panel.classList.remove("hidden");
  const remember = !!el("rememberUnlock")?.checked;
  if(remember){
    localStorage.setItem("studyos_nerd_unlocked", "1");
  }else{
    localStorage.removeItem("studyos_nerd_unlocked");
  }
  toast("Unlocked");
}

function quickMute(){
  const audio = el("bgAudio");
  if(audio && !audio.paused){
    stopMusic();
    toast("Muted");
  }
}

let audioCtx = null;
function sfx(freq=440, dur=0.07, type="sine", gain=0.05){
  if(!APP.sfxOn) return;
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(gain, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g).connect(audioCtx.destination);
    o.start(t0);
    o.stop(t0 + dur);
  }catch(_){}
}

const GAME = {
  mode: "snake",
  running: false,
  last: 0,
  score: 0,
  bestSnake: 0,
  bestBeat: 0,
  snake: null,
  beat: null
};

function gameCanvas(){ return el("gameCanvas"); }

function updateGameStats(){
  const st = el("gameStats");
  if(!st) return;
  const best = GAME.mode==="snake" ? GAME.bestSnake : GAME.bestBeat;
  st.textContent = `Score: ${GAME.score}   Best: ${best}`;
}

function syncCheatUI(){
  const wrap = el("cheatWrap");
  const slow = el("cheatSlow");
  const mag = el("cheatMagnet");
  if(wrap && GAME.snake) wrap.checked = !!GAME.snake.cheats.wrap;
  if(slow && GAME.snake) slow.checked = !!GAME.snake.cheats.slow;
  if(mag && GAME.snake) mag.checked = !!GAME.snake.cheats.magnet;
}

function initSnake(drawOnly){
  const canvas = gameCanvas();
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const hard = el("snakeHard")?.checked ?? true;

  const size = 22;
  const cols = Math.floor(canvas.width / size);
  const rows = Math.floor(canvas.height / size);

  const randCell = () => ({ x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows) });

  function placeFree(s){
    let tries = 0;
    while(tries++ < 900){
      const p = randCell();
      if(s.body.some(b=>b.x===p.x&&b.y===p.y)) continue;
      if(s.obstacles.some(o=>o.x===p.x&&o.y===p.y)) continue;
      if(s.poison && s.poison.x===p.x && s.poison.y===p.y) continue;
      if(s.food && s.food.x===p.x && s.food.y===p.y) continue;
      return p;
    }
    return randCell();
  }

  const snake = {
    size, cols, rows, ctx, canvas,
    dir:{x:1,y:0},
    nextDir:{x:1,y:0},
    body:[{x:Math.floor(cols/2), y:Math.floor(rows/2)}],
    grow:3,
    food:null,
    poison:null,
    obstacles:[],
    stepAcc:0,
    alive:true,
    hard,
    baseSpeed: hard ? 14 : 10,
    cheats:{wrap:false, slow:false, magnet:false}
  };

  if(hard){
    for(let i=0;i<10;i++){
      const o = placeFree(snake);
      if(Math.abs(o.x-snake.body[0].x)<4 && Math.abs(o.y-snake.body[0].y)<4) continue;
      snake.obstacles.push(o);
    }
  }

  snake.food = placeFree(snake);

  GAME.snake = snake;
  GAME.running = false;
  GAME.score = 0;
  updateGameStats();
  syncCheatUI();

  function draw(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(0,0,0,.25)";
    ctx.fillRect(0,0,w,h);

    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.lineWidth = 1;
    for(let x=0;x<w;x+=snake.size){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y=0;y<h;y+=snake.size){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

    const drawCell = (p, fill, glow) => {
      const px = p.x*snake.size;
      const py = p.y*snake.size;
      ctx.fillStyle = fill;
      ctx.fillRect(px+2, py+2, snake.size-4, snake.size-4);
      if(glow){
        ctx.strokeStyle = "rgba(255,181,90,.55)";
        ctx.strokeRect(px+1.5, py+1.5, snake.size-3, snake.size-3);
      }
    };

    for(const o of snake.obstacles) drawCell(o, "rgba(255,255,255,.12)");
    if(snake.poison) drawCell(snake.poison, "rgba(255,77,77,.30)", true);
    drawCell(snake.food, "rgba(255,122,24,.35)", true);

    const inv = performance.now() < APP.invincibleUntil;
    for(let i=snake.body.length-1;i>=0;i--){
      const b = snake.body[i];
      const isHead = i===0;
      drawCell(b, isHead ? (inv ? "rgba(68,208,122,.45)" : "rgba(255,181,90,.38)") : "rgba(255,122,24,.20)", isHead);
    }

    if(!snake.alive){
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = "rgba(244,244,247,.95)";
      ctx.font = "700 32px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Game Over", w/2, h/2 - 10);
      ctx.font = "14px system-ui";
      ctx.fillStyle = "rgba(244,244,247,.75)";
      ctx.fillText("Press Start to try again", w/2, h/2 + 22);
    }else if(!GAME.running){
      ctx.fillStyle = "rgba(0,0,0,.40)";
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = "rgba(244,244,247,.92)";
      ctx.font = "700 26px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Press Start", w/2, h/2);
      ctx.font = "13px system-ui";
      ctx.fillStyle = "rgba(244,244,247,.72)";
      ctx.fillText("or Space / tap canvas", w/2, h/2 + 28);
    }
  }

  function step(dt){
    if(!GAME.running || !snake.alive) return;

    const speed = snake.cheats.slow ? Math.max(7, snake.baseSpeed - 6) : snake.baseSpeed + Math.min(18, Math.floor(GAME.score/4));
    snake.stepAcc += dt * speed;

    if(snake.cheats.magnet){
      const head = snake.body[0];
      const dx = head.x - snake.food.x;
      const dy = head.y - snake.food.y;
      if(Math.abs(dx)+Math.abs(dy) > 2){
        snake.food.x += dx>0 ? 1 : -1;
        snake.food.y += dy>0 ? 1 : -1;
        snake.food.x = (snake.food.x + snake.cols) % snake.cols;
        snake.food.y = (snake.food.y + snake.rows) % snake.rows;
      }
    }

    while(snake.stepAcc >= 1){
      snake.stepAcc -= 1;
      snake.dir = snake.nextDir;

      const head = { ...snake.body[0] };
      head.x += snake.dir.x;
      head.y += snake.dir.y;

      if(snake.cheats.wrap){
        head.x = (head.x + snake.cols) % snake.cols;
        head.y = (head.y + snake.rows) % snake.rows;
      }

      const hitWall = head.x<0 || head.x>=snake.cols || head.y<0 || head.y>=snake.rows;
      const hitSelf = snake.body.some((b,i)=> i>0 && b.x===head.x && b.y===head.y);
      const hitObs = snake.obstacles.some(o=>o.x===head.x && o.y===head.y);
      const inv = performance.now() < APP.invincibleUntil;

      if((hitWall || hitSelf || hitObs) && !inv){
        snake.alive = false;
        GAME.running = false;
        sfx(120, 0.16, "square", 0.08);
        if(GAME.score > GAME.bestSnake) GAME.bestSnake = GAME.score;
        toast("Game over");
        draw();
        updateGameStats();
        return;
      }

      snake.body.unshift(head);

      if(head.x===snake.food.x && head.y===snake.food.y){
        snake.grow += 1;
        GAME.score += 1;
        sfx(660, 0.06, "sine", 0.04);
        if(snake.hard && GAME.score % 3 === 0) snake.obstacles.push(placeFree(snake));
        if(snake.hard && !snake.poison && Math.random() < 0.20) snake.poison = placeFree(snake);
        snake.food = placeFree(snake);
        updateGameStats();
      }

      if(snake.poison && head.x===snake.poison.x && head.y===snake.poison.y){
        snake.poison = null;
        snake.grow = Math.max(0, snake.grow - 2);
        GAME.score = Math.max(0, GAME.score - 2);
        sfx(220, 0.10, "sawtooth", 0.05);
        updateGameStats();
      }

      if(snake.grow>0){
        snake.grow -= 1;
      }else{
        snake.body.pop();
      }
    }

    draw();
  }

  GAME.snake.step = step;
  GAME.snake.draw = draw;
  if(drawOnly) draw();
}

function snakeInput(dx,dy){
  const s = GAME.snake;
  if(!s || !s.alive) return;
  if(dx === -s.dir.x && dy === -s.dir.y) return;
  s.nextDir = { x:dx, y:dy };
}

function initBeat(drawOnly){
  const canvas = gameCanvas();
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  const beat = {
    ctx, canvas,
    x: 140,
    y: canvas.height - 120,
    vy: 0,
    g: 2400,
    jump: -820,
    ground: canvas.height - 90,
    alive: true,
    speed: 420,
    blocks: [],
    score: 0
  };

  function spawn(){
    const h = 38 + Math.floor(Math.random()*60);
    const w = 28 + Math.floor(Math.random()*42);
    const gap = 240 + Math.floor(Math.random()*180);
    const y = beat.ground - h;
    const x = canvas.width + gap;
    beat.blocks.push({ x, y, w, h });
  }

  beat.blocks = [];
  for(let i=0;i<4;i++) spawn();

  GAME.beat = beat;
  GAME.running = false;
  GAME.score = 0;
  updateGameStats();

  function rectHit(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  function draw(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(0,0,0,.25)";
    ctx.fillRect(0,0,w,h);

    const prog = Math.min(1, (GAME.score % 20)/20);
    ctx.fillStyle = "rgba(255,255,255,.10)";
    ctx.fillRect(18, 18, w-36, 10);
    ctx.fillStyle = "rgba(255,122,24,.55)";
    ctx.fillRect(18, 18, (w-36)*prog, 10);

    ctx.fillStyle = "rgba(255,255,255,.08)";
    ctx.fillRect(0, beat.ground + 38, w, h);

    for(const b of beat.blocks){
      ctx.fillStyle = "rgba(255,255,255,.12)";
      ctx.fillRect(b.x, b.y, b.w, b.h);
      ctx.strokeStyle = "rgba(255,122,24,.35)";
      ctx.strokeRect(b.x+0.5, b.y+0.5, b.w-1, b.h-1);
    }

    ctx.fillStyle = "rgba(255,181,90,.35)";
    ctx.fillRect(beat.x, beat.y, 38, 38);
    ctx.strokeStyle = "rgba(255,181,90,.75)";
    ctx.strokeRect(beat.x+0.5, beat.y+0.5, 37, 37);

    if(!beat.alive){
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = "rgba(244,244,247,.95)";
      ctx.font = "700 30px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Try again", w/2, h/2 - 12);
      ctx.font = "14px system-ui";
      ctx.fillStyle = "rgba(244,244,247,.72)";
      ctx.fillText("Press Start or Space / tap", w/2, h/2 + 18);
    }else if(!GAME.running){
      ctx.fillStyle = "rgba(0,0,0,.40)";
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = "rgba(244,244,247,.92)";
      ctx.font = "700 26px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Press Start", w/2, h/2);
      ctx.font = "13px system-ui";
      ctx.fillStyle = "rgba(244,244,247,.72)";
      ctx.fillText("Space / tap to jump", w/2, h/2 + 28);
    }
  }

  function step(dt){
    if(!GAME.running || !beat.alive) return;

    beat.vy += beat.g * dt;
    beat.y += beat.vy * dt;
    if(beat.y > beat.ground){
      beat.y = beat.ground;
      beat.vy = 0;
    }

    const speed = beat.speed + Math.min(900, GAME.score*10);
    for(const b of beat.blocks) b.x -= speed * dt;

    if(beat.blocks.length && beat.blocks[0].x + beat.blocks[0].w < -50){
      beat.blocks.shift();
      GAME.score += 1;
      sfx(520, 0.05, "triangle", 0.035);
      updateGameStats();
      spawn();
    }

    const player = { x: beat.x, y: beat.y, w: 38, h: 38 };
    for(const b of beat.blocks){
      if(rectHit(player, b)){
        beat.alive = false;
        GAME.running = false;
        sfx(140, 0.16, "square", 0.07);
        if(GAME.score > GAME.bestBeat) GAME.bestBeat = GAME.score;
        updateGameStats();
        toast("Crashed");
        draw();
        return;
      }
    }

    draw();
  }

  GAME.beat.step = step;
  GAME.beat.draw = draw;
  if(drawOnly) draw();
}

function beatJump(){
  const b = GAME.beat;
  if(!b || !b.alive) return;
  if(b.y >= b.ground - 1){
    b.vy = b.jump;
    sfx(740, 0.04, "sine", 0.03);
  }
}

function setGameMode(m){
  GAME.mode = m;
  if(el("gameTitle")) el("gameTitle").textContent = m==="snake" ? "Snake: Hard Mode" : "BeatJump";
  if(el("gameHint")) el("gameHint").textContent = m==="snake" ? "Arrow keys / WASD. Tap to turn. Space to restart." : "Space / tap to jump. Survive and beat your best.";
  if(m==="snake") initSnake(true); else initBeat(true);
  updateGameStats();
}

function startGame(){
  if(GAME.mode==="snake"){
    if(!GAME.snake) initSnake(true);
    if(!GAME.snake.alive) initSnake(true);
    GAME.running = true;
    sfx(440, 0.05, "sine", 0.03);
  }else{
    if(!GAME.beat) initBeat(true);
    if(!GAME.beat.alive) initBeat(true);
    GAME.running = true;
    sfx(440, 0.05, "sine", 0.03);
  }
}

function resetGame(){
  GAME.running = false;
  if(GAME.mode==="snake") initSnake(true); else initBeat(true);
}

function gameLoop(t){
  const dt = GAME.last ? Math.min(0.05, (t - GAME.last)/1000) : 0;
  GAME.last = t;
  if(GAME.mode==="snake" && GAME.snake) GAME.snake.step(dt);
  if(GAME.mode==="beat" && GAME.beat) GAME.beat.step(dt);
  requestAnimationFrame(gameLoop);
}

function activateInvincible(){
  APP.invincibleUntil = performance.now() + 10000;
  toast("Invincible 10s");
  sfx(880, 0.08, "triangle", 0.04);
}

function clearObstacles(){
  if(GAME.snake){
    GAME.snake.obstacles = [];
    GAME.snake.poison = null;
    toast("Cleared obstacles");
    if(GAME.snake.draw) GAME.snake.draw();
  }
}

function addLength(){
  if(GAME.snake){
    GAME.snake.grow += 5;
    toast("+5 length");
  }
}

let timer = { mode:"focus", running:false, remaining: 1500, last:0, focus:25*60, brk:5*60 };

function timerRender(){
  const m = Math.floor(timer.remaining/60);
  const s = Math.floor(timer.remaining%60);
  if(el("timerDisplay")) el("timerDisplay").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  if(el("timerState")) el("timerState").textContent = timer.running ? (timer.mode==="focus" ? "Focusing" : "Break") : "Ready";
}

function timerSetFromInputs(){
  const f = Number(el("focusMins")?.value ?? 25);
  const b = Number(el("breakMins")?.value ?? 5);
  timer.focus = (Number.isFinite(f) && f>0 && f<600) ? Math.round(f*60) : 1500;
  timer.brk = (Number.isFinite(b) && b>0 && b<120) ? Math.round(b*60) : 300;
  if(!timer.running){
    timer.remaining = timer.mode==="focus" ? timer.focus : timer.brk;
    timerRender();
  }
}

function timerStart(){
  timerSetFromInputs();
  timer.running = true;
  timer.last = performance.now();
  sfx(520, 0.04, "triangle", 0.03);
}

function timerPause(){
  timer.running = false;
  sfx(260, 0.04, "triangle", 0.03);
}

function timerReset(){
  timer.running = false;
  timer.mode = "focus";
  timer.remaining = timer.focus;
  timerRender();
}

function timerTick(){
  const now = performance.now();
  if(timer.running){
    const dt = (now - timer.last)/1000;
    timer.last = now;
    timer.remaining -= dt;
    if(timer.remaining <= 0){
      timer.mode = (timer.mode==="focus") ? "break" : "focus";
      timer.remaining = timer.mode==="focus" ? timer.focus : timer.brk;
      sfx(880, 0.10, "sine", 0.05);
      toast(timer.mode==="focus" ? "Back to focus" : "Break time");
    }
    timerRender();
  }
  requestAnimationFrame(timerTick);
}

function showTab(name){
  qsa(".navbtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  const panels = ["notes","graph","games","timer","settings"];
  for(const p of panels){
    const sec = el(`tab-${p}`);
    if(sec) sec.classList.toggle("hidden", p!==name);
  }
  if(el("panelTitle")) el("panelTitle").textContent = name.charAt(0).toUpperCase()+name.slice(1);
  if(name==="graph") reloadGraph();
  if(name==="games" && !GAME.snake && !GAME.beat) setGameMode("snake");
}

function openAuthModal(open){
  const m = el("authModal");
  if(m) m.classList.toggle("hidden", !open);
  const msg = el("authMsg");
  if(msg) msg.textContent = "—";
}

async function signIn(){
  const email = el("authEmail")?.value?.trim() || "";
  const password = el("authPass")?.value || "";
  if(el("authMsg")) el("authMsg").textContent = "Signing in...";
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error){
    if(el("authMsg")) el("authMsg").textContent = error.message;
    return;
  }
  if(data?.user){
    if(el("authMsg")) el("authMsg").textContent = "Signed in";
    openAuthModal(false);
  }
}

async function signUp(){
  const email = el("authEmail")?.value?.trim() || "";
  const password = el("authPass")?.value || "";
  if(el("authMsg")) el("authMsg").textContent = "Signing up...";
  const { data, error } = await sb.auth.signUp({ email, password });
  if(error){
    if(el("authMsg")) el("authMsg").textContent = error.message;
    return;
  }
  if(data?.session){
    if(el("authMsg")) el("authMsg").textContent = "Account created and signed in";
    openAuthModal(false);
  }else{
    if(el("authMsg")) el("authMsg").textContent = "Account created. Check email to confirm (if enabled).";
  }
}

async function logout(){
  await sb.auth.signOut();
  toast("Logged out");
}

function bindUI(){
  qsa(".navbtn").forEach(b=> b.addEventListener("click", ()=> showTab(b.dataset.tab)));

  el("btnOpenAuth")?.addEventListener("click", ()=> openAuthModal(true));
  el("btnCloseAuth")?.addEventListener("click", ()=> openAuthModal(false));
  el("btnSignIn")?.addEventListener("click", signIn);
  el("btnSignUp")?.addEventListener("click", signUp);
  el("btnLogout")?.addEventListener("click", logout);

  el("btnNewNote")?.addEventListener("click", createNote);
  el("btnSaveNow")?.addEventListener("click", saveNow);
  el("btnDelete")?.addEventListener("click", deleteNote);
  el("btnPrint")?.addEventListener("click", printActive);
  el("btnLink")?.addEventListener("click", linkNoteFlow);

  el("noteSearch")?.addEventListener("input", renderNotesList);
  el("filterSchool")?.addEventListener("change", renderNotesList);
  el("filterCategory")?.addEventListener("change", renderNotesList);

  ["noteTitle","noteSchool","noteCategory","noteGrade","noteTags","noteContent"].forEach(id=>{
    el(id)?.addEventListener("input", ()=>{
      if(!APP.activeNote) return;
      setSaveState("Typing...");
      scheduleAutosave();
    });
  });

  el("btnSaveSettings")?.addEventListener("click", saveSettings);

  el("nerdUnlock")?.addEventListener("click", unlockNerd);
  el("btnPlayPause")?.addEventListener("click", playPauseMusic);
  el("btnStop")?.addEventListener("click", stopMusic);
  el("musicVol")?.addEventListener("input", applyMusicVol);
  el("trackSelect")?.addEventListener("change", (e)=> setTrack(e.target.value));

  el("rememberUnlock")?.addEventListener("change", (e)=>{
    const on = !!e.target.checked;
    if(on) localStorage.setItem("studyos_nerd_unlocked","1");
    else localStorage.removeItem("studyos_nerd_unlocked");
  });

  el("sfxEnabled")?.addEventListener("change", (e)=>{ APP.sfxOn = !!e.target.checked; });
  el("snakeHard")?.addEventListener("change", ()=>{ if(GAME.mode==="snake") initSnake(true); });

  el("cheatWrap")?.addEventListener("change", (e)=>{ if(GAME.snake) GAME.snake.cheats.wrap = !!e.target.checked; });
  el("cheatSlow")?.addEventListener("change", (e)=>{ if(GAME.snake) GAME.snake.cheats.slow = !!e.target.checked; });
  el("cheatMagnet")?.addEventListener("change", (e)=>{ if(GAME.snake) GAME.snake.cheats.magnet = !!e.target.checked; });

  el("btnInvincible")?.addEventListener("click", activateInvincible);
  el("btnClearObs")?.addEventListener("click", clearObstacles);
  el("btnAdd5")?.addEventListener("click", addLength);

  el("btnGameSnake")?.addEventListener("click", ()=> setGameMode("snake"));
  el("btnGameBeat")?.addEventListener("click", ()=> setGameMode("beat"));
  el("btnGameStart")?.addEventListener("click", startGame);
  el("btnGameReset")?.addEventListener("click", resetGame);

  el("btnReloadGraph")?.addEventListener("click", reloadGraph);

  el("btnTimerStart")?.addEventListener("click", timerStart);
  el("btnTimerPause")?.addEventListener("click", timerPause);
  el("btnTimerReset")?.addEventListener("click", timerReset);
  el("focusMins")?.addEventListener("input", timerSetFromInputs);
  el("breakMins")?.addEventListener("input", timerSetFromInputs);

  const gc = el("gameCanvas");
  if(gc){
    gc.addEventListener("pointerdown", ()=>{
      if(!GAME.running) startGame();
      if(GAME.mode==="beat") beatJump();
    });
  }

  window.addEventListener("keydown", (e)=>{
    if(e.key === "`"){ quickMute(); return; }
    if(e.key.toLowerCase() === "n" && !e.ctrlKey && !e.metaKey && !e.altKey){
      if(document.activeElement && ["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)) return;
      createNote();
      return;
    }
    if(e.key === "Escape"){ openAuthModal(false); return; }

    if(GAME.mode==="snake"){
      const k = e.key.toLowerCase();
      if(k==="arrowup"||k==="w") snakeInput(0,-1);
      if(k==="arrowdown"||k==="s") snakeInput(0,1);
      if(k==="arrowleft"||k==="a") snakeInput(-1,0);
      if(k==="arrowright"||k==="d") snakeInput(1,0);
      if(k===" " && !GAME.running) startGame();
    }else{
      const k = e.key.toLowerCase();
      if(k===" "){ if(!GAME.running) startGame(); beatJump(); }
      if(k==="arrowup"||k==="w") beatJump();
    }
  });
}

async function boot(){
  bindUI();
  setupNerdAudio();
  timerRender();
  timerTick();
  requestAnimationFrame(gameLoop);

  const remembered = localStorage.getItem("studyos_nerd_unlocked")==="1";
  if(remembered){
    if(el("rememberUnlock")) el("rememberUnlock").checked = true;
    APP.audioUnlocked = true;
    if(el("nerdPanel")) el("nerdPanel").classList.remove("hidden");
  }

  const { data } = await sb.auth.getSession();
  APP.user = data?.session?.user || null;
  setAuthedUI();

  if(APP.user){
    await ensureSettingsRow();
    await loadSettings();
    await fetchNotes();
    await fetchLinks();
  }else{
    setEditorEnabled(false);
    renderNotesList();
  }

  sb.auth.onAuthStateChange(async (_event, session)=>{
    APP.user = session?.user || null;
    setAuthedUI();
    fillEditor(null);
    renderNotesList();
    if(APP.user){
      await ensureSettingsRow();
      await loadSettings();
      await fetchNotes();
      await fetchLinks();
    }
  });

  initGraph();
  setGameMode("snake");
  showTab("notes");
}

boot();
</script>
</body>
</html>
