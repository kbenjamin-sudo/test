<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StudyOS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg0:#05060a;
  --bg1:#0b0f1d;
  --card:rgba(255,255,255,.06);
  --card2:rgba(255,255,255,.09);
  --stroke:rgba(255,255,255,.12);
  --text:#eef2ff;
  --muted:rgba(238,242,255,.68);
  --muted2:rgba(238,242,255,.48);
  --a:#70f0ff;
  --b:#ff7ad9;
  --c:#7cff86;
  --d:#ffd36b;
  --bad:#ff6b6b;
  --good:#7cffc1;
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --r:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 550px at 18% 20%, rgba(112,240,255,.16), transparent 60%),
    radial-gradient(780px 540px at 76% 24%, rgba(255,122,217,.14), transparent 60%),
    radial-gradient(820px 600px at 52% 88%, rgba(124,255,134,.10), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden;
}
#app{max-width:1180px;margin:26px auto 40px;padding:0 18px}
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:14px;
  padding:14px 16px;border:1px solid var(--stroke);border-radius:22px;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  box-shadow:var(--shadow);
  position:sticky;top:14px;z-index:40;
  backdrop-filter: blur(14px);
}
.brand{display:flex;align-items:center;gap:10px}
.logo{
  width:34px;height:34px;border-radius:12px;
  background:conic-gradient(from 210deg, rgba(112,240,255,.95), rgba(255,122,217,.9), rgba(124,255,134,.9), rgba(255,211,107,.9), rgba(112,240,255,.95));
  box-shadow:0 0 0 1px rgba(255,255,255,.14) inset, 0 14px 40px rgba(112,240,255,.12);
}
.brand h1{margin:0;font-size:14px;letter-spacing:.6px;font-weight:900;text-transform:uppercase}
.brand .sub{font-size:12px;color:var(--muted2);font-weight:700;margin-top:2px}
.pills{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{
  display:flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.04);
  font-weight:800;font-size:12px;color:var(--muted);
}
.dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.22)}
.dot.good{background:rgba(124,255,193,.92)}
.dot.bad{background:rgba(255,107,107,.92)}
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:18px 2px 14px}
.tab{
  padding:10px 12px;border-radius:999px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.04);
  font-weight:900;font-size:12px;color:var(--muted);
  cursor:pointer;user-select:none;
  transition:transform .12s ease, background .12s ease, border-color .12s ease;
}
.tab:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
.tab.active{background:linear-gradient(135deg, rgba(112,240,255,.18), rgba(255,122,217,.12));border-color:rgba(255,255,255,.18);color:var(--text)}
.grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{
  border:1px solid var(--stroke);border-radius:var(--r);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card .hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 14px 10px}
.card .title{font-weight:900;letter-spacing:.3px}
.card .body{padding:0 14px 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;border-radius:12px;
  font-weight:900;font-size:12px;
  cursor:pointer;user-select:none;
  transition:transform .12s ease, background .12s ease, border-color .12s ease;
}
.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
.btn.primary{background:linear-gradient(135deg, rgba(112,240,255,.22), rgba(255,122,217,.18));border-color:rgba(255,255,255,.2)}
.btn.good{background:linear-gradient(135deg, rgba(124,255,193,.18), rgba(112,240,255,.12))}
.btn.bad{background:linear-gradient(135deg, rgba(255,107,107,.22), rgba(255,211,107,.10))}
.btn.ghost{background:transparent}
.input, select, textarea{
  width:100%;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(10,14,26,.55);
  color:var(--text);
  border-radius:14px;
  padding:11px 12px;
  outline:none;
  font-weight:800;
}
textarea{min-height:210px;resize:vertical;line-height:1.35}
.small{font-size:12px;color:var(--muted2);font-weight:800}
.kbd{padding:3px 7px;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-weight:900;font-size:11px;color:var(--muted)}
.split{display:grid;grid-template-columns:1fr 1.15fr;gap:14px}
@media (max-width:980px){.split{grid-template-columns:1fr}}
.list{display:flex;flex-direction:column;gap:10px}
.noteItem{
  padding:11px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  cursor:pointer;
}
.noteItem:hover{background:rgba(255,255,255,.06)}
.noteItem.active{background:linear-gradient(135deg, rgba(112,240,255,.14), rgba(255,122,217,.10));border-color:rgba(255,255,255,.18)}
.noteTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.tag{
  padding:5px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  font-weight:900;font-size:11px;color:var(--muted);
  white-space:nowrap;
}
.tag.a{border-color:rgba(112,240,255,.25)}
.tag.b{border-color:rgba(255,122,217,.25)}
.tag.c{border-color:rgba(124,255,134,.25)}
.tag.d{border-color:rgba(255,211,107,.25)}
.hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
.toastWrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:100}
.toast{
  max-width:360px;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(8,10,18,.72);
  box-shadow:0 18px 70px rgba(0,0,0,.6);
  backdrop-filter: blur(14px);
}
.toast .t{font-weight:900}
.toast .m{color:var(--muted);font-weight:800;font-size:12px;margin-top:4px}
.modalBack{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;z-index:120;
  padding:18px;
}
.modal{
  width:min(720px, 96vw);
  border-radius:22px;border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  box-shadow:0 22px 90px rgba(0,0,0,.7);
  overflow:hidden;
  backdrop-filter: blur(18px);
}
.modal .mh{padding:14px 14px 12px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.modal .mb{padding:0 14px 14px}
.gameGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:980px){.gameGrid{grid-template-columns:1fr}}
.gameCard{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  border-radius:18px;
  padding:12px;
}
.gameCard h3{margin:0 0 6px;font-size:14px;font-weight:900}
.gameCard p{margin:0;color:var(--muted);font-weight:800;font-size:12px;line-height:1.3}
.canvasWrap{border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);overflow:hidden}
#graphCanvas{width:100%;height:420px;display:block}
.timerBig{font-size:54px;font-weight:900;letter-spacing:1px}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>StudyOS</h1>
        <div class="sub" id="subline">Notes • Graph • Games • Timer</div>
      </div>
    </div>
    <div class="pills">
      <div class="pill"><div class="dot" id="dotAuth"></div><span id="authLabel">Guest</span></div>
      <div class="pill"><span id="schoolLabel">School: —</span></div>
      <div class="pill"><span class="kbd">Shift</span><span class="kbd">Click</span><span class="small">to link notes</span></div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-view="notesView">Notes</div>
    <div class="tab" data-view="graphView">Graph</div>
    <div class="tab" data-view="gamesView">Games</div>
    <div class="tab" data-view="timerView">Timer</div>
    <div class="tab" data-view="settingsView">Settings</div>
  </div>

  <div id="notesView" class="view">
    <div class="card">
      <div class="hd">
        <div class="title">Your notes</div>
        <div class="row">
          <input class="input" id="noteSearch" placeholder="Search notes…" style="width:260px">
          <button class="btn primary" id="newNoteBtn">New</button>
        </div>
      </div>
      <div class="body">
        <div class="split">
          <div>
            <div class="row" style="margin-bottom:10px">
              <select id="filterSubject" style="flex:1;min-width:180px"></select>
              <button class="btn" id="refreshBtn">Refresh</button>
            </div>
            <div class="list" id="notesList"></div>
            <div class="small" style="margin-top:10px">Tip: <span class="kbd">Ctrl</span> + <span class="kbd">S</span> saves. <span class="kbd">Ctrl</span> + <span class="kbd">P</span> exports PDF.</div>
          </div>
          <div>
            <div class="row" style="margin-bottom:10px">
              <input class="input" id="noteTitle" placeholder="Title">
            </div>
            <div class="row" style="margin-bottom:10px">
              <select id="noteSubject" style="flex:1;min-width:180px"></select>
              <select id="noteGrade" style="width:160px"></select>
              <select id="noteSchool" style="width:220px"></select>
            </div>
            <textarea id="noteContent" placeholder="Write it out…"></textarea>
            <div class="row" style="margin-top:10px;justify-content:space-between">
              <div class="row">
                <button class="btn good" id="saveNoteBtn">Save</button>
                <button class="btn bad" id="deleteNoteBtn">Delete</button>
                <button class="btn" id="duplicateNoteBtn">Duplicate</button>
              </div>
              <div class="row">
                <button class="btn" id="pdfBtn">Export PDF</button>
              </div>
            </div>
            <div class="small" id="noteMeta" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="graphView" class="view" style="display:none">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">Graph</div>
          <div class="row">
            <button class="btn" id="layoutBtn">Auto layout</button>
            <button class="btn" id="clearLinksBtn">Clear links</button>
          </div>
        </div>
        <div class="body">
          <div class="canvasWrap">
            <canvas id="graphCanvas" width="1100" height="420"></canvas>
          </div>
          <div class="small" style="margin-top:10px">Click a note to focus. <span class="kbd">Shift</span> + click a second note to link. Drag to rearrange.</div>
        </div>
      </div>
      <div class="card">
        <div class="hd">
          <div class="title">Focused note</div>
          <div class="row">
            <button class="btn" id="openFocusedBtn">Open in editor</button>
          </div>
        </div>
        <div class="body">
          <div class="small" id="focusSub"></div>
          <div class="hr"></div>
          <div id="focusTitle" style="font-weight:900;font-size:16px"></div>
          <div class="small" id="focusText" style="margin-top:8px;white-space:pre-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="gamesView" class="view" style="display:none">
    <div class="card">
      <div class="hd">
        <div class="title">Games</div>
        <div class="row">
          <button class="btn" id="toggleSfxBtn">SFX: On</button>
        </div>
      </div>
      <div class="body">
        <div class="gameGrid">
          <div class="gameCard">
            <h3>Neon Snake+</h3>
            <p>Classic snake, but speed ramps, neon boost, and a score combo.</p>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-game="snake">Play</button>
            </div>
          </div>
          <div class="gameCard">
            <h3>Mini Tetris</h3>
            <p>Drop blocks and clear lines. Simple, fast, satisfying.</p>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-game="tetris">Play</button>
            </div>
          </div>
          <div class="gameCard">
            <h3>Runner</h3>
            <p>Jump over obstacles. Survive longer, get faster.</p>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-game="runner">Play</button>
            </div>
          </div>
          <div class="gameCard">
            <h3>Memory Match</h3>
            <p>Flip tiles. Match pairs. Beat your time.</p>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-game="memory">Play</button>
            </div>
          </div>
          <div class="gameCard">
            <h3>Rapid Click</h3>
            <p>30 seconds. How many clicks can you stack?</p>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-game="click">Play</button>
            </div>
          </div>
          <div class="gameCard">
            <h3>Zen Break</h3>
            <p>Chill mode: tap bubbles, no timer, just vibes.</p>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" data-game="zen">Play</button>
            </div>
          </div>
        </div>
        <div class="small" style="margin-top:10px">All games work offline. Music is optional and lives in a locked section.</div>
      </div>
    </div>
  </div>

  <div id="timerView" class="view" style="display:none">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">Timer</div>
          <div class="row">
            <button class="btn" data-preset="25">Pomodoro 25</button>
            <button class="btn" data-preset="50">Deep 50</button>
            <button class="btn" data-preset="10">Quick 10</button>
          </div>
        </div>
        <div class="body">
          <div class="timerBig" id="timerDisplay">25:00</div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="timerStart">Start</button>
            <button class="btn" id="timerPause">Pause</button>
            <button class="btn bad" id="timerReset">Reset</button>
          </div>
          <div class="small" style="margin-top:10px">Shortcuts: <span class="kbd">Space</span> start/pause, <span class="kbd">R</span> reset (when Timer tab is open)</div>
        </div>
      </div>
      <div class="card">
        <div class="hd">
          <div class="title">Session notes</div>
          <div class="row">
            <button class="btn" id="timerLogBtn">Log focus note</button>
          </div>
        </div>
        <div class="body">
          <textarea id="timerNotes" placeholder="What are you working on right now?"></textarea>
          <div class="small" style="margin-top:10px">This saves to your settings if you’re signed in.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="settingsView" class="view" style="display:none">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">Account</div>
          <div class="row">
            <button class="btn" id="signOutBtn" style="display:none">Sign out</button>
          </div>
        </div>
        <div class="body">
          <div class="small">Sign in to sync notes across devices. Guest mode saves locally in this browser.</div>
          <div class="hr"></div>
          <div class="row" style="align-items:flex-start">
            <div style="flex:1;min-width:220px">
              <input class="input" id="emailInput" placeholder="Email">
            </div>
            <div style="flex:1;min-width:220px">
              <input class="input" id="passInput" placeholder="Password" type="password">
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="signInBtn">Sign in</button>
            <button class="btn" id="signUpBtn">Sign up</button>
            <button class="btn" id="importLocalBtn">Import local notes</button>
          </div>
          <div class="small" id="acctStatus" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">Preferences</div>
          <div class="row">
            <button class="btn" id="exportLocalBtn">Export local backup</button>
          </div>
        </div>
        <div class="body">
          <div class="row">
            <div style="flex:1;min-width:220px">
              <div class="small" style="margin-bottom:8px">School</div>
              <select id="currentSchool"></select>
            </div>
            <div style="flex:1;min-width:220px">
              <div class="small" style="margin-bottom:8px">Theme</div>
              <select id="themeSelect"></select>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn good" id="saveSettingsBtn">Save preferences</button>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="small">Settings for nerds</div>
            <button class="btn" id="openNerdBtn">Open</button>
          </div>
          <div class="small" style="margin-top:8px">This section is password-locked. It only affects your browser/account.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toastWrap" id="toastWrap"></div>

<div class="modalBack" id="modalBack">
  <div class="modal" id="modalBox">
    <div class="mh">
      <div class="title" id="modalTitle">Game</div>
      <button class="btn" id="modalClose">Close</button>
    </div>
    <div class="mb" id="modalBody"></div>
  </div>
</div>

<div class="modalBack" id="nerdBack">
  <div class="modal">
    <div class="mh">
      <div class="title">Settings for nerds</div>
      <button class="btn" id="nerdClose">Close</button>
    </div>
    <div class="mb">
      <div id="nerdLocked">
        <div class="small">Enter passcode to unlock.</div>
        <div class="row" style="margin-top:10px">
          <input class="input" id="nerdPass" placeholder="Passcode" type="password" style="max-width:220px">
          <button class="btn primary" id="nerdUnlockBtn">Unlock</button>
        </div>
        <div class="small" id="nerdMsg" style="margin-top:8px"></div>
      </div>
      <div id="nerdUnlocked" style="display:none">
        <div class="row" style="align-items:flex-start">
          <div style="flex:1;min-width:240px">
            <div class="small" style="margin-bottom:8px">Personal audio</div>
            <select id="audioTrack"></select>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="audioToggle">Play</button>
              <button class="btn" id="audioMute">Mute</button>
            </div>
            <div class="row" style="margin-top:10px;align-items:center">
              <div class="small" style="min-width:72px">Volume</div>
              <input id="audioVol" type="range" min="0" max="1" step="0.01" style="flex:1">
            </div>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="audioLoopBtn">Loop: On</button>
              <button class="btn" id="audioSaveBtn">Save audio prefs</button>
            </div>
            <div class="small" style="margin-top:10px">Shortcut: <span class="kbd">Alt</span> + <span class="kbd">M</span> quick mute/unmute (after unlock).</div>
          </div>
          <div style="flex:1;min-width:240px">
            <div class="small" style="margin-bottom:8px">SFX</div>
            <div class="row">
              <button class="btn" id="sfxToggleBtn">Game SFX: On</button>
            </div>
            <div class="small" style="margin-top:10px">SFX are tiny beeps generated in-browser, no extra files.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="pdfPrint" style="position:fixed;left:-9999px;top:-9999px;width:720px;padding:24px;background:#ffffff;color:#111111;font-family:Inter,system-ui">
  <div style="font-size:22px;font-weight:900" id="pdfTitle"></div>
  <div style="margin-top:6px;font-size:12px;font-weight:800;color:#444" id="pdfMeta"></div>
  <div style="margin-top:14px;white-space:pre-wrap;line-height:1.35" id="pdfBody"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
const SUPABASE_URL = "https://cgmazcvmpcgistoimqlw.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnbWF6Y3ZtcGNnaXN0b2ltcWx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjI2NjMsImV4cCI6MjA4NTc5ODY2M30.iIoIyb4bBnOR1zEjZ6ORpLsfJX77YWM1LyYoo_NrUuc"

const AUDIO_TRACKS = [
  {name:"entry four (instrumental)", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/jaydes%20-%20entry%20four%20(instrumental)%20(prod.%20khozy).mp3"},
  {name:"convenience (fixed instrumental)", url:"https://cgmazcvmpcgistoimqlw.supabase.co/storage/v1/object/public/assets/jaydes%20%20convenience%20(fixed%20instrumental).mp3"}
]

const SUBJECTS = ["All","Math","Science","English","History","Language","Computer Science","Art","Music","Health","Other"]
const GRADES = ["—","Period 1","Period 2","Period 3","Period 4","Period 5","Period 6","Period 7","Period 8","Honors","AP","IB"]
const SCHOOLS = ["Salesianum","St. Mark's","St. Peter","Charter","Public","Other"]

const THEMES = {
  "Aurora Neon": {
    bg0:"#05060a", bg1:"#0b0f1d", a:"#70f0ff", b:"#ff7ad9", c:"#7cff86", d:"#ffd36b"
  },
  "Mint Twilight": {
    bg0:"#04080b", bg1:"#061225", a:"#65ffe4", b:"#a48bff", c:"#7cffc1", d:"#ffe07a"
  },
  "Mono Night": {
    bg0:"#06060a", bg1:"#0a0a14", a:"#cfd4ff", b:"#9aa2ff", c:"#7cffc1", d:"#ffd36b"
  }
}

const el = (id) => document.getElementById(id)
const toastWrap = el("toastWrap")
const supabase = (window.supabase && typeof window.supabase.createClient === "function") ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null

let activeView = "notesView"
let user = null
let notes = []
let links = new Set()
let selectedId = null
let focusedId = null

let settings = {
  current_school: SCHOOLS[0],
  ui: { theme: "Aurora Neon" },
  timer: { preset: 25, notes: "" },
  game: { sfx: true },
  audio: { unlocked: false, enabled: false, track: 0, volume: 0.35, loop: true, quickMute: true }
}

let audioEl = new Audio()
audioEl.crossOrigin = "anonymous"

function toast(title, msg) {
  const d = document.createElement("div")
  d.className = "toast"
  d.innerHTML = '<div class="t">'+escapeHtml(title)+'</div><div class="m">'+escapeHtml(msg)+'</div>'
  toastWrap.appendChild(d)
  setTimeout(() => {
    d.style.opacity = "0"
    d.style.transform = "translateY(6px)"
    setTimeout(() => d.remove(), 240)
  }, 2600)
}

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))
}

function setTabs() {
  document.querySelectorAll(".tab").forEach(t => {
    t.classList.toggle("active", t.dataset.view === activeView)
  })
  document.querySelectorAll(".view").forEach(v => {
    v.style.display = (v.id === activeView) ? "" : "none"
  })
}

document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => {
    activeView = t.dataset.view
    setTabs()
    if (activeView === "graphView") requestAnimationFrame(drawGraph)
  })
})

function applyTheme() {
  const themeName = settings.ui?.theme || "Aurora Neon"
  const th = THEMES[themeName] || THEMES["Aurora Neon"]
  document.documentElement.style.setProperty("--bg0", th.bg0)
  document.documentElement.style.setProperty("--bg1", th.bg1)
  document.documentElement.style.setProperty("--a", th.a)
  document.documentElement.style.setProperty("--b", th.b)
  document.documentElement.style.setProperty("--c", th.c)
  document.documentElement.style.setProperty("--d", th.d)
}

function setAuthUI() {
  el("authLabel").textContent = user ? (user.email || "Signed in") : "Guest"
  el("dotAuth").className = "dot " + (user ? "good" : "")
  el("signOutBtn").style.display = user ? "" : "none"
  el("acctStatus").textContent = user ? "Sync is on for this account." : "Guest mode: saves locally in this browser."
  el("schoolLabel").textContent = "School: " + (settings.current_school || "—")
}

function seedDropdowns() {
  const subjectSel = el("noteSubject")
  const filterSel = el("filterSubject")
  subjectSel.innerHTML = ""
  filterSel.innerHTML = ""
  SUBJECTS.forEach((s,i) => {
    const o1 = document.createElement("option")
    o1.value = s
    o1.textContent = s
    subjectSel.appendChild(o1)
    const o2 = document.createElement("option")
    o2.value = s
    o2.textContent = s
    filterSel.appendChild(o2)
  })
  el("noteGrade").innerHTML = GRADES.map(g => '<option value="'+escapeHtml(g)+'">'+escapeHtml(g)+'</option>').join("")
  el("noteSchool").innerHTML = SCHOOLS.map(s => '<option value="'+escapeHtml(s)+'">'+escapeHtml(s)+'</option>').join("")
  el("currentSchool").innerHTML = SCHOOLS.map(s => '<option value="'+escapeHtml(s)+'">'+escapeHtml(s)+'</option>').join("")
  el("themeSelect").innerHTML = Object.keys(THEMES).map(n => '<option value="'+escapeHtml(n)+'">'+escapeHtml(n)+'</option>').join("")
}

seedDropdowns()

function loadLocal() {
  try {
    const raw = localStorage.getItem("studyos_local")
    if (!raw) return
    const obj = JSON.parse(raw)
    if (obj.notes && Array.isArray(obj.notes)) notes = obj.notes
    if (obj.links && Array.isArray(obj.links)) links = new Set(obj.links)
    if (obj.settings) settings = deepMerge(settings, obj.settings)
  } catch (e) {}
}

function saveLocal() {
  try {
    localStorage.setItem("studyos_local", JSON.stringify({notes, links:[...links], settings}))
  } catch (e) {}
}

function deepMerge(base, next) {
  const out = Array.isArray(base) ? [...base] : {...base}
  for (const k in next) {
    const a = base?.[k]
    const b = next?.[k]
    if (a && b && typeof a === "object" && typeof b === "object" && !Array.isArray(a) && !Array.isArray(b)) out[k] = deepMerge(a,b)
    else out[k] = b
  }
  return out
}

function fmtTime(ts) {
  try {
    const d = new Date(ts)
    return d.toLocaleString()
  } catch (e) {
    return ""
  }
}

function tagClass(subject) {
  const s = String(subject || "").toLowerCase()
  if (s.includes("math")) return "a"
  if (s.includes("science")) return "c"
  if (s.includes("english") || s.includes("language")) return "b"
  if (s.includes("history")) return "d"
  return ""
}

function renderNotesList() {
  const q = el("noteSearch").value.trim().toLowerCase()
  const f = el("filterSubject").value
  const wrap = el("notesList")
  wrap.innerHTML = ""
  const items = notes
    .filter(n => (f === "All" || (n.subject || "Other") === f))
    .filter(n => !q || (n.title||"").toLowerCase().includes(q) || (n.content||"").toLowerCase().includes(q))
    .sort((a,b) => new Date(b.updated_at||b.created_at||0) - new Date(a.updated_at||a.created_at||0))

  if (!items.length) {
    const empty = document.createElement("div")
    empty.className = "small"
    empty.textContent = "No notes yet. Hit New."
    wrap.appendChild(empty)
    return
  }

  items.forEach(n => {
    const d = document.createElement("div")
    d.className = "noteItem" + (n.id === selectedId ? " active" : "")
    const subj = n.subject || "Other"
    d.innerHTML = '<div class="noteTop"><div style="font-weight:900">'+escapeHtml(n.title||"Untitled")+'</div><div class="tag '+tagClass(subj)+'">'+escapeHtml(subj)+'</div></div><div class="small" style="margin-top:6px">'+escapeHtml((n.school||settings.current_school||"") + (n.grade && n.grade!=="—" ? " • "+n.grade : ""))+'</div>'
    d.addEventListener("click", () => {
      openNote(n.id)
    })
    wrap.appendChild(d)
  })
}

function setEditor(note) {
  el("noteTitle").value = note?.title || ""
  el("noteContent").value = note?.content || ""
  el("noteSubject").value = note?.subject || "Other"
  el("noteGrade").value = note?.grade || "—"
  el("noteSchool").value = note?.school || settings.current_school || SCHOOLS[0]
  if (!note) {
    el("noteMeta").textContent = ""
    return
  }
  const meta = []
  if (note.created_at) meta.push("Created: " + fmtTime(note.created_at))
  if (note.updated_at) meta.push("Updated: " + fmtTime(note.updated_at))
  el("noteMeta").textContent = meta.join(" • ")
}

function openNote(id) {
  selectedId = id
  const n = notes.find(x => x.id === id)
  setEditor(n)
  renderNotesList()
  setFocused(id)
}

function newNote() {
  const id = crypto.randomUUID()
  const now = new Date().toISOString()
  const n = {
    id,
    user_id: user?.id || null,
    title: "Untitled",
    subject: el("filterSubject").value !== "All" ? el("filterSubject").value : "Other",
    grade: "—",
    school: settings.current_school || SCHOOLS[0],
    content: "",
    created_at: now,
    updated_at: now
  }
  notes.unshift(n)
  selectedId = id
  setEditor(n)
  renderNotesList()
  saveLocal()
  toast("New note", "Made a fresh note.")
}

function duplicateNote() {
  const src = notes.find(n => n.id === selectedId)
  if (!src) return
  const id = crypto.randomUUID()
  const now = new Date().toISOString()
  const copy = {...src, id, title: (src.title||"Untitled") + " (copy)", created_at: now, updated_at: now}
  notes.unshift(copy)
  selectedId = id
  setEditor(copy)
  renderNotesList()
  saveLocal()
  toast("Duplicated", "Copied your note.")
}

function deleteNote() {
  const id = selectedId
  if (!id) return
  const idx = notes.findIndex(n => n.id === id)
  if (idx === -1) return
  notes.splice(idx,1)
  const toRemove = []
  links.forEach(k => {
    const [a,b] = k.split("|")
    if (a === id || b === id) toRemove.push(k)
  })
  toRemove.forEach(k => links.delete(k))
  selectedId = notes[0]?.id || null
  setEditor(notes.find(n => n.id === selectedId) || null)
  renderNotesList()
  saveLocal()
  if (user) deleteNoteRemote(id)
  toast("Deleted", "Gone.")
}

function readEditorIntoNote() {
  const id = selectedId
  if (!id) return null
  const n = notes.find(x => x.id === id)
  if (!n) return null
  n.title = el("noteTitle").value.trim() || "Untitled"
  n.content = el("noteContent").value
  n.subject = el("noteSubject").value || "Other"
  n.grade = el("noteGrade").value || "—"
  n.school = el("noteSchool").value || settings.current_school || SCHOOLS[0]
  n.updated_at = new Date().toISOString()
  return n
}

async function saveNote() {
  const n = readEditorIntoNote()
  if (!n) return
  renderNotesList()
  saveLocal()
  if (!user) {
    toast("Saved locally", "Sign in to sync across devices.")
    return
  }
  const payload = {
    id: n.id,
    user_id: user.id,
    title: n.title,
    content: n.content,
    subject: n.subject,
    grade: n.grade,
    school: n.school,
    updated_at: n.updated_at
  }
  const { error } = await supabase.from("notes").upsert(payload, { onConflict: "id" })
  if (error) {
    toast("Sync failed", String(error.message || error))
    return
  }
  toast("Saved", "Synced to your account.")
  await fetchNotes()
}

async function deleteNoteRemote(id) {
  const { error } = await supabase.from("notes").delete().eq("id", id)
  if (error) toast("Remote delete failed", String(error.message || error))
  const r = await supabase.from("note_links").delete().eq("user_id", user.id).or("note_a.eq."+id+",note_b.eq."+id)
  if (r.error) toast("Links delete failed", String(r.error.message || r.error))
}

async function fetchNotes() {
  if (!user) return
  const { data, error } = await supabase.from("notes")
    .select("id,title,content,subject,grade,school,created_at,updated_at")
    .order("updated_at", { ascending:false })
  if (error) {
    toast("Fetch failed", String(error.message || error))
    return
  }
  notes = (data || []).map(n => ({
    ...n,
    user_id: user.id
  }))
  await fetchLinks()
  selectedId = notes[0]?.id || null
  setEditor(notes.find(n => n.id === selectedId) || null)
  renderNotesList()
  saveLocal()
  requestAnimationFrame(drawGraph)
}

async function fetchLinks() {
  if (!user) return
  const { data, error } = await supabase.from("note_links").select("note_a,note_b")
  if (error) {
    toast("Links fetch failed", String(error.message || error))
    return
  }
  links = new Set((data||[]).map(x => (x.note_a < x.note_b ? x.note_a+"|"+x.note_b : x.note_b+"|"+x.note_a)))
  saveLocal()
}

async function upsertLink(a,b) {
  if (!user) {
    saveLocal()
    return
  }
  const note_a = a < b ? a : b
  const note_b = a < b ? b : a
  const { error } = await supabase.from("note_links").upsert({ user_id: user.id, note_a, note_b }, { onConflict: "user_id,note_a,note_b" })
  if (error) toast("Link sync failed", String(error.message || error))
}

async function clearLinks() {
  links.clear()
  saveLocal()
  if (user) {
    const { error } = await supabase.from("note_links").delete().neq("user_id", "00000000-0000-0000-0000-000000000000")
    if (error) toast("Clear failed", String(error.message || error))
  }
  requestAnimationFrame(drawGraph)
}

function setFocused(id) {
  focusedId = id
  const n = notes.find(x => x.id === id)
  el("focusTitle").textContent = n ? (n.title || "Untitled") : "—"
  el("focusSub").textContent = n ? ((n.subject||"Other") + " • " + (n.school||settings.current_school||"")) : ""
  el("focusText").textContent = n ? (String(n.content||"").slice(0, 1400) + (String(n.content||"").length>1400 ? "…" : "")) : ""
}

el("openFocusedBtn").addEventListener("click", () => {
  if (!focusedId) return
  activeView = "notesView"
  setTabs()
  openNote(focusedId)
})

el("newNoteBtn").addEventListener("click", newNote)
el("saveNoteBtn").addEventListener("click", saveNote)
el("deleteNoteBtn").addEventListener("click", deleteNote)
el("duplicateNoteBtn").addEventListener("click", duplicateNote)
el("refreshBtn").addEventListener("click", () => user ? fetchNotes() : toast("Guest", "Sign in to sync, or keep using local mode."))
el("noteSearch").addEventListener("input", renderNotesList)
el("filterSubject").addEventListener("change", renderNotesList)

document.addEventListener("keydown", (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
    e.preventDefault()
    saveNote()
  }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "p") {
    e.preventDefault()
    exportPDF()
  }
  if (settings.audio?.unlocked && (e.altKey && e.key.toLowerCase() === "m")) {
    e.preventDefault()
    quickMute()
  }
})

function exportPDF() {
  const n = readEditorIntoNote()
  if (!n) return
  el("pdfTitle").textContent = n.title || "Untitled"
  el("pdfMeta").textContent = (n.subject||"Other") + " • " + (n.school||settings.current_school||"") + (n.grade && n.grade!=="—" ? " • " + n.grade : "")
  el("pdfBody").textContent = n.content || ""
  const opt = {
    margin: 0.4,
    filename: (n.title || "note").replace(/[^a-z0-9\- _]+/gi,"").slice(0,60) + ".pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
  }
  if (typeof html2pdf === "undefined") { toast("PDF export unavailable", "The PDF library didn’t load."); return }
  html2pdf().set(opt).from(el("pdfPrint")).save()
}

el("pdfBtn").addEventListener("click", exportPDF)

async function ensureSettingsRow() {
  if (!user) return
  const { data, error } = await supabase.from("user_settings").select("*").eq("user_id", user.id).maybeSingle()
  if (error) {
    toast("Settings error", String(error.message || error))
    return
  }
  if (!data) {
    const payload = {
      user_id: user.id,
      current_school: settings.current_school,
      ui: settings.ui,
      timer: settings.timer,
      game: settings.game,
      audio: settings.audio
    }
    const r = await supabase.from("user_settings").insert(payload)
    if (r.error) toast("Settings init failed", String(r.error.message || r.error))
    return
  }
  settings = deepMerge(settings, data)
  applyTheme()
  setAuthUI()
  el("currentSchool").value = settings.current_school || SCHOOLS[0]
  el("themeSelect").value = settings.ui?.theme || "Aurora Neon"
  el("timerNotes").value = settings.timer?.notes || ""
  settings.audio = deepMerge(settings.audio || {}, data.audio || {})
  applyAudioPrefs()
  saveLocal()
}

async function saveSettingsRemote() {
  if (!user) {
    saveLocal()
    toast("Saved locally", "Sign in to sync settings.")
    return
  }
  const payload = {
    user_id: user.id,
    current_school: settings.current_school,
    ui: settings.ui,
    timer: settings.timer,
    game: settings.game,
    audio: settings.audio,
    updated_at: new Date().toISOString()
  }
  const { error } = await supabase.from("user_settings").upsert(payload, { onConflict: "user_id" })
  if (error) {
    toast("Save failed", String(error.message || error))
    return
  }
  toast("Saved", "Preferences synced.")
}

el("saveSettingsBtn").addEventListener("click", () => {
  settings.current_school = el("currentSchool").value
  settings.ui.theme = el("themeSelect").value
  settings.timer.notes = el("timerNotes").value
  applyTheme()
  setAuthUI()
  saveLocal()
  saveSettingsRemote()
})

el("currentSchool").addEventListener("change", () => {
  el("schoolLabel").textContent = "School: " + el("currentSchool").value
})

async function signIn() {
  if (!supabase) { toast("Sync unavailable", "Sign-in is disabled (sync library blocked/offline)."); return }

  const email = el("emailInput").value.trim()
  const password = el("passInput").value
  if (!email || !password) {
    toast("Missing", "Add email + password.")
    return
  }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) {
    toast("Sign in failed", String(error.message || error))
    return
  }
  user = data.user
  toast("Signed in", "Sync is on.")
  await ensureSettingsRow()
  await fetchNotes()
  setAuthUI()
}

async function signUp() {
  if (!supabase) { toast("Sync unavailable", "Sign-up is disabled (sync library blocked/offline)."); return }

  const email = el("emailInput").value.trim()
  const password = el("passInput").value
  if (!email || !password) {
    toast("Missing", "Add email + password.")
    return
  }
  const { data, error } = await supabase.auth.signUp({ email, password })
  if (error) {
    toast("Sign up failed", String(error.message || error))
    return
  }
  toast("Signed up", "If email confirmation is on, check your inbox.")
  user = data.user
  await ensureSettingsRow()
  setAuthUI()
}

async function signOut() {
  if (!supabase) { user = null; setAuthUI(); toast("Signed out", "Back to guest mode."); return }

  await supabase.auth.signOut()
  user = null
  setAuthUI()
  toast("Signed out", "Back to guest mode.")
}

el("signInBtn").addEventListener("click", signIn)
el("signUpBtn").addEventListener("click", signUp)
el("signOutBtn").addEventListener("click", signOut)

el("importLocalBtn").addEventListener("click", async () => {
  if (!user) {
    toast("Sign in first", "This imports local notes into your account.")
    return
  }
  const localRaw = localStorage.getItem("studyos_local")
  if (!localRaw) {
    toast("No local notes", "Nothing to import.")
    return
  }
  let obj = null
  try { obj = JSON.parse(localRaw) } catch (e) {}
  const localNotes = (obj?.notes || []).filter(n => n && n.id && n.title !== undefined)
  if (!localNotes.length) {
    toast("No local notes", "Nothing to import.")
    return
  }
  const rows = localNotes.map(n => ({
    id: n.id,
    user_id: user.id,
    title: n.title || "Untitled",
    content: n.content || "",
    subject: n.subject || "Other",
    grade: n.grade || "—",
    school: n.school || settings.current_school || SCHOOLS[0],
    updated_at: n.updated_at || new Date().toISOString()
  }))
  const { error } = await supabase.from("notes").upsert(rows, { onConflict: "id" })
  if (error) {
    toast("Import failed", String(error.message || error))
    return
  }
  toast("Imported", "Local notes moved into your account.")
  await fetchNotes()
})

el("exportLocalBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify({notes, links:[...links], settings}, null, 2)], {type:"application/json"})
  const a = document.createElement("a")
  a.href = URL.createObjectURL(blob)
  a.download = "studyos_backup.json"
  a.click()
  setTimeout(() => URL.revokeObjectURL(a.href), 800)
})

function initSession() {
  loadLocal()
  applyTheme()
  el("currentSchool").value = settings.current_school || SCHOOLS[0]
  el("themeSelect").value = settings.ui?.theme || "Aurora Neon"
  el("timerNotes").value = settings.timer?.notes || ""
  setAuthUI()
  renderNotesList()
  setEditor(notes.find(n => n.id === selectedId) || null)

  if (!supabase) { toast("Sync unavailable", "Using local mode (sync library blocked/offline)."); return }

    supabase.auth.getSession().then(async (r) => {
    user = r.data?.session?.user || null
    setAuthUI()
    if (user) {
      await ensureSettingsRow()
      await fetchNotes()
    }
  })

  supabase.auth.onAuthStateChange(async (evt, sess) => {
    user = sess?.user || null
    setAuthUI()
    if (user) {
      await ensureSettingsRow()
      await fetchNotes()
    }
  })
}

initSession()

const canvas = el("graphCanvas")
const ctx = canvas.getContext("2d")
let nodes = []
let nodePos = new Map()
let dragging = null
let dragOff = {x:0,y:0}
let shiftLinkFrom = null

function rebuildGraph() {
  nodes = notes.map(n => ({
    id: n.id,
    title: n.title || "Untitled",
    subject: n.subject || "Other"
  }))
  const w = canvas.width
  const h = canvas.height
  nodes.forEach((n,i) => {
    if (!nodePos.has(n.id)) {
      const ang = (i / Math.max(1,nodes.length)) * Math.PI * 2
      nodePos.set(n.id, {
        x: w*0.5 + Math.cos(ang)*Math.min(w,h)*0.26 + (Math.random()-0.5)*30,
        y: h*0.5 + Math.sin(ang)*Math.min(w,h)*0.22 + (Math.random()-0.5)*30,
        vx:0, vy:0
      })
    }
  })
}

function colorFor(subject) {
  const s = String(subject||"").toLowerCase()
  if (s.includes("math")) return getCss("--a")
  if (s.includes("science")) return getCss("--c")
  if (s.includes("english") || s.includes("language")) return getCss("--b")
  if (s.includes("history")) return getCss("--d")
  return "rgba(255,255,255,.85)"
}

function getCss(v) {
  return getComputedStyle(document.documentElement).getPropertyValue(v).trim()
}

function toRgba(col, a) {
  col = String(col || "").trim()
  if (!col) return "rgba(255,255,255," + a + ")"
  if (col[0] === "#") {
    const hex = col.length === 4 ? ("#" + col[1] + col[1] + col[2] + col[2] + col[3] + col[3]) : col
    const n = parseInt(hex.slice(1), 16)
    const r = (n >> 16) & 255
    const g = (n >> 8) & 255
    const b = n & 255
    return "rgba(" + r + "," + g + "," + b + "," + a + ")"
  }
  const m = col.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i)
  if (m) return "rgba(" + m[1] + "," + m[2] + "," + m[3] + "," + a + ")"
  return col
}

function tickPhysics() {
  rebuildGraph()
  const w = canvas.width
  const h = canvas.height
  const center = {x:w*0.5,y:h*0.5}
  const k = Math.min(w,h) * 0.22
  const damp = 0.86

  nodes.forEach(a => {
    const pa = nodePos.get(a.id)
    const dx = center.x - pa.x
    const dy = center.y - pa.y
    pa.vx += dx * 0.00035
    pa.vy += dy * 0.00035
  })

  for (let i=0;i<nodes.length;i++) {
    for (let j=i+1;j<nodes.length;j++) {
      const a = nodes[i], b = nodes[j]
      const pa = nodePos.get(a.id), pb = nodePos.get(b.id)
      const dx = pb.x - pa.x
      const dy = pb.y - pa.y
      const dist = Math.hypot(dx,dy) || 1
      const rep = (k*k) / dist
      const nx = dx / dist
      const ny = dy / dist
      pa.vx -= nx * rep * 0.00008
      pa.vy -= ny * rep * 0.00008
      pb.vx += nx * rep * 0.00008
      pb.vy += ny * rep * 0.00008
    }
  }

  links.forEach(kv => {
    const [a,b] = kv.split("|")
    const pa = nodePos.get(a), pb = nodePos.get(b)
    if (!pa || !pb) return
    const dx = pb.x - pa.x
    const dy = pb.y - pa.y
    const dist = Math.hypot(dx,dy) || 1
    const target = k * 1.1
    const pull = (dist - target) * 0.0011
    const nx = dx / dist
    const ny = dy / dist
    pa.vx += nx * pull
    pa.vy += ny * pull
    pb.vx -= nx * pull
    pb.vy -= ny * pull
  })

  nodes.forEach(n => {
    const p = nodePos.get(n.id)
    if (dragging === n.id) {
      p.vx *= 0.35
      p.vy *= 0.35
    } else {
      p.x += p.vx
      p.y += p.vy
      p.vx *= damp
      p.vy *= damp
      p.x = Math.max(28, Math.min(w-28, p.x))
      p.y = Math.max(28, Math.min(h-28, p.y))
    }
  })
}

function drawGraph() {
  if (activeView !== "graphView") return
  tickPhysics()
  ctx.clearRect(0,0,canvas.width,canvas.height)

  const glowA = getCss("--a")
  ctx.fillStyle = "rgba(0,0,0,.15)"
  ctx.fillRect(0,0,canvas.width,canvas.height)

  links.forEach(kv => {
    const [a,b] = kv.split("|")
    const pa = nodePos.get(a), pb = nodePos.get(b)
    if (!pa || !pb) return
    const isFocus = (a === focusedId || b === focusedId)
    ctx.lineWidth = isFocus ? 2.2 : 1.2
    ctx.strokeStyle = isFocus ? "rgba(255,255,255,.38)" : "rgba(255,255,255,.18)"
    ctx.beginPath()
    ctx.moveTo(pa.x, pa.y)
    ctx.lineTo(pb.x, pb.y)
    ctx.stroke()
  })

  nodes.forEach(n => {
    const p = nodePos.get(n.id)
    const r = n.id === focusedId ? 16 : 13
    const col = colorFor(n.subject)
    ctx.beginPath()
    ctx.arc(p.x, p.y, r+7, 0, Math.PI*2)
    ctx.fillStyle = "rgba(0,0,0,.35)"
    ctx.fill()
    ctx.beginPath()
    ctx.arc(p.x, p.y, r+3, 0, Math.PI*2)
    ctx.fillStyle = toRgba(col, 0.18)
    ctx.fill()
    ctx.beginPath()
    ctx.arc(p.x, p.y, r, 0, Math.PI*2)
    ctx.fillStyle = "rgba(255,255,255,.92)"
    ctx.fill()
    ctx.beginPath()
    ctx.arc(p.x, p.y, r, 0, Math.PI*2)
    ctx.strokeStyle = "rgba(0,0,0,.22)"
    ctx.lineWidth = 1
    ctx.stroke()

    ctx.font = "900 12px Inter"
    ctx.fillStyle = "rgba(238,242,255,.92)"
    ctx.textAlign = "center"
    const title = n.title.length > 16 ? n.title.slice(0,16) + "…" : n.title
    ctx.fillText(title, p.x, p.y + r + 18)
  })

  requestAnimationFrame(drawGraph)
}

function hitNode(x,y) {
  let best = null
  let bestD = 1e9
  nodes.forEach(n => {
    const p = nodePos.get(n.id)
    if (!p) return
    const d = Math.hypot(x-p.x, y-p.y)
    if (d < 18 && d < bestD) {
      best = n.id
      bestD = d
    }
  })
  return best
}

function canvasPos(e) {
  const r = canvas.getBoundingClientRect()
  return {
    x: (e.clientX - r.left) * (canvas.width / r.width),
    y: (e.clientY - r.top) * (canvas.height / r.height)
  }
}

canvas.addEventListener("mousedown", (e) => {
  const p = canvasPos(e)
  const id = hitNode(p.x,p.y)
  if (!id) return
  dragging = id
  dragOff = {x:p.x - nodePos.get(id).x, y:p.y - nodePos.get(id).y}
})

window.addEventListener("mouseup", () => {
  dragging = null
})

canvas.addEventListener("mousemove", (e) => {
  if (!dragging) return
  const p = canvasPos(e)
  const pos = nodePos.get(dragging)
  pos.x = p.x - dragOff.x
  pos.y = p.y - dragOff.y
})

canvas.addEventListener("click", async (e) => {
  const p = canvasPos(e)
  const id = hitNode(p.x,p.y)
  if (!id) return
  if (e.shiftKey) {
    if (!shiftLinkFrom) {
      shiftLinkFrom = id
      setFocused(id)
      toast("Link mode", "Pick another note to link.")
      return
    }
    if (shiftLinkFrom === id) {
      shiftLinkFrom = null
      return
    }
    const a = shiftLinkFrom
    const b = id
    shiftLinkFrom = null
    const key = a < b ? a+"|"+b : b+"|"+a
    if (links.has(key)) {
      links.delete(key)
      saveLocal()
      if (user) {
        const note_a = a < b ? a : b
        const note_b = a < b ? b : a
        await supabase.from("note_links").delete().eq("user_id", user.id).eq("note_a", note_a).eq("note_b", note_b)
      }
      toast("Unlinked", "Removed the connection.")
    } else {
      links.add(key)
      saveLocal()
      await upsertLink(a,b)
      toast("Linked", "Connected those notes.")
      sfx("link")
    }
    return
  }
  setFocused(id)
})

el("layoutBtn").addEventListener("click", () => {
  nodePos.clear()
  rebuildGraph()
  toast("Auto layout", "Re-centered the graph.")
})

el("clearLinksBtn").addEventListener("click", () => {
  clearLinks()
  toast("Cleared", "All links removed.")
})

function showModal(title, bodyNode) {
  el("modalTitle").textContent = title
  const mb = el("modalBody")
  mb.innerHTML = ""
  mb.appendChild(bodyNode)
  el("modalBack").style.display = "flex"
}

function closeModal() {
  el("modalBack").style.display = "none"
  el("modalBody").innerHTML = ""
}

el("modalClose").addEventListener("click", closeModal)
el("modalBack").addEventListener("click", (e) => {
  if (e.target === el("modalBack")) closeModal()
})

let audioUnlocked = false
function openNerd() {
  el("nerdBack").style.display = "flex"
  el("nerdPass").value = ""
  el("nerdMsg").textContent = ""
  el("nerdLocked").style.display = settings.audio?.unlocked ? "none" : ""
  el("nerdUnlocked").style.display = settings.audio?.unlocked ? "" : "none"
  if (settings.audio?.unlocked) {
    audioUnlocked = true
    syncAudioUI()
  }
}

function closeNerd() {
  el("nerdBack").style.display = "none"
}

el("openNerdBtn").addEventListener("click", openNerd)
el("nerdClose").addEventListener("click", closeNerd)
el("nerdBack").addEventListener("click", (e) => {
  if (e.target === el("nerdBack")) closeNerd()
})

el("nerdUnlockBtn").addEventListener("click", () => {
  const v = el("nerdPass").value.trim()
  if (v === "9999") {
    settings.audio.unlocked = true
    audioUnlocked = true
    el("nerdLocked").style.display = "none"
    el("nerdUnlocked").style.display = ""
    el("nerdMsg").textContent = ""
    syncAudioUI()
    saveLocal()
    saveSettingsRemote()
    toast("Unlocked", "Nerd settings opened.")
  } else {
    el("nerdMsg").textContent = "Nope."
    toast("Wrong passcode", "Try again.")
  }
})

function applyAudioPrefs() {
  if (!settings.audio) settings.audio = { unlocked:false, enabled:false, track:0, volume:0.35, loop:true, quickMute:true }
  audioEl.loop = !!settings.audio.loop
  audioEl.volume = Math.max(0, Math.min(1, Number(settings.audio.volume ?? 0.35)))
  const track = AUDIO_TRACKS[Math.max(0, Math.min(AUDIO_TRACKS.length-1, Number(settings.audio.track ?? 0)))]
  if (track) audioEl.src = track.url
}

function syncAudioUI() {
  el("audioTrack").innerHTML = AUDIO_TRACKS.map((t,i) => '<option value="'+i+'">'+escapeHtml(t.name)+'</option>').join("")
  el("audioTrack").value = String(settings.audio.track ?? 0)
  el("audioVol").value = String(settings.audio.volume ?? 0.35)
  el("audioLoopBtn").textContent = "Loop: " + (settings.audio.loop ? "On" : "Off")
  el("audioToggle").textContent = audioEl.paused ? "Play" : "Pause"
  el("toggleSfxBtn").textContent = "SFX: " + (settings.game?.sfx ? "On" : "Off")
  el("sfxToggleBtn").textContent = "Game SFX: " + (settings.game?.sfx ? "On" : "Off")
}

function quickMute() {
  if (!audioUnlocked) return
  if (audioEl.paused) {
    audioEl.play().then(() => {
      el("audioToggle").textContent = "Pause"
      toast("Audio", "Playing.")
    }).catch(() => {
      toast("Audio blocked", "Tap Play in the nerd settings once.")
    })
  } else {
    audioEl.pause()
    el("audioToggle").textContent = "Play"
    toast("Audio", "Muted.")
  }
}

el("audioToggle").addEventListener("click", quickMute)

el("audioMute").addEventListener("click", () => {
  if (!audioUnlocked) return
  audioEl.pause()
  el("audioToggle").textContent = "Play"
  toast("Audio", "Muted.")
})

el("audioTrack").addEventListener("change", () => {
  if (!audioUnlocked) return
  settings.audio.track = Number(el("audioTrack").value || 0)
  applyAudioPrefs()
  if (!audioEl.paused) {
    audioEl.play().then(() => {
      el("audioToggle").textContent = "Pause"
    }).catch(() => {
      audioEl.pause()
      el("audioToggle").textContent = "Play"
    })
  }
})

el("audioVol").addEventListener("input", () => {
  if (!audioUnlocked) return
  const v = Number(el("audioVol").value)
  settings.audio.volume = Math.max(0, Math.min(1, v))
  audioEl.volume = settings.audio.volume
})

el("audioLoopBtn").addEventListener("click", () => {
  if (!audioUnlocked) return
  settings.audio.loop = !settings.audio.loop
  audioEl.loop = settings.audio.loop
  el("audioLoopBtn").textContent = "Loop: " + (settings.audio.loop ? "On" : "Off")
})

el("audioSaveBtn").addEventListener("click", () => {
  if (!audioUnlocked) return
  saveLocal()
  saveSettingsRemote()
  toast("Saved", "Audio prefs saved.")
})

el("sfxToggleBtn").addEventListener("click", () => {
  settings.game.sfx = !settings.game.sfx
  syncAudioUI()
  saveLocal()
  saveSettingsRemote()
})

el("toggleSfxBtn").addEventListener("click", () => {
  settings.game.sfx = !settings.game.sfx
  syncAudioUI()
  saveLocal()
})

applyAudioPrefs()
syncAudioUI()

let audioCtx = null
function sfx(kind) {
  if (!settings.game?.sfx) return
  if (!audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)() } catch (e) { return }
  }
  const now = audioCtx.currentTime
  const osc = audioCtx.createOscillator()
  const gain = audioCtx.createGain()
  const freq = kind === "eat" ? 640 : kind === "line" ? 520 : kind === "hit" ? 220 : kind === "link" ? 780 : 440
  osc.frequency.setValueAtTime(freq, now)
  osc.type = "triangle"
  gain.gain.setValueAtTime(0.0001, now)
  gain.gain.exponentialRampToValueAtTime(0.08, now + 0.01)
  gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12)
  osc.connect(gain)
  gain.connect(audioCtx.destination)
  osc.start(now)
  osc.stop(now + 0.14)
}

document.querySelectorAll("[data-game]").forEach(b => {
  b.addEventListener("click", () => openGame(b.dataset.game))
})

function openGame(id) {
  if (id === "snake") return showModal("Neon Snake+", buildSnake())
  if (id === "tetris") return showModal("Mini Tetris", buildTetris())
  if (id === "runner") return showModal("Runner", buildRunner())
  if (id === "memory") return showModal("Memory Match", buildMemory())
  if (id === "click") return showModal("Rapid Click", buildClicker())
  if (id === "zen") return showModal("Zen Break", buildZen())
}

function wrapCanvas(w=520,h=420) {
  const wrap = document.createElement("div")
  wrap.className = "canvasWrap"
  wrap.style.width = "100%"
  const c = document.createElement("canvas")
  c.width = w
  c.height = h
  c.style.width = "100%"
  c.style.height = "420px"
  wrap.appendChild(c)
  return {wrap, c, ctx: c.getContext("2d")}
}

function buildSnake() {
  const root = document.createElement("div")
  const top = document.createElement("div")
  top.className = "row"
  top.style.justifyContent = "space-between"
  top.innerHTML = '<div style="font-weight:900">Score: <span id="snScore">0</span> <span class="small">Combo <span id="snCombo">x1</span></span></div><div class="small">Keys: WASD / Arrows</div>'
  const {wrap,c,ctx} = wrapCanvas(520,420)
  const row = document.createElement("div")
  row.className = "row"
  row.style.marginTop = "10px"
  row.innerHTML = '<button class="btn primary" id="snStart">Start</button><button class="btn" id="snBoost">Boost</button><button class="btn bad" id="snStop">Stop</button><div class="small">Boost recharges on apples.</div>'
  root.appendChild(top)
  root.appendChild(wrap)
  root.appendChild(row)

  const tile = 20
  const cols = Math.floor(c.width / tile)
  const rows = Math.floor(c.height / tile)
  let snake = [{x:Math.floor(cols/2), y:Math.floor(rows/2)}]
  let dir = {x:1,y:0}
  let nextDir = {x:1,y:0}
  let apple = {x:5,y:5}
  let tick = 0
  let running = false
  let score = 0
  let combo = 1
  let boost = 2
  let speed = 7
  let raf = null

  function randCell() {
    while (true) {
      const x = Math.floor(Math.random()*cols)
      const y = Math.floor(Math.random()*rows)
      if (!snake.some(s => s.x===x && s.y===y)) return {x,y}
    }
  }

  function reset() {
    snake = [{x:Math.floor(cols/2), y:Math.floor(rows/2)}]
    dir = {x:1,y:0}
    nextDir = {x:1,y:0}
    apple = randCell()
    score = 0
    combo = 1
    boost = 2
    speed = 7
    el("snScore").textContent = "0"
    el("snCombo").textContent = "x1"
    draw()
  }

  function draw() {
    ctx.clearRect(0,0,c.width,c.height)
    ctx.fillStyle = "rgba(0,0,0,.20)"
    ctx.fillRect(0,0,c.width,c.height)
    ctx.strokeStyle = "rgba(255,255,255,.06)"
    for (let x=0;x<cols;x++) {
      ctx.beginPath()
      ctx.moveTo(x*tile,0)
      ctx.lineTo(x*tile,c.height)
      ctx.stroke()
    }
    for (let y=0;y<rows;y++) {
      ctx.beginPath()
      ctx.moveTo(0,y*tile)
      ctx.lineTo(c.width,y*tile)
      ctx.stroke()
    }

    const a = apple
    const grad = ctx.createRadialGradient(a.x*tile+tile/2, a.y*tile+tile/2, 2, a.x*tile+tile/2, a.y*tile+tile/2, 14)
    grad.addColorStop(0, "rgba(255,122,217,.95)")
    grad.addColorStop(1, "rgba(255,122,217,.05)")
    ctx.fillStyle = grad
    ctx.beginPath()
    ctx.arc(a.x*tile+tile/2, a.y*tile+tile/2, 10, 0, Math.PI*2)
    ctx.fill()

    for (let i=snake.length-1;i>=0;i--) {
      const s = snake[i]
      const p = i / Math.max(1, snake.length-1)
      ctx.fillStyle = "rgba(112,240,255," + (0.15 + 0.75*(1-p)) + ")"
      ctx.fillRect(s.x*tile+2, s.y*tile+2, tile-4, tile-4)
    }
    const head = snake[0]
    ctx.fillStyle = "rgba(255,255,255,.85)"
    ctx.fillRect(head.x*tile+4, head.y*tile+4, tile-8, tile-8)
  }

  function step(mult=1) {
    dir = nextDir
    for (let k=0;k<mult;k++) {
      const head = snake[0]
      const nx = head.x + dir.x
      const ny = head.y + dir.y
      if (nx<0 || ny<0 || nx>=cols || ny>=rows) {
        end()
        return
      }
      if (snake.some((s,idx)=>idx>0 && s.x===nx && s.y===ny)) {
        end()
        return
      }
      snake.unshift({x:nx,y:ny})
      if (nx===apple.x && ny===apple.y) {
        score += 10 * combo
        combo = Math.min(9, combo + 1)
        boost = Math.min(3, boost + 1)
        speed = Math.min(14, speed + 0.3)
        apple = randCell()
        el("snScore").textContent = String(score)
        el("snCombo").textContent = "x"+String(combo)
        sfx("eat")
      } else {
        snake.pop()
        combo = Math.max(1, combo - 0.06)
        el("snCombo").textContent = "x"+String(Math.round(combo))
      }
    }
  }

  function end() {
    running = false
    cancelAnimationFrame(raf)
    toast("Snake", "Game over. Score " + score)
    sfx("hit")
  }

  function loop() {
    if (!running) return
    tick++
    const base = 60 / speed
    if (tick % Math.max(1, Math.floor(base)) === 0) step(1)
    draw()
    raf = requestAnimationFrame(loop)
  }

  function start() {
    if (running) return
    running = true
    tick = 0
    loop()
  }

  function stop() {
    running = false
    cancelAnimationFrame(raf)
    draw()
  }

  function boostNow() {
    if (!running) return
    if (boost <= 0) return
    boost -= 1
    step(2)
    draw()
  }

  root.querySelector("#snStart").addEventListener("click", () => {
    reset()
    start()
  })
  root.querySelector("#snStop").addEventListener("click", stop)
  root.querySelector("#snBoost").addEventListener("click", boostNow)

  function setDir(x,y) {
    if (dir.x + x === 0 && dir.y + y === 0) return
    nextDir = {x,y}
  }

  window.addEventListener("keydown", (e) => {
    if (el("modalBack").style.display !== "flex") return
    if (el("modalTitle").textContent !== "Neon Snake+") return
    const k = e.key.toLowerCase()
    if (k === "arrowup" || k === "w") setDir(0,-1)
    if (k === "arrowdown" || k === "s") setDir(0,1)
    if (k === "arrowleft" || k === "a") setDir(-1,0)
    if (k === "arrowright" || k === "d") setDir(1,0)
    if (k === " ") boostNow()
  })

  reset()
  return root
}

function buildTetris() {
  const root = document.createElement("div")
  const top = document.createElement("div")
  top.className = "row"
  top.style.justifyContent = "space-between"
  top.innerHTML = '<div style="font-weight:900">Lines: <span id="ttLines">0</span></div><div class="small">Keys: ← → ↓ rotate: ↑</div>'
  const {wrap,c,ctx} = wrapCanvas(360,420)
  const row = document.createElement("div")
  row.className = "row"
  row.style.marginTop = "10px"
  row.innerHTML = '<button class="btn primary" id="ttStart">Start</button><button class="btn bad" id="ttStop">Stop</button>'
  root.appendChild(top)
  root.appendChild(wrap)
  root.appendChild(row)

  const W=10,H=20, S=20
  let grid = Array.from({length:H}, () => Array.from({length:W}, () => 0))
  const pieces = [
    {m:[[1,1,1,1]], c:"rgba(112,240,255,.85)"},
    {m:[[1,1],[1,1]], c:"rgba(255,211,107,.85)"},
    {m:[[0,1,0],[1,1,1]], c:"rgba(255,122,217,.85)"},
    {m:[[1,0,0],[1,1,1]], c:"rgba(124,255,134,.85)"},
    {m:[[0,0,1],[1,1,1]], c:"rgba(160,180,255,.85)"},
    {m:[[0,1,1],[1,1,0]], c:"rgba(255,160,122,.85)"},
    {m:[[1,1,0],[0,1,1]], c:"rgba(200,255,160,.85)"}
  ]
  let cur=null
  let x=0,y=0
  let drop=0
  let running=false
  let lines=0
  let raf=null

  function newPiece() {
    cur = pieces[Math.floor(Math.random()*pieces.length)]
    x = Math.floor(W/2) - Math.floor(cur.m[0].length/2)
    y = 0
    if (collide(x,y,cur.m)) end()
  }

  function rotate(m) {
    const h=m.length,w=m[0].length
    const out = Array.from({length:w}, (_,i) => Array.from({length:h}, (_,j) => m[h-1-j][i]))
    return out
  }

  function collide(px,py,m) {
    for (let r=0;r<m.length;r++) for (let c2=0;c2<m[0].length;c2++) {
      if (!m[r][c2]) continue
      const gx = px + c2
      const gy = py + r
      if (gx<0 || gx>=W || gy<0 || gy>=H) return true
      if (grid[gy][gx]) return true
    }
    return false
  }

  function merge() {
    for (let r=0;r<cur.m.length;r++) for (let c2=0;c2<cur.m[0].length;c2++) {
      if (!cur.m[r][c2]) continue
      const gx = x + c2
      const gy = y + r
      if (gy>=0 && gy<H && gx>=0 && gx<W) grid[gy][gx] = cur.c
    }
  }

  function clearLines() {
    let cleared=0
    grid = grid.filter(row => {
      if (row.every(v => v)) {
        cleared++
        return false
      }
      return true
    })
    while (grid.length < H) grid.unshift(Array.from({length:W},()=>0))
    if (cleared) {
      lines += cleared
      el("ttLines").textContent = String(lines)
      sfx("line")
    }
  }

  function draw() {
    ctx.clearRect(0,0,c.width,c.height)
    ctx.fillStyle="rgba(0,0,0,.18)"
    ctx.fillRect(0,0,c.width,c.height)
    for (let r=0;r<H;r++) for (let c2=0;c2<W;c2++) {
      const v = grid[r][c2]
      if (v) {
        ctx.fillStyle = v
        ctx.fillRect(c2*S+1,r*S+1,S-2,S-2)
      } else {
        ctx.strokeStyle="rgba(255,255,255,.06)"
        ctx.strokeRect(c2*S+0.5,r*S+0.5,S-1,S-1)
      }
    }
    if (cur) {
      for (let r=0;r<cur.m.length;r++) for (let c2=0;c2<cur.m[0].length;c2++) {
        if (!cur.m[r][c2]) continue
        ctx.fillStyle = cur.c
        ctx.fillRect((x+c2)*S+1,(y+r)*S+1,S-2,S-2)
      }
    }
  }

  function step() {
    if (!running) return
    drop++
    const sp = Math.max(10, 42 - Math.floor(lines*1.5))
    if (drop % sp === 0) {
      if (!collide(x,y+1,cur.m)) y++
      else {
        merge()
        clearLines()
        newPiece()
      }
    }
    draw()
    raf = requestAnimationFrame(step)
  }

  function start() {
    grid = Array.from({length:H}, () => Array.from({length:W}, () => 0))
    lines = 0
    el("ttLines").textContent = "0"
    newPiece()
    running = true
    drop = 0
    step()
  }

  function stop() {
    running = false
    cancelAnimationFrame(raf)
    draw()
  }

  function end() {
    running = false
    cancelAnimationFrame(raf)
    toast("Tetris", "Game over. Lines " + lines)
    sfx("hit")
  }

  root.querySelector("#ttStart").addEventListener("click", start)
  root.querySelector("#ttStop").addEventListener("click", stop)

  window.addEventListener("keydown", (e) => {
    if (el("modalBack").style.display !== "flex") return
    if (el("modalTitle").textContent !== "Mini Tetris") return
    if (!running) return
    if (e.key === "ArrowLeft" && !collide(x-1,y,cur.m)) x--
    if (e.key === "ArrowRight" && !collide(x+1,y,cur.m)) x++
    if (e.key === "ArrowDown" && !collide(x,y+1,cur.m)) y++
    if (e.key === "ArrowUp") {
      const rm = rotate(cur.m)
      if (!collide(x,y,rm)) cur.m = rm
    }
    draw()
  })

  draw()
  return root
}

function buildRunner() {
  const root = document.createElement("div")
  const top = document.createElement("div")
  top.className = "row"
  top.style.justifyContent = "space-between"
  top.innerHTML = '<div style="font-weight:900">Distance: <span id="rnDist">0</span></div><div class="small">Jump: Space / ↑</div>'
  const {wrap,c,ctx} = wrapCanvas(520,420)
  const row = document.createElement("div")
  row.className = "row"
  row.style.marginTop = "10px"
  row.innerHTML = '<button class="btn primary" id="rnStart">Start</button><button class="btn bad" id="rnStop">Stop</button>'
  root.appendChild(top)
  root.appendChild(wrap)
  root.appendChild(row)

  let running=false
  let t=0
  let speed=3.2
  let dist=0
  let y=0
  let vy=0
  let onGround=true
  let obs=[]
  let raf=null

  function reset() {
    t=0
    speed=3.2
    dist=0
    y=0
    vy=0
    onGround=true
    obs=[]
    el("rnDist").textContent="0"
    draw()
  }

  function spawn() {
    const h = 22 + Math.random()*26
    const w = 18 + Math.random()*22
    obs.push({x:c.width+20, y:c.height-70-h, w, h})
  }

  function jump() {
    if (!running) return
    if (!onGround) return
    vy = -11.5
    onGround = false
    sfx("eat")
  }

  function step() {
    if (!running) return
    t++
    dist += speed
    el("rnDist").textContent = String(Math.floor(dist/10))
    speed = Math.min(8.5, speed + 0.0009*dist/10)

    if (Math.random() < 0.02 + speed*0.002) spawn()
    obs.forEach(o => o.x -= speed*1.7)
    obs = obs.filter(o => o.x + o.w > -20)

    vy += 0.55
    y += vy
    if (y > 0) {
      y = 0
      vy = 0
      onGround = true
    }

    const px = 90
    const py = c.height - 70 - 34 + y
    const pw = 28, ph = 34

    for (const o of obs) {
      if (px < o.x+o.w && px+pw > o.x && py < o.y+o.h && py+ph > o.y) {
        end()
        return
      }
    }

    draw()
    raf = requestAnimationFrame(step)
  }

  function draw() {
    ctx.clearRect(0,0,c.width,c.height)
    ctx.fillStyle="rgba(0,0,0,.16)"
    ctx.fillRect(0,0,c.width,c.height)

    const groundY = c.height - 70
    ctx.strokeStyle="rgba(255,255,255,.10)"
    ctx.lineWidth=2
    ctx.beginPath()
    ctx.moveTo(0, groundY)
    ctx.lineTo(c.width, groundY)
    ctx.stroke()

    ctx.fillStyle="rgba(112,240,255,.22)"
    ctx.fillRect(0, groundY, c.width, 70)

    const px = 90
    const py = groundY - 34 + y
    ctx.fillStyle="rgba(255,255,255,.86)"
    ctx.fillRect(px, py, 28, 34)
    ctx.fillStyle="rgba(112,240,255,.55)"
    ctx.fillRect(px+4, py+4, 20, 26)

    obs.forEach(o => {
      ctx.fillStyle="rgba(255,122,217,.70)"
      ctx.fillRect(o.x, o.y, o.w, o.h)
      ctx.fillStyle="rgba(255,122,217,.18)"
      ctx.fillRect(o.x-6, o.y-6, o.w+12, o.h+12)
    })
  }

  function start() {
    reset()
    running=true
    step()
  }
  function stop() {
    running=false
    cancelAnimationFrame(raf)
    draw()
  }
  function end() {
    running=false
    cancelAnimationFrame(raf)
    toast("Runner", "Crashed. Distance " + Math.floor(dist/10))
    sfx("hit")
  }

  root.querySelector("#rnStart").addEventListener("click", start)
  root.querySelector("#rnStop").addEventListener("click", stop)

  window.addEventListener("keydown", (e) => {
    if (el("modalBack").style.display !== "flex") return
    if (el("modalTitle").textContent !== "Runner") return
    if (e.key === " " || e.key === "ArrowUp") jump()
  })

  draw()
  return root
}

function buildMemory() {
  const root = document.createElement("div")
  const top = document.createElement("div")
  top.className = "row"
  top.style.justifyContent = "space-between"
  top.innerHTML = '<div style="font-weight:900">Time: <span id="mmTime">0.0</span>s</div><div class="small">Match all pairs.</div>'
  root.appendChild(top)

  const grid = document.createElement("div")
  grid.style.display="grid"
  grid.style.gridTemplateColumns="repeat(4,1fr)"
  grid.style.gap="10px"
  grid.style.marginTop="12px"
  root.appendChild(grid)

  const row = document.createElement("div")
  row.className = "row"
  row.style.marginTop="12px"
  row.innerHTML = '<button class="btn primary" id="mmStart">Start</button><button class="btn bad" id="mmReset">Reset</button>'
  root.appendChild(row)

  const icons = ["★","◆","●","▲","■","☀","☾","✦"]
  let deck=[]
  let open=[]
  let matched=new Set()
  let startAt=0
  let timer=null
  let running=false

  function buildDeck() {
    deck = [...icons, ...icons].sort(() => Math.random()-0.5).map((v,i) => ({v,i}))
  }

  function draw() {
    grid.innerHTML=""
    deck.forEach(card => {
      const b = document.createElement("button")
      b.className="btn"
      b.style.height="70px"
      b.style.borderRadius="16px"
      b.style.fontSize="22px"
      b.style.fontWeight="900"
      b.style.background="rgba(255,255,255,.05)"
      const isOpen = open.includes(card.i) || matched.has(card.i)
      b.textContent = isOpen ? card.v : " "
      b.addEventListener("click", () => flip(card.i))
      grid.appendChild(b)
    })
  }

  function flip(i) {
    if (!running) return
    if (matched.has(i)) return
    if (open.includes(i)) return
    if (open.length >= 2) return
    open.push(i)
    sfx("eat")
    draw()
    if (open.length === 2) {
      const a = deck.find(c => c.i === open[0])
      const b = deck.find(c => c.i === open[1])
      if (a.v === b.v) {
        matched.add(a.i); matched.add(b.i)
        open=[]
        sfx("line")
        draw()
        if (matched.size === deck.length) win()
      } else {
        setTimeout(() => {
          open=[]
          draw()
        }, 520)
      }
    }
  }

  function tick() {
    const t = (performance.now()-startAt)/1000
    el("mmTime").textContent = t.toFixed(1)
  }

  function start() {
    running=true
    matched.clear()
    open=[]
    buildDeck()
    draw()
    startAt=performance.now()
    clearInterval(timer)
    timer=setInterval(tick, 100)
  }

  function reset() {
    running=false
    clearInterval(timer)
    el("mmTime").textContent="0.0"
    matched.clear()
    open=[]
    buildDeck()
    draw()
  }

  function win() {
    running=false
    clearInterval(timer)
    toast("Memory", "Cleared in " + el("mmTime").textContent + "s")
  }

  root.querySelector("#mmStart").addEventListener("click", start)
  root.querySelector("#mmReset").addEventListener("click", reset)

  reset()
  return root
}

function buildClicker() {
  const root = document.createElement("div")
  root.innerHTML = '<div class="row" style="justify-content:space-between"><div style="font-weight:900">Clicks: <span id="ckCount">0</span></div><div class="small">30 seconds</div></div>'
  const big = document.createElement("button")
  big.className="btn primary"
  big.style.width="100%"
  big.style.height="220px"
  big.style.fontSize="28px"
  big.style.marginTop="12px"
  big.textContent="CLICK"
  root.appendChild(big)
  const row = document.createElement("div")
  row.className="row"
  row.style.marginTop="10px"
  row.innerHTML = '<button class="btn" id="ckStart">Start</button><button class="btn bad" id="ckReset">Reset</button><div class="small" id="ckTime">Ready</div>'
  root.appendChild(row)

  let running=false
  let count=0
  let endAt=0
  let timer=null

  function render() {
    el("ckCount").textContent=String(count)
  }

  function start() {
    running=true
    count=0
    render()
    endAt = performance.now() + 30000
    el("ckTime").textContent="30.0s"
    clearInterval(timer)
    timer=setInterval(() => {
      const left = Math.max(0, endAt - performance.now())
      el("ckTime").textContent=(left/1000).toFixed(1)+"s"
      if (left<=0) finish()
    }, 60)
  }

  function finish() {
    running=false
    clearInterval(timer)
    el("ckTime").textContent="Done"
    toast("Rapid Click", "Score " + count)
    sfx("line")
  }

  function reset() {
    running=false
    clearInterval(timer)
    count=0
    render()
    el("ckTime").textContent="Ready"
  }

  big.addEventListener("click", () => {
    if (!running) return
    count++
    render()
    sfx("eat")
  })

  row.querySelector("#ckStart").addEventListener("click", start)
  row.querySelector("#ckReset").addEventListener("click", reset)

  reset()
  return root
}

function buildZen() {
  const root = document.createElement("div")
  const small = document.createElement("div")
  small.className="small"
  small.textContent="Tap bubbles. No score. Just a little brain break."
  root.appendChild(small)
  const {wrap,c,ctx} = wrapCanvas(520,420)
  root.appendChild(wrap)
  const row = document.createElement("div")
  row.className="row"
  row.style.marginTop="10px"
  row.innerHTML='<button class="btn primary" id="znSpawn">Spawn</button><button class="btn" id="znClear">Clear</button>'
  root.appendChild(row)

  let bubbles=[]
  function spawn(n=8) {
    for (let i=0;i<n;i++) {
      bubbles.push({
        x: Math.random()*c.width,
        y: Math.random()*c.height,
        r: 14 + Math.random()*22,
        vx: (Math.random()-0.5)*1.2,
        vy: (Math.random()-0.5)*1.2
      })
    }
  }
  function step() {
    ctx.clearRect(0,0,c.width,c.height)
    ctx.fillStyle="rgba(0,0,0,.16)"
    ctx.fillRect(0,0,c.width,c.height)
    bubbles.forEach(b => {
      b.x += b.vx
      b.y += b.vy
      if (b.x<b.r || b.x>c.width-b.r) b.vx *= -1
      if (b.y<b.r || b.y>c.height-b.r) b.vy *= -1
      const g = ctx.createRadialGradient(b.x,b.y,2,b.x,b.y,b.r)
      g.addColorStop(0,"rgba(112,240,255,.55)")
      g.addColorStop(1,"rgba(255,122,217,.05)")
      ctx.fillStyle=g
      ctx.beginPath()
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2)
      ctx.fill()
    })
    requestAnimationFrame(step)
  }
  c.addEventListener("click", (e) => {
    const r = c.getBoundingClientRect()
    const x = (e.clientX - r.left) * (c.width / r.width)
    const y = (e.clientY - r.top) * (c.height / r.height)
    const idx = bubbles.findIndex(b => Math.hypot(x-b.x,y-b.y) <= b.r)
    if (idx>=0) {
      bubbles.splice(idx,1)
      sfx("eat")
    } else {
      bubbles.push({x,y,r:16+Math.random()*18,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*1.2})
      sfx("link")
    }
  })
  row.querySelector("#znSpawn").addEventListener("click", () => spawn(10))
  row.querySelector("#znClear").addEventListener("click", () => {bubbles=[]})
  spawn(12)
  step()
  return root
}

let timerSeconds = 25*60
let timerRunning = false
let timerInt = null

function timerRender() {
  const m = Math.floor(timerSeconds/60)
  const s = timerSeconds%60
  el("timerDisplay").textContent = String(m).padStart(2,"0")+":"+String(s).padStart(2,"0")
}

function timerSetPreset(mins) {
  timerSeconds = mins*60
  timerRender()
}

document.querySelectorAll("[data-preset]").forEach(b => {
  b.addEventListener("click", () => {
    const mins = Number(b.dataset.preset)
    timerSetPreset(mins)
  })
})

function timerStart() {
  if (timerRunning) return
  timerRunning = true
  timerInt = setInterval(() => {
    if (!timerRunning) return
    timerSeconds = Math.max(0, timerSeconds - 1)
    timerRender()
    if (timerSeconds === 0) {
      timerRunning = false
      clearInterval(timerInt)
      toast("Timer", "Done.")
      sfx("line")
    }
  }, 1000)
}

function timerPause() {
  timerRunning = false
  clearInterval(timerInt)
}

function timerReset() {
  timerRunning = false
  clearInterval(timerInt)
  timerSetPreset(Number(settings.timer?.preset || 25))
}

el("timerStart").addEventListener("click", timerStart)
el("timerPause").addEventListener("click", timerPause)
el("timerReset").addEventListener("click", timerReset)
el("timerLogBtn").addEventListener("click", () => {
  const n = readEditorIntoNote()
  if (!n) {
    toast("No note", "Open a note first.")
    return
  }
  const stamp = new Date().toLocaleString()
  el("timerNotes").value += (el("timerNotes").value ? "\n\n" : "") + "["+stamp+"] " + (n.title||"Untitled") + ": " + (String(n.content||"").slice(0,220).replace(/\s+/g," ").trim()) 
  toast("Logged", "Added a quick snippet.")
})

document.addEventListener("keydown", (e) => {
  if (activeView !== "timerView") return
  if (e.key === " ") {
    e.preventDefault()
    if (timerRunning) timerPause()
    else timerStart()
  }
  if (e.key.toLowerCase() === "r") timerReset()
})

timerSetPreset(Number(settings.timer?.preset || 25))
timerRender()

renderNotesList()
</script>
</body>
</html>
